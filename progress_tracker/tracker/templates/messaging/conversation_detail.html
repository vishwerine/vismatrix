{% extends "tracker/base.html" %}
{% block title %}Chat - {{ other.username }}{% endblock %}

{% block toast %}{% endblock %}

{% block content %}
<main class="max-w-5xl mx-auto space-y-6">

  <!-- Header -->
  <header class="card border border-base-200 bg-base-100">
    <div class="card-body p-5 sm:p-6">
      <div class="flex items-center justify-between gap-3">
        <div class="flex items-center gap-3 min-w-0">
          <a href="{% url 'inbox' %}" class="btn btn-ghost btn-sm" aria-label="Back to inbox">
            <i class="bi bi-arrow-left" aria-hidden="true"></i>
          </a>

          <div class="avatar placeholder flex-shrink-0">
            <div class="bg-neutral text-neutral-content rounded-full w-11">
              <span class="text-sm font-bold">{{ other.username|first|upper }}</span>
            </div>
          </div>

          <div class="min-w-0">
            <h1 class="text-lg sm:text-xl font-extrabold text-base-content truncate">
              {{ other.username }}
            </h1>
            <p class="text-xs text-base-content/60">
              Keep it friendly âœ¨
            </p>
          </div>
        </div>

        <div class="flex items-center gap-2">
          <a href="{% url 'friends_list' %}" class="btn btn-outline btn-sm gap-2">
            <i class="bi bi-people" aria-hidden="true"></i>
            <span class="hidden sm:inline">Friends</span>
          </a>
          <a href="{% url 'dashboard' %}" class="btn btn-primary btn-sm gap-2">
            <i class="bi bi-house" aria-hidden="true"></i>
            <span class="hidden sm:inline">Dashboard</span>
          </a>
        </div>
      </div>
    </div>
  </header>

  <!-- Chat panel -->
  <section class="card border border-base-200 bg-base-100">
    <div class="card-body p-0">

      <!-- Messages -->
      <div id="chatScroll"
           class="h-[60vh] sm:h-[65vh] overflow-auto p-4 sm:p-5 space-y-3 bg-base-100">
        {% for msg in messages %}
          {% if msg.sender_id == user.id %}
            <!-- My message -->
            <div class="chat chat-end">
              <div class="chat-header text-xs opacity-70">
                You
                <time class="ml-2">{{ msg.created_at|date:"M j, g:i A" }}</time>
              </div>
              <div class="chat-bubble chat-bubble-primary text-sm whitespace-pre-wrap">
                {{ msg.body }}
              </div>
            </div>
          {% else %}
            <!-- Their message -->
            <div class="chat chat-start">
              <div class="chat-header text-xs opacity-70">
                {{ msg.sender.username }}
                <time class="ml-2">{{ msg.created_at|date:"M j, g:i A" }}</time>
              </div>
              <div class="chat-bubble text-sm whitespace-pre-wrap">
                {{ msg.body }}
              </div>
            </div>
          {% endif %}
        {% empty %}
          <div class="p-10 text-center text-sm text-base-content/70">
            No messages yet. Say hello ðŸ‘‹
          </div>
        {% endfor %}
      </div>

      <!-- Composer -->
      <div class="border-t border-base-200 p-3 sm:p-4 bg-base-100">
        <form method="post" class="flex items-end gap-2">
          {% csrf_token %}
          <label class="w-full">
            <span class="sr-only">Message</span>
            <textarea
              name="body"
              id="chatInput"
              rows="1"
              class="textarea textarea-bordered w-full resize-none"
              placeholder="Type a messageâ€¦"
              maxlength="2000"
              required></textarea>
          </label>

          <button type="submit" class="btn btn-primary gap-2">
            <i class="bi bi-send" aria-hidden="true"></i>
            <span class="hidden sm:inline">Send</span>
          </button>
        </form>

        <p class="mt-2 text-xs text-base-content/60">
          Press <span class="font-semibold">Enter</span> to send, <span class="font-semibold">Shift+Enter</span> for a new line.
        </p>
      </div>

    </div>
  </section>

</main>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // Auto-scroll to bottom on load
  const scroll = document.getElementById('chatScroll');
  if (scroll) scroll.scrollTop = scroll.scrollHeight;

  // Enter to send (Shift+Enter newline)
  const input = document.getElementById('chatInput');
  if (input) {
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        const form = input.closest('form');
        if (form) form.submit();
      }
    });

    // Auto-grow (simple)
    const autoGrow = () => {
      input.style.height = 'auto';
      input.style.height = Math.min(input.scrollHeight, 160) + 'px';
    };
    input.addEventListener('input', autoGrow);
    autoGrow();
  }
});
</script>
{% endblock %}
