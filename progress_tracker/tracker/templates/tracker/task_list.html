{% extends 'tracker/base.html' %}
{% load math_filters %}

{% block title %}Tasks - VisMatrix.Space{% endblock %}

{% block content %}

<style>
  /* Page-specific polish (kept minimal; aligns with your base tokens) */
  .vm-section { border: 1px solid rgb(226 232 240 / 0.85); }
  .vm-task { 
    transition: all 200ms cubic-bezier(0.4, 0, 0.2, 1);
    cursor: pointer;
    user-select: none;
    -webkit-user-select: none;
  }
  .vm-task:hover { 
    box-shadow: 0 12px 24px rgb(15 23 42 / 0.08), 0 4px 8px rgb(15 23 42 / 0.04); 
    transform: translateY(-2px); 
  }
  .vm-task:active {
    transform: translateY(0);
    box-shadow: 0 4px 12px rgb(15 23 42 / 0.06);
  }
  .vm-chip { background: rgb(15 23 42 / 0.04); border: 1px solid rgb(226 232 240 / 0.9); }
  .vm-muted { color: rgb(15 23 42 / 0.65); }

  /* Priority color coding */
  .priority-high { 
    border-left: 4px solid #ef4444 !important; 
  }
  .priority-medium { 
    border-left: 4px solid #f59e0b !important; 
  }
  .priority-low { 
    border-left: 4px solid #3b82f6 !important; 
  }

  /* Priority badges with colors */
  .badge-priority-high { 
    background-color: #fef2f2; 
    color: #dc2626; 
    border-color: #fecaca;
    font-weight: 700;
    box-shadow: 0 2px 4px rgb(220 38 38 / 0.15);
  }
  .badge-priority-medium { 
    background-color: #fffbeb; 
    color: #d97706; 
    border-color: #fde68a;
    font-weight: 700;
    box-shadow: 0 2px 4px rgb(217 119 6 / 0.15);
  }
  .badge-priority-low { 
    background-color: #eff6ff; 
    color: #2563eb; 
    border-color: #bfdbfe;
    font-weight: 700;
    box-shadow: 0 2px 4px rgb(37 99 235 / 0.15);
  }

  /* Overdue tasks highlighting */
  .task-overdue {
    background-color: #fef2f2 !important;
    border-color: #fecaca !important;
  }

  /* Completed task styling */
  .task-completed {
    opacity: 0.6;
  }

  /* Better checkbox styling */
  .task-checkbox {
    width: 1.25rem;
    height: 1.25rem;
    cursor: pointer;
    flex-shrink: 0;
  }

  /* Larger touch targets for mobile */
  @media (max-width: 768px) {
    .task-checkbox {
      width: 1.5rem;
      height: 1.5rem;
    }
    .vm-task { 
      margin-bottom: 0.75rem; 
    }
    .btn-sm {
      min-height: 2.5rem;
    }
  }

  /* Opaque dropdown for task menu */
  .vm-dropdown-opaque {
    background-color: #ffffff !important;
    opacity: 1 !important;
    backdrop-filter: none !important;
    -webkit-backdrop-filter: none !important;
  }

  /* Let dropdown escape the card (prevents clipping) */
  .vm-task .card-body {
    overflow: visible !important;
  }

  /* Ensure dropdown stacks above cards/navs */
  .task-menu { 
    position: relative; 
    z-index: 1;
  }
  .task-menu .dropdown-content {
    position: absolute;
    z-index: 90 !important;
    min-width: 11rem;
  }
  
  /* Better touch targets and feedback for iOS Safari */
  .task-menu button {
    -webkit-tap-highlight-color: rgba(59, 130, 246, 0.3);
    touch-action: manipulation;
    cursor: pointer;
  }
  
  .task-menu .dropdown-content li > a {
    padding: 0.75rem 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    -webkit-tap-highlight-color: rgba(59, 130, 246, 0.2);
  }

  /* When a task menu is open, raise the entire card above others */
  .vm-task.vm-open {
    position: relative;
    z-index: 85 !important;
  }

  /* Disable hover transform while open (transform creates a stacking context) */
  .vm-task.vm-open:hover {
    transform: none !important;
  }

  /* Expandable task details on mobile */
  .task-details-expanded {
    max-height: 500px;
  }

  /* Better mobile filter layout */
  @media (max-width: 640px) {
    .filter-buttons {
      width: 100%;
    }
    .filter-buttons .btn {
      flex: 1;
      min-width: 0;
    }
  }

  /* iOS-style bottom sheet for mobile menu */
  .task-action-sheet {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: white;
    border-radius: 16px 16px 0 0;
    padding: 0;
    transform: translateY(100%);
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    z-index: 1000;
    max-height: 70vh;
    overflow-y: auto;
    box-shadow: 0 -4px 24px rgba(0, 0, 0, 0.15);
  }

  .task-action-sheet.active {
    transform: translateY(0);
  }

  .task-action-sheet-backdrop {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease, visibility 0.3s ease;
    z-index: 999;
  }

  .task-action-sheet-backdrop.active {
    opacity: 1;
    visibility: visible;
  }

  .task-action-sheet-handle {
    width: 36px;
    height: 4px;
    background: #d1d5db;
    border-radius: 2px;
    margin: 12px auto 8px;
  }

  .task-action-sheet-title {
    font-weight: 600;
    font-size: 0.875rem;
    color: #6b7280;
    text-align: center;
    padding: 8px 16px 12px;
    border-bottom: 1px solid #f3f4f6;
  }

  .task-action-sheet-actions {
    padding: 8px;
  }

  .task-action-sheet-btn {
    display: flex;
    align-items: center;
    gap: 12px;
    width: 100%;
    padding: 16px;
    border: none;
    background: white;
    text-align: left;
    font-size: 1rem;
    color: #1f2937;
    border-radius: 12px;
    cursor: pointer;
    transition: background 0.15s ease;
    -webkit-tap-highlight-color: transparent;
  }

  .task-action-sheet-btn:active {
    background: #f3f4f6;
  }

  .task-action-sheet-btn i {
    font-size: 1.25rem;
    width: 24px;
    text-align: center;
  }

  .task-action-sheet-btn.text-success {
    color: #10b981;
  }

  .task-action-sheet-btn.text-primary {
    color: #3b82f6;
  }

  .task-action-sheet-btn.text-error {
    color: #ef4444;
  }

  .task-action-sheet-btn.disabled {
    color: #9ca3af;
    cursor: not-allowed;
  }

  .task-action-sheet-cancel {
    margin: 8px;
    padding: 16px;
    background: #f9fafb;
    border: none;
    border-radius: 12px;
    font-weight: 600;
    font-size: 1rem;
    color: #6b7280;
    cursor: pointer;
    width: calc(100% - 16px);
    -webkit-tap-highlight-color: transparent;
  }

  .task-action-sheet-cancel:active {
    background: #f3f4f6;
  }

  /* Hide default dropdown on mobile, show button */
  @media (max-width: 768px) {
    .dropdown.task-menu .dropdown-content {
      display: none !important;
    }
  }
</style>

<main class="py-8 sm:py-10">
  <div class="max-w-6xl mx-auto px-4 sm:px-6 space-y-6">

    <!-- Header -->
    <header class="card vm-section bg-base-100 animate-slideUp" role="banner">
      <div class="card-body p-5 sm:p-6">
        <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-4">
          <div class="min-w-0">
            <h1 class="text-2xl sm:text-3xl font-extrabold text-base-content flex items-center gap-2 truncate">
              <i class="bi bi-list-check text-primary" aria-hidden="true"></i>
              <span class="gradient-text">Tasks</span>
              {% if total_tasks %}
                <span class="badge vm-chip text-xs font-bold ml-2 shadow-sm">
                  {{ total_tasks }} total
                </span>
              {% endif %}
            </h1>
            <p class="text-sm vm-muted mt-1">
              Manage and track your tasks. Stay consistent ‚Äî small wins compound.
            </p>
          </div>

          <div class="flex items-center gap-2">
            <!-- Pro Feature: Bulk Operations -->
            {% if user_subscription.is_pro %}
            <button 
              id="bulkModeBtn" 
              class="btn btn-ghost btn-sm gap-2" 
              aria-label="Bulk edit tasks"
              title="Pro: Bulk Operations">
              <i class="bi bi-layers"></i>
              <span class="hidden sm:inline">Bulk Edit</span>
              <span class="badge badge-xs badge-primary">Pro</span>
            </button>
            {% else %}
            <a 
              href="{% url 'subscription_plans' %}" 
              class="btn btn-ghost btn-sm gap-2 opacity-60" 
              aria-label="Upgrade to Pro for bulk operations"
              title="Upgrade to Pro">
              <i class="bi bi-lock"></i>
              <span class="hidden sm:inline">Bulk Edit</span>
              <span class="badge badge-xs">Pro</span>
            </a>
            {% endif %}
            
            <a href="{% url 'category_list' %}" class="btn btn-ghost btn-sm gap-2" aria-label="Manage categories">
              <i class="bi bi-tags" aria-hidden="true"></i>
              <span class="hidden sm:inline">Categories</span>
            </a>
            <a href="{% url 'task_create' %}" class="btn btn-primary btn-sm gap-2" aria-label="Create a new task">
              <i class="bi bi-plus-square" aria-hidden="true"></i>
              <span>New task</span>
            </a>
          </div>
        </div>
      </div>
    </header>

    <!-- Filters -->
    <section class="card vm-section bg-base-100 animate-fadeIn" aria-label="Task filters">
      <div class="card-body p-5 sm:p-6">
        <div class="flex flex-col lg:flex-row gap-4 lg:items-end lg:justify-between">

          <!-- Search -->
          <form method="get" class="w-full lg:max-w-md" id="searchForm">
            <label class="label font-semibold">
              <span class="label-text flex items-center gap-2">
                <i class="bi bi-search text-primary" aria-hidden="true"></i>
                Search
                <span id="searchResultsCount" class="text-xs vm-muted hidden"></span>
              </span>
            </label>

            <div class="join w-full">
              <input
                type="text"
                name="search"
                id="taskSearchInput"
                value="{{ request.GET.search|default:'' }}"
                placeholder="Search tasks..."
                class="input input-bordered join-item w-full"
                aria-label="Search tasks"
                autocomplete="off"
              >
              <button class="btn btn-outline join-item" type="button" id="clearSearchBtn" aria-label="Clear search">
                <i class="bi bi-x-lg" aria-hidden="true"></i>
              </button>
            </div>

            <!-- Preserve filters when searching -->
            {% if request.GET.priority %}
              <input type="hidden" name="priority" value="{{ request.GET.priority }}">
            {% endif %}
            {% if request.GET.status %}
              <input type="hidden" name="status" value="{{ request.GET.status }}">
            {% endif %}
          </form>

          <!-- Quick filters -->
          {% with p=request.GET.priority s=request.GET.status q=request.GET.search %}
          <div class="flex flex-wrap gap-2 filter-buttons">
            <a href="?priority=high{% if q %}&search={{ q }}{% endif %}{% if s %}&status={{ s }}{% endif %}"
               class="btn btn-outline btn-sm gap-1 sm:gap-2 {% if p == 'high' %}btn-active{% endif %}"
               style="{% if p == 'high' %}background-color: #fef2f2; color: #dc2626; border-color: #fecaca;{% endif %}">
              <i class="bi bi-exclamation-circle-fill" aria-hidden="true"></i>
              <span class="hidden sm:inline">High</span>
            </a>

            <a href="?priority=medium{% if q %}&search={{ q }}{% endif %}{% if s %}&status={{ s }}{% endif %}"
               class="btn btn-outline btn-sm gap-1 sm:gap-2 {% if p == 'medium' %}btn-active{% endif %}"
               style="{% if p == 'medium' %}background-color: #fffbeb; color: #d97706; border-color: #fde68a;{% endif %}">
              <i class="bi bi-dash-circle-fill" aria-hidden="true"></i>
              <span class="hidden sm:inline">Medium</span>
            </a>

            <a href="?priority=low{% if q %}&search={{ q }}{% endif %}{% if s %}&status={{ s }}{% endif %}"
               class="btn btn-outline btn-sm gap-1 sm:gap-2 {% if p == 'low' %}btn-active{% endif %}"
               style="{% if p == 'low' %}background-color: #eff6ff; color: #2563eb; border-color: #bfdbfe;{% endif %}">
              <i class="bi bi-arrow-down-circle-fill" aria-hidden="true"></i>
              <span class="hidden sm:inline">Low</span>
            </a>

            <a href="?status=pending{% if q %}&search={{ q }}{% endif %}{% if p %}&priority={{ p }}{% endif %}"
               class="btn btn-outline btn-sm gap-1 sm:gap-2 {% if s == 'pending' %}btn-active{% endif %}">
              <i class="bi bi-circle" aria-hidden="true"></i>
              <span class="hidden sm:inline">Undone</span>
            </a>

            <a href="{% url 'task_list' %}" class="btn btn-ghost btn-sm gap-1 sm:gap-2">
              <i class="bi bi-x-circle" aria-hidden="true"></i>
              <span class="hidden sm:inline">Clear</span>
            </a>
          </div>
          {% endwith %}

        </div>
      </div>
    </section>

    <!-- Task list -->
    <section class="space-y-3" aria-label="Task list" id="taskListSection">
      <!-- No search results message (initially hidden) -->
      <div id="noSearchResults" class="card vm-section bg-base-100 hidden">
        <div class="card-body p-8 sm:p-10 text-center">
          <div class="text-4xl mb-3">üîç</div>
          <h2 class="text-lg font-bold">No matching tasks</h2>
          <p class="text-sm text-base-content/70 mt-1">
            Try a different search term.
          </p>
        </div>
      </div>

      {% if tasks %}
        {% for task in tasks %}
        {% load tz %}
        {% now "Y-m-d" as today_str %}
        <article class="card vm-section bg-base-100 vm-task 
                        {% if task.status == 'completed' %}task-completed{% endif %}
                        {% if task.due_date and task.due_date|date:'Y-m-d' < today_str and task.status != 'completed' %}task-overdue{% endif %}
                        priority-{{ task.priority }}"
                 data-task-id="{{ task.id }}">
          <div class="card-body p-4 sm:p-5">
            <div class="flex items-start gap-3 sm:gap-4">

              <!-- Checkbox -->
              <div class="pt-0.5 flex-shrink-0">
                <input
                  type="checkbox"
                  class="checkbox task-checkbox"
                  {% if task.status == 'completed' %}checked{% endif %}
                  onchange="toggleTaskComplete({{ task.id }}, this.checked)"
                  onclick="event.stopPropagation()"
                  aria-label="{% if task.status == 'completed' %}Mark '{{ task.title }}' as incomplete{% else %}Mark '{{ task.title }}' as complete{% endif %}"
                >
              </div>

              <!-- Content -->
              <div class="flex-1 min-w-0">
                <div class="flex items-start justify-between gap-3">

                  <div class="min-w-0 flex-1">
                    <div class="flex items-start gap-2 flex-wrap">
                      <h3 class="font-semibold text-base sm:text-lg text-base-content {% if task.status == 'completed' %}line-through text-base-content/50{% endif %}">
                        {{ task.title }}
                      </h3>
                      {% if task.due_date and task.due_date|date:'Y-m-d' < today_str and task.status != 'completed' %}
                        <span class="badge badge-sm badge-error gap-1">
                          <i class="bi bi-exclamation-triangle-fill" aria-hidden="true"></i>
                          Overdue
                        </span>
                      {% endif %}
                    </div>

                    {% if task.description %}
                    <p class="text-sm text-base-content/70 mt-1.5 {% if task.status == 'completed' %}text-base-content/50{% endif %}">
                      {{ task.description|truncatewords:20 }}
                    </p>
                    {% endif %}

                    <!-- Meta - moved up for better mobile visibility -->
                    <div class="mt-3 flex flex-wrap items-center gap-2 text-sm">
                      <span class="badge badge-outline badge-priority-{{ task.priority }}">
                        {% if task.priority == 'high' %}
                          <i class="bi bi-exclamation-circle-fill mr-1" aria-hidden="true"></i>High
                        {% elif task.priority == 'medium' %}
                          <i class="bi bi-dash-circle-fill mr-1" aria-hidden="true"></i>Medium
                        {% else %}
                          <i class="bi bi-arrow-down-circle-fill mr-1" aria-hidden="true"></i>Low
                        {% endif %}
                      </span>

                      {% if task.category %}
                        <span class="badge badge-outline badge-sm">
                          <i class="bi bi-tag mr-1" aria-hidden="true"></i>
                          {{ task.category.name }}
                        </span>
                      {% endif %}

                      {% if task.due_date %}
                        <span class="badge badge-ghost badge-sm gap-1 {% if task.due_date|date:'Y-m-d' < today_str and task.status != 'completed' %}text-error{% endif %}">
                          <i class="bi bi-calendar-event" aria-hidden="true"></i>
                          {{ task.due_date|date:"M d" }}
                        </span>
                      {% endif %}

                      {% if task.status == 'completed' and task.completed_at %}
                        <span class="badge badge-success badge-sm gap-1">
                          <i class="bi bi-check2-all" aria-hidden="true"></i>
                          Done
                        </span>
                      {% endif %}
                    </div>
                  </div>

                  <!-- Desktop actions -->
                  <div class="hidden md:flex gap-2 flex-shrink-0" onclick="event.stopPropagation()">
                    <a href="{% url 'task_timer' task.id %}" class="btn btn-success btn-sm gap-2" aria-label="Start Pomodoro timer for {{ task.title }}">
                      <i class="bi bi-alarm" aria-hidden="true"></i>
                      <span class="hidden lg:inline">Timer</span>
                    </a>
                    <a href="{% url 'log_create' %}?task={{ task.id }}" class="btn btn-primary btn-sm gap-2" aria-label="Log time for {{ task.title }}">
                      <i class="bi bi-stopwatch" aria-hidden="true"></i>
                      <span class="hidden lg:inline">Log</span>
                    </a>
                    <a href="{% url 'task_update' task.id %}" class="btn btn-outline btn-sm" aria-label="Edit task">
                      <i class="bi bi-pencil-square" aria-hidden="true"></i>
                    </a>
                    {% if task.title != 'General Activity' %}
                    <a href="{% url 'task_delete' task.id %}" class="btn btn-outline btn-sm text-error" aria-label="Delete task">
                      <i class="bi bi-trash" aria-hidden="true"></i>
                    </a>
                    {% else %}
                    <button class="btn btn-outline btn-sm" disabled title="Cannot delete default task">
                      <i class="bi bi-lock" aria-hidden="true"></i>
                    </button>
                    {% endif %}
                  </div>

                  <!-- Mobile actions -->
                  <div class="md:hidden flex-shrink-0">
                    <button
                      type="button"
                      class="btn btn-ghost btn-sm task-menu-trigger"
                      data-task-id="{{ task.id }}"
                      data-task-title="{{ task.title }}"
                      data-timer-url="{% url 'task_timer' task.id %}"
                      data-log-url="{% url 'log_create' %}?task={{ task.id }}"
                      data-edit-url="{% url 'task_update' task.id %}"
                      {% if task.title != 'General Activity' %}data-delete-url="{% url 'task_delete' task.id %}"{% endif %}
                      aria-label="Task actions"
                    >
                      <i class="bi bi-three-dots-vertical text-lg" aria-hidden="true"></i>
                    </button>
                  </div>

                </div>
              </div>
            </div>
          </div>
        </article>
        {% endfor %}
      {% else %}
        <div class="card vm-section bg-base-100">
          <div class="card-body p-8 sm:p-10 text-center">
            <div class="text-4xl mb-3">üéØ</div>
            <h2 class="text-lg font-bold">No tasks found</h2>
            <p class="text-sm text-base-content/70 mt-1">
              {% if request.GET.search or request.GET.priority or request.GET.status %}
                Try adjusting filters or search terms.
              {% else %}
                Create your first task to get started.
              {% endif %}
            </p>
            <div class="mt-5 flex flex-col sm:flex-row gap-3 justify-center">
              {% if request.GET.search or request.GET.priority or request.GET.status %}
                <a href="{% url 'task_list' %}" class="btn btn-outline btn-sm gap-2">
                  <i class="bi bi-x-circle" aria-hidden="true"></i>
                  Clear filters
                </a>
              {% endif %}
              <a href="{% url 'task_create' %}" class="btn btn-primary btn-sm gap-2">
                <i class="bi bi-plus-square" aria-hidden="true"></i>
                Create task
              </a>
            </div>
          </div>
        </div>
      {% endif %}
    </section>

    <!-- Pagination -->
    {% if page_obj.has_other_pages %}
    <section class="flex justify-center" aria-label="Pagination navigation">
      <div class="join">
        {% if page_obj.has_previous %}
          <a href="?page=1{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.priority %}&priority={{ request.GET.priority }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}" 
             class="join-item btn btn-sm"
             aria-label="First page">
            <i class="bi bi-chevron-bar-left" aria-hidden="true"></i>
          </a>
          <a href="?page={{ page_obj.previous_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.priority %}&priority={{ request.GET.priority }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}" 
             class="join-item btn btn-sm"
             aria-label="Previous page">
            <i class="bi bi-chevron-left" aria-hidden="true"></i>
          </a>
        {% else %}
          <button class="join-item btn btn-sm btn-disabled" disabled aria-label="First page (disabled)">
            <i class="bi bi-chevron-bar-left" aria-hidden="true"></i>
          </button>
          <button class="join-item btn btn-sm btn-disabled" disabled aria-label="Previous page (disabled)">
            <i class="bi bi-chevron-left" aria-hidden="true"></i>
          </button>
        {% endif %}

        <!-- Page numbers -->
        {% for num in page_obj.paginator.page_range %}
          {% if page_obj.number == num %}
            <button class="join-item btn btn-sm btn-active" aria-current="page" aria-label="Page {{ num }}">{{ num }}</button>
          {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
            <a href="?page={{ num }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.priority %}&priority={{ request.GET.priority }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}" 
               class="join-item btn btn-sm"
               aria-label="Page {{ num }}">{{ num }}</a>
          {% elif num == 1 or num == page_obj.paginator.num_pages %}
            <a href="?page={{ num }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.priority %}&priority={{ request.GET.priority }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}" 
               class="join-item btn btn-sm"
               aria-label="Page {{ num }}">{{ num }}</a>
          {% elif num == page_obj.number|add:'-3' or num == page_obj.number|add:'3' %}
            <button class="join-item btn btn-sm btn-disabled" disabled>...</button>
          {% endif %}
        {% endfor %}

        {% if page_obj.has_next %}
          <a href="?page={{ page_obj.next_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.priority %}&priority={{ request.GET.priority }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}" 
             class="join-item btn btn-sm"
             aria-label="Next page">
            <i class="bi bi-chevron-right" aria-hidden="true"></i>
          </a>
          <a href="?page={{ page_obj.paginator.num_pages }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.priority %}&priority={{ request.GET.priority }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}" 
             class="join-item btn btn-sm"
             aria-label="Last page">
            <i class="bi bi-chevron-bar-right" aria-hidden="true"></i>
          </a>
        {% else %}
          <button class="join-item btn btn-sm btn-disabled" disabled aria-label="Next page (disabled)">
            <i class="bi bi-chevron-right" aria-hidden="true"></i>
          </button>
          <button class="join-item btn btn-sm btn-disabled" disabled aria-label="Last page (disabled)">
            <i class="bi bi-chevron-bar-right" aria-hidden="true"></i>
          </button>
        {% endif %}
      </div>
    </section>

    <!-- Pagination info -->
    <div class="text-center text-sm text-base-content/70 mt-3">
      Showing {{ page_obj.start_index }} to {{ page_obj.end_index }} of {{ total_tasks }} task{{ total_tasks|pluralize }}
    </div>
    {% endif %}

  </div>
</main>

<!-- iOS-style bottom sheet for mobile task actions -->
<div class="task-action-sheet-backdrop" id="taskActionBackdrop"></div>
<div class="task-action-sheet" id="taskActionSheet">
  <div class="task-action-sheet-handle"></div>
  <div class="task-action-sheet-title" id="taskActionTitle">Task Actions</div>
  <div class="task-action-sheet-actions" id="taskActionButtons">
    <!-- Buttons will be dynamically inserted here -->
  </div>
  <button class="task-action-sheet-cancel" id="taskActionCancel">Cancel</button>
</div>

<script>
  function getCSRFToken() {
    // Try meta tag first (works on production with HTTPS)
    const metaTag = document.querySelector('meta[name="csrf-token"]');
    if (metaTag && metaTag.content) return metaTag.content;
    
    // Fallback to cookie
    const name = 'csrftoken=';
    const parts = document.cookie.split(';').map(s => s.trim());
    for (const p of parts) {
      if (p.startsWith(name)) return decodeURIComponent(p.substring(name.length));
    }
    
    // Last resort
    return '{{ csrf_token }}';
  }

  function toggleTaskComplete(taskId, isChecked) {
    const csrfToken = getCSRFToken();
    const checkbox = document.querySelector(`input[onchange*="${taskId}"]`);
    const taskCard = document.querySelector(`article[data-task-id="${taskId}"]`);
    
    // Optimistic UI update
    if (taskCard) {
      if (isChecked) {
        taskCard.classList.add('task-completed');
      } else {
        taskCard.classList.remove('task-completed');
      }
    }
    
    fetch(`/tasks/${taskId}/complete/`, {
      method: 'POST',
      headers: { 
        'X-CSRFToken': csrfToken,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ completed: isChecked })
    })
    .then(function (r) {
      if (!r.ok) {
        // Revert optimistic update on error
        if (checkbox) checkbox.checked = !isChecked;
        if (taskCard) {
          if (isChecked) {
            taskCard.classList.remove('task-completed');
          } else {
            taskCard.classList.add('task-completed');
          }
        }
        return r.text().then(text => {
          throw new Error(`HTTP ${r.status}: ${text.substring(0, 200)}`);
        });
      }
      // Reload to get fresh data after a brief delay for visual feedback
      setTimeout(() => window.location.reload(), 300);
    })
    .catch(function (err) {
      console.error('Task completion error:', err);
      alert('Error updating task: ' + (err.message || 'Unknown error. Check browser console.'));
    });
  }

  // iOS-style bottom sheet for mobile task actions
  (function () {
    const backdrop = document.getElementById('taskActionBackdrop');
    const sheet = document.getElementById('taskActionSheet');
    const title = document.getElementById('taskActionTitle');
    const buttonsContainer = document.getElementById('taskActionButtons');
    const cancelBtn = document.getElementById('taskActionCancel');

    if (!backdrop || !sheet) {
      console.error('Bottom sheet elements not found');
      return;
    }

    const closeSheet = () => {
      sheet.classList.remove('active');
      backdrop.classList.remove('active');
      document.body.style.overflow = '';
    };

    const openSheet = (button) => {
      const taskTitle = button.dataset.taskTitle;
      const timerUrl = button.dataset.timerUrl;
      const logUrl = button.dataset.logUrl;
      const editUrl = button.dataset.editUrl;
      const deleteUrl = button.dataset.deleteUrl;

      console.log('Opening sheet for task:', taskTitle);

      // Set title
      title.textContent = taskTitle || 'Task Actions';

      // Build action buttons
      let buttonsHTML = '';
      
      if (timerUrl) {
        buttonsHTML += `
          <a href="${timerUrl}" class="task-action-sheet-btn text-success">
            <i class="bi bi-alarm" aria-hidden="true"></i>
            <span>Pomodoro Timer</span>
          </a>
        `;
      }
      
      if (logUrl) {
        buttonsHTML += `
          <a href="${logUrl}" class="task-action-sheet-btn text-primary">
            <i class="bi bi-stopwatch" aria-hidden="true"></i>
            <span>Log Time</span>
          </a>
        `;
      }
      
      if (editUrl) {
        buttonsHTML += `
          <a href="${editUrl}" class="task-action-sheet-btn">
            <i class="bi bi-pencil-square" aria-hidden="true"></i>
            <span>Edit Task</span>
          </a>
        `;
      }
      
      if (deleteUrl) {
        buttonsHTML += `
          <a href="${deleteUrl}" class="task-action-sheet-btn text-error">
            <i class="bi bi-trash" aria-hidden="true"></i>
            <span>Delete Task</span>
          </a>
        `;
      } else {
        buttonsHTML += `
          <button class="task-action-sheet-btn disabled" disabled>
            <i class="bi bi-lock" aria-hidden="true"></i>
            <span>Default Task (Cannot Delete)</span>
          </button>
        `;
      }

      buttonsContainer.innerHTML = buttonsHTML;

      // Show sheet
      document.body.style.overflow = 'hidden';
      backdrop.classList.add('active');
      sheet.classList.add('active');
    };

    // Open sheet when clicking trigger buttons - handle both touch and click
    const handleTrigger = (e) => {
      const trigger = e.target.closest('.task-menu-trigger');
      if (trigger) {
        console.log('Trigger clicked:', trigger);
        e.preventDefault();
        e.stopPropagation();
        e.stopImmediatePropagation();
        openSheet(trigger);
      }
    };

    document.addEventListener('click', handleTrigger, true);
    document.addEventListener('touchend', handleTrigger, true);

    // Close on backdrop click/touch
    backdrop.addEventListener('click', closeSheet);
    backdrop.addEventListener('touchend', closeSheet);

    // Close on cancel button
    cancelBtn.addEventListener('click', closeSheet);
    cancelBtn.addEventListener('touchend', closeSheet);

    // Close on escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && sheet.classList.contains('active')) {
        closeSheet();
      }
    });

    // Swipe down to close
    let touchStartY = 0;
    let touchCurrentY = 0;
    
    sheet.addEventListener('touchstart', (e) => {
      touchStartY = e.touches[0].clientY;
    }, { passive: true });
    
    sheet.addEventListener('touchmove', (e) => {
      touchCurrentY = e.touches[0].clientY;
      const diff = touchCurrentY - touchStartY;
      
      // Only allow downward swipes
      if (diff > 0) {
        sheet.style.transform = `translateY(${diff}px)`;
      }
    }, { passive: true });
    
    sheet.addEventListener('touchend', () => {
      const diff = touchCurrentY - touchStartY;
      
      // If swiped down more than 100px, close
      if (diff > 100) {
        closeSheet();
      }
      
      // Reset transform
      sheet.style.transform = '';
      touchStartY = 0;
      touchCurrentY = 0;
    }, { passive: true });

    console.log('Bottom sheet initialized');
  })();

  // Instant search functionality
  (function () {
    const searchInput = document.getElementById('taskSearchInput');
    const clearBtn = document.getElementById('clearSearchBtn');
    const resultsCount = document.getElementById('searchResultsCount');
    const noResultsMsg = document.getElementById('noSearchResults');
    const taskCards = Array.from(document.querySelectorAll('.vm-task'));
    const emptyState = document.querySelector('.card.vm-section .card-body > .text-4xl')?.closest('.card.vm-section');
    const paginationSection = document.querySelector('section[aria-label="Pagination navigation"]');
    const paginationInfo = document.querySelector('.text-center.text-sm.text-base-content\\/70');

    if (!searchInput || taskCards.length === 0) return;

    function performSearch() {
      const query = searchInput.value.trim().toLowerCase();
      let visibleCount = 0;

      if (!query) {
        // Show all tasks
        taskCards.forEach(card => {
          card.style.display = '';
        });
        if (resultsCount) resultsCount.classList.add('hidden');
        if (noResultsMsg) noResultsMsg.classList.add('hidden');
        if (emptyState) emptyState.style.display = '';
        if (paginationSection) paginationSection.style.display = '';
        if (paginationInfo) paginationInfo.style.display = '';
        return;
      }

      // Hide the original empty state and pagination when searching
      if (emptyState) emptyState.style.display = 'none';
      if (paginationSection) paginationSection.style.display = 'none';
      if (paginationInfo) paginationInfo.style.display = 'none';

      // Filter tasks
      taskCards.forEach(card => {
        const title = card.querySelector('h3')?.textContent?.toLowerCase() || '';
        const description = card.querySelector('p.text-sm')?.textContent?.toLowerCase() || '';
        const category = card.querySelector('.bi-tag')?.parentElement?.textContent?.toLowerCase() || '';
        const priority = card.querySelector('.badge-priority-high, .badge-priority-medium, .badge-priority-low')?.textContent?.toLowerCase() || '';

        const searchableText = `${title} ${description} ${category} ${priority}`;
        const matches = searchableText.includes(query);

        if (matches) {
          card.style.display = '';
          visibleCount++;
        } else {
          card.style.display = 'none';
        }
      });

      // Update UI
      if (visibleCount === 0) {
        if (noResultsMsg) noResultsMsg.classList.remove('hidden');
        if (resultsCount) {
          resultsCount.textContent = '0 results';
          resultsCount.classList.remove('hidden');
        }
      } else {
        if (noResultsMsg) noResultsMsg.classList.add('hidden');
        if (resultsCount) {
          resultsCount.textContent = `${visibleCount} result${visibleCount !== 1 ? 's' : ''} (on this page)`;
          resultsCount.classList.remove('hidden');
        }
      }
    }

    // Debounce function for better performance
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // Instant search with slight debounce
    const debouncedSearch = debounce(performSearch, 150);
    searchInput.addEventListener('input', debouncedSearch);

    // Clear button
    if (clearBtn) {
      clearBtn.addEventListener('click', () => {
        searchInput.value = '';
        performSearch();
        searchInput.focus();
      });
    }

    // Perform initial search if there's a query parameter
    if (searchInput.value.trim()) {
      performSearch();
    }
  })();

  // Click to edit task - Use event delegation
  (function () {
    // Single delegated click handler instead of N listeners
    document.addEventListener('click', (e) => {
      const card = e.target.closest('.vm-task');
      if (!card) return;
      
      // Don't navigate if clicking on interactive elements
      const isInteractive = e.target.closest('input, button, a, .task-menu-trigger, .task-checkbox');
      if (isInteractive) return;
      
      // Get task ID and navigate to edit page
      const taskId = card.dataset.taskId;
      if (taskId) {
        window.location.href = `/tasks/${taskId}/edit/`;
      }
    });
    
    // Visual feedback on touch/press using event delegation
    let touchedCard = null;
    let touchStartX = 0;
    let touchStartY = 0;
    
    document.addEventListener('touchstart', (e) => {
      // Don't apply touch feedback if touching interactive elements
      if (e.target.closest('input, button, a, .task-menu-trigger, .task-checkbox')) {
        return;
      }
      
      const card = e.target.closest('.vm-task');
      if (card) {
        touchedCard = card;
        touchStartX = e.touches[0].clientX;
        touchStartY = e.touches[0].clientY;
        card.style.opacity = '0.7';
      }
    }, { passive: true });
    
    document.addEventListener('touchend', (e) => {
      if (touchedCard) {
        touchedCard.style.opacity = '';
        touchedCard = null;
      }
    }, { passive: true });
    
    document.addEventListener('touchmove', (e) => {
      // Cancel touch feedback if user is scrolling
      if (touchedCard) {
        const moveX = e.touches[0].clientX;
        const moveY = e.touches[0].clientY;
        const distanceX = Math.abs(moveX - touchStartX);
        const distanceY = Math.abs(moveY - touchStartY);
        
        // If moved more than 10px, cancel the touch feedback
        if (distanceX > 10 || distanceY > 10) {
          touchedCard.style.opacity = '';
          touchedCard = null;
        }
      }
    }, { passive: true });
    
    document.addEventListener('touchcancel', () => {
      if (touchedCard) {
        touchedCard.style.opacity = '';
        touchedCard = null;
      }
    }, { passive: true });
  })();
</script>

{% endblock %}
