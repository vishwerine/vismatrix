{% extends 'tracker/base.html' %}
{% load math_filters %}

{% block title %}Tasks - VisMatrix.Space{% endblock %}

{% block content %}
<main class="py-8 sm:py-10">
  <div class="max-w-6xl mx-auto px-4 sm:px-6 space-y-6">

    <!-- Header -->
    <header class="card border border-base-200 bg-base-100" role="banner">
      <div class="card-body p-5 sm:p-6">
        <div class="flex items-start justify-between gap-4">
          <div class="min-w-0">
            <h1 class="text-2xl sm:text-3xl font-extrabold text-base-content flex items-center gap-2 truncate">
              <i class="bi bi-list-check text-primary" aria-hidden="true"></i>
              <span>Tasks</span>
            </h1>
            <p class="text-sm text-base-content/70 mt-1">
              Manage and track your tasks
              {% if tasks %}
                <span class="ml-2 text-xs text-base-content/60">({{ tasks|length }} total)</span>
              {% endif %}
            </p>
          </div>

          <a href="{% url 'task_create' %}" class="btn btn-primary btn-sm gap-2" aria-label="Create a new task">
            <i class="bi bi-plus-square" aria-hidden="true"></i>
            <span>New task</span>
          </a>
        </div>
      </div>
    </header>

    <!-- Filters -->
    <section class="card border border-base-200 bg-base-100" aria-label="Task filters">
      <div class="card-body p-5 sm:p-6">
        <div class="flex flex-col lg:flex-row gap-3 lg:items-end lg:justify-between">
          <!-- Search -->
          <form method="get" class="w-full lg:max-w-md">
            <label class="label font-semibold">
              <span class="label-text flex items-center gap-2">
                <i class="bi bi-search text-primary" aria-hidden="true"></i>
                Search
              </span>
            </label>
            <div class="join w-full">
              <input
                type="text"
                name="search"
                value="{{ request.GET.search|default:'' }}"
                placeholder="Search tasks..."
                class="input input-bordered join-item w-full"
                aria-label="Search tasks"
              >
              <button class="btn btn-outline join-item" type="submit" aria-label="Apply search">
                <i class="bi bi-arrow-right" aria-hidden="true"></i>
              </button>
            </div>

            {# Preserve filters when searching (optional) #}
            {% if request.GET.priority %}
              <input type="hidden" name="priority" value="{{ request.GET.priority }}">
            {% endif %}
            {% if request.GET.status %}
              <input type="hidden" name="status" value="{{ request.GET.status }}">
            {% endif %}
          </form>

          <!-- Quick filters -->
          {% with p=request.GET.priority s=request.GET.status q=request.GET.search %}
          <div class="flex flex-wrap gap-2">
            <a href="?priority=high{% if q %}&search={{ q }}{% endif %}{% if s %}&status={{ s }}{% endif %}"
               class="btn btn-outline btn-sm gap-2 {% if p == 'high' %}btn-active{% endif %}">
              <i class="bi bi-arrow-up-circle" aria-hidden="true"></i>
              <span>High</span>
            </a>

            <a href="?priority=medium{% if q %}&search={{ q }}{% endif %}{% if s %}&status={{ s }}{% endif %}"
               class="btn btn-outline btn-sm gap-2 {% if p == 'medium' %}btn-active{% endif %}">
              <i class="bi bi-arrow-right-circle" aria-hidden="true"></i>
              <span>Medium</span>
            </a>

            <a href="?status=completed{% if q %}&search={{ q }}{% endif %}{% if p %}&priority={{ p }}{% endif %}"
               class="btn btn-outline btn-sm gap-2 {% if s == 'completed' %}btn-active{% endif %}">
              <i class="bi bi-check-circle" aria-hidden="true"></i>
              <span>Completed</span>
            </a>

            <a href="{% url 'task_list' %}" class="btn btn-ghost btn-sm gap-2">
              <i class="bi bi-x-circle" aria-hidden="true"></i>
              <span>Clear</span>
            </a>
          </div>
          {% endwith %}
        </div>
      </div>
    </section>

    <!-- Task list -->
    <section class="space-y-3" aria-label="Task list">
      {% if tasks %}
        {% for task in tasks %}
        <article class="card border border-base-200 bg-base-100">
          <div class="card-body p-4 sm:p-5">
            <div class="flex items-start gap-3">

              <!-- Checkbox -->
              <div class="pt-1">
                <input
                  type="checkbox"
                  class="checkbox checkbox-sm"
                  {% if task.status == 'completed' %}checked disabled{% endif %}
                  onchange="completeTask({{ task.id }})"
                  aria-label="Mark '{{ task.title }}' as complete"
                >
              </div>

              <!-- Content -->
              <div class="flex-1 min-w-0">
                <div class="flex items-start justify-between gap-3">
                  <div class="min-w-0">
                    <h3 class="font-semibold text-base-content truncate {% if task.status == 'completed' %}line-through text-base-content/50{% endif %}">
                      {{ task.title }}
                    </h3>

                    {% if task.description %}
                    <p class="text-sm text-base-content/70 mt-1 line-clamp-2 {% if task.status == 'completed' %}text-base-content/50{% endif %}">
                      {{ task.description }}
                    </p>
                    {% endif %}
                  </div>

                  <!-- Desktop actions -->
                  <div class="hidden md:flex gap-2 flex-shrink-0">
                    <a href="{% url 'task_update' task.id %}" class="btn btn-outline btn-sm" aria-label="Edit task">
                      <i class="bi bi-pencil-square" aria-hidden="true"></i>
                    </a>
                    <a href="{% url 'log_create' %}?task={{ task.id }}" class="btn btn-outline btn-sm" aria-label="Log time">
                      <i class="bi bi-stopwatch" aria-hidden="true"></i>
                    </a>
                    <a href="{% url 'task_delete' task.id %}" class="btn btn-outline btn-sm text-error" aria-label="Delete task">
                      <i class="bi bi-trash" aria-hidden="true"></i>
                    </a>
                  </div>

                  <!-- Mobile actions -->
                  <div class="dropdown dropdown-end md:hidden flex-shrink-0">
                    <button tabindex="0" class="btn btn-ghost btn-sm" aria-label="Task actions">
                      <i class="bi bi-three-dots-vertical" aria-hidden="true"></i>
                    </button>
                    <ul tabindex="0" class="dropdown-content menu bg-base-100 rounded-box z-50 shadow-lg border border-base-200 w-44">
                      <li>
                        <a href="{% url 'task_update' task.id %}">
                          <i class="bi bi-pencil-square" aria-hidden="true"></i>
                          Edit
                        </a>
                      </li>
                      <li>
                        <a href="{% url 'log_create' %}?task={{ task.id }}">
                          <i class="bi bi-stopwatch" aria-hidden="true"></i>
                          Log time
                        </a>
                      </li>
                      <li>
                        <a href="{% url 'task_delete' task.id %}" class="text-error">
                          <i class="bi bi-trash" aria-hidden="true"></i>
                          Delete
                        </a>
                      </li>
                    </ul>
                  </div>
                </div>

                <!-- Meta -->
                <div class="mt-3 flex flex-wrap items-center gap-2 text-sm">
                  {% if task.category %}
                    <span class="badge badge-outline">
                      <i class="bi bi-tag mr-1" aria-hidden="true"></i>
                      {{ task.category.name }}
                    </span>
                  {% endif %}

                  <span class="badge badge-ghost">
                    {% if task.priority == 'high' %}High{% elif task.priority == 'medium' %}Medium{% else %}Low{% endif %}
                  </span>

                  {% if task.due_date %}
                    <span class="text-base-content/70 flex items-center gap-1">
                      <i class="bi bi-calendar-event" aria-hidden="true"></i>
                      Due {{ task.due_date|date:"M d" }}
                    </span>
                  {% endif %}

                  {% if task.status == 'completed' %}
                    <span class="text-base-content/60 flex items-center gap-1">
                      <i class="bi bi-check2-all" aria-hidden="true"></i>
                      Completed
                    </span>
                  {% endif %}
                </div>

              </div>
            </div>
          </div>
        </article>
        {% endfor %}
      {% else %}
        <div class="card border border-base-200 bg-base-100">
          <div class="card-body p-8 sm:p-10 text-center">
            <div class="text-4xl mb-3">ðŸŽ¯</div>
            <h2 class="text-lg font-bold">No tasks found</h2>
            <p class="text-sm text-base-content/70 mt-1">
              {% if request.GET.search or request.GET.priority or request.GET.status %}
                Try adjusting filters or search terms.
              {% else %}
                Create your first task to get started.
              {% endif %}
            </p>
            <div class="mt-5 flex flex-col sm:flex-row gap-3 justify-center">
              {% if request.GET.search or request.GET.priority or request.GET.status %}
                <a href="{% url 'task_list' %}" class="btn btn-outline btn-sm gap-2">
                  <i class="bi bi-x-circle" aria-hidden="true"></i>
                  Clear filters
                </a>
              {% endif %}
              <a href="{% url 'task_create' %}" class="btn btn-primary btn-sm gap-2">
                <i class="bi bi-plus-square" aria-hidden="true"></i>
                Create task
              </a>
            </div>
          </div>
        </div>
      {% endif %}
    </section>

  </div>
</main>

<script>
  function completeTask(taskId) {
    fetch(`/tasks/${taskId}/complete/`, {
      method: 'POST',
      headers: { 'X-CSRFToken': '{{ csrf_token }}' }
    })
    .then(function (r) {
      if (!r.ok) throw new Error('Request failed');
      window.location.reload();
    })
    .catch(function () {
      alert('Error completing task. Please try again.');
    });
  }
</script>
{% endblock %}
