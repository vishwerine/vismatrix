{% extends 'tracker/base.html' %}
{% load math_filters %}

{% block title %}Tasks - VisMatrix.Space{% endblock %}

{% block content %}

<style>
  /* Page-specific polish (kept minimal; aligns with your base tokens) */
  .vm-section { border: 1px solid rgb(226 232 240 / 0.85); }
  .vm-task { transition: 160ms ease; }
  .vm-task:hover { box-shadow: 0 10px 18px rgb(15 23 42 / 0.06); transform: translateY(-1px); }
  .vm-chip { background: rgb(15 23 42 / 0.04); border: 1px solid rgb(226 232 240 / 0.9); }
  .vm-muted { color: rgb(15 23 42 / 0.65); }

  /* Opaque dropdown for task menu */
  .vm-dropdown-opaque {
    background-color: #ffffff !important;
    opacity: 1 !important;
    backdrop-filter: none !important;
    -webkit-backdrop-filter: none !important;
  }

  /* Let dropdown escape the card (prevents clipping) */
  .vm-task,
  .vm-task .card-body {
    overflow: visible !important;
  }

  /* Ensure dropdown stacks above cards/navs */
  .task-menu { position: relative; z-index: 1; }
  .task-menu .dropdown-content {
    position: absolute;
    z-index: 100000 !important;
  }

  /* When a task menu is open, raise the entire card above others */
  .vm-task.vm-open {
    position: relative;
    z-index: 100000 !important;
  }

  /* Disable hover transform while open (transform creates a stacking context) */
  .vm-task.vm-open:hover {
    transform: none !important;
  }
</style>

<main class="py-8 sm:py-10">
  <div class="max-w-6xl mx-auto px-4 sm:px-6 space-y-6">

    <!-- Header -->
    <header class="card vm-section bg-base-100" role="banner">
      <div class="card-body p-5 sm:p-6">
        <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-4">
          <div class="min-w-0">
            <h1 class="text-2xl sm:text-3xl font-extrabold text-base-content flex items-center gap-2 truncate">
              <i class="bi bi-list-check text-primary" aria-hidden="true"></i>
              <span>Tasks</span>
              {% if tasks %}
                <span class="badge vm-chip text-xs font-bold ml-2">
                  {{ tasks|length }} total
                </span>
              {% endif %}
            </h1>
            <p class="text-sm vm-muted mt-1">
              Manage and track your tasks. Stay consistent â€” small wins compound.
            </p>
          </div>

          <div class="flex items-center gap-2">
            <a href="{% url 'task_create' %}" class="btn btn-primary btn-sm gap-2" aria-label="Create a new task">
              <i class="bi bi-plus-square" aria-hidden="true"></i>
              <span>New task</span>
            </a>
          </div>
        </div>
      </div>
    </header>

    <!-- Filters -->
    <section class="card vm-section bg-base-100" aria-label="Task filters">
      <div class="card-body p-5 sm:p-6">
        <div class="flex flex-col lg:flex-row gap-4 lg:items-end lg:justify-between">

          <!-- Search -->
          <form method="get" class="w-full lg:max-w-md">
            <label class="label font-semibold">
              <span class="label-text flex items-center gap-2">
                <i class="bi bi-search text-primary" aria-hidden="true"></i>
                Search
              </span>
            </label>

            <div class="join w-full">
              <input
                type="text"
                name="search"
                value="{{ request.GET.search|default:'' }}"
                placeholder="Search tasks..."
                class="input input-bordered join-item w-full"
                aria-label="Search tasks"
              >
              <button class="btn btn-outline join-item" type="submit" aria-label="Apply search">
                <i class="bi bi-arrow-right" aria-hidden="true"></i>
              </button>
            </div>

            <!-- Preserve filters when searching -->
            {% if request.GET.priority %}
              <input type="hidden" name="priority" value="{{ request.GET.priority }}">
            {% endif %}
            {% if request.GET.status %}
              <input type="hidden" name="status" value="{{ request.GET.status }}">
            {% endif %}
          </form>

          <!-- Quick filters -->
          {% with p=request.GET.priority s=request.GET.status q=request.GET.search %}
          <div class="flex flex-wrap gap-2">
            <a href="?priority=high{% if q %}&search={{ q }}{% endif %}{% if s %}&status={{ s }}{% endif %}"
               class="btn btn-outline btn-sm gap-2 {% if p == 'high' %}btn-active{% endif %}">
              <i class="bi bi-arrow-up-circle" aria-hidden="true"></i>
              <span>High</span>
            </a>

            <a href="?priority=medium{% if q %}&search={{ q }}{% endif %}{% if s %}&status={{ s }}{% endif %}"
               class="btn btn-outline btn-sm gap-2 {% if p == 'medium' %}btn-active{% endif %}">
              <i class="bi bi-arrow-right-circle" aria-hidden="true"></i>
              <span>Medium</span>
            </a>

            <a href="?status=completed{% if q %}&search={{ q }}{% endif %}{% if p %}&priority={{ p }}{% endif %}"
               class="btn btn-outline btn-sm gap-2 {% if s == 'completed' %}btn-active{% endif %}">
              <i class="bi bi-check-circle" aria-hidden="true"></i>
              <span>Completed</span>
            </a>

            <a href="{% url 'task_list' %}" class="btn btn-ghost btn-sm gap-2">
              <i class="bi bi-x-circle" aria-hidden="true"></i>
              <span>Clear</span>
            </a>
          </div>
          {% endwith %}

        </div>
      </div>
    </section>

    <!-- Task list -->
    <section class="space-y-3" aria-label="Task list">
      {% if tasks %}
        {% for task in tasks %}
        <article class="card vm-section bg-base-100 vm-task">
          <div class="card-body p-4 sm:p-5">
            <div class="flex items-start gap-3">

              <!-- Checkbox -->
              <div class="pt-1">
                <input
                  type="checkbox"
                  class="checkbox checkbox-sm"
                  {% if task.status == 'completed' %}checked disabled{% endif %}
                  onchange="completeTask({{ task.id }})"
                  aria-label="Mark '{{ task.title }}' as complete"
                >
              </div>

              <!-- Content -->
              <div class="flex-1 min-w-0">
                <div class="flex items-start justify-between gap-3">

                  <div class="min-w-0">
                    <h3 class="font-semibold text-base-content truncate {% if task.status == 'completed' %}line-through text-base-content/50{% endif %}">
                      {{ task.title }}
                    </h3>

                    {% if task.description %}
                    <p class="text-sm text-base-content/70 mt-1 line-clamp-2 {% if task.status == 'completed' %}text-base-content/50{% endif %}">
                      {{ task.description }}
                    </p>
                    {% endif %}
                  </div>

                  <!-- Desktop actions -->
                  <div class="hidden md:flex gap-2 flex-shrink-0">
                    <a href="{% url 'task_update' task.id %}" class="btn btn-outline btn-sm" aria-label="Edit task">
                      <i class="bi bi-pencil-square" aria-hidden="true"></i>
                    </a>
                    <a href="{% url 'log_create' %}?task={{ task.id }}" class="btn btn-outline btn-sm" aria-label="Log time">
                      <i class="bi bi-stopwatch" aria-hidden="true"></i>
                    </a>
                    <a href="{% url 'task_delete' task.id %}" class="btn btn-outline btn-sm text-error" aria-label="Delete task">
                      <i class="bi bi-trash" aria-hidden="true"></i>
                    </a>
                  </div>

                  <!-- Mobile actions -->
                  <div class="dropdown dropdown-end md:hidden flex-shrink-0 task-menu" id="taskMenu-{{ task.id }}">
                    <button
                      id="taskMenuBtn-{{ task.id }}"
                      type="button"
                      class="btn btn-ghost btn-sm"
                      aria-label="Task actions"
                      aria-haspopup="true"
                      aria-expanded="false"
                    >
                      <i class="bi bi-three-dots-vertical" aria-hidden="true"></i>
                    </button>

                    <ul
                      id="taskMenuDd-{{ task.id }}"
                      class="dropdown-content menu vm-dropdown-opaque rounded-box shadow-lg border border-base-200 w-44 hidden"
                      style="z-index: 100000;"
                      role="menu"
                    >
                      <li>
                        <a href="{% url 'task_update' task.id %}">
                          <i class="bi bi-pencil-square" aria-hidden="true"></i>
                          Edit
                        </a>
                      </li>
                      <li>
                        <a href="{% url 'log_create' %}?task={{ task.id }}">
                          <i class="bi bi-stopwatch" aria-hidden="true"></i>
                          Log time
                        </a>
                      </li>
                      <li>
                        <a href="{% url 'task_delete' task.id %}" class="text-error">
                          <i class="bi bi-trash" aria-hidden="true"></i>
                          Delete
                        </a>
                      </li>
                    </ul>
                  </div>

                </div>

                <!-- Meta -->
                <div class="mt-3 flex flex-wrap items-center gap-2 text-sm">
                  {% if task.category %}
                    <span class="badge badge-outline">
                      <i class="bi bi-tag mr-1" aria-hidden="true"></i>
                      {{ task.category.name }}
                    </span>
                  {% endif %}

                  <span class="badge badge-ghost">
                    {% if task.priority == 'high' %}High{% elif task.priority == 'medium' %}Medium{% else %}Low{% endif %}
                  </span>

                  {% if task.due_date %}
                    <span class="text-base-content/70 flex items-center gap-1">
                      <i class="bi bi-calendar-event" aria-hidden="true"></i>
                      Due {{ task.due_date|date:"M d" }}
                    </span>
                  {% endif %}

                  {% if task.status == 'completed' %}
                    <span class="text-base-content/60 flex items-center gap-1">
                      <i class="bi bi-check2-all" aria-hidden="true"></i>
                      Completed
                    </span>
                  {% endif %}
                </div>

              </div>
            </div>
          </div>
        </article>
        {% endfor %}
      {% else %}
        <div class="card vm-section bg-base-100">
          <div class="card-body p-8 sm:p-10 text-center">
            <div class="text-4xl mb-3">ðŸŽ¯</div>
            <h2 class="text-lg font-bold">No tasks found</h2>
            <p class="text-sm text-base-content/70 mt-1">
              {% if request.GET.search or request.GET.priority or request.GET.status %}
                Try adjusting filters or search terms.
              {% else %}
                Create your first task to get started.
              {% endif %}
            </p>
            <div class="mt-5 flex flex-col sm:flex-row gap-3 justify-center">
              {% if request.GET.search or request.GET.priority or request.GET.status %}
                <a href="{% url 'task_list' %}" class="btn btn-outline btn-sm gap-2">
                  <i class="bi bi-x-circle" aria-hidden="true"></i>
                  Clear filters
                </a>
              {% endif %}
              <a href="{% url 'task_create' %}" class="btn btn-primary btn-sm gap-2">
                <i class="bi bi-plus-square" aria-hidden="true"></i>
                Create task
              </a>
            </div>
          </div>
        </div>
      {% endif %}
    </section>

  </div>
</main>

<script>
  function getCSRFToken() {
    // Try meta tag first (works on production with HTTPS)
    const metaTag = document.querySelector('meta[name="csrf-token"]');
    if (metaTag && metaTag.content) return metaTag.content;
    
    // Fallback to cookie
    const name = 'csrftoken=';
    const parts = document.cookie.split(';').map(s => s.trim());
    for (const p of parts) {
      if (p.startsWith(name)) return decodeURIComponent(p.substring(name.length));
    }
    
    // Last resort
    return '{{ csrf_token }}';
  }

  function completeTask(taskId) {
    const csrfToken = getCSRFToken();
    console.log('Completing task', taskId, '| CSRF Token present:', !!csrfToken);
    
    fetch(`/tasks/${taskId}/complete/`, {
      method: 'POST',
      headers: { 'X-CSRFToken': csrfToken }
    })
    .then(function (r) {
      console.log('Response status:', r.status);
      if (!r.ok) {
        return r.text().then(text => {
          throw new Error(`HTTP ${r.status}: ${text.substring(0, 200)}`);
        });
      }
      window.location.reload();
    })
    .catch(function (err) {
      console.error('Task completion error:', err);
      alert('Error completing task: ' + (err.message || 'Unknown error. Check browser console.'));
    });
  }

  // Mobile task menu: toggle, close on outside click / Esc, only one open at a time
  (function () {
    const menus = Array.from(document.querySelectorAll('.task-menu'));
    if (!menus.length) return;

    const closeAll = () => {
      menus.forEach((menu) => {
        const btn = menu.querySelector('button[id^="taskMenuBtn-"]');
        const dd  = menu.querySelector('ul[id^="taskMenuDd-"]');
        if (!btn || !dd) return;

        dd.classList.add('hidden');
        btn.setAttribute('aria-expanded', 'false');

        const card = menu.closest('.vm-task');
        if (card) card.classList.remove('vm-open');
      });
    };

    const toggleOne = (menu) => {
      const btn = menu.querySelector('button[id^="taskMenuBtn-"]');
      const dd  = menu.querySelector('ul[id^="taskMenuDd-"]');
      if (!btn || !dd) return;

      const isHidden = dd.classList.contains('hidden');
      closeAll();

      if (isHidden) {
        dd.classList.remove('hidden');
        btn.setAttribute('aria-expanded', 'true');

        const card = menu.closest('.vm-task');
        if (card) card.classList.add('vm-open');
      }
    };

    menus.forEach((menu) => {
      const btn = menu.querySelector('button[id^="taskMenuBtn-"]');
      if (!btn) return;

      btn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        toggleOne(menu);
      });

      // Close when clicking a menu action (better UX on mobile)
      const dd = menu.querySelector('ul[id^="taskMenuDd-"]');
      if (dd) {
        dd.addEventListener('click', () => closeAll());
      }
    });

    document.addEventListener('click', (e) => {
      const clickedInsideAny = menus.some((menu) => menu.contains(e.target));
      if (!clickedInsideAny) closeAll();
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeAll();
    });

    // Also close on scroll (prevents floating menus while scrolling list)
    document.addEventListener('scroll', closeAll, { passive: true });
  })();
</script>

{% endblock %}
