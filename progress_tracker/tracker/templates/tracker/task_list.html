{% extends 'tracker/base.html' %}
{% load math_filters %}

{% block title %}Tasks - VisMatrix.Space{% endblock %}

{% block content %}

<style>
  /* Page-specific polish (kept minimal; aligns with your base tokens) */
  .vm-section { border: 1px solid rgb(226 232 240 / 0.85); }
  .vm-task { 
    transition: all 200ms cubic-bezier(0.4, 0, 0.2, 1);
    cursor: pointer;
    user-select: none;
    -webkit-user-select: none;
  }
  .vm-task:hover { 
    box-shadow: 0 12px 24px rgb(15 23 42 / 0.08), 0 4px 8px rgb(15 23 42 / 0.04); 
    transform: translateY(-2px); 
  }
  .vm-task:active {
    transform: translateY(0);
    box-shadow: 0 4px 12px rgb(15 23 42 / 0.06);
  }
  .vm-chip { background: rgb(15 23 42 / 0.04); border: 1px solid rgb(226 232 240 / 0.9); }
  .vm-muted { color: rgb(15 23 42 / 0.65); }

  /* Priority color coding */
  .priority-high { 
    border-left: 4px solid #ef4444 !important; 
  }
  .priority-medium { 
    border-left: 4px solid #f59e0b !important; 
  }
  .priority-low { 
    border-left: 4px solid #3b82f6 !important; 
  }

  /* Priority badges with colors */
  .badge-priority-high { 
    background-color: #fef2f2; 
    color: #dc2626; 
    border-color: #fecaca;
    font-weight: 700;
    box-shadow: 0 2px 4px rgb(220 38 38 / 0.15);
  }
  .badge-priority-medium { 
    background-color: #fffbeb; 
    color: #d97706; 
    border-color: #fde68a;
    font-weight: 700;
    box-shadow: 0 2px 4px rgb(217 119 6 / 0.15);
  }
  .badge-priority-low { 
    background-color: #eff6ff; 
    color: #2563eb; 
    border-color: #bfdbfe;
    font-weight: 700;
    box-shadow: 0 2px 4px rgb(37 99 235 / 0.15);
  }

  /* Overdue tasks highlighting */
  .task-overdue {
    background-color: #fef2f2 !important;
    border-color: #fecaca !important;
  }

  /* Completed task styling */
  .task-completed {
    opacity: 0.6;
  }

  /* Better checkbox styling */
  .task-checkbox {
    width: 1.25rem;
    height: 1.25rem;
    cursor: pointer;
    flex-shrink: 0;
  }

  /* Larger touch targets for mobile */
  @media (max-width: 768px) {
    .task-checkbox {
      width: 1.5rem;
      height: 1.5rem;
    }
    .vm-task { 
      margin-bottom: 0.75rem; 
    }
    .btn-sm {
      min-height: 2.5rem;
    }
  }

  /* Opaque dropdown for task menu */
  .vm-dropdown-opaque {
    background-color: #ffffff !important;
    opacity: 1 !important;
    backdrop-filter: none !important;
    -webkit-backdrop-filter: none !important;
  }

  /* Let dropdown escape the card (prevents clipping) */
  .vm-task .card-body {
    overflow: visible !important;
  }

  /* Ensure dropdown stacks above cards/navs */
  .task-menu { 
    position: relative; 
    z-index: 1;
  }
  .task-menu .dropdown-content {
    position: absolute;
    z-index: 90 !important;
    min-width: 11rem;
  }
  
  /* Better touch targets and feedback for iOS Safari */
  .task-menu button {
    -webkit-tap-highlight-color: rgba(59, 130, 246, 0.3);
    touch-action: manipulation;
    cursor: pointer;
  }
  
  .task-menu .dropdown-content li > a {
    padding: 0.75rem 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    -webkit-tap-highlight-color: rgba(59, 130, 246, 0.2);
  }

  /* When a task menu is open, raise the entire card above others */
  .vm-task.vm-open {
    position: relative;
    z-index: 85 !important;
  }

  /* Disable hover transform while open (transform creates a stacking context) */
  .vm-task.vm-open:hover {
    transform: none !important;
  }

  /* Expandable task details on mobile */
  .task-details-expanded {
    max-height: 500px;
  }

  /* Better mobile filter layout */
  @media (max-width: 640px) {
    .filter-buttons {
      width: 100%;
    }
    .filter-buttons .btn {
      flex: 1;
      min-width: 0;
    }
  }
</style>

<main class="py-8 sm:py-10">
  <div class="max-w-6xl mx-auto px-4 sm:px-6 space-y-6">

    <!-- Header -->
    <header class="card vm-section bg-base-100 animate-slideUp" role="banner">
      <div class="card-body p-5 sm:p-6">
        <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-4">
          <div class="min-w-0">
            <h1 class="text-2xl sm:text-3xl font-extrabold text-base-content flex items-center gap-2 truncate">
              <i class="bi bi-list-check text-primary" aria-hidden="true"></i>
              <span class="gradient-text">Tasks</span>
              {% if total_tasks %}
                <span class="badge vm-chip text-xs font-bold ml-2 shadow-sm">
                  {{ total_tasks }} total
                </span>
              {% endif %}
            </h1>
            <p class="text-sm vm-muted mt-1">
              Manage and track your tasks. Stay consistent ‚Äî small wins compound.
            </p>
          </div>

          <div class="flex items-center gap-2">
            <a href="{% url 'category_list' %}" class="btn btn-ghost btn-sm gap-2" aria-label="Manage categories">
              <i class="bi bi-tags" aria-hidden="true"></i>
              <span class="hidden sm:inline">Categories</span>
            </a>
            <a href="{% url 'task_create' %}" class="btn btn-primary btn-sm gap-2" aria-label="Create a new task">
              <i class="bi bi-plus-square" aria-hidden="true"></i>
              <span>New task</span>
            </a>
          </div>
        </div>
      </div>
    </header>

    <!-- Filters -->
    <section class="card vm-section bg-base-100 animate-fadeIn" aria-label="Task filters">
      <div class="card-body p-5 sm:p-6">
        <div class="flex flex-col lg:flex-row gap-4 lg:items-end lg:justify-between">

          <!-- Search -->
          <form method="get" class="w-full lg:max-w-md" id="searchForm">
            <label class="label font-semibold">
              <span class="label-text flex items-center gap-2">
                <i class="bi bi-search text-primary" aria-hidden="true"></i>
                Search
                <span id="searchResultsCount" class="text-xs vm-muted hidden"></span>
              </span>
            </label>

            <div class="join w-full">
              <input
                type="text"
                name="search"
                id="taskSearchInput"
                value="{{ request.GET.search|default:'' }}"
                placeholder="Search tasks..."
                class="input input-bordered join-item w-full"
                aria-label="Search tasks"
                autocomplete="off"
              >
              <button class="btn btn-outline join-item" type="button" id="clearSearchBtn" aria-label="Clear search">
                <i class="bi bi-x-lg" aria-hidden="true"></i>
              </button>
            </div>

            <!-- Preserve filters when searching -->
            {% if request.GET.priority %}
              <input type="hidden" name="priority" value="{{ request.GET.priority }}">
            {% endif %}
            {% if request.GET.status %}
              <input type="hidden" name="status" value="{{ request.GET.status }}">
            {% endif %}
          </form>

          <!-- Quick filters -->
          {% with p=request.GET.priority s=request.GET.status q=request.GET.search %}
          <div class="flex flex-wrap gap-2 filter-buttons">
            <a href="?priority=high{% if q %}&search={{ q }}{% endif %}{% if s %}&status={{ s }}{% endif %}"
               class="btn btn-outline btn-sm gap-1 sm:gap-2 {% if p == 'high' %}btn-active{% endif %}"
               style="{% if p == 'high' %}background-color: #fef2f2; color: #dc2626; border-color: #fecaca;{% endif %}">
              <i class="bi bi-exclamation-circle-fill" aria-hidden="true"></i>
              <span class="hidden sm:inline">High</span>
            </a>

            <a href="?priority=medium{% if q %}&search={{ q }}{% endif %}{% if s %}&status={{ s }}{% endif %}"
               class="btn btn-outline btn-sm gap-1 sm:gap-2 {% if p == 'medium' %}btn-active{% endif %}"
               style="{% if p == 'medium' %}background-color: #fffbeb; color: #d97706; border-color: #fde68a;{% endif %}">
              <i class="bi bi-dash-circle-fill" aria-hidden="true"></i>
              <span class="hidden sm:inline">Medium</span>
            </a>

            <a href="?priority=low{% if q %}&search={{ q }}{% endif %}{% if s %}&status={{ s }}{% endif %}"
               class="btn btn-outline btn-sm gap-1 sm:gap-2 {% if p == 'low' %}btn-active{% endif %}"
               style="{% if p == 'low' %}background-color: #eff6ff; color: #2563eb; border-color: #bfdbfe;{% endif %}">
              <i class="bi bi-arrow-down-circle-fill" aria-hidden="true"></i>
              <span class="hidden sm:inline">Low</span>
            </a>

            <a href="?status=pending{% if q %}&search={{ q }}{% endif %}{% if p %}&priority={{ p }}{% endif %}"
               class="btn btn-outline btn-sm gap-1 sm:gap-2 {% if s == 'pending' %}btn-active{% endif %}">
              <i class="bi bi-circle" aria-hidden="true"></i>
              <span class="hidden sm:inline">Undone</span>
            </a>

            <a href="{% url 'task_list' %}" class="btn btn-ghost btn-sm gap-1 sm:gap-2">
              <i class="bi bi-x-circle" aria-hidden="true"></i>
              <span class="hidden sm:inline">Clear</span>
            </a>
          </div>
          {% endwith %}

        </div>
      </div>
    </section>

    <!-- Task list -->
    <section class="space-y-3" aria-label="Task list" id="taskListSection">
      <!-- No search results message (initially hidden) -->
      <div id="noSearchResults" class="card vm-section bg-base-100 hidden">
        <div class="card-body p-8 sm:p-10 text-center">
          <div class="text-4xl mb-3">üîç</div>
          <h2 class="text-lg font-bold">No matching tasks</h2>
          <p class="text-sm text-base-content/70 mt-1">
            Try a different search term.
          </p>
        </div>
      </div>

      {% if tasks %}
        {% for task in tasks %}
        {% load tz %}
        {% now "Y-m-d" as today_str %}
        <article class="card vm-section bg-base-100 vm-task 
                        {% if task.status == 'completed' %}task-completed{% endif %}
                        {% if task.due_date and task.due_date|date:'Y-m-d' < today_str and task.status != 'completed' %}task-overdue{% endif %}
                        priority-{{ task.priority }}"
                 data-task-id="{{ task.id }}">
          <div class="card-body p-4 sm:p-5">
            <div class="flex items-start gap-3 sm:gap-4">

              <!-- Checkbox -->
              <div class="pt-0.5 flex-shrink-0">
                <input
                  type="checkbox"
                  class="checkbox task-checkbox"
                  {% if task.status == 'completed' %}checked{% endif %}
                  onchange="toggleTaskComplete({{ task.id }}, this.checked)"
                  onclick="event.stopPropagation()"
                  aria-label="{% if task.status == 'completed' %}Mark '{{ task.title }}' as incomplete{% else %}Mark '{{ task.title }}' as complete{% endif %}"
                >
              </div>

              <!-- Content -->
              <div class="flex-1 min-w-0">
                <div class="flex items-start justify-between gap-3">

                  <div class="min-w-0 flex-1">
                    <div class="flex items-start gap-2 flex-wrap">
                      <h3 class="font-semibold text-base sm:text-lg text-base-content {% if task.status == 'completed' %}line-through text-base-content/50{% endif %}">
                        {{ task.title }}
                      </h3>
                      {% if task.due_date and task.due_date|date:'Y-m-d' < today_str and task.status != 'completed' %}
                        <span class="badge badge-sm badge-error gap-1">
                          <i class="bi bi-exclamation-triangle-fill" aria-hidden="true"></i>
                          Overdue
                        </span>
                      {% endif %}
                    </div>

                    {% if task.description %}
                    <p class="text-sm text-base-content/70 mt-1.5 {% if task.status == 'completed' %}text-base-content/50{% endif %}">
                      {{ task.description|truncatewords:20 }}
                    </p>
                    {% endif %}

                    <!-- Meta - moved up for better mobile visibility -->
                    <div class="mt-3 flex flex-wrap items-center gap-2 text-sm">
                      <span class="badge badge-outline badge-priority-{{ task.priority }}">
                        {% if task.priority == 'high' %}
                          <i class="bi bi-exclamation-circle-fill mr-1" aria-hidden="true"></i>High
                        {% elif task.priority == 'medium' %}
                          <i class="bi bi-dash-circle-fill mr-1" aria-hidden="true"></i>Medium
                        {% else %}
                          <i class="bi bi-arrow-down-circle-fill mr-1" aria-hidden="true"></i>Low
                        {% endif %}
                      </span>

                      {% if task.category %}
                        <span class="badge badge-outline badge-sm">
                          <i class="bi bi-tag mr-1" aria-hidden="true"></i>
                          {{ task.category.name }}
                        </span>
                      {% endif %}

                      {% if task.due_date %}
                        <span class="badge badge-ghost badge-sm gap-1 {% if task.due_date|date:'Y-m-d' < today_str and task.status != 'completed' %}text-error{% endif %}">
                          <i class="bi bi-calendar-event" aria-hidden="true"></i>
                          {{ task.due_date|date:"M d" }}
                        </span>
                      {% endif %}

                      {% if task.status == 'completed' and task.completed_at %}
                        <span class="badge badge-success badge-sm gap-1">
                          <i class="bi bi-check2-all" aria-hidden="true"></i>
                          Done
                        </span>
                      {% endif %}
                    </div>
                  </div>

                  <!-- Desktop actions -->
                  <div class="hidden md:flex gap-2 flex-shrink-0" onclick="event.stopPropagation()">
                    <a href="{% url 'task_timer' task.id %}" class="btn btn-success btn-sm gap-2" aria-label="Start Pomodoro timer for {{ task.title }}">
                      <i class="bi bi-alarm" aria-hidden="true"></i>
                      <span class="hidden lg:inline">Timer</span>
                    </a>
                    <a href="{% url 'log_create' %}?task={{ task.id }}" class="btn btn-primary btn-sm gap-2" aria-label="Log time for {{ task.title }}">
                      <i class="bi bi-stopwatch" aria-hidden="true"></i>
                      <span class="hidden lg:inline">Log</span>
                    </a>
                    <a href="{% url 'task_update' task.id %}" class="btn btn-outline btn-sm" aria-label="Edit task">
                      <i class="bi bi-pencil-square" aria-hidden="true"></i>
                    </a>
                    {% if task.title != 'General Activity' %}
                    <a href="{% url 'task_delete' task.id %}" class="btn btn-outline btn-sm text-error" aria-label="Delete task">
                      <i class="bi bi-trash" aria-hidden="true"></i>
                    </a>
                    {% else %}
                    <button class="btn btn-outline btn-sm" disabled title="Cannot delete default task">
                      <i class="bi bi-lock" aria-hidden="true"></i>
                    </button>
                    {% endif %}
                  </div>

                  <!-- Mobile actions -->
                  <div class="dropdown dropdown-end md:hidden flex-shrink-0 task-menu" id="taskMenu-{{ task.id }}" onclick="event.stopPropagation()">
                    <button
                      id="taskMenuBtn-{{ task.id }}"
                      type="button"
                      class="btn btn-ghost btn-sm"
                      aria-label="Task actions"
                      aria-haspopup="true"
                      aria-expanded="false"
                    >
                      <i class="bi bi-three-dots-vertical text-lg" aria-hidden="true"></i>
                    </button>

                    <ul
                      id="taskMenuDd-{{ task.id }}"
                      class="dropdown-content menu vm-dropdown-opaque rounded-box shadow-xl border border-base-200 hidden"
                      role="menu"
                    >
                      <li>
                        <a href="{% url 'task_timer' task.id %}" class="text-success font-medium">
                          <i class="bi bi-alarm text-lg" aria-hidden="true"></i>
                          Pomodoro Timer
                        </a>
                      </li>
                      <li>
                        <a href="{% url 'log_create' %}?task={{ task.id %}" class="text-primary font-medium">
                          <i class="bi bi-stopwatch text-lg" aria-hidden="true"></i>
                          Log Time
                        </a>
                      </li>
                      <li>
                        <a href="{% url 'task_update' task.id %}">
                          <i class="bi bi-pencil-square text-lg" aria-hidden="true"></i>
                          Edit Task
                        </a>
                      </li>
                      {% if task.title != 'General Activity' %}
                      <li>
                        <a href="{% url 'task_delete' task.id %}" class="text-error">
                          <i class="bi bi-trash text-lg" aria-hidden="true"></i>
                          Delete Task
                        </a>
                      </li>
                      {% else %}
                      <li>
                        <span class="opacity-50 cursor-not-allowed flex items-center gap-2 px-4 py-3">
                          <i class="bi bi-lock text-lg" aria-hidden="true"></i>
                          Default Task
                        </span>
                      </li>
                      {% endif %}
                    </ul>
                  </div>

                </div>
              </div>
            </div>
          </div>
        </article>
        {% endfor %}
      {% else %}
        <div class="card vm-section bg-base-100">
          <div class="card-body p-8 sm:p-10 text-center">
            <div class="text-4xl mb-3">üéØ</div>
            <h2 class="text-lg font-bold">No tasks found</h2>
            <p class="text-sm text-base-content/70 mt-1">
              {% if request.GET.search or request.GET.priority or request.GET.status %}
                Try adjusting filters or search terms.
              {% else %}
                Create your first task to get started.
              {% endif %}
            </p>
            <div class="mt-5 flex flex-col sm:flex-row gap-3 justify-center">
              {% if request.GET.search or request.GET.priority or request.GET.status %}
                <a href="{% url 'task_list' %}" class="btn btn-outline btn-sm gap-2">
                  <i class="bi bi-x-circle" aria-hidden="true"></i>
                  Clear filters
                </a>
              {% endif %}
              <a href="{% url 'task_create' %}" class="btn btn-primary btn-sm gap-2">
                <i class="bi bi-plus-square" aria-hidden="true"></i>
                Create task
              </a>
            </div>
          </div>
        </div>
      {% endif %}
    </section>

    <!-- Pagination -->
    {% if page_obj.has_other_pages %}
    <section class="flex justify-center" aria-label="Pagination navigation">
      <div class="join">
        {% if page_obj.has_previous %}
          <a href="?page=1{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.priority %}&priority={{ request.GET.priority }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}" 
             class="join-item btn btn-sm"
             aria-label="First page">
            <i class="bi bi-chevron-bar-left" aria-hidden="true"></i>
          </a>
          <a href="?page={{ page_obj.previous_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.priority %}&priority={{ request.GET.priority }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}" 
             class="join-item btn btn-sm"
             aria-label="Previous page">
            <i class="bi bi-chevron-left" aria-hidden="true"></i>
          </a>
        {% else %}
          <button class="join-item btn btn-sm btn-disabled" disabled aria-label="First page (disabled)">
            <i class="bi bi-chevron-bar-left" aria-hidden="true"></i>
          </button>
          <button class="join-item btn btn-sm btn-disabled" disabled aria-label="Previous page (disabled)">
            <i class="bi bi-chevron-left" aria-hidden="true"></i>
          </button>
        {% endif %}

        <!-- Page numbers -->
        {% for num in page_obj.paginator.page_range %}
          {% if page_obj.number == num %}
            <button class="join-item btn btn-sm btn-active" aria-current="page" aria-label="Page {{ num }}">{{ num }}</button>
          {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
            <a href="?page={{ num }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.priority %}&priority={{ request.GET.priority }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}" 
               class="join-item btn btn-sm"
               aria-label="Page {{ num }}">{{ num }}</a>
          {% elif num == 1 or num == page_obj.paginator.num_pages %}
            <a href="?page={{ num }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.priority %}&priority={{ request.GET.priority }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}" 
               class="join-item btn btn-sm"
               aria-label="Page {{ num }}">{{ num }}</a>
          {% elif num == page_obj.number|add:'-3' or num == page_obj.number|add:'3' %}
            <button class="join-item btn btn-sm btn-disabled" disabled>...</button>
          {% endif %}
        {% endfor %}

        {% if page_obj.has_next %}
          <a href="?page={{ page_obj.next_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.priority %}&priority={{ request.GET.priority }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}" 
             class="join-item btn btn-sm"
             aria-label="Next page">
            <i class="bi bi-chevron-right" aria-hidden="true"></i>
          </a>
          <a href="?page={{ page_obj.paginator.num_pages }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.priority %}&priority={{ request.GET.priority }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}" 
             class="join-item btn btn-sm"
             aria-label="Last page">
            <i class="bi bi-chevron-bar-right" aria-hidden="true"></i>
          </a>
        {% else %}
          <button class="join-item btn btn-sm btn-disabled" disabled aria-label="Next page (disabled)">
            <i class="bi bi-chevron-right" aria-hidden="true"></i>
          </button>
          <button class="join-item btn btn-sm btn-disabled" disabled aria-label="Last page (disabled)">
            <i class="bi bi-chevron-bar-right" aria-hidden="true"></i>
          </button>
        {% endif %}
      </div>
    </section>

    <!-- Pagination info -->
    <div class="text-center text-sm text-base-content/70 mt-3">
      Showing {{ page_obj.start_index }} to {{ page_obj.end_index }} of {{ total_tasks }} task{{ total_tasks|pluralize }}
    </div>
    {% endif %}

  </div>
</main>

<script>
  function getCSRFToken() {
    // Try meta tag first (works on production with HTTPS)
    const metaTag = document.querySelector('meta[name="csrf-token"]');
    if (metaTag && metaTag.content) return metaTag.content;
    
    // Fallback to cookie
    const name = 'csrftoken=';
    const parts = document.cookie.split(';').map(s => s.trim());
    for (const p of parts) {
      if (p.startsWith(name)) return decodeURIComponent(p.substring(name.length));
    }
    
    // Last resort
    return '{{ csrf_token }}';
  }

  function toggleTaskComplete(taskId, isChecked) {
    const csrfToken = getCSRFToken();
    const checkbox = document.querySelector(`input[onchange*="${taskId}"]`);
    const taskCard = document.querySelector(`article[data-task-id="${taskId}"]`);
    
    // Optimistic UI update
    if (taskCard) {
      if (isChecked) {
        taskCard.classList.add('task-completed');
      } else {
        taskCard.classList.remove('task-completed');
      }
    }
    
    fetch(`/tasks/${taskId}/complete/`, {
      method: 'POST',
      headers: { 
        'X-CSRFToken': csrfToken,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ completed: isChecked })
    })
    .then(function (r) {
      if (!r.ok) {
        // Revert optimistic update on error
        if (checkbox) checkbox.checked = !isChecked;
        if (taskCard) {
          if (isChecked) {
            taskCard.classList.remove('task-completed');
          } else {
            taskCard.classList.add('task-completed');
          }
        }
        return r.text().then(text => {
          throw new Error(`HTTP ${r.status}: ${text.substring(0, 200)}`);
        });
      }
      // Reload to get fresh data after a brief delay for visual feedback
      setTimeout(() => window.location.reload(), 300);
    })
    .catch(function (err) {
      console.error('Task completion error:', err);
      alert('Error updating task: ' + (err.message || 'Unknown error. Check browser console.'));
    });
  }

  // Mobile task menu: toggle, close on outside click / Esc, only one open at a time
  (function () {
    const menus = Array.from(document.querySelectorAll('.task-menu'));
    if (!menus.length) return;

    const closeAll = () => {
      menus.forEach((menu) => {
        const btn = menu.querySelector('button[id^="taskMenuBtn-"]');
        const dd  = menu.querySelector('ul[id^="taskMenuDd-"]');
        if (!btn || !dd) return;

        dd.classList.add('hidden');
        btn.setAttribute('aria-expanded', 'false');

        const card = menu.closest('.vm-task');
        if (card) card.classList.remove('vm-open');
      });
    };

    const toggleOne = (menu) => {
      const btn = menu.querySelector('button[id^="taskMenuBtn-"]');
      const dd  = menu.querySelector('ul[id^="taskMenuDd-"]');
      if (!btn || !dd) return;

      const isHidden = dd.classList.contains('hidden');
      closeAll();

      if (isHidden) {
        dd.classList.remove('hidden');
        btn.setAttribute('aria-expanded', 'true');

        const card = menu.closest('.vm-task');
        if (card) card.classList.add('vm-open');
      }
    };

    menus.forEach((menu) => {
      const btn = menu.querySelector('button[id^="taskMenuBtn-"]');
      if (!btn) return;

      // Use both click and touchend for better iOS Safari support
      const handleToggle = (e) => {
        e.preventDefault();
        e.stopPropagation();
        toggleOne(menu);
      };

      btn.addEventListener('click', handleToggle);
      btn.addEventListener('touchend', (e) => {
        e.preventDefault();
        e.stopPropagation();
        toggleOne(menu);
      }, { passive: false });

      // Close when clicking a menu action (better UX on mobile)
      const dd = menu.querySelector('ul[id^="taskMenuDd-"]');
      if (dd) {
        dd.addEventListener('click', () => closeAll());
        dd.addEventListener('touchend', () => closeAll(), { passive: true });
      }
    });

    const handleDocumentClick = (e) => {
      const clickedInsideAny = menus.some((menu) => menu.contains(e.target));
      if (!clickedInsideAny) closeAll();
    };

    const handleEscapeKey = (e) => {
      if (e.key === 'Escape') closeAll();
    };

    document.addEventListener('click', handleDocumentClick);
    document.addEventListener('keydown', handleEscapeKey);
    document.addEventListener('scroll', closeAll, { passive: true });

    // Clean up event listeners on page unload
    window.addEventListener('beforeunload', function() {
      document.removeEventListener('click', handleDocumentClick);
      document.removeEventListener('keydown', handleEscapeKey);
      document.removeEventListener('scroll', closeAll);
    });
  })();

  // Instant search functionality
  (function () {
    const searchInput = document.getElementById('taskSearchInput');
    const clearBtn = document.getElementById('clearSearchBtn');
    const resultsCount = document.getElementById('searchResultsCount');
    const noResultsMsg = document.getElementById('noSearchResults');
    const taskCards = Array.from(document.querySelectorAll('.vm-task'));
    const emptyState = document.querySelector('.card.vm-section .card-body > .text-4xl')?.closest('.card.vm-section');
    const paginationSection = document.querySelector('section[aria-label="Pagination navigation"]');
    const paginationInfo = document.querySelector('.text-center.text-sm.text-base-content\\/70');

    if (!searchInput || taskCards.length === 0) return;

    function performSearch() {
      const query = searchInput.value.trim().toLowerCase();
      let visibleCount = 0;

      if (!query) {
        // Show all tasks
        taskCards.forEach(card => {
          card.style.display = '';
        });
        if (resultsCount) resultsCount.classList.add('hidden');
        if (noResultsMsg) noResultsMsg.classList.add('hidden');
        if (emptyState) emptyState.style.display = '';
        if (paginationSection) paginationSection.style.display = '';
        if (paginationInfo) paginationInfo.style.display = '';
        return;
      }

      // Hide the original empty state and pagination when searching
      if (emptyState) emptyState.style.display = 'none';
      if (paginationSection) paginationSection.style.display = 'none';
      if (paginationInfo) paginationInfo.style.display = 'none';

      // Filter tasks
      taskCards.forEach(card => {
        const title = card.querySelector('h3')?.textContent?.toLowerCase() || '';
        const description = card.querySelector('p.text-sm')?.textContent?.toLowerCase() || '';
        const category = card.querySelector('.bi-tag')?.parentElement?.textContent?.toLowerCase() || '';
        const priority = card.querySelector('.badge-priority-high, .badge-priority-medium, .badge-priority-low')?.textContent?.toLowerCase() || '';

        const searchableText = `${title} ${description} ${category} ${priority}`;
        const matches = searchableText.includes(query);

        if (matches) {
          card.style.display = '';
          visibleCount++;
        } else {
          card.style.display = 'none';
        }
      });

      // Update UI
      if (visibleCount === 0) {
        if (noResultsMsg) noResultsMsg.classList.remove('hidden');
        if (resultsCount) {
          resultsCount.textContent = '0 results';
          resultsCount.classList.remove('hidden');
        }
      } else {
        if (noResultsMsg) noResultsMsg.classList.add('hidden');
        if (resultsCount) {
          resultsCount.textContent = `${visibleCount} result${visibleCount !== 1 ? 's' : ''} (on this page)`;
          resultsCount.classList.remove('hidden');
        }
      }
    }

    // Debounce function for better performance
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // Instant search with slight debounce
    const debouncedSearch = debounce(performSearch, 150);
    searchInput.addEventListener('input', debouncedSearch);

    // Clear button
    if (clearBtn) {
      clearBtn.addEventListener('click', () => {
        searchInput.value = '';
        performSearch();
        searchInput.focus();
      });
    }

    // Perform initial search if there's a query parameter
    if (searchInput.value.trim()) {
      performSearch();
    }
  })();

  // Click to edit task - FIXED: Use event delegation instead of forEach
  (function () {
    // Single delegated click handler instead of N listeners
    document.addEventListener('click', (e) => {
      const card = e.target.closest('.vm-task');
      if (!card) return;
      
      // Don't navigate if clicking on interactive elements
      const isInteractive = e.target.closest('input, button, a, .dropdown, .task-menu');
      if (isInteractive) return;
      
      // Get task ID and navigate to edit page
      const taskId = card.dataset.taskId;
      if (taskId) {
        window.location.href = `/tasks/${taskId}/edit/`;
      }
    });
    
    // Visual feedback on touch/press using event delegation
    let touchedCard = null;
    
    document.addEventListener('touchstart', (e) => {
      const card = e.target.closest('.vm-task');
      if (card) {
        touchedCard = card;
        card.style.opacity = '0.7';
      }
    }, { passive: true });
    
    document.addEventListener('touchend', () => {
      if (touchedCard) {
        touchedCard.style.opacity = '';
        touchedCard = null;
      }
    }, { passive: true });
    
    document.addEventListener('touchcancel', () => {
      if (touchedCard) {
        touchedCard.style.opacity = '';
        touchedCard = null;
      }
    }, { passive: true });
  })();
</script>

{% endblock %}
