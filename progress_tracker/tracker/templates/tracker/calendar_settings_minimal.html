{% extends 'tracker/base.html' %}

{% block title %}Calendar Settings - VisMatrix{% endblock %}

{% block content %}
<main class="space-y-6 max-w-4xl mx-auto">
  
  <header class="card border border-base-200 bg-base-100">
    <div class="card-body p-5 sm:p-6">
      <div class="flex items-center justify-between">
        <div>
          <h1 class="text-2xl sm:text-3xl font-bold">Calendar Integrations</h1>
          <p class="text-base-content/70 mt-1">Connect your calendars to sync events</p>
        </div>
        <a href="{% url 'dashboard' %}" class="btn btn-outline btn-sm gap-2">
          <i class="bi bi-arrow-left" aria-hidden="true"></i>
          <span>Back</span>
        </a>
      </div>
    </div>
  </header>

  <!-- Google Calendar Section -->
  <section class="card border border-base-200 bg-base-100">
    <div class="card-body p-5 sm:p-6">
      <div class="flex items-start gap-4">
        <div class="w-12 h-12 rounded-xl bg-blue-100 dark:bg-blue-900 flex items-center justify-center flex-shrink-0">
          <svg class="w-7 h-7 text-blue-600 dark:text-blue-400" viewBox="0 0 24 24" fill="currentColor">
            <path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zM5 8V6h14v2H5z"/>
          </svg>
        </div>
        <div class="flex-1 min-w-0">
          <h2 class="text-xl font-bold mb-2">Google Calendar</h2>
          
          {% if google_integration %}
          <div class="space-y-3">
            <div class="flex items-center gap-2">
              <span class="badge badge-success gap-1">
                <i class="bi bi-check-circle" aria-hidden="true"></i>
                Connected
              </span>
              {% if google_integration.is_active %}
              <span class="badge badge-info gap-1">
                <i class="bi bi-arrow-repeat" aria-hidden="true"></i>
                Active
              </span>
              {% endif %}
            </div>
            
            {% if google_integration.last_sync_at %}
            <p class="text-sm text-base-content/70">
              Last synced: {{ google_integration.last_sync_at|date:"M d, Y H:i" }}
            </p>
            {% endif %}
            
            <div class="flex gap-2 flex-wrap">
              <form method="post" action="{% url 'calendar_sync_now' %}">
                {% csrf_token %}
                <button type="submit" class="btn btn-primary btn-sm gap-2">
                  <i class="bi bi-arrow-clockwise" aria-hidden="true"></i>
                  <span>Sync Now</span>
                </button>
              </form>
              
              <label for="google-disconnect-modal" class="btn btn-error btn-sm gap-2">
                <i class="bi bi-x-circle" aria-hidden="true"></i>
                <span>Disconnect</span>
              </label>
            </div>
          </div>
          {% else %}
          <p class="text-base-content/70 mb-3">Sync your Google Calendar events automatically</p>
          {% if google_configured %}
          
          <!--
          <a href="{% url 'calendar_connect' %}" class="btn btn-primary gap-2">
            <i class="bi bi-google" aria-hidden="true"></i>
            <span>Connect Google Calendar</span>
          </a>
        -->
            
          {% else %}
          <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle" aria-hidden="true"></i>
            <span>Google Calendar integration not configured by administrator.</span>
          </div>
          {% endif %}
          {% endif %}
        </div>
      </div>
    </div>
  </section>

  <!-- iCloud Calendar Section -->
  <section class="card border border-base-200 bg-base-100">
    <div class="card-body p-5 sm:p-6">
      <div class="flex items-start gap-4">
        <div class="w-12 h-12 rounded-xl bg-slate-100 dark:bg-slate-800 flex items-center justify-center flex-shrink-0">
          <i class="bi bi-apple text-3xl text-slate-700 dark:text-slate-300" aria-hidden="true"></i>
        </div>
        <div class="flex-1 min-w-0">
          <h2 class="text-xl font-bold mb-2">iCloud Calendar</h2>
          
          {% if icloud_integration %}
          <div class="space-y-3">
            <div class="flex items-center gap-2">
              <span class="badge badge-success gap-1">
                <i class="bi bi-check-circle" aria-hidden="true"></i>
                Connected
              </span>
              {% if icloud_integration.is_active %}
              <span class="badge badge-info gap-1">
                <i class="bi bi-arrow-repeat" aria-hidden="true"></i>
                Active
              </span>
              {% endif %}
            </div>
            
            <p class="text-sm text-base-content/70">
              Apple ID: {{ icloud_integration.apple_id }}
            </p>
            
            {% if icloud_integration.last_sync_at %}
            <p class="text-sm text-base-content/70">
              Last synced: {{ icloud_integration.last_sync_at|date:"M d, Y H:i" }}
            </p>
            {% endif %}
            
            <div class="flex gap-2 flex-wrap">
              <form method="post" action="{% url 'icloud_calendar_sync' %}">
                {% csrf_token %}
                <button type="submit" class="btn btn-primary btn-sm gap-2">
                  <i class="bi bi-arrow-clockwise" aria-hidden="true"></i>
                  <span>Sync Now</span>
                </button>
              </form>
              
              <a href="{% url 'icloud_calendar_connect' %}" class="btn btn-outline btn-sm gap-2">
                <i class="bi bi-pencil" aria-hidden="true"></i>
                <span>Update</span>
              </a>
              
              <label for="icloud-disconnect-modal" class="btn btn-error btn-sm gap-2">
                <i class="bi bi-x-circle" aria-hidden="true"></i>
                <span>Disconnect</span>
              </label>
            </div>
          </div>
          {% else %}
          <p class="text-base-content/70 mb-3">Sync your iCloud Calendar events using CalDAV</p>
          <a href="{% url 'icloud_calendar_connect' %}" class="btn btn-primary gap-2">
            <i class="bi bi-apple" aria-hidden="true"></i>
            <span>Connect iCloud Calendar</span>
          </a>
          <div class="alert alert-info mt-3">
            <i class="bi bi-info-circle" aria-hidden="true"></i>
            <div class="text-sm">
              <p class="font-semibold">You'll need an App-Specific Password</p>
              <p>Generate one at <a href="https://appleid.apple.com" target="_blank" class="link link-primary">appleid.apple.com</a> → Security → App-Specific Passwords</p>
            </div>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </section>

</main>

<!-- Google Disconnect Modal -->
<input type="checkbox" id="google-disconnect-modal" class="modal-toggle" />
<div class="modal">
  <div class="modal-box">
    <h3 class="font-bold text-lg mb-2">Disconnect Google Calendar?</h3>
    <p class="py-4">This will remove the connection to your Google Calendar. You can reconnect at any time.</p>
    <div class="modal-action">
      <form method="post" action="{% url 'calendar_disconnect' %}">
        {% csrf_token %}
        <button type="submit" class="btn btn-error gap-2">
          <i class="bi bi-x-circle" aria-hidden="true"></i>
          <span>Disconnect</span>
        </button>
      </form>
      <label for="google-disconnect-modal" class="btn btn-outline">Cancel</label>
    </div>
  </div>
</div>

<!-- iCloud Disconnect Modal -->
<input type="checkbox" id="icloud-disconnect-modal" class="modal-toggle" />
<div class="modal">
  <div class="modal-box">
    <h3 class="font-bold text-lg mb-2">Disconnect iCloud Calendar?</h3>
    <p class="py-4">This will remove the connection to your iCloud Calendar. You can reconnect at any time.</p>
    <div class="modal-action">
      <form method="post" action="{% url 'icloud_calendar_disconnect' %}">
        {% csrf_token %}
        <button type="submit" class="btn btn-error gap-2">
          <i class="bi bi-x-circle" aria-hidden="true"></i>
          <span>Disconnect</span>
        </button>
      </form>
      <label for="icloud-disconnect-modal" class="btn btn-outline">Cancel</label>
    </div>
  </div>
</div>

{% endblock %}
