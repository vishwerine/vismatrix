{% extends 'tracker/base.html' %}
{% load math_filters %}

{% block title %}{{ friend.username }} - Progress{% endblock %}

{% block content %}
<main class="space-y-6">

  <!-- Header -->
  <header class="card border border-base-200 bg-base-100" role="banner">
    <div class="card-body p-5 sm:p-6">
      <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
        <div class="min-w-0">
          <div class="flex flex-col gap-4 sm:flex-row sm:items-center">
            <div class="avatar placeholder">
              <div class="bg-gradient-to-br from-indigo-500 to-purple-600 text-white rounded-2xl w-20 h-20 md:w-24 md:h-24 shadow-lg flex items-center justify-center">
                <span class="text-3xl font-bold">{{ friend.username|first|upper }}</span>
              </div>
            </div>
            <div>
              <h1 class="text-2xl md:text-4xl font-black">{{ friend.username }}</h1>
              <p class="text-base-content/70">Progress Dashboard</p>
            </div>
          </div>
        </div>

        <div class="flex items-center gap-2 text-sm text-base-content/70">
             <a href="{% url 'start_chat' friend.username %}" class="btn btn-primary btn-block" aria-label="Message {{ friend.username }}">
      <i class="bi bi-chat-dots" aria-hidden="true"></i>
      <span>Message {{ friend.username }}</span>
    </a>

        </div>
      </div>
    </div>
  </header>

  <!-- Metrics -->
  <section class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4" aria-label="Key metrics">
    <div class="card border border-base-200 bg-base-100">
      <div class="card-body p-5">
        <div class="flex items-start justify-between gap-3">
          <div class="flex items-center gap-2">
            <span class="inline-flex items-center justify-center w-10 h-10 rounded-xl bg-base-200">
              <i class="bi bi-calendar-check text-primary text-lg" aria-hidden="true"></i>
            </span>
            <div>
              <p class="text-xs uppercase tracking-wide text-base-content/60">Tasks today</p>
              <p class="text-2xl font-extrabold tabular-nums">{{ today_tasks_count|default:0 }}</p>
            </div>
          </div>
        </div>

        <div class="mt-3 space-y-2">
          <div class="flex items-center justify-between text-sm">
            <span class="text-base-content/70">Completed</span>
            <span class="font-semibold tabular-nums">{{ completed_today|default:0 }}</span>
          </div>
          <progress class="progress progress-primary w-full"
            value="{% if today_tasks_count %}{{ completed_today|mul:100|div:today_tasks_count }}{% else %}0{% endif %}"
            max="100"></progress>
        </div>
      </div>
    </div>

    <div class="card border border-base-200 bg-base-100">
      <div class="card-body p-5">
        <div class="flex items-center gap-2">
          <span class="inline-flex items-center justify-center w-10 h-10 rounded-xl bg-base-200">
            <i class="bi bi-fire text-primary text-lg" aria-hidden="true"></i>
          </span>
          <div>
            <p class="text-xs uppercase tracking-wide text-base-content/60">Streak</p>
            <p class="text-2xl font-extrabold tabular-nums">{{ activity_streak|default:0 }}</p>
          </div>
        </div>
        <p class="mt-3 text-sm text-base-content/70">Keep it steadyâ€”small wins daily.</p>
      </div>
    </div>

    <div class="card border border-base-200 bg-base-100">
      <div class="card-body p-5">
        <div class="flex items-center gap-2">
          <span class="inline-flex items-center justify-center w-10 h-10 rounded-xl bg-base-200">
            <i class="bi bi-activity text-primary text-lg" aria-hidden="true"></i>
          </span>
          <div>
            <p class="text-xs uppercase tracking-wide text-base-content/60">This month</p>
            <p class="text-2xl font-extrabold tabular-nums">{{ logs_this_month|default:0 }}</p>
          </div>
        </div>
        <p class="mt-3 text-sm text-base-content/70">Activity logs recorded.</p>
      </div>
    </div>

    <div class="card border border-base-200 bg-base-100">
      <div class="card-body p-5">
        <div class="flex items-center gap-2">
          <span class="inline-flex items-center justify-center w-10 h-10 rounded-xl bg-base-200">
            <i class="bi bi-stopwatch text-primary text-lg" aria-hidden="true"></i>
          </span>
          <div>
            <p class="text-xs uppercase tracking-wide text-base-content/60">Total time</p>
            <p class="text-2xl font-extrabold tabular-nums">{{ total_time|default:0 }}</p>
          </div>
        </div>
        <p class="mt-3 text-sm text-base-content/70">Minutes tracked.</p>
      </div>
    </div>
  </section>

  <!-- Weekly chart -->
  <section class="card border border-base-200 bg-base-100" aria-label="Weekly overview">
    <div class="card-body p-5 sm:p-6">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
        <div>
          <h2 class="text-lg font-bold flex items-center gap-2">
            <i class="bi bi-graph-up" aria-hidden="true"></i>
            <span>Weekly progress</span>
          </h2>
          <p class="text-sm text-base-content/70 mt-1">Minutes logged over the last 7 days.</p>
        </div>
        <span class="badge badge-primary badge-outline">Last 7 days</span>
      </div>

      {% if weekly_overview %}
      <div class="mt-4 p-4 rounded-2xl border border-base-200 bg-base-100">
        <div class="chart-wrap">
          <canvas id="weeklyChart" class="w-full" aria-label="Weekly minutes chart" role="img"></canvas>
        </div>
      </div>
      {% else %}
      <div class="mt-4 p-6 rounded-2xl border border-base-200 bg-base-200/40 text-center">
        <p class="text-sm text-base-content/70">No weekly data yet.</p>
      </div>
      {% endif %}
    </div>
  </section>

  <!-- Goals + Calendar -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

    <!-- Goals -->
    <section class="card border border-base-200 bg-base-100" aria-label="Goals">
      <div class="card-body p-5 sm:p-6">
        <h2 class="text-lg font-bold flex items-center gap-2">
          <i class="bi bi-trophy" aria-hidden="true"></i>
          <span>Daily goals</span>
        </h2>
        <p class="text-sm text-base-content/70 mt-1">Simple targets to keep you consistent.</p>

        <div class="mt-4 space-y-4">
          <div class="p-4 rounded-2xl border border-base-200 bg-base-100">
            <div class="flex items-center justify-between gap-3">
              <div class="flex items-center gap-2">
                <i class="bi bi-stopwatch text-primary" aria-hidden="true"></i>
                <span class="font-semibold text-sm">Time goal</span>
              </div>
              <span class="text-sm font-bold tabular-nums">{{ today_time|default:0 }}/60 min</span>
            </div>
            <progress class="progress progress-primary w-full mt-3"
              value="{% if today_time|default:0 > 60 %}100{% else %}{{ today_time|default:0|mul:100|div:60 }}{% endif %}"
              max="100"></progress>
            <p class="mt-2 text-xs text-base-content/70">
              {% widthratio today_time 60 100 %}% complete
            </p>
          </div>

          <div class="p-4 rounded-2xl border border-base-200 bg-base-100">
            <div class="flex items-center justify-between gap-3">
              <div class="flex items-center gap-2">
                <i class="bi bi-check-circle text-primary" aria-hidden="true"></i>
                <span class="font-semibold text-sm">Tasks goal</span>
              </div>
              <span class="text-sm font-bold tabular-nums">{{ completed_today|default:0 }}/5 tasks</span>
            </div>
            <progress class="progress progress-primary w-full mt-3"
              value="{% if completed_today|default:0 > 5 %}100{% else %}{{ completed_today|default:0|mul:100|div:5 }}{% endif %}"
              max="100"></progress>
            <p class="mt-2 text-xs text-base-content/70">
              {% widthratio completed_today 5 100 %}% complete
            </p>
          </div>
        </div>
      </div>
    </section>

    <!-- Calendar -->
    <section class="card border border-base-200 bg-base-100" aria-label="Calendar">
      <div class="card-body p-5 sm:p-6">
        <div class="flex items-start justify-between gap-3">
          <div>
            <h2 class="text-lg font-bold flex items-center gap-2">
              <i class="bi bi-calendar" aria-hidden="true"></i>
              <span>{{ month_name }} {{ selected_year }}</span>
            </h2>
            <p class="text-sm text-base-content/70 mt-1">Activity overview for the month.</p>
          </div>
        </div>

        <div class="mt-4 p-4 rounded-2xl border border-base-200 bg-base-100" id="calendar-grid">
          <div class="grid grid-cols-7 gap-2 text-center mb-3">
            {% for day_name in day_names %}
              <div class="text-xs font-semibold text-base-content/70 py-2">{{ day_name }}</div>
            {% endfor %}
          </div>

          <div class="grid grid-cols-7 gap-2">
            {% for day in calendar_days %}
              {% if day.logged %}
                <div class="cal-day cal-day--active"
                     aria-label="Active day on {{ day.date|date:'F j, Y' }}">
                  <span>{{ day.day }}</span>
                </div>
              {% elif day.is_future %}
                <div class="cal-day cal-day--future" aria-label="{{ day.date|date:'F j, Y' }} (future day)">
                  <span>{{ day.day }}</span>
                </div>
              {% else %}
                <div class="cal-day"
                     aria-label="Inactive day on {{ day.date|date:'F j, Y' }}">
                  <span>{{ day.day }}</span>
                </div>
              {% endif %}
            {% endfor %}
          </div>
        </div>

        <div class="mt-4 flex flex-wrap items-center justify-center gap-4 text-sm text-base-content/70">
          <span class="inline-flex items-center gap-2">
            <span class="legend-dot" style="background: rgb(29 78 216 / .55)"></span> Active
          </span>
          <span class="inline-flex items-center gap-2">
            <span class="legend-dot" style="background: rgba(226,232,240,1)"></span> Inactive
          </span>
          <span class="inline-flex items-center gap-2">
            <span class="legend-dot" style="background: rgba(226,232,240,.6)"></span> Future
          </span>
        </div>
      </div>
    </section>
  </div>

  <!-- Category breakdown -->
  <section class="card border border-base-200 bg-base-100" aria-label="Category breakdown">
    <div class="card-body p-5 sm:p-6">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
        <div>
          <h2 class="text-lg font-bold flex items-center gap-2">
            <i class="bi bi-pie-chart" aria-hidden="true"></i>
            <span>Time distribution</span>
          </h2>
          <p class="text-sm text-base-content/70 mt-1">Minutes by category (weekly).</p>
        </div>
        <div class="flex items-center gap-4">
          <div class="text-right">
            <p class="text-sm text-base-content/70">Total</p>
            <p class="text-lg font-bold tabular-nums">{{ category_total_time|default:0 }} min</p>
          </div>
          <span class="badge badge-outline">Weekly</span>
        </div>
      </div>

      <div class="mt-4">
        {% if category_data_list %}
        <div class="flex justify-center">
          <div class="chart-wrap" style="height: 400px; width: 400px; max-width: 100%;">
            <canvas id="categoryChart" class="w-full h-full" aria-label="Category distribution chart" role="img"></canvas>
          </div>
        </div>
        {% else %}
        <div class="mt-4 p-6 rounded-2xl border border-base-200 bg-base-200/40 text-center">
          <p class="text-sm text-base-content/70">No category data available.</p>
        </div>
        {% endif %}
      </div>
    </div>
  </section>

  <!-- Task breakdown -->
  <section class="card border border-base-200 bg-base-100" aria-label="Task breakdown">
    <div class="card-body p-5 sm:p-6">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
        <div>
          <h2 class="text-lg font-bold flex items-center gap-2">
            <i class="bi bi-list-task" aria-hidden="true"></i>
            <span>Task distribution</span>
          </h2>
          <p class="text-sm text-base-content/70 mt-1">Minutes by task (weekly).</p>
        </div>
        <div class="flex items-center gap-4">
          <div class="text-right">
            <p class="text-sm text-base-content/70">Total</p>
            <p class="text-lg font-bold tabular-nums">{{ task_total_time|default:0 }} min</p>
          </div>
          <span class="badge badge-outline">Weekly</span>
        </div>
      </div>

      <div class="mt-4">
        {% if task_data %}
        <div class="flex justify-center">
          <div class="chart-wrap" style="height: 400px; width: 400px; max-width: 100%;">
            <canvas id="taskChart" class="w-full h-full" aria-label="Task distribution chart" role="img"></canvas>
          </div>
        </div>
        {% else %}
        <div class="mt-4 p-6 rounded-2xl border border-base-200 bg-base-200/40 text-center">
          <p class="text-sm text-base-content/70">No task data available.</p>
        </div>
        {% endif %}
      </div>
    </div>
  </section>

  <div class="flex flex-col gap-3 pt-4">
 
    <a href="{% url 'friends_list' %}" class="btn btn-outline btn-block">Back to Friends</a>
  </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
<script>
  // Weekly chart
  {% if weekly_overview %}
  const weeklyCtx = document.getElementById('weeklyChart');
  if (weeklyCtx) {
    const weeklyData = {{ weekly_overview|safe }};
    new Chart(weeklyCtx, {
      type: 'line',
      data: {
        labels: weeklyData.labels,
        datasets: [{
          label: 'Minutes',
          data: weeklyData.data,
          borderColor: 'rgb(99, 102, 241)',
          backgroundColor: 'rgba(99, 102, 241, 0.1)',
          tension: 0.4,
          fill: true,
          pointBackgroundColor: 'rgb(99, 102, 241)',
          pointBorderColor: '#fff',
          pointBorderWidth: 2,
          pointRadius: 6,
          pointHoverRadius: 8,
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false }
        },
        scales: {
          y: {
            beginAtZero: true,
            grid: { color: 'rgba(0,0,0,0.05)' },
            ticks: { font: { size: 12 } }
          },
          x: {
            grid: { display: false },
            ticks: { font: { size: 12 } }
          }
        },
        interaction: {
          intersect: false,
          mode: 'index'
        }
      }
    });
  }
  {% endif %}

  // Category chart
  {% if category_data_list %}
  const categoryCtx = document.getElementById('categoryChart');
  if (categoryCtx) {
    const categoryData = {{ category_data_list|safe }};
    new Chart(categoryCtx, {
      type: 'doughnut',
      data: {
        labels: categoryData.map(item => item.name),
        datasets: [{
          data: categoryData.map(item => item.value),
          backgroundColor: [
            'rgb(99, 102, 241)',
            'rgb(168, 85, 247)',
            'rgb(236, 72, 153)',
            'rgb(34, 197, 94)',
            'rgb(251, 191, 36)',
            'rgb(239, 68, 68)',
            'rgb(6, 182, 212)',
            'rgb(139, 69, 19)'
          ],
          borderWidth: 0,
          hoverOffset: 4
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: true,
            position: 'bottom',
            labels: {
              padding: 20,
              usePointStyle: true,
              font: { size: 12 }
            }
          }
        },
        cutout: '60%'
      }
    });
  }
  {% endif %}

  // Task chart
  {% if task_data %}
  const taskCtx = document.getElementById('taskChart');
  if (taskCtx) {
    const taskData = {{ task_data|safe }};
    new Chart(taskCtx, {
      type: 'doughnut',
      data: {
        labels: taskData.map(item => item.name),
        datasets: [{
          data: taskData.map(item => item.value),
          backgroundColor: [
            'rgb(34, 197, 94)',
            'rgb(99, 102, 241)',
            'rgb(168, 85, 247)',
            'rgb(236, 72, 153)',
            'rgb(251, 191, 36)',
            'rgb(239, 68, 68)',
            'rgb(6, 182, 212)',
            'rgb(139, 69, 19)'
          ],
          borderWidth: 0,
          hoverOffset: 4
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: true,
            position: 'bottom',
            labels: {
              padding: 20,
              usePointStyle: true,
              font: { size: 12 }
            }
          }
        },
        cutout: '60%'
      }
    });
  }
  {% endif %}
</script>

<style>
  .cal-day {
    @apply aspect-square rounded-lg border border-base-200 bg-base-200 flex items-center justify-center text-sm font-medium cursor-pointer transition-all duration-200 hover:bg-base-300;
  }

  .cal-day--active {
    @apply bg-primary/55 text-primary-content border-primary/30 hover:bg-primary/65;
  }

  .cal-day--future {
    @apply bg-base-200/60 text-base-content/40 border-base-200/60;
  }

  .legend-dot {
    @apply w-3 h-3 rounded-full border border-base-300;
  }

  .chart-wrap {
    position: relative;
    height: 300px;
  }
</style>
{% endblock %}