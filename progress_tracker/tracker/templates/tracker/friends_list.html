{% extends 'tracker/base.html' %}

{% block title %}Friends - VisMatrix.Space{% endblock %}

{% block content %}
<!-- Use theme-aware surfaces instead of fixed light gradients -->
<div class="min-h-screen pb-24 md:pb-8 px-3 sm:px-4 lg:px-8"
     style="background: var(--bg); color: var(--text);">

  <!-- Header -->
  <header class="max-w-6xl mx-auto mb-6 md:mb-12 pt-4">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 md:gap-6">
      <div class="min-w-0">
        <h1 class="text-2xl sm:text-3xl md:text-4xl lg:text-5xl font-black mb-1 md:mb-2 flex items-center gap-2"
            style="color: var(--text);">
          <i class="bi bi-people-fill" aria-hidden="true" style="color: var(--muted);"></i>
          <span>My Friends</span>
        </h1>

        <p class="text-sm md:text-lg flex items-center gap-1" style="color: var(--muted);">
          <i class="bi bi-person-badge" aria-hidden="true"></i>
          <span>
            <span id="friend-count-number" data-count="{{ friends_data|length|default:0 }}">
              {{ friends_data|length|default:0 }}
            </span>
            friend{% if friends_data|length != 1 %}s{% endif %}
          </span>
        </p>
      </div>

      <a href="{% url 'user_list' %}"
         class="btn btn-outline btn-sm md:btn-md gap-2 w-fit"
         style="border-color: var(--border); color: var(--text); background: transparent;"
         aria-label="Find new friends">
        <i class="bi bi-person-plus" aria-hidden="true"></i>
        Find Friends<span class="hidden sm:inline">to Add</span>
      </a>
    </div>
  </header>

  <!-- Friends Grid -->
  <main class="max-w-6xl mx-auto" aria-label="Friends list">
    {% if friends_data %}
      <div id="friends-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6">
        {% for item in friends_data %}
        <article
          class="rounded-2xl md:rounded-3xl p-4 md:p-6 border hover:shadow-xl md:hover:-translate-y-1 transition-all flex flex-col"
          id="friend-{{ item.friendship.id }}"
          aria-label="Friend card for {{ item.friend.get_full_name|default:item.friend.username }}"
          style="background: var(--surface); border-color: var(--border); box-shadow: var(--shadow);"
        >
          <!-- Friend Header -->
          <div class="flex items-start justify-between mb-3 md:mb-4">
            <div class="min-w-0">
              <h3 class="font-bold text-sm md:text-base truncate flex items-center gap-1"
                  style="color: var(--text);">
                <i class="bi bi-person-circle" aria-hidden="true" style="color: var(--muted);"></i>
                <span>{{ item.friend.get_full_name|default:item.friend.username }}</span>
              </h3>
              <p class="text-xs md:text-sm truncate flex items-center gap-1" style="color: var(--muted);">
                <i class="bi bi-at" aria-hidden="true"></i>
                <span>@{{ item.friend.username }}</span>
              </p>
            </div>

            <div class="w-10 h-10 md:w-12 md:h-12 rounded-lg md:rounded-xl flex-shrink-0 flex items-center justify-center text-base md:text-lg"
                 style="background: var(--text); color: var(--bg);">
              <i class="bi bi-person-fill" aria-hidden="true"></i>
            </div>
          </div>

          <!-- Week Stats -->
          <div class="space-y-2 md:space-y-3 flex-1 mb-4 text-xs md:text-sm">
            <div class="flex items-center justify-between">
              <span class="flex items-center gap-1" style="color: var(--muted);">
                <i class="bi bi-clipboard-check" aria-hidden="true"></i>
                <span>Completed This Week</span>
              </span>
              <span class="font-semibold px-2 py-1 rounded"
                    style="color: var(--text); background: var(--surface-2);">
                {{ item.completed_tasks|default:"0" }}
              </span>
            </div>

            <div class="flex items-center justify-between">
              <span class="flex items-center gap-1" style="color: var(--muted);">
                <i class="bi bi-stopwatch" aria-hidden="true"></i>
                <span>Time Logged (7d)</span>
              </span>
              <span class="font-semibold px-2 py-1 rounded"
                    style="color: var(--text); background: var(--surface-2);">
                {{ item.total_time|default:"0" }}m
              </span>
            </div>
          </div>

          <!-- Progress Bar -->
          <div class="mb-4">
            <div class="flex items-center justify-between mb-2">
              <span class="text-xs flex items-center gap-1" style="color: var(--muted);">
                <i class="bi bi-activity" aria-hidden="true"></i>
                <span>Weekly Activity</span>
              </span>
              <span class="text-xs font-semibold flex items-center gap-1" style="color: var(--text);">
                <i class="bi bi-list-check" aria-hidden="true"></i>
                <span>{{ item.completed_tasks|default:"0" }} tasks</span>
              </span>
            </div>

            <div class="w-full rounded-full h-2 overflow-hidden" aria-hidden="true"
                 style="background: var(--border);">
              <div
                class="h-2 rounded-full transition-all duration-300"
                style="width: {{ item.activity_percent|default:'0' }}%; background: var(--primary);">
              </div>
            </div>
          </div>

          <!-- Actions -->
          <div class="flex gap-2 mt-auto">
            <a href="{% url 'view_friend_profile' item.friendship.id %}"
               class="btn btn-xs md:btn-sm flex-1 flex-col py-2 border text-center"
               style="border-color: var(--border); background: var(--surface); color: var(--text);"
               aria-label="View profile of {{ item.friend.username }}">
              <i class="bi bi-person-badge text-lg" aria-hidden="true"></i>
              <span class="text-[10px] md:text-xs font-medium mt-1">View Profile</span>
            </a>

            <button
              type="button"
              onclick="removeFriend('{{ item.friendship.id }}', 'friend-{{ item.friendship.id }}', '{% url 'remove_friend' item.friendship.id %}')"
              class="btn btn-xs md:btn-sm flex-1 flex-col py-2 border text-center"
              style="border-color: var(--border); background: var(--surface); color: var(--text);"
              id="remove-btn-{{ item.friendship.id }}"
              aria-label="Remove {{ item.friend.username }} from your friends list"
              onmouseover="this.style.background='rgb(239 68 68 / 0.10)'; this.style.color='var(--error)';"
              onmouseout="this.style.background='var(--surface)'; this.style.color='var(--text)';"
            >
              <i class="bi bi-person-x text-lg" aria-hidden="true"></i>
              <span class="text-[10px] md:text-xs font-medium mt-1">Remove Friend</span>
            </button>
          </div>
        </article>
        {% endfor %}
      </div>

    {% else %}
      <!-- Empty State -->
      <div id="empty-state" class="text-center py-12 md:py-16">
        <div class="text-4xl md:text-5xl mb-3 md:mb-4" style="color: var(--muted);">
          <i class="bi bi-people" aria-hidden="true"></i>
        </div>
        <h3 class="text-base md:text-lg font-bold mb-2" style="color: var(--text);">No friends yet</h3>
        <p class="text-sm mb-6" style="color: var(--muted);">
          Find and connect with other users to see their progress.
        </p>
        <a href="{% url 'user_list' %}"
           class="btn btn-outline btn-sm gap-2"
           style="border-color: var(--border); color: var(--text); background: transparent;">
          <i class="bi bi-search" aria-hidden="true"></i>
          <span>Explore Users</span>
        </a>
      </div>
    {% endif %}
  </main>

  <!-- NOTE: Remove the page-level bottom nav here, because base.html already provides the mobile nav.
       Keeping both results in two stacked nav bars on mobile. -->

</div>

<script>
  function removeFriend(friendshipId, containerId, url) {
    if (!confirm('Remove this friend? You can add them back later.')) return;

    const button = document.getElementById(`remove-btn-${friendshipId}`);
    const card = document.getElementById(containerId);
    const originalHTML = button.innerHTML;

    button.disabled = true;
    button.innerHTML = '<i class="bi bi-arrow-repeat animate-spin" aria-hidden="true"></i>';

    fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token }}',
        'Accept': 'application/json'
      },
      body: JSON.stringify({})
    })
    .then(r => r.json())
    .then(data => {
      showToast(data.message || 'Friend updated', data.status || 'info');

      if (data.status === 'success') {
        card.style.opacity = '0';
        card.style.transform = 'scale(0.95)';
        card.style.transition = 'all 0.3s ease';

        setTimeout(() => {
          card.remove();
          updateFriendCount();
          ensureEmptyState();
        }, 300);
      } else {
        button.disabled = false;
        button.innerHTML = originalHTML;
      }
    })
    .catch(e => {
      showToast('Error: ' + e, 'error');
      button.disabled = false;
      button.innerHTML = originalHTML;
    });
  }

  function updateFriendCount() {
    const countEl = document.getElementById('friend-count-number');
    if (!countEl) return;

    const current = parseInt(countEl.dataset.count || '0', 10);
    const next = Math.max(current - 1, 0);

    countEl.dataset.count = next.toString();
    countEl.textContent = next.toString();

    const labelParent = countEl.parentElement;
    if (!labelParent) return;

    const suffix = next === 1 ? ' friend' : ' friends';
    labelParent.innerHTML =
      `<i class="bi bi-person-badge" aria-hidden="true"></i> ` +
      `<span><span id="friend-count-number" data-count="${next}">${next}</span>${suffix}</span>`;
  }

  function ensureEmptyState() {
    const friendsGrid = document.getElementById('friends-grid');
    if (friendsGrid && friendsGrid.children.length > 0) return;

    if (!document.getElementById('empty-state')) {
      const main = document.querySelector('main[max-w-6xl], main.max-w-6xl, main');
      const container = main || document.body;

      const emptyDiv = document.createElement('div');
      emptyDiv.id = 'empty-state';
      emptyDiv.className = 'text-center py-12 md:py-16';
      emptyDiv.innerHTML = `
        <div class="text-4xl md:text-5xl mb-3 md:mb-4" style="color: var(--muted);">
          <i class="bi bi-people" aria-hidden="true"></i>
        </div>
        <h3 class="text-base md:text-lg font-bold mb-2" style="color: var(--text);">No friends yet</h3>
        <p class="text-sm mb-6" style="color: var(--muted);">Find and connect with other users to see their progress.</p>
        <a href="{% url 'user_list' %}"
           class="btn btn-outline btn-sm gap-2"
           style="border-color: var(--border); color: var(--text); background: transparent;">
          <i class="bi bi-search" aria-hidden="true"></i>
          <span>Explore Users</span>
        </a>
      `;
      container.appendChild(emptyDiv);
    }
  }

  function showToast(message, type = 'info') {
    const container = document.getElementById('toast-container') ||
      (function () {
        const div = document.createElement('div');
        div.id = 'toast-container';
        div.className = 'fixed bottom-20 md:bottom-4 right-4 space-y-2 z-50';
        document.body.appendChild(div);
        return div;
      })();

    const iconMap = {
      success: 'bi-check-circle-fill',
      error:   'bi-exclamation-octagon-fill',
      warning: 'bi-exclamation-triangle-fill',
      info:    'bi-info-circle-fill'
    };

    const alertClassMap = {
      success: 'alert-success',
      error:   'alert-error',
      warning: 'alert-warning',
      info:    'alert-info'
    };

    const iconClass = iconMap[type] || iconMap.info;
    const alertClass = alertClassMap[type] || alertClassMap.info;

    const alert = document.createElement('div');
    alert.className = `alert ${alertClass} shadow-lg max-w-xs text-sm flex items-center gap-2`;
    alert.innerHTML = `
      <i class="bi ${iconClass}" aria-hidden="true"></i>
      <span>${message}</span>
    `;
    container.appendChild(alert);

    setTimeout(() => alert.remove(), 3000);
  }
</script>
{% endblock %}
