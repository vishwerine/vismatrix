{% extends 'tracker/base.html' %}

{% block title %}Friends - VisMatrix.Space{% endblock %}

{% block content %}
<!-- Use theme-aware surfaces instead of fixed light gradients -->
<div class="min-h-screen pb-24 md:pb-8 px-3 sm:px-4 lg:px-8"
     style="background: var(--bg); color: var(--text);">

  <!-- Header -->
  <header class="max-w-6xl mx-auto mb-6 md:mb-12 pt-4">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 md:gap-6 mb-4">
      <div class="min-w-0">
        <h1 class="text-2xl sm:text-3xl md:text-4xl lg:text-5xl font-black mb-1 md:mb-2 flex items-center gap-2"
            style="color: var(--text);">
          <i class="bi bi-people-fill" aria-hidden="true" style="color: var(--muted);"></i>
          <span>My Friends</span>
        </h1>

        <p class="text-sm md:text-lg flex items-center gap-1" style="color: var(--muted);">
          <i class="bi bi-person-badge" aria-hidden="true"></i>
          <span>
            <span id="friend-count-display">
              <span id="friend-count-visible">{{ friends_data|length|default:0 }}</span>
              <span id="friend-count-separator"> of </span>
              <span id="friend-count-total" data-count="{{ friends_data|length|default:0 }}">{{ friends_data|length|default:0 }}</span>
            </span>
            friend<span id="friend-plural">{% if friends_data|length != 1 %}s{% endif %}</span>
          </span>
        </p>
      </div>

      <a href="{% url 'user_list' %}"
         class="btn btn-outline btn-sm md:btn-md gap-2 w-fit"
         style="border-color: var(--border); color: var(--text); background: transparent;"
         aria-label="Find new friends">
        <i class="bi bi-person-plus" aria-hidden="true"></i>
        Find Friends<span class="hidden sm:inline">to Add</span>
      </a>
    </div>

    <!-- Search Bar -->
    {% if friends_data %}
    <div class="max-w-2xl">
      <div class="relative">
        <input
          type="text"
          id="friend-search"
          placeholder="Search friends by name or username..."
          class="input input-bordered w-full pl-10 pr-10"
          style="background: var(--surface); border-color: var(--border); color: var(--text);"
          aria-label="Search friends"
        >
        <i class="bi bi-search absolute left-3 top-1/2 -translate-y-1/2 text-lg" style="color: var(--muted);" aria-hidden="true"></i>
        <button
          id="clear-search"
          class="absolute right-3 top-1/2 -translate-y-1/2 hidden hover:opacity-70 transition-opacity"
          style="color: var(--muted);"
          aria-label="Clear search"
          title="Clear search"
        >
          <i class="bi bi-x-circle-fill text-lg" aria-hidden="true"></i>
        </button>
      </div>
      <div id="no-results" class="hidden mt-4 p-4 rounded-lg text-center" style="background: var(--surface); border: 1px solid var(--border);">
        <i class="bi bi-search text-2xl mb-2" style="color: var(--muted);" aria-hidden="true"></i>
        <p class="text-sm font-medium mb-1" style="color: var(--text);">No friends found</p>
        <p class="text-xs" style="color: var(--muted);">Try a different search term</p>
      </div>
    </div>
    {% endif %}
  </header>

  <!-- Friends Grid -->
  <main class="max-w-6xl mx-auto" aria-label="Friends list">
    {% if friends_data %}
      <div id="friends-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
        {% for item in friends_data %}
        <article
          class="rounded-2xl p-5 md:p-6 border hover:shadow-lg transition-all flex flex-col friend-card"
          id="friend-{{ item.friendship.id }}"
          data-friend-name="{{ item.friend.get_full_name|default:item.friend.username|lower }}"
          data-friend-username="{{ item.friend.username|lower }}"
          aria-label="Friend card for {{ item.friend.get_full_name|default:item.friend.username }}"
          style="background: var(--surface); border-color: var(--border);"
        >
          <!-- Top: Friend Info + Stats Row -->
          <div class="flex items-start justify-between gap-4 mb-4">
            <!-- Left: Avatar + Name -->
            <div class="flex items-start gap-3 min-w-0 flex-1">
              <div class="w-12 h-12 rounded-lg flex-shrink-0 flex items-center justify-center text-lg font-bold"
                   style="background: var(--primary); color: var(--primary-ink);">
                {{ item.friend.username|first|upper }}
              </div>
              <div class="min-w-0 flex-1">
                <h3 class="font-bold text-base md:text-lg truncate"
                    style="color: var(--text);">
                  {{ item.friend.get_full_name|default:item.friend.username }}
                </h3>
                <p class="text-xs md:text-sm truncate" style="color: var(--muted);">
                  @{{ item.friend.username }}
                </p>
              </div>
            </div>

            <!-- Right: Quick Stats -->
            <div class="flex gap-3 flex-shrink-0">
              <div class="text-center">
                <div class="text-sm md:text-base font-bold" style="color: var(--text);">
                  {{ item.completed_tasks|default:"0" }}
                </div>
                <div class="text-xs" style="color: var(--muted);">tasks</div>
              </div>
              <div class="text-center">
                <div class="text-sm md:text-base font-bold" style="color: var(--text);">
                  {{ item.total_time|default:"0" }}
                </div>
                <div class="text-xs" style="color: var(--muted);">min</div>
              </div>
            </div>
          </div>

          <!-- Activity Progress -->
          <div class="mb-4">
            <div class="flex items-center justify-between mb-2">
              <span class="text-xs font-medium flex items-center gap-1" style="color: var(--muted);">
                <i class="bi bi-activity" aria-hidden="true"></i>
                <span>Weekly Activity</span>
              </span>
              <span class="text-xs font-semibold" style="color: var(--text);">
                {{ item.activity_percent|default:"0" }}%
              </span>
            </div>
            <div class="w-full rounded-full h-2 overflow-hidden" style="background: var(--border);">
              <div
                class="h-2 rounded-full transition-all duration-300"
                style="width: {{ item.activity_percent|default:'0' }}%; background: var(--primary);">
              </div>
            </div>
          </div>

          <!-- Actions: Message + View Profile + Remove -->
          <div class="flex gap-2 mt-auto pt-4" style="border-top: 1px solid var(--border);">
            <a href="{% url 'start_chat' item.friend.username %}"
               class="btn btn-primary btn-sm flex-1"
               aria-label="Message {{ item.friend.username }}">
              <i class="bi bi-chat-dots" aria-hidden="true"></i>
              <span>Message</span>
            </a>

            <a href="{% url 'view_friend_profile' item.friendship.id %}"
               class="btn btn-outline btn-sm flex-1"
               style="border-color: var(--border); color: var(--text); background: var(--surface);"
               aria-label="View profile of {{ item.friend.username }}">
              <i class="bi bi-person-badge" aria-hidden="true"></i>
              <span>Profile</span>
            </a>

            <button
              type="button"
              onclick="removeFriend('{{ item.friendship.id }}', 'friend-{{ item.friendship.id }}', '{% url 'remove_friend' item.friendship.id %}')"
              class="btn btn-ghost btn-sm"
              style="color: var(--muted);"
              id="remove-btn-{{ item.friendship.id }}"
              aria-label="Remove {{ item.friend.username }} from your friends list"
              title="Remove friend"
            >
              <i class="bi bi-x-lg" aria-hidden="true"></i>
            </button>
          </div>
        </article>
        {% endfor %}
      </div>

    {% else %}
      <!-- Empty State -->
      <div id="empty-state" class="text-center py-12 md:py-16">
        <div class="text-4xl md:text-5xl mb-3 md:mb-4" style="color: var(--muted);">
          <i class="bi bi-people" aria-hidden="true"></i>
        </div>
        <h3 class="text-base md:text-lg font-bold mb-2" style="color: var(--text);">No friends yet</h3>
        <p class="text-sm mb-6" style="color: var(--muted);">
          Find and connect with other users to see their progress.
        </p>
        <a href="{% url 'user_list' %}"
           class="btn btn-outline btn-sm gap-2"
           style="border-color: var(--border); color: var(--text); background: transparent;">
          <i class="bi bi-search" aria-hidden="true"></i>
          <span>Explore Users</span>
        </a>
      </div>
    {% endif %}
  </main>

  <!-- NOTE: Remove the page-level bottom nav here, because base.html already provides the mobile nav.
       Keeping both results in two stacked nav bars on mobile. -->

</div>

<script>
  // Search functionality
  (function() {
    const searchInput = document.getElementById('friend-search');
    const clearBtn = document.getElementById('clear-search');
    const friendCards = document.querySelectorAll('.friend-card');
    const noResults = document.getElementById('no-results');
    const friendsGrid = document.getElementById('friends-grid');
    const visibleCount = document.getElementById('friend-count-visible');
    const countSeparator = document.getElementById('friend-count-separator');
    const totalCount = document.getElementById('friend-count-total');
    const pluralSpan = document.getElementById('friend-plural');

    if (!searchInput) return;

    function updateVisibleCount() {
      const visible = Array.from(friendCards).filter(card => !card.classList.contains('hidden')).length;
      const total = friendCards.length;

      if (visibleCount) visibleCount.textContent = visible;
      
      if (visible === total) {
        if (countSeparator) countSeparator.classList.add('hidden');
        if (totalCount) totalCount.classList.add('hidden');
      } else {
        if (countSeparator) countSeparator.classList.remove('hidden');
        if (totalCount) totalCount.classList.remove('hidden');
      }

      if (pluralSpan) {
        pluralSpan.textContent = visible === 1 ? '' : 's';
      }

      // Show/hide no results message
      if (noResults) {
        if (visible === 0 && searchInput.value.trim() !== '') {
          noResults.classList.remove('hidden');
          if (friendsGrid) friendsGrid.classList.add('hidden');
        } else {
          noResults.classList.add('hidden');
          if (friendsGrid) friendsGrid.classList.remove('hidden');
        }
      }
    }

    function filterFriends() {
      const query = searchInput.value.toLowerCase().trim();

      // Show/hide clear button
      if (clearBtn) {
        clearBtn.classList.toggle('hidden', query === '');
      }

      if (query === '') {
        friendCards.forEach(card => card.classList.remove('hidden'));
        updateVisibleCount();
        return;
      }

      friendCards.forEach(card => {
        const name = card.dataset.friendName || '';
        const username = card.dataset.friendUsername || '';
        const matches = name.includes(query) || username.includes(query);
        card.classList.toggle('hidden', !matches);
      });

      updateVisibleCount();
    }

    searchInput.addEventListener('input', filterFriends);
    searchInput.addEventListener('search', filterFriends);

    if (clearBtn) {
      clearBtn.addEventListener('click', () => {
        searchInput.value = '';
        filterFriends();
        searchInput.focus();
      });
    }

    // Keyboard shortcut: Ctrl/Cmd + K to focus search
    document.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
        e.preventDefault();
        searchInput.focus();
      }
    });
  })();

  function removeFriend(friendshipId, containerId, url) {
    if (!confirm('Remove this friend? You can add them back later.')) return;

    const button = document.getElementById(`remove-btn-${friendshipId}`);
    const card = document.getElementById(containerId);
    const originalHTML = button.innerHTML;

    button.disabled = true;
    button.innerHTML = '<i class="bi bi-arrow-repeat animate-spin" aria-hidden="true"></i>';

    fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token }}',
        'Accept': 'application/json'
      },
      body: JSON.stringify({})
    })
    .then(r => r.json())
    .then(data => {
      showToast(data.message || 'Friend updated', data.status || 'info');

      if (data.status === 'success') {
        card.style.opacity = '0';
        card.style.transform = 'scale(0.95)';
        card.style.transition = 'all 0.3s ease';

        setTimeout(() => {
          card.remove();
          updateFriendCount();
          ensureEmptyState();
        }, 300);
      } else {
        button.disabled = false;
        button.innerHTML = originalHTML;
      }
    })
    .catch(e => {
      showToast('Error: ' + e, 'error');
      button.disabled = false;
      button.innerHTML = originalHTML;
    });
  }

  function updateFriendCount() {
    const visibleCount = document.getElementById('friend-count-visible');
    const totalCount = document.getElementById('friend-count-total');
    const countSeparator = document.getElementById('friend-count-separator');
    
    if (!totalCount) return;

    const current = parseInt(totalCount.dataset.count || '0', 10);
    const next = Math.max(current - 1, 0);

    totalCount.dataset.count = next.toString();
    totalCount.textContent = next.toString();
    
    if (visibleCount) {
      visibleCount.textContent = next.toString();
    }

    // Hide separator if all friends are visible
    if (countSeparator && next === parseInt(visibleCount?.textContent || '0', 10)) {
      countSeparator.classList.add('hidden');
      totalCount.classList.add('hidden');
    }

    const pluralSpan = document.getElementById('friend-plural');
    if (pluralSpan) {
      pluralSpan.textContent = next === 1 ? '' : 's';
    }
  }

  function ensureEmptyState() {
    const friendsGrid = document.getElementById('friends-grid');
    if (friendsGrid && friendsGrid.children.length > 0) return;

    if (!document.getElementById('empty-state')) {
      const main = document.querySelector('main[max-w-6xl], main.max-w-6xl, main');
      const container = main || document.body;

      const emptyDiv = document.createElement('div');
      emptyDiv.id = 'empty-state';
      emptyDiv.className = 'text-center py-12 md:py-16';
      emptyDiv.innerHTML = `
        <div class="text-4xl md:text-5xl mb-3 md:mb-4" style="color: var(--muted);">
          <i class="bi bi-people" aria-hidden="true"></i>
        </div>
        <h3 class="text-base md:text-lg font-bold mb-2" style="color: var(--text);">No friends yet</h3>
        <p class="text-sm mb-6" style="color: var(--muted);">Find and connect with other users to see their progress.</p>
        <a href="{% url 'user_list' %}"
           class="btn btn-outline btn-sm gap-2"
           style="border-color: var(--border); color: var(--text); background: transparent;">
          <i class="bi bi-search" aria-hidden="true"></i>
          <span>Explore Users</span>
        </a>
      `;
      container.appendChild(emptyDiv);
    }
  }

  function showToast(message, type = 'info') {
    const container = document.getElementById('toast-container') ||
      (function () {
        const div = document.createElement('div');
        div.id = 'toast-container';
        div.className = 'fixed bottom-20 md:bottom-4 right-4 space-y-2 z-50';
        document.body.appendChild(div);
        return div;
      })();

    const iconMap = {
      success: 'bi-check-circle-fill',
      error:   'bi-exclamation-octagon-fill',
      warning: 'bi-exclamation-triangle-fill',
      info:    'bi-info-circle-fill'
    };

    const alertClassMap = {
      success: 'alert-success',
      error:   'alert-error',
      warning: 'alert-warning',
      info:    'alert-info'
    };

    const iconClass = iconMap[type] || iconMap.info;
    const alertClass = alertClassMap[type] || alertClassMap.info;

    const alert = document.createElement('div');
    alert.className = `alert ${alertClass} shadow-lg max-w-xs text-sm flex items-center gap-2`;
    alert.innerHTML = `
      <i class="bi ${iconClass}" aria-hidden="true"></i>
      <span>${message}</span>
    `;
    container.appendChild(alert);

    setTimeout(() => alert.remove(), 3000);
  }
</script>
{% endblock %}
