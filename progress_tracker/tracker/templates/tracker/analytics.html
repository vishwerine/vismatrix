{% extends 'tracker/base.html' %}
{% load math_filters %}

{% block title %}Analytics - VisMatrix{% endblock %}

{% block extra_head %}
<style>
  /* Keep it minimal + accessible (no gradients, no big motion) */
  .chart-wrap { position: relative; height: 320px; }
  @media (max-width: 768px) { .chart-wrap { height: 260px; } }

  /* Clear focus for calendar controls and day links */
  .cal-day:focus-visible,
  .cal-nav:focus-visible {
    outline: none;
    box-shadow: 0 0 0 3px rgb(29 78 216 / 0.25);
    border-radius: 12px;
  }

  /* Calendar day styles (not relying on colour only) */
  .cal-day {
    border: 1px solid var(--border, #e2e8f0);
    border-radius: 12px;
    min-height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    text-decoration: none;
  }
  .cal-day:hover { background: rgba(226,232,240,.5); }

  .cal-day--active {
    background: rgb(29 78 216 / 0.10);
    border-color: rgb(29 78 216 / 0.25);
    color: #1d4ed8;
  }
  .cal-day--active:hover { background: rgb(29 78 216 / 0.16); }

  .cal-day--future {
    opacity: .55;
    cursor: not-allowed;
    background: rgba(226,232,240,.35);
  }

  /* Small legend dots */
  .legend-dot { width: 10px; height: 10px; border-radius: 9999px; display: inline-block; }
</style>
{% endblock %}

{% block content %}
<main class="space-y-6">

  <!-- Header (simple) -->
  <header class="card border border-base-200 bg-base-100" role="banner">
    <div class="card-body p-5 sm:p-6">
      <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
        <div>
          <h1 class="text-2xl sm:text-3xl font-extrabold text-base-content">Analytics</h1>
          <p class="text-sm text-base-content/70 mt-1">Trends, goals, and time breakdown.</p>
        </div>
        <div class="flex items-center gap-2 text-sm text-base-content/70">
          <i class="bi bi-calendar-event text-primary text-lg" aria-hidden="true"></i>
          <span class="font-semibold">{{ today|date:"l, F j, Y" }}</span>
        </div>
      </div>
    </div>
  </header>

  <!-- Pro Analytics Banner -->
  {% if user_subscription.is_pro %}
  <div class="alert bg-gradient-to-r from-purple-500 to-indigo-600 text-white border-0 shadow-lg">
    <i class="bi bi-star-fill text-2xl"></i>
    <div class="flex-1">
      <h3 class="font-bold text-lg">Unlock Deeper Insights</h3>
      <p class="text-sm text-white/90">Access advanced analytics with trends, predictions, and detailed reports</p>
    </div>
    <a href="{% url 'advanced_analytics' %}" class="btn btn-sm bg-white text-purple-600 border-0 hover:bg-purple-50 gap-2">
      <i class="bi bi-graph-up-arrow"></i>
      View Pro Analytics
    </a>
  </div>
  {% else %}
  <div class="alert bg-base-200 border border-base-300">
    <i class="bi bi-lock text-2xl"></i>
    <div class="flex-1">
      <h3 class="font-bold">Want More Insights?</h3>
      <p class="text-sm text-base-content/70">Upgrade to Pro for advanced analytics, data exports, and AI-powered features</p>
    </div>
    <a href="{% url 'subscription_plans' %}" class="btn btn-sm btn-primary gap-2">
      <i class="bi bi-star"></i>
      Upgrade to Pro
    </a>
  </div>
  {% endif %}

  {% if random_quote %}
  <!-- Quote of the Day -->
  <section class="card border border-info/20 bg-gradient-to-br from-info/10 via-info/5 to-transparent shadow-md hover:shadow-lg transition-all">
    <div class="card-body p-6">
      <div class="flex items-center gap-2 mb-4">
        <i class="bi bi-quote text-info text-xl" aria-hidden="true"></i>
        <h2 class="text-base font-bold text-base-content">Quote of the Day</h2>
      </div>
      <div class="flex items-start gap-4">
        <div class="flex-shrink-0 w-12 h-12 rounded-full bg-info/20 flex items-center justify-center">
          <i class="bi bi-quote text-info text-2xl" aria-hidden="true"></i>
        </div>
        <div class="flex-1 min-w-0">
          <blockquote class="text-base sm:text-lg text-base-content italic font-medium leading-relaxed">
            {{ random_quote.quote|safe }}
          </blockquote>
          <p class="mt-3 text-sm text-base-content/70 font-semibold text-right">
            — {{ random_quote.author }}
          </p>
        </div>
      </div>
    </div>
  </section>
  {% endif %}

  <!-- Metrics (no gradients) -->
  <section class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4" aria-label="Key metrics">
    <div class="card border border-base-200 bg-base-100">
      <div class="card-body p-5">
        <div class="flex items-start justify-between gap-3">
          <div class="flex items-center gap-2">
            <span class="inline-flex items-center justify-center w-10 h-10 rounded-xl bg-base-200">
              <i class="bi bi-calendar-check text-primary text-lg" aria-hidden="true"></i>
            </span>
            <div>
              <p class="text-xs uppercase tracking-wide text-base-content/60">Tasks today</p>
              <p class="text-2xl font-extrabold tabular-nums">{{ today_tasks_count|default:0 }}</p>
            </div>
          </div>
        </div>

        <div class="mt-3 space-y-2">
          <div class="flex items-center justify-between text-sm">
            <span class="text-base-content/70">Completed</span>
            <span class="font-semibold tabular-nums">{{ completed_today|default:0 }}</span>
          </div>
          <progress class="progress progress-primary w-full"
            value="{% if today_tasks_count %}{{ completed_today|mul:100|div:today_tasks_count }}{% else %}0{% endif %}"
            max="100"></progress>
        </div>
      </div>
    </div>

    <div class="card border border-base-200 bg-base-100">
      <div class="card-body p-5">
        <div class="flex items-center gap-2">
          <span class="inline-flex items-center justify-center w-10 h-10 rounded-xl bg-base-200">
            <i class="bi bi-fire text-primary text-lg" aria-hidden="true"></i>
          </span>
          <div>
            <p class="text-xs uppercase tracking-wide text-base-content/60">Streak</p>
            <p class="text-2xl font-extrabold tabular-nums">{{ current_streak|default:0 }}</p>
          </div>
        </div>
        <p class="mt-3 text-sm text-base-content/70">Keep it steady—small wins daily.</p>
      </div>
    </div>

    <div class="card border border-base-200 bg-base-100">
      <div class="card-body p-5">
        <div class="flex items-center gap-2">
          <span class="inline-flex items-center justify-center w-10 h-10 rounded-xl bg-base-200">
            <i class="bi bi-activity text-primary text-lg" aria-hidden="true"></i>
          </span>
          <div>
            <p class="text-xs uppercase tracking-wide text-base-content/60">This month</p>
            <p class="text-2xl font-extrabold tabular-nums" id="logs-this-month">{{ logs_this_month|default:0 }}</p>
          </div>
        </div>
        <p class="mt-3 text-sm text-base-content/70">Activity logs recorded.</p>
      </div>
    </div>

    <div class="card border border-base-200 bg-base-100">
      <div class="card-body p-5">
        <div class="flex items-center gap-2">
          <span class="inline-flex items-center justify-center w-10 h-10 rounded-xl bg-base-200">
            <i class="bi bi-stopwatch text-primary text-lg" aria-hidden="true"></i>
          </span>
          <div>
            <p class="text-xs uppercase tracking-wide text-base-content/60">Total time</p>
            <p class="text-2xl font-extrabold tabular-nums">{{ total_time|default:0 }}</p>
          </div>
        </div>
        <p class="mt-3 text-sm text-base-content/70">Minutes tracked.</p>
      </div>
    </div>
  </section>

  <!-- Weekly chart -->
  <section class="card border border-base-200 bg-base-100" aria-label="Weekly overview">
    <div class="card-body p-5 sm:p-6">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
        <div>
          <h2 class="text-lg font-bold flex items-center gap-2">
            <i class="bi bi-graph-up" aria-hidden="true"></i>
            <span>Weekly progress</span>
          </h2>
          <p class="text-sm text-base-content/70 mt-1">Minutes logged over the last 7 days.</p>
        </div>
        <span class="badge badge-primary badge-outline">Last 7 days</span>
      </div>

      {% if weekly_overview %}
      <div class="mt-4 p-4 rounded-2xl border border-base-200 bg-base-100">
        <div class="chart-wrap">
          <canvas id="weeklyChart" class="w-full" aria-label="Weekly minutes chart" role="img"></canvas>
        </div>
      </div>
      {% else %}
      <div class="mt-4 p-6 rounded-2xl border border-base-200 bg-base-200/40 text-center">
        <p class="text-sm text-base-content/70">No weekly data yet.</p>
        <a href="{% url 'log_create' %}" class="btn btn-primary btn-sm mt-3 gap-2">
          <i class="bi bi-plus-circle" aria-hidden="true"></i>
          <span>Log an activity</span>
        </a>
      </div>
      {% endif %}
    </div>
  </section>

  <!-- Goals + Calendar -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

    <!-- Goals -->
    <section class="card border border-base-200 bg-base-100" aria-label="Goals">
      <div class="card-body p-5 sm:p-6">
        <h2 class="text-lg font-bold flex items-center gap-2">
          <i class="bi bi-trophy" aria-hidden="true"></i>
          <span>Daily goals</span>
        </h2>
        <p class="text-sm text-base-content/70 mt-1">Simple targets to keep you consistent.</p>

        <div class="mt-4 space-y-4">
          <div class="p-4 rounded-2xl border border-base-200 bg-base-100">
            <div class="flex items-center justify-between gap-3">
              <div class="flex items-center gap-2">
                <i class="bi bi-stopwatch text-primary" aria-hidden="true"></i>
                <span class="font-semibold text-sm">Time goal</span>
              </div>
              <span class="text-sm font-bold tabular-nums">{{ today_time|default:0 }}/60 min</span>
            </div>
            <progress class="progress progress-primary w-full mt-3"
              value="{% if today_time|default:0 > 60 %}100{% else %}{{ today_time|default:0|mul:100|div:60 }}{% endif %}"
              max="100"></progress>
            <p class="mt-2 text-xs text-base-content/70">
              {% widthratio today_time 60 100 %}% complete
            </p>
          </div>

          <div class="p-4 rounded-2xl border border-base-200 bg-base-100">
            <div class="flex items-center justify-between gap-3">
              <div class="flex items-center gap-2">
                <i class="bi bi-check-circle text-primary" aria-hidden="true"></i>
                <span class="font-semibold text-sm">Tasks goal</span>
              </div>
              <span class="text-sm font-bold tabular-nums">{{ completed_today|default:0 }}/5 tasks</span>
            </div>
            <progress class="progress progress-primary w-full mt-3"
              value="{% if completed_today|default:0 > 5 %}100{% else %}{{ completed_today|default:0|mul:100|div:5 }}{% endif %}"
              max="100"></progress>
            <p class="mt-2 text-xs text-base-content/70">
              {% widthratio completed_today 5 100 %}% complete
            </p>
          </div>
        </div>
      </div>
    </section>

    <!-- Calendar -->
    <section class="card border border-base-200 bg-base-100" aria-label="Calendar">
      <div class="card-body p-5 sm:p-6">
        <div class="flex items-start justify-between gap-3">
          <div>
            <h2 class="text-lg font-bold flex items-center gap-2">
              <i class="bi bi-calendar" aria-hidden="true"></i>
              <span id="calendar-month-year">{{ month_name }} {{ selected_year }}</span>
            </h2>
            <p class="text-sm text-base-content/70 mt-1">Select a day for the summary.</p>
          </div>

          <div class="flex gap-2">
            <button id="prev-month-btn"
                    class="cal-nav btn btn-circle btn-outline btn-sm"
                    data-year="{{ prev_year }}" data-month="{{ prev_month }}"
                    aria-label="Previous month">
              <i class="bi bi-chevron-left" aria-hidden="true"></i>
            </button>
            <button id="next-month-btn"
                    class="cal-nav btn btn-circle btn-outline btn-sm"
                    data-year="{{ next_year }}" data-month="{{ next_month }}"
                    aria-label="Next month">
              <i class="bi bi-chevron-right" aria-hidden="true"></i>
            </button>
          </div>
        </div>

        <div class="mt-4 p-4 rounded-2xl border border-base-200 bg-base-100" id="calendar-grid">
          <div class="grid grid-cols-7 gap-2 text-center mb-3">
            {% for day_name in day_names %}
              <div class="text-xs font-semibold text-base-content/70 py-2">{{ day_name }}</div>
            {% endfor %}
          </div>

          <div class="grid grid-cols-7 gap-2">
            {% for day in calendar_days %}
              {% if day.logged %}
                <a href="{% url 'daily_summary' day.date.year day.date.month day.date.day %}"
                   class="cal-day cal-day--active"
                   aria-label="View summary for {{ day.date|date:'F j, Y' }} (active day)">
                  <span>{{ day.day }}</span>
                </a>
              {% elif day.is_future %}
                <div class="cal-day cal-day--future" aria-label="{{ day.date|date:'F j, Y' }} (future day)">
                  <span>{{ day.day }}</span>
                </div>
              {% else %}
                <a href="{% url 'daily_summary' day.date.year day.date.month day.date.day %}"
                   class="cal-day"
                   aria-label="View summary for {{ day.date|date:'F j, Y' }}">
                  <span>{{ day.day }}</span>
                </a>
              {% endif %}
            {% endfor %}
          </div>
        </div>

        <div class="mt-4 flex flex-wrap items-center justify-center gap-4 text-sm text-base-content/70">
          <span class="inline-flex items-center gap-2">
            <span class="legend-dot" style="background: rgb(29 78 216 / .55)"></span> Active
          </span>
          <span class="inline-flex items-center gap-2">
            <span class="legend-dot" style="background: rgba(226,232,240,1)"></span> Inactive
          </span>
          <span class="inline-flex items-center gap-2">
            <span class="legend-dot" style="background: rgba(226,232,240,.6)"></span> Future
          </span>
        </div>
      </div>
    </section>
  </div>

  <!-- Category breakdown -->
  {% if category_data %}
  <section class="card border border-base-200 bg-base-100" aria-label="Category breakdown">
    <div class="card-body p-5 sm:p-6">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
        <div>
          <h2 class="text-lg font-bold flex items-center gap-2">
            <i class="bi bi-pie-chart" aria-hidden="true"></i>
            <span>Time distribution</span>
          </h2>
          <p class="text-sm text-base-content/70 mt-1">Minutes by category (weekly).</p>
        </div>
        <span class="badge badge-outline">Weekly</span>
      </div>

      <div class="mt-4 grid grid-cols-1 lg:grid-cols-2 gap-6 items-start">
        <div class="p-4 rounded-2xl border border-base-200 bg-base-100">
          <div class="chart-wrap" style="height: 320px;">
            <canvas id="categoryChart" class="w-full" aria-label="Category distribution chart" role="img"></canvas>
          </div>
        </div>

        <div class="space-y-3">
          {% for item in category_data %}
          <div class="p-4 rounded-2xl border border-base-200 bg-base-100">
            <div class="flex items-center justify-between gap-3">
              <span class="font-semibold">{{ item.name }}</span>
              <span class="font-bold tabular-nums">{{ item.value }} min</span>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </section>
  {% endif %}

</main>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{{ weekly_overview|json_script:"weekly-data" }}
{{ category_data|json_script:"category-data" }}

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Global: improve contrast using theme values (no fancy animations)
  Chart.defaults.color = 'rgba(15, 23, 42, 0.75)'; // slate-900-ish
  Chart.defaults.font.family = 'system-ui, -apple-system, Segoe UI, Roboto, sans-serif';

  const weeklyData = JSON.parse(document.getElementById('weekly-data').textContent || '[]');
  if (weeklyData.length > 0) {
    const ctx = document.getElementById('weeklyChart').getContext('2d');
    const labels = weeklyData.map(d => d.label);
    const data = weeklyData.map(d => d.minutes);

    new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [{
          label: 'Minutes logged',
          data,
          borderColor: 'rgb(29, 78, 216)',          // accessible blue
          backgroundColor: 'rgba(29, 78, 216, 0.10)',
          borderWidth: 2,
          fill: true,
          tension: 0.35,
          pointRadius: 3,
          pointHoverRadius: 5
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { intersect: false, mode: 'index' },
        plugins: {
          legend: { display: false },
          tooltip: {
            displayColors: false,
            callbacks: {
              label: (context) => `${context.parsed.y} minutes`
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: { callback: (v) => `${v}m` },
            grid: { color: 'rgba(15, 23, 42, 0.08)' }
          },
          x: {
            grid: { color: 'rgba(15, 23, 42, 0.08)' }
          }
        },
        animation: false
      }
    });
  }

  const categoryData = JSON.parse(document.getElementById('category-data').textContent || '[]');
  if (categoryData.length > 0) {
    const labels = categoryData.map(i => i.name);
    const values = categoryData.map(i => i.value);
    const ctx2 = document.getElementById('categoryChart').getContext('2d');

    // Color set: distinct + readable (avoid very light colours)
    const colors = [
      'rgba(29, 78, 216, 0.85)',  // blue
      'rgba(17, 94, 89, 0.85)',   // teal
      'rgba(21, 128, 61, 0.85)',  // green
      'rgba(161, 98, 7, 0.85)',   // amber
      'rgba(185, 28, 28, 0.85)',  // red
      'rgba(91, 33, 182, 0.85)'   // purple
    ];

    new Chart(ctx2, {
      type: 'doughnut',
      data: {
        labels,
        datasets: [{
          data: values,
          backgroundColor: labels.map((_, i) => colors[i % colors.length]),
          borderColor: '#ffffff',
          borderWidth: 2,
          hoverOffset: 6
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        cutout: '62%',
        plugins: {
          legend: {
            position: 'bottom',
            labels: { boxWidth: 10, usePointStyle: true, padding: 16 }
          },
          tooltip: {
            callbacks: {
              label: (context) => {
                const total = context.dataset.data.reduce((a,b) => a + b, 0);
                const pct = total ? ((context.parsed / total) * 100).toFixed(1) : '0.0';
                return `${context.label}: ${context.parsed} min (${pct}%)`;
              }
            }
          }
        },
        animation: false
      }
    });
  }
});
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const prevBtn = document.getElementById('prev-month-btn');
  const nextBtn = document.getElementById('next-month-btn');
  const monthYearDisplay = document.getElementById('calendar-month-year');
  const calendarGrid = document.getElementById('calendar-grid');
  const logsThisMonthStat = document.getElementById('logs-this-month');

  function setNavLoading(isLoading) {
    prevBtn.disabled = isLoading;
    nextBtn.disabled = isLoading;
    prevBtn.innerHTML = isLoading ? '<i class="bi bi-arrow-repeat"></i>' : '<i class="bi bi-chevron-left"></i>';
    nextBtn.innerHTML = isLoading ? '<i class="bi bi-arrow-repeat"></i>' : '<i class="bi bi-chevron-right"></i>';
  }

  function updateCalendar(year, month) {
    setNavLoading(true);

    fetch(`{% url 'analytics' %}?year=${year}&month=${month}`, {
      method: 'GET',
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(r => r.json())
    .then(data => {
      monthYearDisplay.textContent = `${data.month_name} ${data.selected_year}`;

      prevBtn.setAttribute('data-year', data.prev_year);
      prevBtn.setAttribute('data-month', data.prev_month);
      nextBtn.setAttribute('data-year', data.next_year);
      nextBtn.setAttribute('data-month', data.next_month);

      // Rebuild calendar markup (same structure: day names row + 7-col grid)
      let html = '';
      html += '<div class="grid grid-cols-7 gap-2 text-center mb-3">';
      data.day_names.forEach(dayName => {
        html += `<div class="text-xs font-semibold text-base-content/70 py-2">${dayName}</div>`;
      });
      html += '</div><div class="grid grid-cols-7 gap-2">';

      data.calendar_days.forEach(day => {
        const date = new Date(day.date);
        const y = date.getFullYear();
        const m = date.getMonth() + 1;
        const d = date.getDate();
        const dailyUrl = `{% url 'daily_summary' 0 0 0 %}`.replace('0/0/0', `${y}/${m}/${d}`);

        if (day.logged) {
          html += `<a href="${dailyUrl}" class="cal-day cal-day--active" aria-label="View summary for ${date.toDateString()} (active day)">${day.day}</a>`;
        } else if (day.is_future) {
          html += `<div class="cal-day cal-day--future" aria-label="${date.toDateString()} (future day)">${day.day}</div>`;
        } else {
          html += `<a href="${dailyUrl}" class="cal-day" aria-label="View summary for ${date.toDateString()}">${day.day}</a>`;
        }
      });

      html += '</div>';
      calendarGrid.innerHTML = html;

      if (logsThisMonthStat) logsThisMonthStat.textContent = data.logs_this_month;

      const url = new URL(window.location);
      url.searchParams.set('year', data.selected_year);
      url.searchParams.set('month', data.selected_month);
      window.history.pushState({}, '', url);
    })
    .catch(err => console.error('Error updating calendar:', err))
    .finally(() => setNavLoading(false));
  }

  prevBtn.addEventListener('click', function() {
    updateCalendar(this.getAttribute('data-year'), this.getAttribute('data-month'));
  });

  nextBtn.addEventListener('click', function() {
    updateCalendar(this.getAttribute('data-year'), this.getAttribute('data-month'));
  });
});
</script>
{% endblock %}
