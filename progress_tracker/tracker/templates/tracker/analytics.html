{% extends "tracker/base.html" %}
{% load static %}


{% block title %}Analytics ‚Äì Progress Insights{% endblock %}

{% block extra_head %}
<style>
  /* ===== SYSTEM-DEFINED COLORS ===== */
  :root {
    /* Light Mode Colors (iOS/macOS) */
    --system-bg-primary: #F2F2F7;
    --system-bg-secondary: #FFFFFF;
    --system-bg-tertiary: #E5E5EA;
    --system-text-primary: #000000;
    --system-text-secondary: #3C3C43;
    --system-text-tertiary: #8E8E93;
    --system-blue: #007AFF;
    --system-green: #34C759;
    --system-orange: #FF9500;
    --system-red: #FF3B30;
    --system-purple: #AF52DE;
    --system-border: #D1D1D6;
    --system-shadow: rgba(0, 0, 0, 0.1);
  }

  @media (prefers-color-scheme: dark) {
    :root {
      /* Dark Mode Colors (iOS/macOS) */
      --system-bg-primary: #000000;
      --system-bg-secondary: #1C1C1E;
      --system-bg-tertiary: #2C2C2E;
      --system-text-primary: #FFFFFF;
      --system-text-secondary: #EBEBF5;
      --system-text-tertiary: #8E8E93;
      --system-blue: #0A84FF;
      --system-green: #30D158;
      --system-orange: #FF9F0A;
      --system-red: #FF453A;
      --system-purple: #BF5AF2;
      --system-border: #38383A;
      --system-shadow: rgba(0, 0, 0, 0.3);
    }
  }

  /* Apply system colors to DaisyUI components */
  .stat {
    color: var(--system-text-primary);
  }
  
  .stat-title {
    color: var(--system-text-tertiary);
  }
  
  .stat-desc {
    color: var(--system-text-secondary);
  }
  
  .btn {
    background-color: var(--system-bg-tertiary);
    color: var(--system-text-primary);
    border-color: var(--system-border);
  }
  
  .btn:hover {
    background-color: var(--system-bg-primary);
  }
  
  .btn-sm {
    font-size: 0.875rem;
  }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen px-4 py-6" style="background: linear-gradient(135deg, var(--system-bg-primary) 0%, var(--system-bg-tertiary) 100%);">

  <!-- ================= HEADER ================= -->
  <div class="max-w-7xl mx-auto mb-8">
    <h1 class="text-3xl md:text-4xl font-black mb-2" style="color: var(--system-text-primary);">
      üìä Progress Analytics
    </h1>
    <p style="color: var(--system-text-secondary);">
      Insightful breakdown of your productivity, habits, and progress.
    </p>
  </div>

  <!-- ================= KEY METRICS ================= -->
  <div class="max-w-7xl mx-auto grid grid-cols-2 md:grid-cols-4 gap-4 mb-10">
    <div class="stat rounded-2xl shadow" style="background: var(--system-bg-secondary); box-shadow: 0 4px 6px var(--system-shadow);">
      <div class="stat-title">Tasks Today</div>
      <div class="stat-value" style="color: var(--system-blue);">{{ today_tasks_count }}</div>
      <div class="stat-desc">
        {{ tasks_trend }}% vs yesterday
      </div>
    </div>

    <div class="stat rounded-2xl shadow" style="background: var(--system-bg-secondary); box-shadow: 0 4px 6px var(--system-shadow);">
      <div class="stat-title">Minutes Today</div>
      <div class="stat-value" style="color: var(--system-purple);">{{ today_time }}</div>
      <div class="stat-desc">
        Avg/day: {{ avg_daily_minutes }} min
      </div>
    </div>

    <div class="stat rounded-2xl shadow" style="background: var(--system-bg-secondary); box-shadow: 0 4px 6px var(--system-shadow);">
      <div class="stat-title">Current Streak</div>
      <div class="stat-value" style="color: var(--system-green);">{{ current_streak }} üî•</div>
      <div class="stat-desc">
        Best: {{ best_streak }} days
      </div>
    </div>

    <div class="stat rounded-2xl shadow" style="background: var(--system-bg-secondary); box-shadow: 0 4px 6px var(--system-shadow);">
      <div class="stat-title">This Month</div>
      <div class="stat-value" style="color: var(--system-orange);">{{ logs_this_month }}</div>
      <div class="stat-desc">
        {{ month_trend }}% vs last month
      </div>
    </div>
  </div>

  <!-- ================= WEEKLY LINE CHART ================= -->
  <div class="max-w-7xl mx-auto rounded-3xl shadow-xl p-6 mb-10" style="background: var(--system-bg-secondary); box-shadow: 0 8px 20px var(--system-shadow);">
    <h2 class="text-xl font-bold mb-4" style="color: var(--system-text-primary);">Weekly Activity</h2>
    <canvas id="weeklyChart" height="90"></canvas>
  </div>

  <!-- ================= CATEGORY + TASK CHARTS ================= -->
  <div class="max-w-7xl mx-auto grid md:grid-cols-2 gap-6 mb-10">
    <div class="rounded-3xl shadow-xl p-6" style="background: var(--system-bg-secondary); box-shadow: 0 8px 20px var(--system-shadow);">
      <h2 class="text-xl font-bold mb-4" style="color: var(--system-text-primary);">Time by Category</h2>
      <canvas id="categoryChart"></canvas>
    </div>

    <div class="rounded-3xl shadow-xl p-6" style="background: var(--system-bg-secondary); box-shadow: 0 8px 20px var(--system-shadow);">
      <h2 class="text-xl font-bold mb-4" style="color: var(--system-text-primary);">Top Tasks (Weekly)</h2>
      <canvas id="taskChart"></canvas>
    </div>
  </div>

  <!-- ================= CALENDAR HEATMAP ================= -->
  <div class="max-w-7xl mx-auto rounded-3xl shadow-xl p-6 mb-10" style="background: var(--system-bg-secondary); box-shadow: 0 8px 20px var(--system-shadow);">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-xl font-bold" style="color: var(--system-text-primary);">{{ month_name }} {{ selected_year }}</h2>
      <div class="flex gap-2">
        <a href="?month={{ prev_month }}&year={{ prev_year }}" class="btn btn-sm">‚Üê</a>
        <a href="?month={{ next_month }}&year={{ next_year }}" class="btn btn-sm">‚Üí</a>
      </div>
    </div>

    <div class="grid grid-cols-7 gap-2 text-center mb-2">
      {% for d in day_names %}
        <div class="text-xs font-semibold" style="color: var(--system-text-tertiary);">{{ d }}</div>
      {% endfor %}
    </div>

    <div class="grid grid-cols-7 gap-2">
      {% for day in calendar_days %}
        {% if day.is_future %}
          <div
            class="aspect-square rounded-xl text-xs flex flex-col items-center justify-center cursor-not-allowed"
            style="background: var(--system-bg-tertiary); color: var(--system-text-tertiary); opacity: 0.5;"
            title="Future date"
          >
            <div class="font-bold">{{ day.day }}</div>
          </div>
        {% else %}
          <a
            href="{% url 'daily_summary' day.date.year day.date.month day.date.day %}"
            class="aspect-square rounded-xl text-xs flex flex-col items-center justify-center transition-all duration-200 hover:scale-105 hover:shadow-lg cursor-pointer {% if day.is_today %} ring-2 {% endif %}"
            style="
              {% if day.intensity == 0 %}background: var(--system-bg-tertiary); color: var(--system-text-primary);
              {% elif day.intensity == 1 %}background: rgba(52, 199, 89, 0.2); color: var(--system-text-primary);
              {% elif day.intensity == 2 %}background: rgba(52, 199, 89, 0.4); color: var(--system-text-primary);
              {% elif day.intensity == 3 %}background: rgba(52, 199, 89, 0.6); color: #FFFFFF;
              {% elif day.intensity == 4 %}background: rgba(52, 199, 89, 0.8); color: #FFFFFF;
              {% elif day.intensity == 5 %}background: var(--system-green); color: #FFFFFF;
              {% endif %}
              {% if day.is_today %}border-color: var(--system-blue);{% endif %}
            "
            title="View details for {{ day.date|date:'F j, Y' }} ({{ day.minutes|default:0 }} minutes)"
          >
            <div class="font-bold">{{ day.day }}</div>
            {% if day.minutes %}
              <div>{{ day.minutes }}m</div>
            {% endif %}
          </a>
        {% endif %}
      {% endfor %}
    </div>
  </div>

  <!-- ================= INSIGHTS ================= -->
  <div class="max-w-7xl mx-auto grid md:grid-cols-3 gap-6 mb-12">
    <div class="rounded-2xl shadow p-5" style="background: var(--system-bg-secondary); box-shadow: 0 4px 6px var(--system-shadow);">
      <h3 class="font-bold mb-1" style="color: var(--system-text-primary);">Best Day</h3>
      {% if best_day %}
        <p style="color: var(--system-text-secondary);">{{ best_day.name }} ({{ best_day.minutes }} min avg)</p>
      {% else %}
        <p style="color: var(--system-text-tertiary);">Not enough data</p>
      {% endif %}
    </div>

    <div class="rounded-2xl shadow p-5" style="background: var(--system-bg-secondary); box-shadow: 0 4px 6px var(--system-shadow);">
      <h3 class="font-bold mb-1" style="color: var(--system-text-primary);">Most Productive Category</h3>
      {% if most_productive_category %}
        <p style="color: var(--system-text-secondary);">{{ most_productive_category.name }} ‚Äì {{ most_productive_category.value }} min</p>
      {% else %}
        <p style="color: var(--system-text-tertiary);">No data</p>
      {% endif %}
    </div>

    <div class="rounded-2xl shadow p-5" style="background: var(--system-bg-secondary); box-shadow: 0 4px 6px var(--system-shadow);">
      <h3 class="font-bold mb-1" style="color: var(--system-text-primary);">Weekly Completion</h3>
      <p style="color: var(--system-text-secondary);">{{ completion_rate_week }}% completed</p>
    </div>
  </div>
</div>

<!-- ================= DATA SCRIPTS ================= -->
{{ weekly_overview|json_script:"weeklyData" }}
{{ category_data|json_script:"categoryData" }}
{{ task_data|json_script:"taskData" }}


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  const weekly = JSON.parse("{{ weekly_overview|escapejs }}");
  const categories = JSON.parse("{{ category_data|escapejs }}");
  const tasks = JSON.parse("{{ task_data|escapejs }}");

  // Get system colors
  const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
  const systemBlue = getComputedStyle(document.documentElement).getPropertyValue('--system-blue').trim();
  const systemGreen = getComputedStyle(document.documentElement).getPropertyValue('--system-green').trim();
  const systemOrange = getComputedStyle(document.documentElement).getPropertyValue('--system-orange').trim();
  const systemRed = getComputedStyle(document.documentElement).getPropertyValue('--system-red').trim();
  const systemPurple = getComputedStyle(document.documentElement).getPropertyValue('--system-purple').trim();
  const textColor = getComputedStyle(document.documentElement).getPropertyValue('--system-text-primary').trim();
  const borderColor = getComputedStyle(document.documentElement).getPropertyValue('--system-border').trim();

  // Chart.js default colors
  Chart.defaults.color = textColor;
  Chart.defaults.borderColor = borderColor;

  new Chart(document.getElementById("weeklyChart"), {
    type: "line",
    data: {
      labels: weekly.map(d => d.label),
      datasets: [{
        label: "Minutes",
        data: weekly.map(d => d.minutes),
        tension: 0.4,
        fill: true,
        borderColor: systemBlue,
        backgroundColor: systemBlue + '40',
        pointBackgroundColor: systemBlue,
        pointBorderColor: '#fff',
        pointHoverBackgroundColor: '#fff',
        pointHoverBorderColor: systemBlue
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          labels: { color: textColor }
        }
      },
      scales: {
        y: {
          grid: { color: borderColor },
          ticks: { color: textColor }
        },
        x: {
          grid: { color: borderColor },
          ticks: { color: textColor }
        }
      }
    }
  });

  new Chart(document.getElementById("categoryChart"), {
    type: "doughnut",
    data: {
      labels: categories.map(c => c.name),
      datasets: [{
        data: categories.map(c => c.value),
        backgroundColor: [systemBlue, systemGreen, systemOrange, systemRed, systemPurple, '#5AC8FA', '#FFD60A'],
        borderWidth: 2,
        borderColor: isDark ? '#1C1C1E' : '#FFFFFF'
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          labels: { color: textColor }
        }
      }
    }
  });

  new Chart(document.getElementById("taskChart"), {
    type: "bar",
    data: {
      labels: tasks.map(t => t.name),
      datasets: [{
        data: tasks.map(t => t.value),
        backgroundColor: systemGreen,
        borderRadius: 6
      }]
    },
    options: {
      indexAxis: "y",
      responsive: true,
      plugins: {
        legend: { display: false }
      },
      scales: {
        y: {
          grid: { display: false },
          ticks: { color: textColor }
        },
        x: {
          grid: { color: borderColor },
          ticks: { color: textColor }
        }
      }
    }
  });

  // Update charts when theme changes
  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
    location.reload();
  });
</script>

{% endblock %}
