{% extends 'tracker/base.html' %}
{% block title %}Day Planner - VisMatrix{% endblock %}
{% block content %}
<style>
/* ===== ENHANCED DAY PLANNER - Uses base.html theme system ===== */
* { box-sizing: border-box; }

.planner-wrapper {
  max-width: 1400px;
  margin: 0 auto;
  padding: 24px;
}

/* ===== HEADER SECTION ===== */
.planner-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 24px;
  margin-bottom: 32px;
  padding: 24px;
  background: var(--surface);
  border-radius: var(--radius);
  border: 1px solid var(--border);
  box-shadow: 0 1px 3px rgb(0 0 0 / 0.05);
}

.header-left {
  display: flex;
  align-items: center;
  gap: 16px;
}

.planner-title {
  font-size: 28px;
  font-weight: 700;
  color: var(--text);
  margin: 0;
}

.date-badge {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 8px 16px;
  background: var(--primary);
  color: var(--primary-ink);
  border-radius: var(--radius);
  font-size: 14px;
  font-weight: 600;
}

.header-right {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
}

/* ===== BUTTON STYLES ===== */
.btn {
  padding: 10px 16px;
  border: none;
  border-radius: var(--rounded-btn);
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
  display: inline-flex;
  align-items: center;
  gap: 6px;
  white-space: nowrap;
}

.btn-primary {
  background: var(--primary);
  color: var(--primary-ink);
}

.btn-primary:hover {
  background: var(--primary-hover);
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgb(0 0 0 / 0.15);
}

.btn-secondary {
  background: var(--surface-2);
  color: var(--text);
  border: 1px solid var(--border);
}

.btn-secondary:hover {
  background: var(--surface);
  border-color: var(--primary);
}

.btn-success {
  background: var(--success);
  color: white;
}

.btn-success:hover {
  opacity: 0.9;
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgb(0 0 0 / 0.15);
}

.btn-sm {
  padding: 8px 12px;
  font-size: 13px;
}

.btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* ===== CONTROLS SECTION ===== */
.planner-controls {
  display: flex;
  gap: 12px;
  align-items: center;
  flex-wrap: wrap;
}

.date-picker-wrapper {
  position: relative;
}

.date-picker-wrapper input {
  padding: 10px 12px;
  border: 1px solid var(--border);
  border-radius: var(--rounded-btn);
  font-size: 14px;
  background: var(--surface);
  color: var(--text);
  cursor: pointer;
}

.date-picker-wrapper input:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: var(--focus);
}

.stats-display {
  display: flex;
  gap: 16px;
  margin-left: auto;
  padding: 0 16px;
  border-left: 1px solid var(--border);
}

.stat {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.stat-value {
  font-size: 18px;
  font-weight: 700;
  color: var(--text);
}

.stat-label {
  font-size: 12px;
  color: var(--muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

/* ===== PLANNER GRID ===== */
.planner-container {
  display: grid;
  grid-template-columns: 80px 1fr;
  border: 1px solid var(--border);
  border-radius: var(--radius);
  overflow-y: auto;
  overflow-x: hidden;
  background: var(--surface);
  box-shadow: 0 4px 12px rgb(0 0 0 / 0.08);
  height: 80vh;
  max-height: 1500px;
  touch-action: pan-y;
  -webkit-overflow-scrolling: touch;
  overscroll-behavior-y: contain;
  scroll-behavior: smooth;
}

.time-labels {
  background: var(--surface-2);
  border-right: 1px solid var(--border);
}

.hour-slot {
  height: 60px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  font-weight: 600;
  color: var(--muted);
  border-bottom: 1px solid var(--border);
}

.hour-slot:last-child {
  border-bottom: none;
}

.timeline {
  position: relative;
  background: var(--surface);
}

.timeline-grid {
  position: relative;
  height: 1440px; /* 24 hours * 60px */
  min-height: 100%;
}


.grid-line {
  position: absolute;
  left: 0;
  right: 0;
  height: 1px;
  background: var(--border);
  opacity: 0.5;
  pointer-events: none;
}

.working-hours-bg {
  position: absolute;
  left: 0;
  right: 0;
  background: var(--primary);
  opacity: 0.08;
  pointer-events: none;
  z-index: 1;
  border-top: 2px solid var(--primary);
  border-bottom: 2px solid var(--primary);
  border-opacity: 0.2;
}

.event-card {
  position: absolute;
  left: 5px;
  right: 5px;
  background: var(--primary);
  border: 1px solid rgba(0, 0, 0, 0.1);
  border-radius: var(--radius);
  padding: 12px 14px;
  cursor: move;
  color: white;
  overflow: visible;
  min-width: 200px;
  min-height: 50px;
  transition: all 0.2s ease;
  z-index: 15;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  box-shadow: 0 2px 6px rgb(0 0 0 / 0.1);
}



.event-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 20px rgb(0 0 0 / 0.15);
  z-index: 20;
}

.event-card.dragging {
  opacity: 0.85;
  cursor: grabbing;
  z-index: 30;
  box-shadow: 0 15px 35px rgb(0 0 0 / 0.25);
}

.event-card.conflict {
  background: var(--warning);
  border-color: rgba(0, 0, 0, 0.1);
}

.event-card.complete {
  opacity: 0.65;
  border-style: dashed;
  filter: grayscale(0.3);
}

.event-card.calendar-event {
  background: #8b5cf6;
  border-color: rgba(0, 0, 0, 0.1);
}

.event-card.calendar-event .event-badge {
  background: rgba(255, 255, 255, 0.2);
}

.event-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  gap: 8px;
  margin-bottom: 2px;
}

.event-title {
  font-weight: 700;
  font-size: 14px;
  flex: 1;
  line-height: 1.4;
  word-wrap: break-word;
  overflow: hidden;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
  letter-spacing: 0.2px;
  padding-right: 60px;
}

.event-badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 4px 8px;
  background: rgba(255, 255, 255, 0.25);
  border: 1px solid rgba(255, 255, 255, 0.3);
  border-radius: 12px;
  font-size: 10px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  white-space: nowrap;
  backdrop-filter: blur(4px);
}

.event-time {
  font-size: 12px;
  opacity: 0.95;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 6px;
  letter-spacing: 0.3px;
}

.event-time::before {
  content: 'üïê';
  font-size: 13px;
  opacity: 0.8;
}

.event-duration {
  font-size: 11px;
  opacity: 0.85;
  font-weight: 500;
  margin-left: auto;
  background: rgba(255, 255, 255, 0.15);
  padding: 2px 6px;
  border-radius: 4px;
}

.event-actions {
  position: absolute;
  top: 10px;
  right: 10px;
  display: flex;
  gap: 6px;
  opacity: 0.6;
  transition: opacity 0.2s, transform 0.2s;
}

.event-card:hover .event-actions {
  opacity: 1;
  transform: translateY(-1px);
}

.event-btn {
  background: rgba(255, 255, 255, 0.25);
  border: 1px solid rgba(255, 255, 255, 0.3);
  border-radius: 6px;
  padding: 6px 9px;
  cursor: pointer;
  font-size: 13px;
  color: white;
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  backdrop-filter: blur(4px);
  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
}

.event-btn:hover {
  background: rgba(255, 255, 255, 0.3);
  border-color: rgba(255, 255, 255, 0.4);
  transform: scale(1.05);
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
}
.event-btn:active {
  transform: scale(0.95);
}

/* ===== NOW LINE ===== */
.now-line {
  position: absolute;
  left: 0;
  right: 0;
  height: 3px;
  background: var(--error);
  z-index: 25;
  pointer-events: none;
  box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.15);
}

.now-line::before {
  content: '';
  position: absolute;
  left: -6px;
  top: -4px;
  width: 14px;
  height: 14px;
  border-radius: 50%;
  background: var(--error);
  border: 3px solid var(--surface);
  box-shadow: 0 2px 8px rgb(0 0 0 / 0.2);
}

/* ===== MODAL STYLES ===== */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.5);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 100;
  backdrop-filter: blur(2px);
}

.modal-overlay.active {
  display: flex;
  animation: fadeIn 0.2s ease;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.modal-content {
  background: var(--surface);
  padding: 32px;
  border-radius: var(--radius);
  width: 90%;
  max-width: 520px;
  box-shadow: 0 20px 50px rgb(0 0 0 / 0.3);
  border: 1px solid var(--border);
  animation: slideUp 0.3s ease;
}

@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 24px;
}

.modal-title {
  font-size: 20px;
  font-weight: 700;
  color: var(--text);
  margin: 0;
}

.modal-close {
  background: var(--surface-2);
  border: none;
  border-radius: var(--rounded-btn);
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  color: var(--muted);
  transition: all 0.2s ease;
}

.modal-close:hover {
  background: var(--border);
  color: var(--text);
}

/* ===== FORM STYLES ===== */
.form-group {
  margin-bottom: 20px;
}

.form-group label {
  display: block;
  margin-bottom: 8px;
  font-weight: 600;
  font-size: 14px;
  color: var(--text);
}

.form-group input,
.form-group textarea {
  width: 100%;
  padding: 12px;
  border: 1px solid var(--border);
  border-radius: var(--rounded-btn);
  background: var(--surface);
  color: var(--text);
  font-size: 14px;
  font-family: inherit;
  transition: all 0.2s ease;
}

.form-group input:focus,
.form-group textarea:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: var(--focus);
}

.form-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
}

.form-group textarea {
  resize: vertical;
  min-height: 80px;
}

.modal-actions {
  display: flex;
  gap: 12px;
  margin-top: 28px;
  justify-content: flex-end;
}

.btn-delete {
  background: rgba(239, 68, 68, 0.1);
  color: var(--error);
  margin-right: auto;
}

.btn-delete:hover {
  background: var(--error);
  color: white;
}

/* ===== RESPONSIVE ===== */
@media (max-width: 1024px) {
  .planner-header {
    flex-direction: column;
    align-items: flex-start;
  }

  .header-right {
    width: 100%;
  }

  .stats-display {
    border-left: none;
    border-top: 1px solid var(--border);
    padding-top: 12px;
    margin-left: 0;
    width: 100%;
  }

  .planner-container {
    grid-template-columns: 60px 1fr;
    max-height: 600px;
  }

  .event-card {
    font-size: 12px;
  }
}

@media (max-width: 768px) {
  .planner-wrapper {
    padding: 8px;
  }

  .planner-header {
    padding: 16px;
    gap: 16px;
  }

  .planner-title {
    font-size: 20px;
  }

  .date-badge {
    font-size: 12px;
    padding: 6px 12px;
  }

  .planner-controls {
    gap: 6px;
    flex-wrap: wrap;
  }

  .btn {
    padding: 8px 10px;
    font-size: 12px;
  }

  .btn-sm {
    padding: 6px 8px;
    font-size: 11px;
  }

  .stats-display {
    flex-direction: row;
    gap: 12px;
    width: 100%;
    padding: 12px 0 0 0;
    border-left: none;
    border-top: 1px solid var(--border);
    margin-left: 0;
  }

  .stat-value {
    font-size: 16px;
  }

  .stat-label {
    font-size: 10px;
  }

  .planner-container {
    grid-template-columns: 50px 1fr;
    max-height: 70vh;
  }

  .hour-slot {
    font-size: 10px;
    color: var(--muted);
  }

  .event-card {
    font-size: 11px;
    padding: 8px 10px;
    min-width: 120px;
    left: 2px;
    right: 2px;
  }

  .event-title {
    font-size: 12px;
    padding-right: 55px;
    white-space: nowrap;
    text-overflow: ellipsis;
    display: block;
    -webkit-line-clamp: unset;
    -webkit-box-orient: unset;
  }

  .event-badge {
    font-size: 9px;
    padding: 2px 6px;
  }

  .event-time {
    font-size: 10px;
  }

  .event-time::before {
    font-size: 11px;
  }

  .event-duration {
    font-size: 9px;
  }

  .event-actions {
    gap: 4px;
    top: 8px;
    right: 8px;
  }

  .event-btn {
    padding: 4px 6px;
    font-size: 12px;
  }

  .modal-content {
    width: 95%;
    padding: 20px;
    max-height: 90vh;
    overflow-y: auto;
  }

  .modal-title {
    font-size: 18px;
  }

  .form-grid {
    grid-template-columns: 1fr;
  }

  .form-group {
    margin-bottom: 16px;
  }

  .form-group label {
    font-size: 13px;
  }

  .form-group input,
  .form-group textarea {
    font-size: 16px; /* Prevent zoom on iOS */
    padding: 10px;
  }

  .modal-actions {
    flex-direction: column;
    gap: 8px;
  }

  .btn-delete {
    order: 3;
  }
}

/* ===== EXTRA SMALL SCREENS ===== */
@media (max-width: 480px) {
  .planner-wrapper {
    padding: 4px;
  }

  .planner-header {
    padding: 12px;
  }

  .header-left {
    flex-direction: column;
    align-items: flex-start;
    gap: 8px;
  }

  .planner-title {
    font-size: 18px;
  }

  .date-badge {
    font-size: 11px;
  }

  .planner-controls {
    width: 100%;
  }

  .planner-controls button {
    flex: 1;
    min-width: 60px;
  }

  .stats-display {
    padding: 8px 0 0 0;
  }

  .planner-container {
    grid-template-columns: 40px 1fr;
    max-height: 60vh;
  }

  .hour-slot {
    font-size: 9px;
  }

  .event-card {
    min-height: 40px;
  }

  .modal-content {
    padding: 16px;
  }
}
</style>

<div class="planner-wrapper">
  <!-- HEADER -->
  <div class="planner-header">
    <div class="header-left">
      <h1 class="planner-title">üìÖ Day Planner</h1>
      <span class="date-badge" id="dateDisplay"></span>
    </div>
    
    <div class="header-right">
      <div class="planner-controls">
        <button class="btn btn-secondary btn-sm" onclick="prevDay()" title="Previous day">‚Üê Prev</button>
        <button class="btn btn-secondary btn-sm" onclick="today()" title="Jump to today">Today</button>
        <button class="btn btn-secondary btn-sm" onclick="nextDay()" title="Next day">Next ‚Üí</button>
        
        <div class="date-picker-wrapper">
          <input type="date" id="datePicker" title="Pick a specific date">
        </div>
        
        <div class="stats-display">
          <div class="stat">
            <span class="stat-value" id="eventCount">0</span>
            <span class="stat-label">Events</span>
          </div>
          <div class="stat">
            <span class="stat-value" id="timeScheduled">0h</span>
            <span class="stat-label">Scheduled</span>
          </div>
        </div>
        
        <button class="btn btn-success btn-sm" onclick="newEvent()" title="Create new event">+ New Event</button>
        <button class="btn btn-primary btn-sm" onclick="autoSchedule()" title="Automatically schedule unscheduled tasks">ü§ñ Auto Schedule</button>
      </div>
    </div>
  </div>

  <!-- PLANNER GRID -->
  <div class="planner-container">
    <div class="time-labels" id="timeLabels"></div>
    <div class="timeline" id="timeline">
      <div class="timeline-grid" id="grid"></div>
    </div>
  </div>
</div>

<!-- EVENT MODAL -->
<div class="modal-overlay" id="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title" id="modalTitle">New Event</h3>
      <button class="modal-close" onclick="closeModal()">‚úï</button>
    </div>

    <div class="form-group">
      <label for="eventTitle">Event Title *</label>
      <input type="text" id="eventTitle" placeholder="Enter event title" autocomplete="off">
    </div>

    <div class="form-grid">
      <div class="form-group">
        <label for="eventStart">Start Time *</label>
        <input type="time" id="eventStart">
      </div>
      <div class="form-group">
        <label for="eventEnd">End Time *</label>
        <input type="time" id="eventEnd">
      </div>
    </div>

    <div class="form-group">
      <label for="eventDescription">Description</label>
      <textarea id="eventDescription" placeholder="Add notes or details (optional)"></textarea>
    </div>

    <div class="modal-actions">
      <button class="btn btn-delete btn-sm" id="deleteBtn" onclick="deleteEvent()" style="display:none;">üóëÔ∏è Delete</button>
      <button class="btn btn-secondary btn-sm" onclick="closeModal()">Cancel</button>
      <button class="btn btn-primary btn-sm" onclick="saveEvent()">Save Event</button>
    </div>
  </div>
</div>

<!-- AUTO-SCHEDULE MODAL -->
<div class="modal-overlay" id="autoScheduleModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title">ü§ñ Auto Schedule Tasks</h3>
      <button class="modal-close" onclick="closeAutoScheduleModal()">‚úï</button>
    </div>

    <p style="color: var(--text-secondary); margin-bottom: 20px; font-size: 14px;">
      Automatically schedule unscheduled tasks within your preferred time window.
    </p>

    <div class="form-grid">
      <div class="form-group">
        <label for="autoStartTime">Start Time *</label>
        <input type="time" id="autoStartTime" value="09:00">
      </div>
      <div class="form-group">
        <label for="autoEndTime">End Time *</label>
        <input type="time" id="autoEndTime" value="17:00">
      </div>
    </div>

    <div class="modal-actions">
      <button class="btn btn-secondary btn-sm" onclick="closeAutoScheduleModal()">Cancel</button>
      <button class="btn btn-primary btn-sm" onclick="executeAutoSchedule()">Schedule Tasks</button>
    </div>
  </div>
</div>

<!-- RESULT MODAL -->
<div class="modal-overlay" id="resultModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title" id="resultTitle">Result</h3>
      <button class="modal-close" onclick="closeResultModal()">‚úï</button>
    </div>

    <div id="resultMessage" style="padding: 20px 0; color: var(--text-secondary); line-height: 1.6;"></div>

    <div class="modal-actions">
      <button class="btn btn-primary btn-sm" onclick="closeResultModal()">OK</button>
    </div>
  </div>
</div>

<script>
const CSRF_TOKEN = '{{ csrf_token }}';
const HOUR_HEIGHT = 60;
let currentDate = new Date().toISOString().split('T')[0];
let events = [];
let editingId = null;
let dragState = null;

// Initialize
function init() {
  renderTimeLabels();
  renderGrid();
  syncDateUI();
  loadEvents();
  updateNowLine();
  setInterval(updateNowLine, 60000);
  
  // Date picker
  document.getElementById('datePicker').addEventListener('change', (e) => {
    currentDate = e.target.value;
    loadEvents();
    syncDateUI();
  });
  
  // Timeline click to create
  document.getElementById('grid').addEventListener('click', (e) => {
    if (e.target === e.currentTarget || e.target.classList.contains('grid-line')) {
      const rect = e.currentTarget.getBoundingClientRect();
      const container = document.querySelector('.planner-container');
      const y = e.clientY - rect.top + container.scrollTop;
      const hour = Math.floor(y / HOUR_HEIGHT);
      const minutes = Math.round(((y % HOUR_HEIGHT) / HOUR_HEIGHT) * 60 / 15) * 15;
      newEvent(hour * 60 + minutes);
    }
  });

  // Close modal on escape
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      closeModal();
      closeAutoScheduleModal();
      closeResultModal();
    }
  });
}

function renderTimeLabels() {
  const container = document.getElementById('timeLabels');
  for (let h = 0; h < 24; h++) {
    const div = document.createElement('div');
    div.className = 'hour-slot';
    div.textContent = h.toString().padStart(2, '0') + ':00';
    container.appendChild(div);
  }
}

function renderGrid() {
  const grid = document.getElementById('grid');
  
  // Add working hours background (9am to 5pm)
  const workingHoursBg = document.createElement('div');
  workingHoursBg.className = 'working-hours-bg';
  workingHoursBg.style.top = (9 * HOUR_HEIGHT) + 'px'; // 9am
  workingHoursBg.style.height = (8 * HOUR_HEIGHT) + 'px'; // 8 hours (9am-5pm)
  grid.appendChild(workingHoursBg);
  
  // Add grid lines
  for (let h = 0; h <= 24; h++) {
    const line = document.createElement('div');
    line.className = 'grid-line';
    line.style.top = (h * HOUR_HEIGHT) + 'px';
    grid.appendChild(line);
  }
}

function syncDateUI() {
  document.getElementById('datePicker').value = currentDate;
  const d = new Date(currentDate + 'T12:00:00');
  const today = new Date().toISOString().split('T')[0];
  const isToday = currentDate === today;
  
  document.getElementById('dateDisplay').textContent = 
    isToday ? 'üìç Today' : d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
}

function prevDay() {
  const d = new Date(currentDate);
  d.setDate(d.getDate() - 1);
  currentDate = d.toISOString().split('T')[0];
  loadEvents();
  syncDateUI();
}

function nextDay() {
  const d = new Date(currentDate);
  d.setDate(d.getDate() + 1);
  currentDate = d.toISOString().split('T')[0];
  loadEvents();
  syncDateUI();
}

function today() {
  currentDate = new Date().toISOString().split('T')[0];
  loadEvents();
  syncDateUI();
  scrollToNow();
}

function scrollToNow() {
  const now = new Date();
  const mins = now.getHours() * 60 + now.getMinutes();
  const y = (mins / 60) * HOUR_HEIGHT;
  document.querySelector('.planner-container').scrollTop = Math.max(0, y - 200);
}

function updateNowLine() {
  const today = new Date().toISOString().split('T')[0];
  if (currentDate !== today) return;
  
  const now = new Date();
  const mins = now.getHours() * 60 + now.getMinutes();
  const y = (mins / 60) * HOUR_HEIGHT;
  
  let line = document.querySelector('.now-line');
  if (!line) {
    line = document.createElement('div');
    line.className = 'now-line';
    document.getElementById('grid').appendChild(line);
  }
  line.style.top = y + 'px';
}

async function loadEvents() {
  try {
    const r = await fetch(`/api/day-schedule/${currentDate}/`, {
      headers: { 'X-CSRFToken': CSRF_TOKEN }
    });
    const data = await r.json();
    if (data.success) {
      events = data.events || [];
      render();
    }
  } catch (e) {
    console.error('Load failed:', e);
  }
}

async function saveToServer() {
  try {
    await fetch('/api/day-schedule/save/', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRF_TOKEN },
      body: JSON.stringify({ date: currentDate, events: events.filter(e => !e.isCalendarEvent) })
    });
  } catch (e) {
    console.error('Save failed:', e);
  }
}

function render() {
  document.querySelectorAll('.event-card').forEach(el => el.remove());
  
  const grid = document.getElementById('grid');
  events.forEach(ev => {
    const card = document.createElement('div');
    card.className = 'event-card';
    if (ev.isCalendarEvent) card.classList.add('calendar-event');
    if (ev.complete) card.classList.add('complete');
    card.dataset.id = ev.id;
    card.style.top = ((ev.startMin / 60) * HOUR_HEIGHT) + 'px';
    card.style.height = (((ev.endMin - ev.startMin) / 60) * HOUR_HEIGHT) + 'px';
    
    const header = document.createElement('div');
    header.className = 'event-header';
    
    const title = document.createElement('div');
    title.className = 'event-title';
    title.textContent = ev.title;
    
    const badge = document.createElement('span');
    badge.className = 'event-badge';
    badge.textContent = ev.isCalendarEvent ? 'üìÜ Cal' : '‚úèÔ∏è Custom';
    
    header.appendChild(title);
    header.appendChild(badge);
    
    const time = document.createElement('div');
    time.className = 'event-time';
    const duration = ev.endMin - ev.startMin;
    const durationText = duration >= 60 
      ? `${Math.floor(duration / 60)}h ${duration % 60}m`
      : `${duration}m`;
    time.innerHTML = `
      ${formatTime(ev.startMin)} - ${formatTime(ev.endMin)}
      <span class="event-duration">${durationText}</span>
    `;
    
    const actions = document.createElement('div');
    actions.className = 'event-actions';
    actions.innerHTML = `
      <button class="event-btn" onclick="editEvent('${ev.id}'); event.stopPropagation();" title="Edit">‚úèÔ∏è</button>
      <button class="event-btn" onclick="quickDelete('${ev.id}'); event.stopPropagation();" title="Delete">üóëÔ∏è</button>
    `;
    
    card.appendChild(header);
    card.appendChild(time);
    card.appendChild(actions);
    
    if (!ev.isCalendarEvent) {
      card.addEventListener('mousedown', startDrag);
      card.addEventListener('touchstart', startDrag, { passive: false });
    }
    
    grid.appendChild(card);
  });
  
  updateStats();
}

function updateStats() {
  const count = events.length;
  const total = events.reduce((sum, ev) => sum + (ev.endMin - ev.startMin), 0);
  const hours = Math.floor(total / 60);
  
  document.getElementById('eventCount').textContent = count;
  document.getElementById('timeScheduled').textContent = hours + 'h';
}

function startDrag(e) {
  const card = e.currentTarget;
  const id = card.dataset.id;
  const event = events.find(ev => ev.id === id);
  if (!event || event.isCalendarEvent) return;
  
  // Support both mouse and touch events
  const startClientY = e.type === 'touchstart' ? e.touches[0].clientY : e.clientY;
  
  const rect = card.getBoundingClientRect();
  const container = document.querySelector('.planner-container');
  const grid = document.getElementById('grid');
  
  // Track if drag has actually started (threshold-based)
  let isDragging = false;
  const DRAG_THRESHOLD = 10; // pixels
  
  dragState = {
    id,
    offsetY: startClientY - rect.top,
    origStartMin: event.startMin,
    origEndMin: event.endMin,
    startY: startClientY
  };
  
  const onMove = (e) => {
    if (!dragState) return;
    
    // Support both mouse and touch events
    const moveY = e.type === 'touchmove' ? e.touches[0].clientY : e.clientY;
    
    // Check if we've moved enough to start dragging
    if (!isDragging) {
      const distance = Math.abs(moveY - dragState.startY);
      if (distance < DRAG_THRESHOLD) {
        // Not moved enough yet, allow scrolling
        return;
      }
      // Threshold exceeded, start dragging
      isDragging = true;
      card.classList.add('dragging');
    }
    
    // Now we're actually dragging, prevent scrolling
    if (e.type === 'touchmove') {
      e.preventDefault();
    }
    
    // Calculate position relative to the grid, accounting for scroll
    const containerRect = container.getBoundingClientRect();
    const y = moveY - containerRect.top + container.scrollTop - dragState.offsetY;
    const mins = Math.round((y / HOUR_HEIGHT) * 60 / 15) * 15;
    const duration = dragState.origEndMin - dragState.origStartMin;
    
    const newStart = Math.max(0, Math.min(1440 - duration, mins));
    const newEnd = newStart + duration;
    
    const ev = events.find(e => e.id === dragState.id);
    if (ev) {
      ev.startMin = newStart;
      ev.endMin = newEnd;
      card.style.top = ((newStart / 60) * HOUR_HEIGHT) + 'px';
      const timeDisplay = card.querySelector('.event-time');
      if (timeDisplay) {
        timeDisplay.innerHTML = `
          ${formatTime(newStart)} - ${formatTime(newEnd)}
          <span class="event-duration">${duration >= 60 ? Math.floor(duration / 60) + 'h ' + (duration % 60) + 'm' : duration + 'm'}</span>
        `;
      }
    }
  };
  
  const onUp = () => {
    if (dragState) {
      if (isDragging) {
        // Only save if we actually dragged
        saveToServer();
        updateStats();
      }
      card.classList.remove('dragging');
      dragState = null;
      isDragging = false;
    }
    document.removeEventListener('mousemove', onMove);
    document.removeEventListener('mouseup', onUp);
    document.removeEventListener('touchmove', onMove);
    document.removeEventListener('touchend', onUp);
  };
  
  document.addEventListener('mousemove', onMove);
  document.addEventListener('mouseup', onUp);
  document.addEventListener('touchmove', onMove, { passive: false });
  document.addEventListener('touchend', onUp);
  
  // Don't prevent default on initial touch - allow scrolling
  if (e.type === 'mousedown') {
    e.preventDefault();
  }
}

function formatTime(mins) {
  const h = Math.floor(mins / 60);
  const m = mins % 60;
  return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
}

function newEvent(startMin = null) {
  editingId = null;
  document.getElementById('modalTitle').textContent = 'New Event';
  document.getElementById('deleteBtn').style.display = 'none';
  
  if (startMin === null) {
    const now = new Date();
    startMin = now.getHours() * 60 + Math.round(now.getMinutes() / 15) * 15;
  }
  
  document.getElementById('eventTitle').value = '';
  document.getElementById('eventDescription').value = '';
  document.getElementById('eventStart').value = formatTime(startMin);
  document.getElementById('eventEnd').value = formatTime(Math.min(1440, startMin + 60));
  
  document.getElementById('modal').classList.add('active');
  document.getElementById('eventTitle').focus();
}

function editEvent(id) {
  const ev = events.find(e => e.id === id);
  if (!ev) return;
  
  editingId = id;
  document.getElementById('modalTitle').textContent = 'Edit Event';
  document.getElementById('deleteBtn').style.display = 'block';
  
  document.getElementById('eventTitle').value = ev.title;
  document.getElementById('eventDescription').value = ev.description || '';
  document.getElementById('eventStart').value = formatTime(ev.startMin);
  document.getElementById('eventEnd').value = formatTime(ev.endMin);
  
  document.getElementById('modal').classList.add('active');
  document.getElementById('eventTitle').focus();
}

function saveEvent() {
  const title = document.getElementById('eventTitle').value.trim();
  if (!title) {
    showResult('‚ö†Ô∏è Validation Error', 'Please enter an event title.', false);
    return;
  }
  
  const startTime = document.getElementById('eventStart').value;
  const endTime = document.getElementById('eventEnd').value;
  const [sh, sm] = startTime.split(':').map(Number);
  const [eh, em] = endTime.split(':').map(Number);
  const startMin = sh * 60 + sm;
  const endMin = eh * 60 + em;
  
  if (endMin <= startMin) {
    showResult('‚ö†Ô∏è Validation Error', 'End time must be after start time.', false);
    return;
  }
  
  if (editingId) {
    const ev = events.find(e => e.id === editingId);
    if (ev) {
      ev.title = title;
      ev.startMin = startMin;
      ev.endMin = endMin;
      ev.description = document.getElementById('eventDescription').value;
    }
  } else {
    events.push({
      id: 'evt_' + Date.now() + '_' + Math.random().toString(36).slice(2),
      title,
      startMin,
      endMin,
      description: document.getElementById('eventDescription').value,
      logged: false
    });
  }
  
  closeModal();
  render();
  saveToServer();
}

function deleteEvent() {
  if (!editingId || !confirm('Delete this event?')) return;
  events = events.filter(e => e.id !== editingId);
  closeModal();
  render();
  saveToServer();
}

function quickDelete(id) {
  if (confirm('Delete this event?')) {
    events = events.filter(e => e.id !== id);
    render();
    saveToServer();
  }
}

async function autoSchedule() {
  document.getElementById('autoScheduleModal').classList.add('active');
}

function closeAutoScheduleModal() {
  document.getElementById('autoScheduleModal').classList.remove('active');
}

async function executeAutoSchedule() {
  const startTime = document.getElementById('autoStartTime').value;
  const endTime = document.getElementById('autoEndTime').value;
  
  if (!startTime || !endTime) {
    showResult('Error', 'Please enter both start and end times.', false);
    return;
  }
  
  const [sh, sm] = startTime.split(':').map(Number);
  const [eh, em] = endTime.split(':').map(Number);
  const startMin = sh * 60 + sm;
  const endMin = eh * 60 + em;
  
  if (endMin <= startMin) {
    showResult('Error', 'End time must be after start time.', false);
    return;
  }
  
  closeAutoScheduleModal();
  
  try {
    const response = await fetch('/api/day-schedule/smart-schedule/', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRF_TOKEN },
      body: JSON.stringify({
        date: currentDate,
        start_time: startTime,
        end_time: endTime,
        existing_events: events.filter(e => !e.isCalendarEvent).map(e => ({
          id: e.id,
          title: e.title,
          start_minutes: e.startMin,
          end_minutes: e.endMin
        }))
      })
    });
    
    const data = await response.json();
    
    if (data.success) {
      // Merge auto-scheduled events with existing calendar events
      const calendarEvents = events.filter(e => e.isCalendarEvent);
      events = [...calendarEvents, ...data.events.map(e => ({
        id: e.id || 'evt_' + Date.now() + '_' + Math.random().toString(36).slice(2),
        title: e.title,
        startMin: e.startMin,
        endMin: e.endMin,
        logged: false,
        isCalendarEvent: false
      }))];
      
      render();
      saveToServer();
      
      const message = `Successfully scheduled ${data.events.length} task${data.events.length !== 1 ? 's' : ''}!${data.message ? '\n\n' + data.message : ''}`;
      showResult('‚úÖ Success', message, true);
    } else {
      showResult('‚ùå Error', 'Auto-scheduling failed: ' + (data.error || 'Unknown error'), false);
    }
  } catch (error) {
    console.error('Auto-schedule error:', error);
    showResult('‚ùå Error', 'Failed to auto-schedule. Please try again.', false);
  }
}

function showResult(title, message, isSuccess) {
  document.getElementById('resultTitle').textContent = title;
  document.getElementById('resultMessage').innerHTML = message.replace(/\n/g, '<br>');
  document.getElementById('resultModal').classList.add('active');
}

function closeResultModal() {
  document.getElementById('resultModal').classList.remove('active');
}

function closeModal() {
  document.getElementById('modal').classList.remove('active');
  editingId = null;
}

document.addEventListener('DOMContentLoaded', init);
</script>

{% endblock %}