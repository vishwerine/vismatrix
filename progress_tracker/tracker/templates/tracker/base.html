{% load static %}
<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="description" content="VisMatrix - Track your progress with friends">
  <meta name="theme-color" content="#1d4ed8">
  <meta name="csrf-token" content="{{ csrf_token }}">
  <title>{% block title %}VisMatrix.Space{% endblock %}</title>

  <!-- Icons -->
  <link rel="icon" type="image/png" href="{% static 'branding/vismatrixicon.png' %}">

  <!-- Tailwind + DaisyUI (CDN OK for now) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

  <!-- THEME BOOTSTRAP (before paint) -->
  <script>
    (function () {
      const key = 'vm_theme';
      const saved = localStorage.getItem(key);
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      const theme = saved || (prefersDark ? 'dark' : 'light');
      document.documentElement.setAttribute('data-theme', theme);
    })();
  </script>

  <!-- DESIGN TOKENS ONLY -->
  <style>
    :root {
      --radius: 14px;
      --font: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      --focus: 0 0 0 3px rgb(29 78 216 / .3);
    }

    body {
      font-family: var(--font);
      -webkit-font-smoothing: antialiased;
      background-color: hsl(var(--b1));
      color: hsl(var(--bc));
    }

    :focus-visible {
      outline: none;
      box-shadow: var(--focus);
      border-radius: 10px;
    }
  </style>
</head>

<body class="min-h-screen flex flex-col">

<!-- ================= NAVBAR ================= -->
<nav class="navbar bg-base-100 sticky top-0 z-50 border-b border-base-300">
  <div class="flex-1">
    <a href="{% url 'dashboard' %}" class="flex items-center gap-3 font-black">
      <img src="{% static 'branding/vismatrixicon.png' %}" class="w-9 h-9 rounded-xl">
      VisMatrix<span class="text-primary">.space</span>
    </a>
  </div>

  <div class="hidden lg:flex gap-1">
    <a href="{% url 'dashboard' %}" class="btn btn-ghost btn-sm {% if request.resolver_match.url_name == 'dashboard' %}btn-active{% endif %}">
      <i class="bi bi-bar-chart"></i> Dashboard
    </a>
    <a href="{% url 'day_planner' %}" class="btn btn-ghost btn-sm {% if request.resolver_match.url_name == 'day_planner' %}btn-active{% endif %}">
      <i class="bi bi-calendar-check"></i> Day Planner
    </a>
    <a href="{% url 'analytics' %}" class="btn btn-ghost btn-sm {% if request.resolver_match.url_name == 'analytics' %}btn-active{% endif %}">
      <i class="bi bi-graph-up"></i> Analytics
    </a>
  </div>

  {% if user.is_authenticated %}
  <!-- DaisyUI handles dropdown -->
  <div class="dropdown dropdown-end">
    <label tabindex="0" class="btn btn-ghost btn-circle avatar">
      <div class="w-10 rounded-full bg-primary text-primary-content flex items-center justify-center font-bold">
        {{ user.username|first|upper }}
      </div>
    </label>

    <ul tabindex="0" class="dropdown-content menu p-2 shadow bg-base-100 rounded-box w-64">
      <li class="menu-title">Hi, {{ user.username }}</li>

      <li>
        <button id="themeToggleBtn">
          <i class="bi bi-moon-stars"></i>
          <span id="themeToggleText">Dark mode</span>
        </button>
      </li>

      <div class="divider"></div>

      <li><a href="{% url 'profile_settings' %}"><i class="bi bi-person"></i> Profile</a></li>
      <li><a href="{% url 'about' %}"><i class="bi bi-info-circle"></i> About</a></li>
      <li><a href="/accounts/logout/" class="text-error"><i class="bi bi-box-arrow-right"></i> Logout</a></li>
    </ul>
  </div>
  {% else %}
  <a href="/accounts/login/" class="btn btn-primary btn-sm">
    <i class="bi bi-box-arrow-in-right"></i> Login
  </a>
  {% endif %}
</nav>

<!-- ================= MAIN ================= -->
<main class="flex-1 w-full max-w-7xl mx-auto px-4 py-6">
  {% if messages %}
  <div class="toast toast-top toast-center">
    {% for message in messages %}
    <div class="alert alert-{{ message.tags|default:'info' }}">
      {{ message }}
    </div>
    {% endfor %}
  </div>
  {% endif %}

  {% block content %}{% endblock %}
</main>

<!-- ================= THEME TOGGLE ================= -->
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const btn = document.getElementById('themeToggleBtn');
    if (!btn) return;

    const html = document.documentElement;
    const label = document.getElementById('themeToggleText');

    const apply = (t) => {
      html.setAttribute('data-theme', t);
      localStorage.setItem('vm_theme', t);
      if (label) label.textContent = t === 'dark' ? 'Light mode' : 'Dark mode';
    };

    apply(html.getAttribute('data-theme'));

    btn.addEventListener('click', (e) => {
      e.preventDefault();
      const next = html.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
      apply(next);
    });
  });
</script>

</body>
</html>
