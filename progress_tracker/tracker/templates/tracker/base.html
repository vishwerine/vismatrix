{% load static %}
{% load ad_tags %}
<!DOCTYPE html>
<html lang="en" data-theme="light" class="scroll-smooth">
<head>
  <meta charset="UTF-8">

  <meta name="google-adsense-account" content="ca-pub-7653466283203958">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="description" content="VisMatrix - Track your progress with friends">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="theme-color" content="#1d4ed8">
  <meta name="csrf-token" content="{{ csrf_token }}">
  <title>{% block title %}VisMatrix.Space{% endblock %}</title>

  <link rel="icon" type="image/png" href="{% static 'branding/vismatrixicon.png' %}">

  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

  <!-- Google AdSense -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7653466283203958"
       crossorigin="anonymous"></script>
  
  <script>
    (function () {
      const saved = localStorage.getItem('vm_theme');
      const theme = saved || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
      document.documentElement.setAttribute('data-theme', theme);
    })();
  </script>

  <style>
    :root {
      --radius-app: 1rem;
    }
    
    /* Light Mode - Minimalistic Color Scheme */
    [data-theme="light"] {
      color-scheme: light;
      --b1: #ffffff;          /* Base/Background */
      --b2: #f8f9fb;          /* Secondary background */
      --b3: #eff2f7;          /* Tertiary background */
      --bc: #0f172a;          /* Base content (text) */
      --primary: #1d4ed8;     /* Primary blue */
      --primary-focus: #1e40af;
      --primary-content: #ffffff;
      --secondary: #0d9488;   /* Teal secondary */
      --secondary-focus: #0f766e;
      --secondary-content: #ffffff;
      --accent: #f59e0b;      /* Amber accent */
      --accent-focus: #d97706;
      --accent-content: #ffffff;
      --info: #3b82f6;        /* Info blue */
      --success: #10b981;     /* Success green */
      --warning: #f59e0b;     /* Warning amber */
      --error: #ef4444;       /* Error red */
      --border: #e2e8f0;      /* Border color */
      --surface: #ffffff;     /* Card surface */
      --surface-2: #f1f5f9;   /* Card hover surface */
      --text: #0f172a;        /* Primary text */
      --muted: #64748b;       /* Muted text */
    }

    /* Light mode dropdown - increased opacity */
    [data-theme="light"] .dropdown-content {
      background-color: rgba(255, 255, 255, 0.98);
      border-color: #e2e8f0;
      backdrop-filter: blur(8px);
    }

    [data-theme="light"] .dropdown-content li a {
      color: #0f172a;
    }

    [data-theme="light"] .dropdown-content li a:hover {
      background-color: rgba(29, 78, 216, 0.1);
      color: #1d4ed8;
    }

    /* Dark Mode - Sophisticated Color Scheme */
    [data-theme="dark"] {
      color-scheme: dark;
      --b1: #1a1f36;          /* Base/Background (dark navy) */
      --b2: #242b3f;          /* Secondary background */
      --b3: #2d3548;          /* Tertiary background */
      --bc: #e0e7ff;          /* Base content (text - soft off-white) */
      --primary: #818cf8;     /* Primary indigo (vibrant but not harsh) */
      --primary-focus: #6366f1;
      --primary-content: #f8fafc;
      --secondary: #2dd4bf;   /* Secondary cyan (vibrant) */
      --secondary-focus: #14b8a6;
      --secondary-content: #f8fafc;
      --accent: #fb923c;      /* Accent orange (warm) */
      --accent-focus: #f97316;
      --accent-content: #1a1f36;
      --info: #60a5fa;        /* Info blue */
      --success: #4ade80;     /* Success green */
      --warning: #fbbf24;     /* Warning amber */
      --error: #f87171;       /* Error red */
      --border: #3f46e6;      /* Border - subtle indigo */
      --surface: #242b3f;     /* Card surface */
      --surface-2: #2d3548;   /* Card hover surface */
      --text: #e0e7ff;        /* Primary text - light indigo */
      --muted: #a5b4fc;       /* Muted text - medium indigo */
    }

    /* Ensure text visibility in dark mode */
    [data-theme="dark"] body {
      background-color: #242b3f;
      color: #e0e7ff;
    }

    [data-theme="dark"] {
      background-color: #1a1f36;
      color: #e0e7ff;
    }

    [data-theme="dark"] .card,
    [data-theme="dark"] .card-body {
      background-color: #242b3f;
      color: #e0e7ff;
      border-color: #3f46e6;
    }

    [data-theme="dark"] .input,
    [data-theme="dark"] .input-bordered,
    [data-theme="dark"] .textarea,
    [data-theme="dark"] .textarea-bordered,
    [data-theme="dark"] .select,
    [data-theme="dark"] .select-bordered {
      background-color: #2d3548;
      border-color: #3f46e6;
      color: #e0e7ff;
    }

    [data-theme="dark"] .input::placeholder,
    [data-theme="dark"] .textarea::placeholder {
      color: #a5b4fc;
    }

    [data-theme="dark"] .menu a,
    [data-theme="dark"] .menu li {
      color: #e0e7ff;
    }

    [data-theme="dark"] .menu a:hover {
      background-color: rgba(129, 140, 248, 0.15);
      color: #818cf8;
    }

    [data-theme="dark"] .menu a.active {
      background-color: rgba(129, 140, 248, 0.2);
      color: #818cf8;
    }

    [data-theme="dark"] .btn-ghost {
      color: #e0e7ff;
    }

    [data-theme="dark"] .btn-ghost:hover {
      background-color: #2d3548;
      color: #818cf8;
    }

    [data-theme="dark"] .btn-outline {
      border-color: #3f46e6;
      color: #e0e7ff;
    }

    [data-theme="dark"] .btn-outline:hover {
      background-color: #818cf8;
      border-color: #818cf8;
      color: #1a1f36;
    }

    [data-theme="dark"] .dropdown-content {
      background-color: #1a1f36;
      border-color: #3f46e6;
    }

    [data-theme="dark"] .dropdown-content li a {
      color: #e0e7ff;
    }

    [data-theme="dark"] .dropdown-content li a:hover {
      background-color: rgba(129, 140, 248, 0.15);
      color: #818cf8;
    }

    [data-theme="dark"] .badge {
      background-color: #2d3548;
      color: #e0e7ff;
    }

    [data-theme="dark"] .badge-primary {
      background-color: rgba(129, 140, 248, 0.2);
      color: #818cf8;
    }

    [data-theme="dark"] .badge-warning {
      background-color: rgba(251, 146, 60, 0.2);
      color: #fb923c;
    }

    [data-theme="dark"] .badge-success {
      background-color: rgba(74, 222, 128, 0.2);
      color: #4ade80;
    }

    [data-theme="dark"] .divider {
      background-image: linear-gradient(to right, #3f46e6, #3f46e6, #3f46e6);
      color: #a5b4fc;
    }

    [data-theme="dark"] .menu-title {
      color: #a5b4fc;
    }

    [data-theme="dark"] .indicator {
      color: #e0e7ff;
    }

    [data-theme="dark"] h1,
    [data-theme="dark"] h2,
    [data-theme="dark"] h3,
    [data-theme="dark"] h4,
    [data-theme="dark"] h5,
    [data-theme="dark"] h6 {
      color: #e0e7ff;
    }

    [data-theme="dark"] a {
      color: #818cf8;
    }

    [data-theme="dark"] a:hover {
      color: #6366f1;
    }

    [data-theme="dark"] .link {
      color: #818cf8;
    }

    [data-theme="dark"] .link:hover {
      color: #6366f1;
    }

    [data-theme="dark"] p,
    [data-theme="dark"] span,
    [data-theme="dark"] div {
      color: #e0e7ff;
    }

    body {
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      transition: background-color 0.3s ease, color 0.3s ease;
      background-color: hsl(var(--b2));
      color: hsl(var(--text));
    }

    /* Apply theme colors to DaisyUI components */
    .btn-primary {
      background-color: hsl(var(--primary));
      border-color: hsl(var(--primary));
      color: hsl(var(--primary-content));
    }

    .btn-primary:hover {
      background-color: hsl(var(--primary-focus));
      border-color: hsl(var(--primary-focus));
    }

    .btn-secondary {
      background-color: hsl(var(--secondary));
      border-color: hsl(var(--secondary));
      color: hsl(var(--secondary-content));
    }

    .btn-secondary:hover {
      background-color: hsl(var(--secondary-focus));
      border-color: hsl(var(--secondary-focus));
    }

    .badge-primary {
      background-color: hsl(var(--primary) / 0.15);
      color: hsl(var(--primary));
    }

    .badge-warning {
      background-color: hsl(var(--warning) / 0.15);
      color: hsl(var(--warning));
    }

    .badge-success {
      background-color: hsl(var(--success) / 0.15);
      color: hsl(var(--success));
    }

    .card, .input, .textarea, .select {
      background-color: hsl(var(--surface));
      border-color: hsl(var(--border));
      color: hsl(var(--text));
    }

    .card:hover {
      background-color: hsl(var(--surface-2));
    }

    .input:focus, .textarea:focus, .select:focus {
      border-color: hsl(var(--primary));
      outline-color: hsl(var(--primary) / 0.5);
    }
    
    body {
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      /* Smooth transitions for theme switching */
      transition: background-color 0.3s ease, color 0.3s ease;
      background-color: hsl(var(--b2)); /* Slightly darker background for better card contrast */
    }

    /* Modern Glass Effect */
    .glass-nav {
      background: hsla(var(--b1) / 0.85) !important;
      border-bottom-color: hsl(var(--border));
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }

    /* Custom Scrollbar */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: hsl(var(--b2)); }
    ::-webkit-scrollbar-thumb { 
      background: hsl(var(--primary) / 0.3); 
      border-radius: 10px; 
    }

    ::-webkit-scrollbar-thumb:hover {
      background: hsl(var(--primary) / 0.5);
    }

    /* App-like feel for mobile */
    @media (max-width: 1024px) {
      .btm-nav {
        padding-bottom: env(safe-area-inset-bottom);
        height: calc(4rem + env(safe-area-inset-bottom));
        background-color: hsl(var(--b1));
        border-top-color: hsl(var(--border));
      }
      main { padding-bottom: 6rem; }
    }

    /* Loading Bar Animation */
    #page-loader {
      position: fixed;
      top: 0; left: 0; right: 0;
      height: 3px;
      z-index: 9999;
      background: linear-gradient(to right, hsl(var(--primary)), hsl(var(--accent)));
      transform: translateX(-100%);
      transition: transform 0.4s ease;
    }

    /* Minimalist focus states */
    .input-bordered:focus, .textarea-bordered:focus, .select-bordered:focus {
      border-color: hsl(var(--primary));
      box-shadow: 0 0 0 3px hsl(var(--primary) / 0.1);
    }

    /* Menu styling */
    .menu a:hover {
      background-color: hsl(var(--primary) / 0.1);
    }

    .menu a.active {
      background-color: hsl(var(--primary) / 0.15);
      color: hsl(var(--primary));
    }

    /* Dropdown styling */
    .dropdown-content {
      background-color: hsl(var(--b1));
      border-color: hsl(var(--border));
    }

    /* Alert styling */
    .alert-info {
      background-color: hsl(var(--info) / 0.1);
      border-color: hsl(var(--info) / 0.3);
      color: hsl(var(--text));
    }

    .alert-success {
      background-color: hsl(var(--success) / 0.1);
      border-color: hsl(var(--success) / 0.3);
      color: hsl(var(--text));
    }

    .alert-warning {
      background-color: hsl(var(--warning) / 0.1);
      border-color: hsl(var(--warning) / 0.3);
      color: hsl(var(--text));
    }

    .alert-error {
      background-color: hsl(var(--error) / 0.1);
      border-color: hsl(var(--error) / 0.3);
      color: hsl(var(--text));
    }
  </style>
  
  {% block extra_head %}{% endblock %}
</head>

<body class="min-h-screen flex flex-col transition-colors duration-300">
  <div id="page-loader"></div>

  <header class="navbar glass-nav sticky top-0 z-[60] border-b border-base-content/5 px-4 md:px-8">
    <div class="navbar-start">
      <a href="{% url 'landing_page' %}" class="flex items-center gap-3 hover:opacity-80 transition-all active:scale-95">
        <div class="avatar">
          <div class="w-10 h-10 rounded-xl shadow-lg shadow-primary/20">
            <img src="{% static 'branding/vismatrixicon.png' %}" alt="Logo">
          </div>
        </div>
        <span class="font-black text-xl tracking-tight hidden sm:block">
          VisMatrix<span class="text-primary">.space</span>
        </span>
      </a>
    </div>

    <div class="navbar-center hidden lg:flex">
      <ul class="menu menu-horizontal px-1 gap-1">
        <li><a href="{% url 'dashboard' %}" class="{% if request.resolver_match.url_name == 'dashboard' %}active{% endif %} rounded-lg"><i class="bi bi-grid-1x2"></i> Dashboard</a></li>
        <li><a href="{% url 'analytics' %}" class="{% if request.resolver_match.url_name == 'analytics' %}active{% endif %} rounded-lg"><i class="bi bi-bar-chart"></i> Analytics</a></li>
        <li><a href="{% url 'plan_list' %}" class="{% if request.resolver_match.url_name == 'plan_list' %}active{% endif %} rounded-lg"><i class="bi bi-diagram-3"></i> Plans</a></li>
        <li><a href="{% url 'day_planner' %}" class="{% if request.resolver_match.url_name == 'day_planner' %}active{% endif %} rounded-lg"><i class="bi bi-calendar-event"></i> Day Planner</a></li>
        <li><a href="{% url 'blog_list' %}" class="{% if 'blog' in request.resolver_match.url_name %}active{% endif %} rounded-lg"><i class="bi bi-journal-text"></i> Blog</a></li>
        <li><a href="{% url 'friends_list' %}" class="{% if request.resolver_match.url_name == 'friends_list' %}active{% endif %} rounded-lg">Friends</a></li>
        
        <!-- Pro Features Menu -->
        {% if user_subscription.is_pro %}
        <li>
          <details>
            <summary class="rounded-lg">
              <i class="bi bi-star-fill text-warning"></i> Pro
            </summary>
            <ul class="p-2 bg-base-100 rounded-box shadow-xl border border-base-200 w-56">
              <li><a href="{% url 'pro_dashboard' %}" class="gap-3"><i class="bi bi-speedometer2"></i> Pro Dashboard</a></li>
              <li><a href="{% url 'advanced_analytics' %}" class="gap-3"><i class="bi bi-graph-up-arrow"></i> Advanced Analytics</a></li>
              <li class="menu-title text-xs opacity-50 px-3 py-2">Quick Actions</li>
              <li><a href="{% url 'export_data_csv' %}?type=tasks" class="gap-3"><i class="bi bi-download"></i> Export Tasks</a></li>
              <li><a href="{% url 'export_data_csv' %}?type=logs" class="gap-3"><i class="bi bi-clock-history"></i> Export Logs</a></li>
            </ul>
          </details>
        </li>
        {% endif %}
      </ul>
    </div>

    <div class="navbar-end gap-2">
      {% if user.is_authenticated %}
        <a href="{% url 'notifications_list' %}" class="btn btn-ghost btn-circle">
          <div class="indicator">
            <i class="bi bi-bell text-lg"></i>
            {% if unread_app_notifications_count > 0 %}
              <span class="badge badge-xs badge-primary indicator-item"></span>
            {% endif %}
          </div>
        </a>

        <div class="dropdown dropdown-end">
          <div tabindex="0" role="button" class="btn btn-ghost btn-circle avatar border border-primary/20">
            <div class="w-10 rounded-full bg-primary text-primary-content flex items-center justify-center">
              <span class="text-lg">{{ user.username|first|upper }}</span>
            </div>
          </div>
          <ul tabindex="0" class="mt-3 z-[1] p-2 shadow-2xl menu menu-sm dropdown-content bg-base-100 rounded-2xl w-56 border border-base-content/5">
            <li class="menu-title px-4 py-2 opacity-60">Account</li>
            <li><a href="{% url 'profile_settings' %}" class="py-3"><i class="bi bi-person text-lg"></i> Profile</a></li>
            <li>
              <a href="{% url 'subscription_plans' %}" class="py-3 justify-between">
                <span class="flex items-center gap-2"><i class="bi bi-star"></i> Subscription</span>
                {% if user_subscription.is_pro %}
                  <span class="badge badge-primary badge-sm">Pro</span>
                {% else %}
                  <span class="badge badge-ghost badge-sm">Free</span>
                {% endif %}
              </a>
            </li>
            <li>
                <button id="themeToggleBtn" class="py-3 justify-between">
                    <span class="flex items-center gap-2"><i class="bi bi-moon-stars"></i> Appearance</span>
                    <span class="badge badge-sm" id="themeToggleText">Light</span>
                </button>
            </li>
            {% if user.is_staff %}
            <div class="divider my-0"></div>
            <li class="menu-title px-4 py-2 opacity-60">Admin</li>
            <li><a href="{% url 'new_users_tracking' %}" class="py-3"><i class="bi bi-people"></i> New Users Tracking</a></li>
            <li><a href="{% url 'landing_analytics' %}" class="py-3"><i class="bi bi-graph-up"></i> Landing Analytics</a></li>
            {% endif %}
            <div class="divider my-0"></div>
            <li class="menu-title px-4 py-2 opacity-60">Legal</li>
            <li><a href="{% url 'privacy_policy' %}" class="py-3"><i class="bi bi-shield-check"></i> Privacy Policy</a></li>
            <li><a href="{% url 'terms_of_service' %}" class="py-3"><i class="bi bi-file-text"></i> Terms & Conditions</a></li>
            <div class="divider my-0"></div>
            <li><a href="/accounts/logout/" class="text-error py-3"><i class="bi bi-box-arrow-right"></i> Logout</a></li>
          </ul>
        </div>
      {% else %}
        <a href="/accounts/login/" class="btn btn-primary btn-sm md:btn-md rounded-xl">Login</a>
      {% endif %}
    </div>
  </header>

  <main class="flex-1 w-full max-w-7xl mx-auto px-4 sm:px-6 py-6 transition-all duration-500">
    {% block content %}{% endblock %}
  </main>

  {% if user.is_authenticated %}
  <!-- Mini Chat Widget -->
  {% include 'tracker/includes/mini_chat_widget.html' %}

  <nav class="btm-nav lg:hidden glass-nav border-t border-base-content/5 shadow-[0_-5px_20px_rgba(0,0,0,0.05)]">
    <a href="{% url 'dashboard' %}" class="{% if request.resolver_match.url_name == 'dashboard' %}active text-primary{% endif %}">
      <i class="bi bi-grid-1x2 text-xl"></i>
      <span class="btm-nav-label text-[10px] font-bold">Dashboard</span>
    </a>
    <a href="{% url 'analytics' %}" class="{% if request.resolver_match.url_name == 'analytics' %}active text-primary{% endif %}">
      <i class="bi bi-bar-chart text-xl"></i>
      <span class="btm-nav-label text-[10px] font-bold">Analytics</span>
    </a>
    <a href="{% url 'day_planner' %}" class="{% if request.resolver_match.url_name == 'day_planner' %}active text-primary{% endif %}">
      <i class="bi bi-calendar3 text-xl"></i>
      <span class="btm-nav-label text-[10px] font-bold">Planner</span>
    </a>
    <a href="{% url 'plan_list' %}" class="{% if request.resolver_match.url_name == 'plan_list' %}active text-primary{% endif %}">
      <i class="bi bi-diagram-3 text-xl"></i>
      <span class="btm-nav-label text-[10px] font-bold">Plans</span>
    </a>
    <a href="{% url 'friends_list' %}" class="{% if request.resolver_match.url_name == 'friends_list' %}active text-primary{% endif %}">
      <i class="bi bi-people text-xl"></i>
      <span class="btm-nav-label text-[10px] font-bold">Friends</span>
    </a>
  </nav>
  {% endif %}

  <script>
    // Theme Switcher Logic
    const themeToggleBtn = document.getElementById('themeToggleBtn');
    const themeToggleText = document.getElementById('themeToggleText');
    const htmlEl = document.documentElement;

    const updateThemeUI = (theme) => {
        themeToggleText.textContent = theme.charAt(0).toUpperCase() + theme.slice(1);
        themeToggleText.className = theme === 'dark' ? 'badge badge-primary badge-sm' : 'badge badge-outline badge-sm';
    };

    if (themeToggleBtn) {
        themeToggleBtn.addEventListener('click', () => {
            const currentTheme = htmlEl.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            htmlEl.setAttribute('data-theme', newTheme);
            localStorage.setItem('vm_theme', newTheme);
            updateThemeUI(newTheme);
        });
        // Initial UI state
        updateThemeUI(htmlEl.getAttribute('data-theme'));
    }

    // Profile Dropdown Toggle - Click avatar again to close
    const profileDropdownBtn = document.querySelector('.dropdown-end [tabindex="0"]');
    const profileDropdownMenu = document.querySelector('.dropdown-end .dropdown-content');
    
    if (profileDropdownBtn && profileDropdownMenu) {
        let isOpen = false;
        
        profileDropdownBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            if (isOpen) {
                profileDropdownBtn.blur();
                isOpen = false;
            } else {
                isOpen = true;
            }
        });
        
        // Close when clicking outside
        document.addEventListener('click', (e) => {
            if (isOpen && !profileDropdownBtn.contains(e.target) && !profileDropdownMenu.contains(e.target)) {
                profileDropdownBtn.blur();
                isOpen = false;
            }
        });
        
        // Track when dropdown loses focus
        profileDropdownBtn.addEventListener('blur', () => {
            setTimeout(() => {
                if (!profileDropdownMenu.matches(':hover')) {
                    isOpen = false;
                }
            }, 100);
        });
    }

    // Page Loader Simulation (on link clicks)
    window.addEventListener('beforeunload', () => {
        document.getElementById('page-loader').style.transform = 'translateX(-20%)';
    });
    
    // Auto-hide messages after 5 seconds
    setTimeout(() => {
        const alerts = document.querySelectorAll('.alert');
        alerts.forEach(a => {
            a.classList.add('opacity-0', 'transition-opacity', 'duration-500');
            setTimeout(() => a.remove(), 500);
        });
    }, 5000);
  </script>
  
  {% block extra_js %}{% endblock %}
</body>
</html>