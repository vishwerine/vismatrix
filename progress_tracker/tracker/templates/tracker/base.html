{% load static %}
<!DOCTYPE html>
<html lang="en" data-theme="light" class="scroll-smooth">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="description" content="VisMatrix - Track your progress with friends">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="theme-color" content="#1d4ed8">
  <meta name="csrf-token" content="{{ csrf_token }}">
  <title>{% block title %}VisMatrix.Space{% endblock %}</title>

  <link rel="icon" type="image/png" href="{% static 'branding/vismatrixicon.png' %}">

  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

  <script>
    (function () {
      const saved = localStorage.getItem('vm_theme');
      const theme = saved || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
      document.documentElement.setAttribute('data-theme', theme);
    })();
  </script>

  <style>
    :root {
      --radius-app: 1rem;
    }
    
    body {
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      /* Smooth transitions for theme switching */
      transition: background-color 0.3s ease, color 0.3s ease;
      background-color: hsl(var(--b2)); /* Slightly darker background for better card contrast */
    }

    /* Modern Glass Effect */
    .glass-nav {
      background: hsla(var(--b1) / 0.8) !important;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }

    /* Custom Scrollbar */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { 
      background: hsl(var(--bc) / 0.2); 
      border-radius: 10px; 
    }

    /* App-like feel for mobile */
    @media (max-width: 1024px) {
      .btm-nav {
        padding-bottom: env(safe-area-inset-bottom);
        height: calc(4rem + env(safe-area-inset-bottom));
      }
      main { padding-bottom: 6rem; }
    }

    /* Loading Bar Animation */
    #page-loader {
      position: fixed;
      top: 0; left: 0; right: 0;
      height: 3px;
      z-index: 9999;
      background: linear-gradient(to right, #1d4ed8, #60a5fa);
      transform: translateX(-100%);
      transition: transform 0.4s ease;
    }
  </style>
  
  {% block extra_head %}{% endblock %}
</head>

<body class="min-h-screen flex flex-col transition-colors duration-300">
  <div id="page-loader"></div>

  <header class="navbar glass-nav sticky top-0 z-[60] border-b border-base-content/5 px-4 md:px-8">
    <div class="navbar-start">
      <a href="{% url 'landing_page' %}" class="flex items-center gap-3 hover:opacity-80 transition-all active:scale-95">
        <div class="avatar">
          <div class="w-10 h-10 rounded-xl shadow-lg shadow-primary/20">
            <img src="{% static 'branding/vismatrixicon.png' %}" alt="Logo">
          </div>
        </div>
        <span class="font-black text-xl tracking-tight hidden sm:block">
          VisMatrix<span class="text-primary">.space</span>
        </span>
      </a>
    </div>

    <div class="navbar-center hidden lg:flex">
      <ul class="menu menu-horizontal px-1 gap-1">
        <li><a href="{% url 'dashboard' %}" class="{% if request.resolver_match.url_name == 'dashboard' %}active{% endif %} rounded-lg"><i class="bi bi-grid-1x2"></i> Dashboard</a></li>
        <li><a href="{% url 'analytics' %}" class="{% if request.resolver_match.url_name == 'analytics' %}active{% endif %} rounded-lg"><i class="bi bi-bar-chart"></i> Analytics</a></li>
        <li><a href="{% url 'plan_list' %}" class="{% if request.resolver_match.url_name == 'plan_list' %}active{% endif %} rounded-lg"><i class="bi bi-diagram-3"></i> Plans</a></li>
        <li><a href="{% url 'day_planner' %}" class="{% if request.resolver_match.url_name == 'day_planner' %}active{% endif %} rounded-lg"><i class="bi bi-calendar-event"></i> Day Planner</a></li>
        <li><a href="{% url 'friends_list' %}" class="{% if request.resolver_match.url_name == 'friends_list' %}active{% endif %} rounded-lg">Friends</a></li>
      </ul>
    </div>

    <div class="navbar-end gap-2">
      {% if user.is_authenticated %}
        <a href="{% url 'notifications_list' %}" class="btn btn-ghost btn-circle">
          <div class="indicator">
            <i class="bi bi-bell text-lg"></i>
            {% if unread_app_notifications_count > 0 %}
              <span class="badge badge-xs badge-primary indicator-item"></span>
            {% endif %}
          </div>
        </a>

        <div class="dropdown dropdown-end">
          <div tabindex="0" role="button" class="btn btn-ghost btn-circle avatar border border-primary/20">
            <div class="w-10 rounded-full bg-primary text-primary-content flex items-center justify-center">
              <span class="text-lg">{{ user.username|first|upper }}</span>
            </div>
          </div>
          <ul tabindex="0" class="mt-3 z-[1] p-2 shadow-2xl menu menu-sm dropdown-content bg-base-100 rounded-2xl w-56 border border-base-content/5">
            <li class="menu-title px-4 py-2 opacity-60">Account</li>
            <li><a href="{% url 'profile_settings' %}" class="py-3"><i class="bi bi-person text-lg"></i> Profile</a></li>
            <li>
                <button id="themeToggleBtn" class="py-3 justify-between">
                    <span class="flex items-center gap-2"><i class="bi bi-moon-stars"></i> Appearance</span>
                    <span class="badge badge-sm" id="themeToggleText">Light</span>
                </button>
            </li>
            <div class="divider my-0"></div>
            <li class="menu-title px-4 py-2 opacity-60">Legal</li>
            <li><a href="{% url 'privacy_policy' %}" class="py-3"><i class="bi bi-shield-check"></i> Privacy Policy</a></li>
            <li><a href="{% url 'terms_of_service' %}" class="py-3"><i class="bi bi-file-text"></i> Terms & Conditions</a></li>
            <div class="divider my-0"></div>
            <li><a href="/accounts/logout/" class="text-error py-3"><i class="bi bi-box-arrow-right"></i> Logout</a></li>
          </ul>
        </div>
      {% else %}
        <a href="/accounts/login/" class="btn btn-primary btn-sm md:btn-md rounded-xl">Login</a>
      {% endif %}
    </div>
  </header>

  <main class="flex-1 w-full max-w-7xl mx-auto px-4 sm:px-6 py-6 transition-all duration-500">
    {% block content %}{% endblock %}
  </main>

  {% if user.is_authenticated %}
  <nav class="btm-nav lg:hidden glass-nav border-t border-base-content/5 shadow-[0_-5px_20px_rgba(0,0,0,0.05)]">
    <a href="{% url 'dashboard' %}" class="{% if request.resolver_match.url_name == 'dashboard' %}active text-primary{% endif %}">
      <i class="bi bi-grid-1x2 text-xl"></i>
      <span class="btm-nav-label text-[10px] font-bold">Dashboard</span>
    </a>
    <a href="{% url 'analytics' %}" class="{% if request.resolver_match.url_name == 'analytics' %}active text-primary{% endif %}">
      <i class="bi bi-bar-chart text-xl"></i>
      <span class="btm-nav-label text-[10px] font-bold">Analytics</span>
    </a>
    <a href="{% url 'day_planner' %}" class="{% if request.resolver_match.url_name == 'day_planner' %}active text-primary{% endif %}">
      <i class="bi bi-calendar3 text-xl"></i>
      <span class="btm-nav-label text-[10px] font-bold">Planner</span>
    </a>
    <a href="{% url 'plan_list' %}" class="{% if request.resolver_match.url_name == 'plan_list' %}active text-primary{% endif %}">
      <i class="bi bi-diagram-3 text-xl"></i>
      <span class="btm-nav-label text-[10px] font-bold">Plans</span>
    </a>
    <a href="{% url 'friends_list' %}" class="{% if request.resolver_match.url_name == 'friends_list' %}active text-primary{% endif %}">
      <i class="bi bi-people text-xl"></i>
      <span class="btm-nav-label text-[10px] font-bold">Friends</span>
    </a>
  </nav>
  {% endif %}

  <script>
    // Theme Switcher Logic
    const themeToggleBtn = document.getElementById('themeToggleBtn');
    const themeToggleText = document.getElementById('themeToggleText');
    const htmlEl = document.documentElement;

    const updateThemeUI = (theme) => {
        themeToggleText.textContent = theme.charAt(0).toUpperCase() + theme.slice(1);
        themeToggleText.className = theme === 'dark' ? 'badge badge-primary badge-sm' : 'badge badge-outline badge-sm';
    };

    if (themeToggleBtn) {
        themeToggleBtn.addEventListener('click', () => {
            const currentTheme = htmlEl.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            htmlEl.setAttribute('data-theme', newTheme);
            localStorage.setItem('vm_theme', newTheme);
            updateThemeUI(newTheme);
        });
        // Initial UI state
        updateThemeUI(htmlEl.getAttribute('data-theme'));
    }

    // Profile Dropdown Toggle - Click avatar again to close
    const profileDropdownBtn = document.querySelector('.dropdown-end [tabindex="0"]');
    const profileDropdownMenu = document.querySelector('.dropdown-end .dropdown-content');
    
    if (profileDropdownBtn && profileDropdownMenu) {
        let isOpen = false;
        
        profileDropdownBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            if (isOpen) {
                profileDropdownBtn.blur();
                isOpen = false;
            } else {
                isOpen = true;
            }
        });
        
        // Close when clicking outside
        document.addEventListener('click', (e) => {
            if (isOpen && !profileDropdownBtn.contains(e.target) && !profileDropdownMenu.contains(e.target)) {
                profileDropdownBtn.blur();
                isOpen = false;
            }
        });
        
        // Track when dropdown loses focus
        profileDropdownBtn.addEventListener('blur', () => {
            setTimeout(() => {
                if (!profileDropdownMenu.matches(':hover')) {
                    isOpen = false;
                }
            }, 100);
        });
    }

    // Page Loader Simulation (on link clicks)
    window.addEventListener('beforeunload', () => {
        document.getElementById('page-loader').style.transform = 'translateX(-20%)';
    });
    
    // Auto-hide messages after 5 seconds
    setTimeout(() => {
        const alerts = document.querySelectorAll('.alert');
        alerts.forEach(a => {
            a.classList.add('opacity-0', 'transition-opacity', 'duration-500');
            setTimeout(() => a.remove(), 500);
        });
    }, 5000);
  </script>
  
  {% block extra_js %}{% endblock %}
</body>
</html>