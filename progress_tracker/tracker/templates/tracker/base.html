{% load static %}
<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="description" content="VisMatrix - Track your progress with friends">
  <meta name="theme-color" content="#1d4ed8">
  <meta name="csrf-token" content="{{ csrf_token }}">
  <title>{% block title %}VisMatrix.Space{% endblock %}</title>

  <!-- Icons -->
  <link rel="icon" type="image/png" href="{% static 'branding/vismatrixicon.png' %}">

  <!-- Preconnect for faster CDN loading -->
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">

  <!-- Tailwind + DaisyUI (CDN OK for now) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <link rel="preload" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/fonts/bootstrap-icons.woff2" as="font" type="font/woff2" crossorigin>

  <!-- THEME BOOTSTRAP (before paint) -->
  <script>
    (function () {
      const key = 'vm_theme';
      const saved = localStorage.getItem(key);
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      const theme = saved || (prefersDark ? 'dark' : 'light');
      document.documentElement.setAttribute('data-theme', theme);
    })();
  </script>

  <!-- DESIGN TOKENS ONLY -->
  <style>
    :root {
      --radius: 14px;
      --font: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      --focus: 0 0 0 3px rgb(29 78 216 / .3);
    }

    body {
      font-family: var(--font);
      -webkit-font-smoothing: antialiased;
      background-color: hsl(var(--b1));
      color: hsl(var(--bc));
    }

    :focus-visible {
      outline: none;
      box-shadow: var(--focus);
      border-radius: 10px;
    }

    /* iOS icon font fix - ensure Bootstrap Icons display properly */
    [class^="bi-"]::before,
    [class*=" bi-"]::before {
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      font-style: normal;
      font-variant: normal;
      text-rendering: auto;
      line-height: 1;
      display: inline-block;
    }

    /* Ensure icon fonts load with fallback */
    .bi {
      font-family: "bootstrap-icons" !important;
      speak: never;
    }
  </style>
  
  <!-- Timezone Helper -->
  {% load static %}
  <script src="{% static 'js/timezone_helper.js' %}" defer></script>
</head>

<body class="min-h-screen flex flex-col" data-user-authenticated="{% if user.is_authenticated %}true{% else %}false{% endif %}">

<!-- ================= NAVBAR ================= -->
<nav class="navbar bg-base-100 sticky top-0 z-50 border-b border-base-300">
  <div class="flex-1">
    <a href="{% url 'dashboard' %}" class="flex items-center gap-2 md:gap-3 font-black text-sm md:text-base">
      <img src="{% static 'branding/vismatrixicon.png' %}" class="w-8 h-8 md:w-9 md:h-9 rounded-xl">
      <span class="hidden sm:inline">VisMatrix<span class="text-primary">.space</span></span>
      <span class="sm:hidden">VisMatrix<span class="text-primary">.space</span></span>
    </a>
  </div>

  <!-- Desktop Navigation -->
  <div class="hidden lg:flex gap-1">
    <a href="{% url 'dashboard' %}" class="btn btn-ghost btn-sm {% if request.resolver_match.url_name == 'dashboard' %}btn-active{% endif %}">
      <i class="bi bi-bar-chart"></i> Dashboard
    </a>
    <a href="{% url 'day_planner' %}" class="btn btn-ghost btn-sm {% if request.resolver_match.url_name == 'day_planner' %}btn-active{% endif %}">
      <i class="bi bi-calendar-check"></i> Day Planner
    </a>
    <a href="{% url 'task_list' %}" class="btn btn-ghost btn-sm {% if request.resolver_match.url_name == 'task_list' %}btn-active{% endif %}">
      <i class="bi bi-list-check"></i> Tasks
    </a>
    <a href="{% url 'analytics' %}" class="btn btn-ghost btn-sm {% if request.resolver_match.url_name == 'analytics' %}btn-active{% endif %}">
      <i class="bi bi-graph-up"></i> Analytics
    </a>
    <a href="{% url 'friends_list' %}" class="btn btn-ghost btn-sm {% if request.resolver_match.url_name == 'friends_list' %}btn-active{% endif %}">
      <i class="bi bi-people"></i> Friends
    </a>
    <a href="{% url 'plan_list' %}" class="btn btn-ghost btn-sm {% if request.resolver_match.url_name == 'plan_list' or request.resolver_match.url_name == 'plan_detail' %}btn-active{% endif %}">
      <i class="bi bi-diagram-3"></i> Plans
    </a>
  </div>

  {% if user.is_authenticated %}
  <!-- User Profile Dropdown -->
  <div class="dropdown dropdown-end" id="profileDropdown">
    <label tabindex="0" class="btn btn-ghost btn-circle avatar" id="profileDropdownToggle">
      <div class="w-9 h-9 md:w-10 md:h-10 rounded-full bg-primary text-primary-content flex items-center justify-center font-bold text-sm md:text-base">
        {{ user.username|first|upper }}
      </div>
    </label>

    <ul tabindex="0" class="dropdown-content menu p-2 shadow bg-base-100 rounded-box w-64 mt-3" id="profileDropdownMenu">
      <li class="menu-title">Hi, {{ user.username }}</li>

      <li>
        <button id="themeToggleBtn">
          <i class="bi bi-moon-stars"></i>
          <span id="themeToggleText">Dark mode</span>
        </button>
      </li>

      <div class="divider"></div>

      <li><a href="{% url 'task_list' %}"><i class="bi bi-list-check"></i> Tasks</a></li>
      <li><a href="{% url 'log_list' %}"><i class="bi bi-clock-history"></i> Logs</a></li>

      <div class="divider"></div>

      <li>
        <a href="{% url 'recent_notifications' %}">
          <i class="bi bi-bell"></i>
          <span>Notifications</span>
          {% if unread_app_notifications_count > 0 %}
          <span class="badge badge-primary badge-sm">{{ unread_app_notifications_count }}</span>
          {% endif %}
        </a>
      </li>
      <li><a href="{% url 'profile_settings' %}"><i class="bi bi-person"></i> Profile</a></li>
      <li><a href="{% url 'about' %}"><i class="bi bi-info-circle"></i> About</a></li>
      <li><a href="/accounts/logout/" class="text-error"><i class="bi bi-box-arrow-right"></i> Logout</a></li>
    </ul>
  </div>
  {% else %}
  <a href="/accounts/login/" class="btn btn-primary btn-sm">
    <i class="bi bi-box-arrow-in-right"></i> <span class="hidden sm:inline">Login</span>
  </a>
  {% endif %}
</nav>

<!-- ================= MAIN ================= -->
<main class="flex-1 w-full max-w-7xl mx-auto px-3 sm:px-4 md:px-6 py-4 md:py-6 pb-20 lg:pb-6">
  {% comment %}
  {% if messages %}
  <div class="toast toast-top toast-center z-50">
    {% for message in messages %}
    <div class="alert alert-{{ message.tags|default:'info' }} shadow-lg">
      {{ message }}
    </div>
    {% endfor %}
  </div>
  {% endif %}
  {% endcomment %}

  {% block content %}{% endblock %}
</main>

<!-- ================= BOTTOM NAV (Mobile Only) ================= -->
{% if user.is_authenticated %}
<nav class="btm-nav lg:hidden fixed bottom-0 left-0 right-0 z-40 bg-base-100 border-t border-base-300 h-16 shadow-lg">
  <a href="{% url 'dashboard' %}" class="{% if request.resolver_match.url_name == 'dashboard' %}active text-primary{% endif %}">
    <i class="bi bi-bar-chart text-xl"></i>
    <span class="btm-nav-label text-xs">Dashboard</span>
  </a>
  <a href="{% url 'day_planner' %}" class="{% if request.resolver_match.url_name == 'day_planner' %}active text-primary{% endif %}">
    <i class="bi bi-calendar-check text-xl"></i>
    <span class="btm-nav-label text-xs">Planner</span>
  </a>
  <a href="{% url 'analytics' %}" class="{% if request.resolver_match.url_name == 'analytics' %}active text-primary{% endif %}">
    <i class="bi bi-graph-up text-xl"></i>
    <span class="btm-nav-label text-xs">Analytics</span>
  </a>
  <a href="{% url 'friends_list' %}" class="{% if request.resolver_match.url_name == 'friends_list' %}active text-primary{% endif %}">
    <i class="bi bi-people text-xl"></i>
    <span class="btm-nav-label text-xs">Friends</span>
  </a>
  <a href="{% url 'plan_list' %}" class="{% if request.resolver_match.url_name == 'plan_list' or request.resolver_match.url_name == 'plan_detail' %}active text-primary{% endif %}">
    <i class="bi bi-diagram-3 text-xl"></i>
    <span class="btm-nav-label text-xs">Plans</span>
  </a>
</nav>
{% endif %}

<!-- ================= THEME TOGGLE ================= -->
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const btn = document.getElementById('themeToggleBtn');
    if (!btn) return;

    const html = document.documentElement;
    const label = document.getElementById('themeToggleText');

    const apply = (t) => {
      html.setAttribute('data-theme', t);
      localStorage.setItem('vm_theme', t);
      if (label) label.textContent = t === 'dark' ? 'Light mode' : 'Dark mode';
    };

    apply(html.getAttribute('data-theme'));

    btn.addEventListener('click', (e) => {
      e.preventDefault();
      const next = html.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
      apply(next);
    });
  });
</script>

<!-- ================= DROPDOWN TOGGLE ================= -->
<script>
  document.addEventListener('DOMContentLoaded', () => {
    // Profile dropdown handler
    const profileToggle = document.getElementById('profileDropdownToggle');
    const profileMenu = document.getElementById('profileDropdownMenu');
    
    if (profileToggle && profileMenu) {
      let isOpen = false;
      
      profileToggle.addEventListener('click', (e) => {
        // Use setTimeout to check state after DaisyUI processes the click
        setTimeout(() => {
          if (isOpen) {
            // Was already open, close it
            profileMenu.blur();
            profileToggle.blur();
            isOpen = false;
          } else {
            // Just opened
            isOpen = true;
          }
        }, 0);
      });
      
      // Track when dropdown closes naturally
      profileMenu.addEventListener('blur', () => {
        isOpen = false;
      });

      // Close dropdown when clicking outside
      document.addEventListener('click', (e) => {
        const dropdown = document.getElementById('profileDropdown');
        if (dropdown && !dropdown.contains(e.target)) {
          profileMenu.blur();
          profileToggle.blur();
          isOpen = false;
        }
      });
    }
  });
</script>

</body>
</html>
