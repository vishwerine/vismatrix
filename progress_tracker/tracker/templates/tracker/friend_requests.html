{% extends 'tracker/base.html' %}

{% block title %}Friend Requests - VisMatrix{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto py-4">
    <div class="mb-6">
        <h1 class="text-2xl md:text-3xl font-bold">Friend Requests</h1>
        <p class="text-sm opacity-70">Manage your connection requests</p>
    </div>

    <div role="tablist" class="tabs tabs-lifted">
        <input 
            type="radio" 
            name="request_tabs" 
            role="tab" 
            class="tab text-sm md:text-base" 
            aria-label="Received ({{ received_requests|length }})"
            checked 
        />
        <div role="tabpanel" class="tab-content bg-base-100 border-base-300 rounded-box p-4 md:p-6 shadow-md border space-y-4">
            {% if received_requests %}
            <div class="space-y-3">
                {% for request in received_requests %}
                <div id="request-{{ request.id }}" class="flex items-center justify-between p-3 bg-base-200/50 rounded-lg shadow-sm border border-base-200 transition-shadow">
                    <div class="flex items-center gap-3 min-w-0">
                        <div class="avatar placeholder">
                            <div class="bg-primary text-primary-content rounded-full w-10 h-10">
                                <span class="text-sm font-bold">{{ request.from_user.username|first|upper }}</span>
                            </div>
                        </div>
                        <span class="font-semibold text-base truncate">{{ request.from_user.username }}</span>
                    </div>
                    
                    <div class="flex gap-2 flex-shrink-0">
                        <button 
                            class="btn btn-sm btn-success" 
                            onclick="handleRequest({{ request.id }}, '{% url 'accept_friend_request' request.id %}', this)">
                            Accept
                        </button>
                        <button 
                            class="btn btn-sm btn-error btn-outline"
                            onclick="handleRequest({{ request.id }}, '{% url 'decline_friend_request' request.id %}', this)">
                            Decline
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-10 opacity-60">
                <svg class="w-10 h-10 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                <p class="text-sm">No pending friend requests.</p>
            </div>
            {% endif %}
        </div>

        <input 
            type="radio" 
            name="request_tabs" 
            role="tab" 
            class="tab text-sm md:text-base" 
            aria-label="Sent ({{ sent_requests|length }})" 
        />
        <div role="tabpanel" class="tab-content bg-base-100 border-base-300 rounded-box p-4 md:p-6 shadow-md border space-y-4">
            {% if sent_requests %}
            <div class="space-y-3">
                {% for request in sent_requests %}
                <div id="request-{{ request.id }}" class="flex items-center justify-between p-3 bg-base-200/50 rounded-lg shadow-sm border border-base-200">
                    <div class="flex items-center gap-3 min-w-0">
                        <div class="avatar placeholder">
                            <div class="bg-secondary text-secondary-content rounded-full w-10 h-10">
                                <span class="text-sm font-bold">{{ request.to_user.username|first|upper }}</span>
                            </div>
                        </div>
                        <span class="font-semibold text-base truncate">{{ request.to_user.username }}</span>
                    </div>
                    
                    <div class="flex-shrink-0">
                        <button 
                            class="btn btn-sm btn-warning btn-outline"
                            onclick="handleRequest({{ request.id }}, '{% url 'cancel_friend_request' request.id %}', this)">
                            Cancel
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-10 opacity-60">
                <svg class="w-10 h-10 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                <p class="text-sm">No pending outgoing requests.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
    function handleRequest(requestId, url, button) {
        const originalHTML = button.innerHTML;
        button.disabled = true;
        button.innerHTML = '<span class="loading loading-spinner loading-xs"></span>';
        const container = document.getElementById(`request-${requestId}`);

        fetch(url, {
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' }
        })
        .then(r => r.json())
        .then(data => {
            if (data.status === 'success') {
                container.style.opacity = '0';
                container.style.transform = 'scale(0.95)';
                container.style.transition = 'all 0.3s ease';
                setTimeout(() => container.remove(), 300);
            } else {
                button.disabled = false;
                button.innerHTML = originalHTML;
            }
        })
        .catch(e => {
            button.disabled = false;
            button.innerHTML = originalHTML;
        });
    }
</script>
{% endblock %}