<!-- Mini Chat Widget - Floating at bottom right -->
<div id="miniChatWidget" class="fixed bottom-4 right-4 z-40 w-80 max-h-96 rounded-2xl border border-base-200 bg-base-100 shadow-2xl flex flex-col hidden lg:flex"
     style="display: none; opacity: 1;">

  <!-- Header -->
  <div class="flex items-center justify-between p-4 border-b border-base-200 bg-gradient-to-r from-primary/5 to-transparent rounded-t-2xl">
    <div class="flex items-center gap-2">
      <i class="bi bi-chat-dots text-primary text-lg"></i>
      <span class="font-bold text-sm">Messages</span>
    </div>
    <button onclick="toggleMiniChat()" class="btn btn-ghost btn-xs btn-circle" aria-label="Close chat">
      <i class="bi bi-x-lg"></i>
    </button>
  </div>

  <!-- Main Chat Area (hidden initially, shown when friend selected) -->
  <div id="chatArea" class="hidden flex-1 flex flex-col overflow-hidden">
    
    <!-- Friend Header -->
    <div class="p-3 border-b border-base-200 bg-base-200/30 flex items-center justify-between">
      <div class="flex items-center gap-2 min-w-0 flex-1">
        <div class="avatar placeholder flex-shrink-0">
          <div class="bg-primary text-primary-content rounded-full w-8">
            <span class="text-xs font-bold" id="chatFriendInitial">A</span>
          </div>
        </div>
        <span class="text-sm font-semibold truncate" id="chatFriendName">Friend</span>
      </div>
      <button onclick="backToFriendsList()" class="btn btn-ghost btn-xs btn-circle" aria-label="Back to friends">
        <i class="bi bi-arrow-left"></i>
      </button>
    </div>

    <!-- Messages Container -->
    <div id="chatMessages" class="flex-1 overflow-y-auto p-3 space-y-2 bg-base-50">
      <!-- Messages will be loaded here -->
    </div>

    <!-- Message Composer -->
    <div class="border-t border-base-200 p-3 bg-base-100">
      <form id="messageForm" class="flex gap-2" onsubmit="sendMessage(event)">
        <input
          type="text"
          id="messageInput"
          placeholder="Type message..."
          class="input input-bordered input-sm flex-1 text-xs"
          maxlength="2000"
          autocomplete="off"
        >
        <button type="submit" class="btn btn-primary btn-sm btn-square" aria-label="Send message">
          <i class="bi bi-send"></i>
        </button>
      </form>
    </div>

  </div>

  <!-- Friends List -->
  <div id="friendsList" class="flex-1 overflow-y-auto p-3 space-y-2">
    <!-- Friends will be loaded here -->
    <div class="text-center py-6 text-xs text-base-content/70">
      <i class="bi bi-hourglass-split animate-spin block text-lg mb-2"></i>
      <p>Loading friends...</p>
    </div>
  </div>

  <!-- No Friends State -->
  <div id="noFriendsState" class="hidden flex-1 flex items-center justify-center p-4 text-center">
    <div>
      <i class="bi bi-people text-2xl text-base-content/30 mb-2 block"></i>
      <p class="text-xs text-base-content/70">No friends yet</p>
      <a href="{% url 'friends_list' %}" class="btn btn-primary btn-xs mt-2">Find Friends</a>
    </div>
  </div>

</div>

<!-- Mini Chat Toggle Button (floating) -->
<button 
  id="chatToggleBtn"
  onclick="toggleMiniChat()"
  class="fixed right-4 btn btn-primary btn-circle btn-lg shadow-lg hover:shadow-xl transition-all z-40 lg:hidden opacity-90 hover:opacity-100"
  style="bottom: calc(5rem + env(safe-area-inset-bottom));"
  aria-label="Open chat"
>
  <i class="bi bi-chat-dots text-xl"></i>
  <span id="unreadBadge" class="badge badge-sm badge-warning absolute -top-2 -right-2 hidden"></span>
</button>

<!-- Desktop Chat Toggle (minimized state) -->
<button 
  id="desktopChatToggle"
  onclick="toggleMiniChat()"
  class="fixed bottom-4 right-4 btn btn-primary btn-sm gap-2 shadow-lg hover:shadow-xl transition-all z-40 hidden lg:flex opacity-90 hover:opacity-100"
  aria-label="Toggle chat"
>
  <i class="bi bi-chat-dots"></i>
  <span>Chat</span>
  <span id="desktopUnreadBadge" class="badge badge-sm badge-warning hidden"></span>
</button>

<script>
let currentConversationId = null;
let currentFriendId = null;
let autoRefreshInterval = null;

async function loadFriends() {
  // Don't update the friends list UI if a chat is currently open
  // Only update unread counts via a separate call
  if (currentFriendId !== null) {
    await updateUnreadCounts();
    return;
  }

  try {
    const response = await fetch('{% url "mini_chat_friends" %}');
    const data = await response.json();
    
    const friendsList = document.getElementById('friendsList');
    const noFriendsState = document.getElementById('noFriendsState');

    if (data.friends.length === 0) {
      friendsList.classList.add('hidden');
      noFriendsState.classList.remove('hidden');
      return;
    }

    friendsList.classList.remove('hidden');
    noFriendsState.classList.add('hidden');
    friendsList.innerHTML = '';

    let totalUnread = 0;

    data.friends.forEach(friend => {
      totalUnread += friend.unread;

      const unreadClass = friend.unread > 0 ? 'bg-warning/10 border-warning/30' : '';
      const unreadBadge = friend.unread > 0 ? 
        `<span class="badge badge-warning badge-xs">${friend.unread}</span>` : '';

      const item = document.createElement('button');
      item.className = `w-full text-left p-2 rounded-lg border border-base-200 hover:bg-base-200 transition text-xs flex items-center justify-between gap-2 ${unreadClass}`;
      item.innerHTML = `
        <div class="flex items-center gap-2 min-w-0 flex-1">
          <div class="avatar placeholder flex-shrink-0">
            <div class="bg-primary text-primary-content rounded-full w-7">
              <span class="text-[10px] font-bold">${friend.username[0].toUpperCase()}</span>
            </div>
          </div>
          <span class="truncate font-medium">${friend.username}</span>
        </div>
        ${unreadBadge}
      `;
      item.onclick = () => openChat(friend.id, friend.username, friend.conversation_id);
      friendsList.appendChild(item);
    });

    updateUnreadBadges(totalUnread);
  } catch (error) {
    console.error('Error loading friends:', error);
  }
}

async function updateUnreadCounts() {
  // Silently update unread counts without affecting UI layout
  try {
    const response = await fetch('{% url "mini_chat_friends" %}');
    const data = await response.json();
    
    let totalUnread = 0;
    data.friends.forEach(friend => {
      totalUnread += friend.unread;
    });
    
    updateUnreadBadges(totalUnread);
  } catch (error) {
    console.error('Error updating unread counts:', error);
  }
}

function updateUnreadBadges(count) {
  const badge = document.getElementById('unreadBadge');
  const desktopBadge = document.getElementById('desktopUnreadBadge');

  if (count > 0) {
    badge.textContent = count > 9 ? '9+' : count;
    badge.classList.remove('hidden');
    desktopBadge.textContent = count > 9 ? '9+' : count;
    desktopBadge.classList.remove('hidden');
  } else {
    badge.classList.add('hidden');
    desktopBadge.classList.add('hidden');
  }
}

async function openChat(friendId, friendUsername, conversationId) {
  currentFriendId = friendId;
  currentConversationId = conversationId;

  // Update header
  document.getElementById('chatFriendName').textContent = friendUsername;
  document.getElementById('chatFriendInitial').textContent = friendUsername[0].toUpperCase();

  // Show chat area
  document.getElementById('friendsList').classList.add('hidden');
  document.getElementById('chatArea').classList.remove('hidden');

  // Load messages
  if (conversationId) {
    await loadMessages(conversationId);
    // Auto-refresh messages every 2 seconds
    if (autoRefreshInterval) clearInterval(autoRefreshInterval);
    autoRefreshInterval = setInterval(() => loadMessages(conversationId), 2000);
  } else {
    document.getElementById('chatMessages').innerHTML = '';
  }

  // Focus input
  document.getElementById('messageInput').focus();
}

async function loadMessages(conversationId) {
  try {
    const response = await fetch(`{% url 'mini_chat_messages' conversation_id=0 %}`.replace('0', conversationId));
    const data = await response.json();

    const container = document.getElementById('chatMessages');
    container.innerHTML = '';

    if (data.messages.length === 0) {
      container.innerHTML = '<div class="text-center text-xs text-base-content/50 py-4">No messages yet. Say hi! ðŸ‘‹</div>';
      return;
    }

    data.messages.forEach(msg => {
      const isMe = msg.is_me;
      const msgDiv = document.createElement('div');
      msgDiv.className = `chat ${isMe ? 'chat-end' : 'chat-start'}`;
      msgDiv.innerHTML = `
        <div class="chat-header text-[10px] opacity-70 mb-1">
          ${isMe ? 'You' : msg.sender}
        </div>
        <div class="chat-bubble ${isMe ? 'chat-bubble-primary' : ''} text-xs max-w-xs break-words">
          ${escapeHtml(msg.body)}
        </div>
        <time class="text-[9px] opacity-50 mt-1">${msg.created_at}</time>
      `;
      container.appendChild(msgDiv);
    });

    // Auto-scroll to bottom
    container.scrollTop = container.scrollHeight;
  } catch (error) {
    console.error('Error loading messages:', error);
  }
}

async function sendMessage(event) {
  event.preventDefault();

  const input = document.getElementById('messageInput');
  const body = input.value.trim();

  if (!body || !currentFriendId) return;

  try {
    input.disabled = true;

    let response;
    if (currentConversationId) {
      response = await fetch(`{% url 'mini_chat_send' conversation_id=0 %}`.replace('0', currentConversationId), {
        method: 'POST',
        headers: {
          'X-CSRFToken': '{{ csrf_token }}',
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ body }),
      });
    } else {
      // Start new conversation
      response = await fetch(`{% url 'mini_chat_start' friend_id=0 %}`.replace('0', currentFriendId), {
        method: 'POST',
        headers: {
          'X-CSRFToken': '{{ csrf_token }}',
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ body }),
      });

      const data = await response.json();
      if (data.ok) {
        currentConversationId = data.conversation_id;
      }
    }

    if (response.ok) {
      input.value = '';
      await loadMessages(currentConversationId);
    }
  } catch (error) {
    console.error('Error sending message:', error);
  } finally {
    input.disabled = false;
    input.focus();
  }
}

function backToFriendsList() {
  if (autoRefreshInterval) clearInterval(autoRefreshInterval);

  document.getElementById('chatArea').classList.add('hidden');
  document.getElementById('friendsList').classList.remove('hidden');
  document.getElementById('messageInput').value = '';

  currentConversationId = null;
  currentFriendId = null;

  loadFriends(); // Refresh to update unread counts
}

function toggleMiniChat() {
  const widget = document.getElementById('miniChatWidget');
  const toggleBtn = document.getElementById('desktopChatToggle');
  const isMobile = window.innerWidth < 1024;

  if (widget.style.display === 'none' || !widget.style.display) {
    widget.style.display = 'flex';
    if (!isMobile) toggleBtn.classList.add('hidden');
    loadFriends();
  } else {
    widget.style.display = 'none';
    if (!isMobile) toggleBtn.classList.remove('hidden');
    backToFriendsList();
  }
}

function escapeHtml(text) {
  const map = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#039;'
  };
  return text.replace(/[&<>"']/g, m => map[m]);
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', () => {
  // Show desktop toggle by default on desktop
  if (window.innerWidth >= 1024) {
    document.getElementById('desktopChatToggle').classList.remove('hidden');
  }

  // Load friends periodically to update unread counts
  setInterval(loadFriends, 5000);
});

// Close chat on mobile when clicking outside
document.addEventListener('click', (e) => {
  const widget = document.getElementById('miniChatWidget');
  const toggleBtn = document.getElementById('chatToggleBtn');
  
  if (window.innerWidth < 1024 && 
      widget.style.display === 'flex' && 
      !widget.contains(e.target) && 
      !toggleBtn.contains(e.target)) {
    toggleMiniChat();
  }
});
</script>

<style>
  #miniChatWidget {
    animation: slideUp 0.3s ease-out;
    opacity: 1 !important;
  }

  @keyframes slideUp {
    from {
      transform: translateY(20px);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }

  /* Base styles without color overrides */
  #miniChatWidget {
    backdrop-filter: none;
  }

  /* Light mode - professional and clean styling */
  @media (prefers-color-scheme: light) {
    #miniChatWidget {
      background-color: #f8fafc !important;
      border-color: #e2e8f0 !important;
    }

    #miniChatWidget > div:first-child {
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%) !important;
      border-color: #e2e8f0 !important;
    }

    #miniChatWidget > div:first-child .text-primary {
      color: #ffffff !important;
    }

    #miniChatWidget > div:first-child span {
      color: #ffffff !important;
    }

    #miniChatWidget > div:first-child i {
      color: #ffffff !important;
    }

    #friendsList {
      background-color: #f8fafc !important;
    }

    #friendsList button {
      background-color: #ffffff !important;
      border-color: #e2e8f0 !important;
      color: #1e293b !important;
    }

    #friendsList button:hover {
      background-color: #f1f5f9 !important;
      border-color: #cbd5e1 !important;
    }

    #friendsList button span {
      color: #1e293b !important;
    }

    #chatMessages {
      background-color: #ffffff !important;
      color: #1e293b !important;
    }

    #chatMessages .chat-bubble {
      color: #1e293b !important;
    }

    #chatMessages .chat-bubble-primary {
      background-color: #3b82f6 !important;
      color: #ffffff !important;
    }

    #chatMessages .chat-header {
      color: #64748b !important;
    }

    #chatMessages time {
      color: #94a3b8 !important;
    }

    #messageInput {
      background-color: #ffffff !important;
      border-color: #e2e8f0 !important;
      color: #aaadb5 !important;
    }

    #messageInput::placeholder {
      color: #94a3b8 !important;
    }

    #messageInput:focus {
      border-color: #cddef9 !important;
      outline: 2px solid rgba(59, 130, 246, 0.1) !important;
    }

    #chatMessages::-webkit-scrollbar-thumb {
      background: rgba(71, 85, 105, 0.2);
    }

    #chatMessages::-webkit-scrollbar-thumb:hover {
      background: rgba(71, 85, 105, 0.4);
    }
  }

  /* Dark mode - solid dark background */
  @media (prefers-color-scheme: dark) {
    #miniChatWidget {
      background-color: #1e293b !important;
      border-color: #334155 !important;
    }

    #miniChatWidget > div:first-child {
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%) !important;
      border-color: #334155 !important;
    }

    #miniChatWidget > div:first-child .text-primary {
      color: #ffffff !important;
    }

    #miniChatWidget > div:first-child span {
      color: #e2e8f0 !important;
    }

    #miniChatWidget > div:first-child i {
      color: #e2e8f0 !important;
    }

    #friendsList {
      background-color: #1e293b !important;
    }

    #friendsList button {
      background-color: #0f172a !important;
      border-color: #334155 !important;
      color: #e2e8f0 !important;
    }

    #friendsList button:hover {
      background-color: #1e293b !important;
      border-color: #475569 !important;
    }

    #friendsList button span {
      color: #e2e8f0 !important;
    }

    #chatMessages {
      background-color: #0f172a !important;
      color: #e2e8f0 !important;
    }

    #chatMessages .chat-bubble {
      background-color: #1e293b !important;
      color: #e2e8f0 !important;
    }

    #chatMessages .chat-bubble-primary {
      background-color: #3b82f6 !important;
      color: #ffffff !important;
    }

    #chatMessages .chat-header {
      color: #94a3b8 !important;
    }

    #chatMessages time {
      color: #64748b !important;
    }

    #messageInput {
      background-color: #1e293b !important;
      border-color: #334155 !important;
      color: #e2e8f0 !important;
    }

    #messageInput::placeholder {
      color: #64748b !important;
    }

    #messageInput:focus {
      border-color: #3b82f6 !important;
      outline: 2px solid rgba(59, 130, 246, 0.2) !important;
    }

    #chatMessages::-webkit-scrollbar-thumb {
      background: rgba(148, 163, 184, 0.2);
    }

    #chatMessages::-webkit-scrollbar-thumb:hover {
      background: rgba(148, 163, 184, 0.4);
    }
  }

  /* Smooth scrolling in chat */
  #chatMessages {
    scroll-behavior: smooth;
  }

  /* Custom scrollbar */
  #chatMessages::-webkit-scrollbar {
    width: 4px;
  }

  #chatMessages::-webkit-scrollbar-track {
    background: opaque;
  }

  #chatMessages::-webkit-scrollbar-thumb {
    background: hsl(var(--bc) / 0.2);
    border-radius: 2px;
  }

  #chatMessages::-webkit-scrollbar-thumb:hover {
    background: hsl(var(--bc) / 0.4);
  }

  @media (max-width: 1024px) {
    #miniChatWidget {
      width: calc(100vw - 2rem);
      max-height: calc(100vh - 10rem - env(safe-area-inset-bottom));
      bottom: calc(1rem + env(safe-area-inset-bottom)) !important;
    }
  }
</style>
