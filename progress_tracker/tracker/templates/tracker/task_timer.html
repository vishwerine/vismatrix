{% extends 'tracker/base.html' %}

{% block title %}Pomodoro Timer - {{ task.title }} - VisMatrix.Space{% endblock %}

{% block content %}

<style>
  .timer-display {
    font-variant-numeric: tabular-nums;
    font-feature-settings: "tnum";
  }
  
  .pulse-animation {
    animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
  }
  
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
  }
  
  .timer-card {
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.05) 0%, rgba(29, 78, 216, 0.05) 100%);
  }
  
  .timer-controls button {
    min-width: 120px;
  }
  
  @media (max-width: 640px) {
    .timer-controls button {
      min-width: 100px;
    }
  }
  
  /* Progress ring */
  .progress-ring {
    transform: rotate(-90deg);
  }
  
  .progress-ring-circle {
    transition: stroke-dashoffset 1s linear;
  }
  
  /* Priority color indicators */
  .priority-indicator-high {
    border-left: 4px solid #ef4444;
  }
  
  .priority-indicator-medium {
    border-left: 4px solid #f59e0b;
  }
  
  .priority-indicator-low {
    border-left: 4px solid #3b82f6;
  }
</style>

<main class="py-8 sm:py-10">
  <div class="max-w-4xl mx-auto px-4 sm:px-6 space-y-6">

    <!-- Back button -->
    <div class="flex items-center justify-between">
      <a href="{% url 'task_list' %}" class="btn btn-ghost btn-sm gap-2">
        <i class="bi bi-arrow-left"></i>
        Back to Tasks
      </a>
      
      <!-- Collaborate buttons -->
      <div class="flex gap-2">
        <button onclick="openCollaborateModal()" class="btn btn-primary btn-sm gap-2" id="inviteFriendsBtn">
          <i class="bi bi-people-fill"></i>
          <span class="hidden sm:inline">Invite Friends</span>
          <span class="sm:hidden">Invite</span>
        </button>
        
        <button onclick="endSession()" class="btn btn-error btn-sm gap-2 hidden" id="endSessionTopBtn">
          <i class="bi bi-box-arrow-right"></i>
          <span class="hidden sm:inline" id="endSessionTopText">End Session</span>
          <span class="sm:hidden">End</span>
        </button>
      </div>
    </div>

    <!-- Task Info Card -->
    <section class="card bg-base-100 border border-base-300 priority-indicator-{{ task.priority }}">
      <div class="card-body p-5 sm:p-6">
        <div class="flex items-start justify-between gap-4">
          <div class="min-w-0 flex-1">
            <h1 class="text-2xl sm:text-3xl font-extrabold text-base-content mb-2">
              {{ task.title }}
            </h1>
            
            {% if task.description %}
            <p class="text-base-content/70 mb-3">
              {{ task.description }}
            </p>
            {% endif %}
            
            <div class="flex flex-wrap items-center gap-2 text-sm">
              <span class="badge badge-outline">
                {% if task.priority == 'high' %}
                  <i class="bi bi-exclamation-circle-fill mr-1 text-error"></i>High Priority
                {% elif task.priority == 'medium' %}
                  <i class="bi bi-dash-circle-fill mr-1 text-warning"></i>Medium Priority
                {% else %}
                  <i class="bi bi-arrow-down-circle-fill mr-1 text-info"></i>Low Priority
                {% endif %}
              </span>
              
              {% if task.category %}
                <span class="badge badge-outline">
                  <i class="bi bi-tag mr-1"></i>
                  {{ task.category.name }}
                </span>
              {% endif %}
              
              {% if task.due_date %}
                <span class="badge badge-outline">
                  <i class="bi bi-calendar-event mr-1"></i>
                  Due: {{ task.due_date|date:"M d, Y" }}
                </span>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Session Participants (if in collaborative mode) -->
    {% if session_participants %}
    <section class="card bg-gradient-to-br from-info/10 to-info/5 border-2 border-info/30">
      <div class="card-body p-4 sm:p-5">
        <div class="flex items-center gap-3 mb-3">
          <div class="flex-shrink-0">
            <div class="w-10 h-10 rounded-full bg-info/20 flex items-center justify-center">
              <i class="bi bi-people-fill text-info text-xl"></i>
            </div>
          </div>
          <div class="flex-1">
            <h3 class="font-bold text-base-content flex items-center gap-2">
              Collaborative Session
              <span class="relative flex h-3 w-3">
                <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-success opacity-75"></span>
                <span class="relative inline-flex rounded-full h-3 w-3 bg-success"></span>
              </span>
              {% if timer_session.is_public %}
              <span class="badge badge-warning badge-xs gap-1">
                <i class="bi bi-globe"></i>
                Public
              </span>
              {% endif %}
            </h3>
            <p class="text-xs text-base-content/70">
              Working together in real-time
              {% if timer_session.is_public %}
              â€¢ Visible to others
              {% endif %}
            </p>
          </div>
        </div>
        
        <!-- Participants Grid -->
        <div id="participantsGrid" class="flex flex-wrap gap-2">
          {% for participant in session_participants %}
          <div class="flex items-center gap-2 px-3 py-2 rounded-lg bg-base-100 border border-info/20">
            <div class="avatar placeholder">
              <div class="bg-info text-info-content rounded-full w-8 h-8">
                <span class="text-xs font-bold">{{ participant.username|first|upper }}</span>
              </div>
            </div>
            <span class="text-sm font-semibold">{{ participant.username }}</span>
            {% if timer_session and participant == timer_session.host %}
            <span class="badge badge-warning badge-xs gap-1">
              <i class="bi bi-star-fill"></i>
              Host
            </span>
            {% endif %}
          </div>
          {% endfor %}
        </div>
      </div>
    </section>
    {% endif %}

    <!-- Pomodoro Timer Card -->
    <section class="card bg-base-100 border border-base-300 timer-card">
      <div class="card-body p-6 sm:p-8">
        <div class="text-center space-y-6">
          
          <!-- Timer Mode Selector -->
          <div class="flex justify-center gap-2 mb-4">
            <button id="workModeBtn" class="btn btn-primary btn-sm" onclick="setTimerMode('work')">
              <i class="bi bi-stopwatch"></i> Work (25 min)
            </button>
            <button id="breakModeBtn" class="btn btn-outline btn-sm" onclick="setTimerMode('break')">
              <i class="bi bi-cup-hot"></i> Break (5 min)
            </button>
            <button id="longBreakModeBtn" class="btn btn-outline btn-sm" onclick="setTimerMode('longBreak')">
              <i class="bi bi-cup-hot-fill"></i> Long Break (15 min)
            </button>
          </div>

          <!-- Timer Display -->
          <div class="relative inline-block">
            <!-- Progress Ring -->
            <svg class="progress-ring" width="280" height="280">
              <circle
                class="text-base-300"
                stroke="currentColor"
                stroke-width="12"
                fill="transparent"
                r="120"
                cx="140"
                cy="140"
              />
              <circle
                id="progressCircle"
                class="progress-ring-circle text-primary"
                stroke="currentColor"
                stroke-width="12"
                fill="transparent"
                r="120"
                cx="140"
                cy="140"
                stroke-dasharray="753.98"
                stroke-dashoffset="753.98"
                stroke-linecap="round"
              />
            </svg>
            
            <!-- Timer Text -->
            <div class="absolute inset-0 flex flex-col items-center justify-center">
              <div id="timerDisplay" class="text-6xl sm:text-7xl font-bold timer-display text-base-content">
                25:00
              </div>
              <div id="timerLabel" class="text-sm sm:text-base text-base-content/60 mt-2">
                Work Session
              </div>
            </div>
          </div>

          <!-- Controls -->
          <div class="timer-controls flex justify-center gap-3 flex-wrap">
            <button id="startBtn" class="btn btn-primary gap-2" onclick="startTimer()">
              <i class="bi bi-play-fill"></i>
              Start
            </button>
            <button id="pauseBtn" class="btn btn-warning gap-2 hidden" onclick="pauseTimer()">
              <i class="bi bi-pause-fill"></i>
              Pause
            </button>
            <button id="resetBtn" class="btn btn-outline gap-2" onclick="resetTimer()">
              <i class="bi bi-arrow-clockwise"></i>
              Reset
            </button>
            <button id="logNowBtn" class="btn btn-success gap-2 hidden" onclick="logCurrentDuration()">
              <i class="bi bi-journal-check"></i>
              Log Now
            </button>
            <button id="endSessionBtn" class="btn btn-error gap-2 hidden" onclick="endSession()">
              <i class="bi bi-box-arrow-right"></i>
              <span id="endSessionText">End Session</span>
            </button>
          </div>

          <!-- Session Counter -->
          <div class="flex justify-center items-center gap-3 text-sm">
            <span class="text-base-content/70">Completed Pomodoros:</span>
            <div id="sessionCounter" class="flex gap-1">
              <!-- Filled by JS -->
            </div>
            <span id="sessionCount" class="badge badge-primary">0</span>
          </div>

          <!-- Alert for completed session -->
          <div id="completionAlert" class="alert alert-success hidden">
            <i class="bi bi-check-circle-fill"></i>
            <span id="completionMessage">Session completed! Time to log your activity.</span>
          </div>

        </div>
      </div>
    </section>

    <!-- Log Activity Form (shown after work session completes) -->
    <section id="logForm" class="card bg-base-100 border border-base-300 hidden">
      <div class="card-body p-5 sm:p-6">
        <h2 class="text-xl font-bold mb-4">
          <i class="bi bi-journal-text text-primary"></i>
          Log Your Activity
        </h2>
        
        <form id="activityLogForm" class="space-y-4">
          <div class="form-control">
            <label class="label">
              <span class="label-text font-semibold">Activity Summary</span>
            </label>
            <input
              type="text"
              id="activityInput"
              class="input input-bordered w-full"
              placeholder="What did you work on?"
              value="Pomodoro: {{ task.title }}"
              required
            >
          </div>

          <div class="form-control">
            <label class="label">
              <span class="label-text font-semibold">Description (optional)</span>
            </label>
            <textarea
              id="descriptionInput"
              class="textarea textarea-bordered h-24"
              placeholder="Add any notes about your work session..."
            ></textarea>
          </div>

          <div class="form-control">
            <label class="label">
              <span class="label-text font-semibold">Duration</span>
            </label>
            <input
              type="number"
              id="durationInput"
              class="input input-bordered w-full"
              value="25"
              min="1"
              readonly
            >
            <label class="label">
              <span class="label-text-alt">Minutes spent on this session</span>
            </label>
          </div>

          <div class="flex gap-3 flex-wrap">
            <button type="submit" class="btn btn-primary gap-2">
              <i class="bi bi-check-circle"></i>
              Save Activity Log
            </button>
            <button type="button" class="btn btn-ghost gap-2" onclick="hideLogForm()">
              <i class="bi bi-x-circle"></i>
              Skip
            </button>
          </div>
        </form>
      </div>
    </section>

    <!-- Recent Logs -->
    {% if recent_logs %}
    <section class="card bg-base-100 border border-base-300">
      <div class="card-body p-5 sm:p-6">
        <h2 class="text-xl font-bold mb-4">
          <i class="bi bi-clock-history text-primary"></i>
          Recent Activity
        </h2>
        
        <div class="space-y-2">
          {% for log in recent_logs %}
          <div class="flex items-center justify-between p-3 rounded-lg bg-base-200/50">
            <div class="min-w-0 flex-1">
              <p class="font-medium text-base-content">{{ log.activity }}</p>
              {% if log.description %}
              <p class="text-sm text-base-content/60 truncate">{{ log.description }}</p>
              {% endif %}
            </div>
            <div class="flex items-center gap-3 ml-3">
              <span class="badge badge-outline badge-sm">
                {{ log.duration }} min
              </span>
              <span class="text-sm text-base-content/60">
                {{ log.date|date:"M d" }}
              </span>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </section>
    {% endif %}

  </div>
</main>

<!-- Collaboration Modal -->
<dialog id="collaborateModal" class="modal">
  <div class="modal-box max-w-2xl">
    <form method="dialog">
      <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">âœ•</button>
    </form>
    
    <h3 class="font-bold text-lg mb-4">
      <i class="bi bi-people-fill text-primary"></i>
      Invite Friends to Collaborate
    </h3>
    
    <p class="text-sm text-base-content/70 mb-4">
      Start a shared timer session and work together with your friends!
    </p>
    
    <!-- Friend Selection -->
    {% if friends %}
    <div class="form-control mb-4">
      <label class="label">
        <span class="label-text font-semibold">Select Friends to Invite</span>
      </label>
      <div class="space-y-2 max-h-60 overflow-y-auto border border-base-300 rounded-lg p-3">
        {% for friend in friends %}
        <label class="flex items-center gap-3 p-2 hover:bg-base-200 rounded-lg cursor-pointer">
          <input type="checkbox" class="checkbox checkbox-primary checkbox-sm" 
                 value="{{ friend.id }}" name="invited_friend">
          <div class="avatar placeholder">
            <div class="bg-primary text-primary-content rounded-full w-8">
              <span class="text-xs">{{ friend.username|slice:":2"|upper }}</span>
            </div>
          </div>
          <span class="font-medium">{{ friend.username }}</span>
        </label>
        {% endfor %}
      </div>
    </div>
    {% else %}
    <div class="alert alert-warning mb-4">
      <i class="bi bi-info-circle"></i>
      <span>You don't have any friends yet. Add friends to collaborate!</span>
    </div>
    {% endif %}
    
    <!-- Public Session Option -->
    <div class="form-control mb-4">
      <label class="label cursor-pointer justify-start gap-3">
        <input type="checkbox" id="publicSession" class="checkbox checkbox-primary">
        <div>
          <span class="label-text font-semibold">Make session public</span>
          <p class="text-xs text-base-content/60">Anyone with the link can join</p>
        </div>
      </label>
    </div>
    
    <!-- Share Link (shown after session created) -->
    <div id="shareLinkSection" class="hidden mb-4">
      <label class="label">
        <span class="label-text font-semibold">Share Link</span>
      </label>
      <div class="join w-full">
        <input type="text" id="shareLink" class="input input-bordered join-item flex-1" readonly>
        <button class="btn btn-primary join-item" onclick="copyShareLink()">
          <i class="bi bi-clipboard"></i>
          Copy
        </button>
      </div>
      <p class="text-xs text-base-content/60 mt-2">
        Share this link with your friends so they can join your timer session!
      </p>
    </div>
    
    <!-- Actions -->
    <div class="modal-action">
      <button type="button" class="btn btn-ghost" onclick="closeCollaborateModal()">
        Cancel
      </button>
      <button type="button" class="btn btn-primary gap-2" onclick="createTimerSession()" id="createSessionBtn">
        <i class="bi bi-play-circle"></i>
        Start Collaborative Session
      </button>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop">
    <button>close</button>
  </form>
</dialog>

<script>
  // Timer state
  let timerInterval = null;
  let remainingSeconds = 25 * 60;  // 25 minutes in seconds
  let totalSeconds = 25 * 60;
  let isRunning = false;
  let currentMode = 'work';  // 'work', 'break', 'longBreak'
  let completedSessions = 0;
  let isJoinedSession = false;
  let sessionSyncInterval = null;
  let isHost = false;
  
  const MODES = {
    work: { duration: 25 * 60, label: 'Work Session', color: 'primary' },
    break: { duration: 5 * 60, label: 'Short Break', color: 'success' },
    longBreak: { duration: 15 * 60, label: 'Long Break', color: 'info' }
  };

  // Elements
  const timerDisplay = document.getElementById('timerDisplay');
  const timerLabel = document.getElementById('timerLabel');
  const startBtn = document.getElementById('startBtn');
  const pauseBtn = document.getElementById('pauseBtn');
  const resetBtn = document.getElementById('resetBtn');
  const logNowBtn = document.getElementById('logNowBtn');
  const endSessionBtn = document.getElementById('endSessionBtn');
  const endSessionText = document.getElementById('endSessionText');
  const endSessionTopBtn = document.getElementById('endSessionTopBtn');
  const endSessionTopText = document.getElementById('endSessionTopText');
  const inviteFriendsBtn = document.getElementById('inviteFriendsBtn');
  const progressCircle = document.getElementById('progressCircle');
  const completionAlert = document.getElementById('completionAlert');
  const completionMessage = document.getElementById('completionMessage');
  const logForm = document.getElementById('logForm');
  const activityLogForm = document.getElementById('activityLogForm');
  const sessionCounter = document.getElementById('sessionCounter');
  const sessionCount = document.getElementById('sessionCount');
  const durationInput = document.getElementById('durationInput');

  // Load saved state from localStorage
  function loadState() {
    const saved = localStorage.getItem('pomodoroState');
    if (saved) {
      const state = JSON.parse(saved);
      completedSessions = state.completedSessions || 0;
      updateSessionDisplay();
    }
  }

  // Save state to localStorage
  function saveState() {
    localStorage.setItem('pomodoroState', JSON.stringify({
      completedSessions: completedSessions
    }));
  }

  // Get CSRF token
  function getCSRFToken() {
    const metaTag = document.querySelector('meta[name="csrf-token"]');
    if (metaTag && metaTag.content) return metaTag.content;
    
    const name = 'csrftoken=';
    const parts = document.cookie.split(';').map(s => s.trim());
    for (const p of parts) {
      if (p.startsWith(name)) return decodeURIComponent(p.substring(name.length));
    }
    return '{{ csrf_token }}';
  }

  // Set timer mode
  function setTimerMode(mode) {
    if (isRunning) {
      if (!confirm('Timer is running. Are you sure you want to switch modes?')) {
        return;
      }
      pauseTimer();
    }
    
    currentMode = mode;
    const modeConfig = MODES[mode];
    totalSeconds = modeConfig.duration;
    remainingSeconds = totalSeconds;
    
    // Update UI
    updateDisplay();
    timerLabel.textContent = modeConfig.label;
    
    // Update button states
    document.getElementById('workModeBtn').classList.toggle('btn-primary', mode === 'work');
    document.getElementById('workModeBtn').classList.toggle('btn-outline', mode !== 'work');
    document.getElementById('breakModeBtn').classList.toggle('btn-primary', mode === 'break');
    document.getElementById('breakModeBtn').classList.toggle('btn-outline', mode !== 'break');
    document.getElementById('longBreakModeBtn').classList.toggle('btn-primary', mode === 'longBreak');
    document.getElementById('longBreakModeBtn').classList.toggle('btn-outline', mode !== 'longBreak');
    
    // Update progress circle color
    progressCircle.classList.remove('text-primary', 'text-success', 'text-info');
    progressCircle.classList.add(`text-${modeConfig.color}`);
    
    // Hide completion alert
    completionAlert.classList.add('hidden');
    logForm.classList.add('hidden');
  }

  // Update timer display
  function updateDisplay() {
    const minutes = Math.floor(remainingSeconds / 60);
    const seconds = remainingSeconds % 60;
    timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    
    // Update progress circle
    const circumference = 2 * Math.PI * 120;
    const progress = 1 - (remainingSeconds / totalSeconds);
    const offset = circumference * progress;
    progressCircle.style.strokeDashoffset = circumference - offset;
    
    // Update page title
    if (isRunning) {
      document.title = `${minutes}:${seconds.toString().padStart(2, '0')} - ${MODES[currentMode].label} - VisMatrix`;
    } else {
      document.title = 'Pomodoro Timer - {{ task.title }} - VisMatrix.Space';
    }
  }

  // Start timer
  function startTimer() {
    if (isRunning) return;
    
    isRunning = true;
    startBtn.classList.add('hidden');
    logNowBtn.classList.remove('hidden');
    pauseBtn.classList.remove('hidden');
    timerDisplay.classList.add('pulse-animation');
    
    timerInterval = setInterval(() => {
      if (remainingSeconds > 0) {
        remainingSeconds--;
        updateDisplay();
      } else {
        completeSession();
      }
    }, 1000);
    
    // If host and in a session, update session state
    if (isHost && currentSessionCode) {
      updateSessionAction('start');
    }
  }

  // Pause timer
  function pauseTimer() {
    if (!isRunning) return;
    
    isRunning = false;
    clearInterval(timerInterval);
    startBtn.classList.remove('hidden');
    pauseBtn.classList.add('hidden');
    timerDisplay.classList.remove('pulse-animation');
    
    // If host and in a session, update session state
    if (isHost && currentSessionCode) {
      updateSessionAction('pause');
    }
  }

  // Reset timer
  function resetTimer() {
    if (isRunning) {
      if (!confirm('Timer is running. Are you sure you want to reset?')) {
        return;
      }
    }
    
    pauseTimer();
    remainingSeconds = totalSeconds;
    updateDisplay();
    completionAlert.classList.add('hidden');
    logForm.classList.add('hidden');
    
    // If host and in a session, update session state
    if (isHost && currentSessionCode) {
      updateSessionAction('reset', {
        mode: currentMode,
        duration: Math.floor(totalSeconds / 60)
      });
    }
  }

  // Complete session
  function completeSession() {
    pauseTimer();
    
    // Play notification sound (optional, browser may require user interaction)
    try {
      const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIGWi98OefTwwLT6fj8LZjGwY5kdfu0H0xBSp+zPLaizsIHGS+8+qhTwwMUqzl8bllHAU1jtXzzHw0BScAdszx3Ik4CB1lu/Hqn08MDFKs5fG5ZRwFNY7V88x8NAUnAHbM8dyJOAgdZbvx6p9PDAxSrOXxuWUcBTWO1fPMfDQFJwB2zPHciTgIHWW78eqfTw==');
      audio.play().catch(() => {});
    } catch (e) {}
    
    // Show completion alert
    if (currentMode === 'work') {
      completionMessage.textContent = 'Work session completed! Great job! ðŸŽ‰';
      completionAlert.classList.remove('hidden');
      
      // Update session counter
      completedSessions++;
      updateSessionDisplay();
      saveState();
      
      // Show log form
      durationInput.value = Math.floor(totalSeconds / 60);
      logForm.classList.remove('hidden');
      
      // Suggest break
      setTimeout(() => {
        if (confirm('Work session complete! Would you like to take a break?')) {
          setTimerMode(completedSessions % 4 === 0 ? 'longBreak' : 'break');
        }
      }, 1000);
    } else {
      completionMessage.textContent = 'Break complete! Ready to focus again? ðŸ’ª';
      completionAlert.classList.remove('hidden');
      
      // Suggest work session
      setTimeout(() => {
        if (confirm('Break complete! Ready to start another work session?')) {
          setTimerMode('work');
        }
      }, 1000);
    }
  }

  // Update session counter display
  function updateSessionDisplay() {
    sessionCount.textContent = completedSessions;
    
    // Show tomato icons for completed sessions
    sessionCounter.innerHTML = '';
    for (let i = 0; i < Math.min(completedSessions, 8); i++) {
      const icon = document.createElement('i');
      icon.className = 'bi bi-circle-fill text-primary';
      icon.style.fontSize = '8px';
      sessionCounter.appendChild(icon);
    }
  }

  // Hide log form
  function hideLogForm() {
    logForm.classList.add('hidden');
  }

  // Log current duration (for "Log Now" button)
  function logCurrentDuration() {
    // Calculate elapsed time
    const elapsedSeconds = totalSeconds - remainingSeconds;
    const elapsedMinutes = Math.ceil(elapsedSeconds / 60); // Round up to nearest minute
    
    // Don't allow logging if less than 1 minute elapsed
    if (elapsedMinutes < 1) {
      alert('Please work for at least 1 minute before logging.');
      return;
    }
    
    // Pause timer
    pauseTimer();
    
    // Set duration and show form
    durationInput.value = elapsedMinutes;
    logForm.classList.remove('hidden');
    
    // Scroll to form
    logForm.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }

  // Handle form submission
  activityLogForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const activity = document.getElementById('activityInput').value;
    const description = document.getElementById('descriptionInput').value;
    const duration = document.getElementById('durationInput').value;
    
    const data = {
      task_id: {{ task.id }},
      activity: activity,
      description: description,
      duration: parseInt(duration),
      date: new Date().toISOString().split('T')[0]
    };
    
    try {
      const response = await fetch('/api/timer/save-log/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify(data)
      });
      
      const result = await response.json();
      
      if (result.success) {
        // Show success message
        alert(result.message);
        
        // Reset form
        document.getElementById('descriptionInput').value = '';
        hideLogForm();
        
        // Optionally redirect to logs page
        if (confirm('Activity logged! Would you like to view your logs?')) {
          window.location.href = result.redirect_url;
        }
      } else {
        alert('Error: ' + result.error);
      }
    } catch (error) {
      console.error('Error saving log:', error);
      alert('An error occurred while saving your log. Please try again.');
    }
  });

  // Keyboard shortcuts
  document.addEventListener('keydown', (e) => {
    // Space to start/pause
    if (e.code === 'Space' && !e.target.matches('input, textarea')) {
      e.preventDefault();
      if (isRunning) {
        pauseTimer();
      } else {
        startTimer();
      }
    }
    
    // R to reset
    if (e.code === 'KeyR' && !e.target.matches('input, textarea')) {
      e.preventDefault();
      resetTimer();
    }
  });

  // Warn before leaving page if timer is running
  window.addEventListener('beforeunload', (e) => {
    if (isRunning) {
      e.preventDefault();
      e.returnValue = '';
      return '';
    }
  });

  // Collaboration Functions - DECLARE THESE FIRST
  let currentSessionCode = '{% if timer_session %}{{ timer_session.share_code }}{% endif %}';
  let isPublicSession = {% if timer_session.is_public %}true{% else %}false{% endif %};
  
  // Check if we joined someone else's session
  {% if timer_session and timer_session.host != user %}
  isJoinedSession = true;
  {% endif %}
  
  // Check if we are the host
  {% if timer_session and timer_session.host == user %}
  isHost = true;
  {% endif %}

  // Initialize
  loadState();
  updateDisplay();
  updateSessionDisplay();
  
  // Show end session buttons if in a session
  if (currentSessionCode) {
    const buttonText = isHost 
      ? (isPublicSession ? 'End Public Session' : 'End Session')
      : (isPublicSession ? 'Leave Public Session' : 'Leave Session');
    
    endSessionBtn.classList.remove('hidden');
    endSessionText.textContent = buttonText;
    endSessionTopBtn.classList.remove('hidden');
    endSessionTopText.textContent = buttonText;
    inviteFriendsBtn.classList.add('hidden');
  }
  async function endSession() {
    const actionText = isHost ? 'end this session for everyone' : 'leave this session';
    const publicNote = isHost 
      ? ' This will remove the session from public listings and disconnect all participants.'
      : ' You will no longer appear in this session and it will be removed from your active sessions.';
    
    if (!confirm(`Are you sure you want to ${actionText}?${publicNote}`)) {
      return;
    }
    
    try {
      endSessionBtn.disabled = true;
      endSessionTopBtn.disabled = true;
      
      const endpoint = isHost 
        ? `/api/timer/session/${currentSessionCode}/end/`
        : `/api/timer/session/${currentSessionCode}/leave/`;
      
      const response = await fetch(endpoint, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCSRFToken()
        }
      });
      
      const result = await response.json();
      
      if (result.success) {
        // Stop polling
        if (participantPollInterval) {
          clearInterval(participantPollInterval);
          participantPollInterval = null;
        }
        if (sessionSyncInterval) {
          clearInterval(sessionSyncInterval);
          sessionSyncInterval = null;
        }
        
        // Reset session state
        currentSessionCode = '';
        isJoinedSession = false;
        isHost = false;
        
        // Hide end session buttons and show invite button
        endSessionBtn.classList.add('hidden');
        endSessionTopBtn.classList.add('hidden');
        inviteFriendsBtn.classList.remove('hidden');
        
        // Show success message
        const message = isHost 
          ? 'Session ended successfully. All participants have been notified.'
          : 'You have left the session.';
        alert(message);
        
        // Reload page to clear session UI
        window.location.reload();
      } else {
        alert('Error: ' + result.error);
        endSessionBtn.disabled = false;
        endSessionTopBtn.disabled = false;
      }
    } catch (error) {
      console.error('Error ending session:', error);
      alert('An error occurred while ending the session.');
      endSessionBtn.disabled = false;
      endSessionTopBtn.disabled = false;
    }
  }

  function openCollaborateModal() {
    document.getElementById('collaborateModal').showModal();
  }

  function closeCollaborateModal() {
    document.getElementById('collaborateModal').close();
  }

  async function createTimerSession() {
    const selectedFriends = Array.from(document.querySelectorAll('input[name="invited_friend"]:checked'))
      .map(cb => parseInt(cb.value));
    
    const isPublic = document.getElementById('publicSession').checked;
    
    const data = {
      task_id: {{ task.id }},
      mode: currentMode,
      duration: Math.floor(totalSeconds / 60),
      is_public: isPublic,
      invited_users: selectedFriends
    };
    
    try {
      document.getElementById('createSessionBtn').disabled = true;
      
      const response = await fetch('/api/timer/create-session/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify(data)
      });
      
      const result = await response.json();
      
      if (result.success) {
        currentSessionCode = result.session_code;
        isHost = true;
        isPublicSession = isPublic;
        
        // Show share link
        const shareUrl = window.location.origin + result.share_url;
        document.getElementById('shareLink').value = shareUrl;
        document.getElementById('shareLinkSection').classList.remove('hidden');
        document.getElementById('createSessionBtn').textContent = 'Session Created!';
        document.getElementById('createSessionBtn').disabled = true;
        
        // Show success message
        const publicNote = isPublic ? ' This session is publicly visible.' : '';
        alert(`Collaborative session created!${publicNote} ${selectedFriends.length > 0 ? 'Your friends have been notified.' : 'Share the link to invite friends.'}`);
        
        // Start polling for participants
        if (currentSessionCode) {
          startParticipantPolling();
        }
        
        // Show end session buttons and hide invite button
        const buttonText = isPublic ? 'End Public Session' : 'End Session';
        endSessionBtn.classList.remove('hidden');
        endSessionText.textContent = buttonText;
        endSessionTopBtn.classList.remove('hidden');
        endSessionTopText.textContent = buttonText;
        inviteFriendsBtn.classList.add('hidden');
        
        // Close modal
        closeCollaborateModal();
      } else {
        alert('Error: ' + result.error);
        document.getElementById('createSessionBtn').disabled = false;
      }
    } catch (error) {
      console.error('Error creating session:', error);
      alert('An error occurred while creating the session.');
      document.getElementById('createSessionBtn').disabled = false;
    }
  }

  function copyShareLink() {
    const shareLink = document.getElementById('shareLink');
    shareLink.select();
    shareLink.setSelectionRange(0, 99999); // For mobile devices
    
    try {
      document.execCommand('copy');
      alert('Link copied to clipboard!');
    } catch (err) {
      // Fallback for newer browsers
      navigator.clipboard.writeText(shareLink.value).then(() => {
        alert('Link copied to clipboard!');
      }).catch(() => {
        alert('Failed to copy link. Please copy manually.');
      });
    }
  }

  // Poll for session participants and timer state
  let participantPollInterval = null;

  function startParticipantPolling() {
    if (!currentSessionCode) return;
    
    participantPollInterval = setInterval(async () => {
      try {
        const response = await fetch(`/api/timer/session/${currentSessionCode}/participants/`);
        const result = await response.json();
        
        if (result.success) {
          updateParticipantsList(result.participants);
        }
      } catch (error) {
        console.error('Error polling participants:', error);
      }
    }, 5000); // Poll every 5 seconds
  }
  
  // Update session action (for host)
  async function updateSessionAction(action, extraData = {}) {
    if (!currentSessionCode || !isHost) return;
    
    try {
      const data = {
        action: action,
        ...extraData
      };
      
      const response = await fetch(`/api/timer/session/${currentSessionCode}/update/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify(data)
      });
      
      const result = await response.json();
      if (!result.success) {
        console.error('Failed to update session:', result.error);
      }
    } catch (error) {
      console.error('Error updating session:', error);
    }
  }
  
  // Sync timer with host's session
  function startTimerSync() {
    if (!currentSessionCode || !isJoinedSession) return;
    
    // Initial sync
    syncTimerWithSession();
    
    // Poll every 2 seconds for timer updates (more frequent for better sync)
    sessionSyncInterval = setInterval(syncTimerWithSession, 2000);
  }
  
  async function syncTimerWithSession() {
    if (!currentSessionCode) return;
    
    try {
      const response = await fetch(`/api/timer/session/${currentSessionCode}/state/`);
      const result = await response.json();
      
      if (result.success) {
        const sessionState = result.state;
        
        // Update mode if different
        if (sessionState.mode && sessionState.mode !== currentMode) {
          currentMode = sessionState.mode;
          const modeConfig = MODES[sessionState.mode];
          totalSeconds = modeConfig.duration;
          timerLabel.textContent = modeConfig.label;
          
          // Update button states
          document.getElementById('workModeBtn').classList.toggle('btn-primary', sessionState.mode === 'work');
          document.getElementById('workModeBtn').classList.toggle('btn-outline', sessionState.mode !== 'work');
          document.getElementById('breakModeBtn').classList.toggle('btn-primary', sessionState.mode === 'break');
          document.getElementById('breakModeBtn').classList.toggle('btn-outline', sessionState.mode !== 'break');
          document.getElementById('longBreakModeBtn').classList.toggle('btn-primary', sessionState.mode === 'longBreak');
          document.getElementById('longBreakModeBtn').classList.toggle('btn-outline', sessionState.mode !== 'longBreak');
          
          // Update progress circle color
          progressCircle.classList.remove('text-primary', 'text-success', 'text-info');
          progressCircle.classList.add(`text-${modeConfig.color}`);
        }
        
        // Sync timer state
        if (sessionState.is_active && sessionState.started_at && !sessionState.ended_at) {
          // Session is running
          const startTime = new Date(sessionState.started_at).getTime();
          const now = Date.now();
          const elapsedSeconds = Math.floor((now - startTime) / 1000);
          const sessionDuration = sessionState.duration * 60; // Convert minutes to seconds
          
          remainingSeconds = Math.max(0, sessionDuration - elapsedSeconds);
          totalSeconds = sessionDuration;
          
          // Start timer if not already running
          if (!isRunning) {
            isRunning = true;
            startBtn.classList.add('hidden');
            logNowBtn.classList.remove('hidden');
            pauseBtn.classList.remove('hidden');
            timerDisplay.classList.add('pulse-animation');
            
            // Start local countdown
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
              if (remainingSeconds > 0) {
                remainingSeconds--;
                updateDisplay();
              } else {
                completeSession();
              }
            }, 1000);
          }
          
          updateDisplay();
        } else if (sessionState.ended_at || !sessionState.started_at) {
          // Session is paused or reset
          if (isRunning) {
            // Pause the local timer
            isRunning = false;
            clearInterval(timerInterval);
            startBtn.classList.remove('hidden');
            pauseBtn.classList.add('hidden');
            timerDisplay.classList.remove('pulse-animation');
          }
          
          // If session was reset (no started_at), reset to full duration
          if (!sessionState.started_at) {
            const sessionDuration = sessionState.duration * 60;
            remainingSeconds = sessionDuration;
            totalSeconds = sessionDuration;
            completionAlert.classList.add('hidden');
            logForm.classList.add('hidden');
          } else if (sessionState.ended_at && sessionState.started_at) {
            // If paused, calculate remaining time from when it was paused
            const startTime = new Date(sessionState.started_at).getTime();
            const endTime = new Date(sessionState.ended_at).getTime();
            const elapsedSeconds = Math.floor((endTime - startTime) / 1000);
            const sessionDuration = sessionState.duration * 60;
            remainingSeconds = Math.max(0, sessionDuration - elapsedSeconds);
            totalSeconds = sessionDuration;
          }
          
          updateDisplay();
        }
      }
    } catch (error) {
      console.error('Error syncing timer:', error);
    }
  }

  function updateParticipantsList(participants) {
    // Update the participants display if it exists
    const participantsGrid = document.getElementById('participantsGrid');
    if (participantsGrid && participants.length > 0) {
      participantsGrid.innerHTML = participants.map(p => `
        <div class="flex items-center gap-2 px-3 py-2 rounded-lg bg-base-100 border border-info/20">
          <div class="avatar placeholder">
            <div class="bg-info text-info-content rounded-full w-8 h-8">
              <span class="text-xs font-bold">${p.username.charAt(0).toUpperCase()}</span>
            </div>
          </div>
          <span class="text-sm font-semibold">${p.username}</span>
          ${p.is_host ? '<span class="badge badge-warning badge-xs gap-1"><i class="bi bi-star-fill"></i>Host</span>' : ''}
        </div>
      `).join('');
    }
  }

  // Auto-join session if arrived via notification link
  const urlParams = new URLSearchParams(window.location.search);
  const sessionCodeParam = urlParams.get('session');
  
  if (sessionCodeParam && !currentSessionCode) {
    // Show joining message
    const joiningAlert = document.createElement('div');
    joiningAlert.className = 'alert alert-info mb-4';
    joiningAlert.innerHTML = `
      <i class="bi bi-hourglass-split"></i>
      <span>Joining collaborative session...</span>
    `;
    document.querySelector('.max-w-4xl').insertBefore(joiningAlert, document.querySelector('.max-w-4xl').firstChild);
    
    // Auto-join after a brief moment
    setTimeout(() => {
      currentSessionCode = sessionCodeParam;
      isJoinedSession = true;
      joiningAlert.remove();
      
      // Show success message
      const successAlert = document.createElement('div');
      successAlert.className = 'alert alert-success mb-4';
      successAlert.innerHTML = `
        <i class="bi bi-check-circle-fill"></i>
        <span>You've joined the collaborative session! Start the timer to work together.</span>
      `;
      document.querySelector('.max-w-4xl').insertBefore(successAlert, document.querySelector('.max-w-4xl').firstChild);
      
      // Start polling for participants
      startParticipantPolling();
      
      // Show end session buttons (as leave session) and hide invite button
      const buttonText = isPublicSession ? 'Leave Public Session' : 'Leave Session';
      endSessionBtn.classList.remove('hidden');
      endSessionText.textContent = buttonText;
      endSessionTopBtn.classList.remove('hidden');
      endSessionTopText.textContent = buttonText;
      inviteFriendsBtn.classList.add('hidden');
      
      // Remove success message after 5 seconds
      setTimeout(() => successAlert.remove(), 5000);
    }, 500);
  } else if (currentSessionCode) {
    // If we're already in a session, start polling
    startParticipantPolling();
    
    // If we joined someone else's session, sync timer
    if (isJoinedSession) {
      startTimerSync();
    }
  }

  // Clean up polling on page unload
  window.addEventListener('beforeunload', () => {
    if (participantPollInterval) {
      clearInterval(participantPollInterval);
    }
    if (sessionSyncInterval) {
      clearInterval(sessionSyncInterval);
    }
  });
</script>

{% endblock %}
