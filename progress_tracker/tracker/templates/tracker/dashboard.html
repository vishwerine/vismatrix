{% extends 'tracker/base.html' %}

{% block title %}Dashboard - VisMatrix{% endblock %}

{% block content %}
<main class="space-y-6">

  <!-- Header (simple, high-contrast, no gradients) -->
  <header class="card border border-base-200 bg-base-100" role="banner">
    <div class="card-body p-5 sm:p-6">
      <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
        <div class="min-w-0">
          <h1 class="text-2xl sm:text-3xl font-extrabold text-base-content truncate">
            Welcome back, {{ user.username }}!
          </h1>
          <p class="text-sm text-base-content/70 mt-1">
            Your progress overview and updates for today.
          </p>
        </div>

        <div class="flex items-center gap-2 text-sm text-base-content/70">
          <i class="bi bi-calendar-event text-primary text-lg" aria-hidden="true"></i>
          <span class="font-semibold">{{ today|date:"l, F j, Y" }}</span>
        </div>
      </div>

      <!-- Quick actions (kept minimal and consistent) -->
      <div class="mt-4 flex flex-col sm:flex-row gap-2">
        <a href="{% url 'task_create' %}" class="btn btn-outline gap-2">
          <i class="bi bi-plus-square" aria-hidden="true"></i>
          <span>New Task</span>
        </a>
        <a href="{% url 'log_create' %}" class="btn btn-primary gap-2">
          <i class="bi bi-stopwatch" aria-hidden="true"></i>
          <span>Log Time</span>
        </a>
        <a href="{% url 'analytics' %}" class="btn btn-primary gap-2">
          <i class="bi bi-bar-chart-line" aria-hidden="true"></i>
          <span>Analytics</span>
        </a>
      </div>
    </div>
  </header>

  {% if star_notifications_count > 0 %}
  <!-- Notifications (calm, readable) -->
  <section class="alert alert-warning" role="alert" aria-live="polite">
    <div class="flex items-start gap-3 w-full">
      <i class="bi bi-star-fill text-xl" aria-hidden="true"></i>
      <div class="flex-1 min-w-0">
        <h2 class="font-bold text-base">
          You have {{ star_notifications_count }} star{{ star_notifications_count|pluralize }}.
        </h2>
        <p class="text-sm text-base-content/70">Friends appreciated your activities.</p>
      </div>
      <a href="{% url 'notifications' %}" class="btn btn-outline btn-sm gap-2">
        <i class="bi bi-bell" aria-hidden="true"></i>
        <span>View</span>
      </a>
    </div>
  </section>
  {% endif %}

  <!-- Main layout -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

    <!-- Left: Friends -->
    {% if friends_timeline %}
    <section class="card border border-base-200 bg-base-100 lg:col-span-2" aria-label="Friends activity">
      <div class="card-body p-5 sm:p-6">
        <div class="flex items-center justify-between gap-3">
          <h2 class="text-lg font-bold flex items-center gap-2">
            <i class="bi bi-people" aria-hidden="true"></i>
            <span>Friends Feed</span>
          </h2>
          <a href="{% url 'friends_list' %}" class="link link-primary text-sm">View all</a>
        </div>

        <div class="mt-4 divide-y divide-base-200">
          {% for item in friends_timeline %}
          <article class="py-4 flex items-start gap-3">
            <div class="avatar placeholder">
              <div class="bg-neutral text-neutral-content rounded-full w-10">
                <span class="text-sm">{{ item.user.username|first|upper }}</span>
              </div>
            </div>

            <div class="flex-1 min-w-0">
              <div class="flex flex-wrap items-center gap-2">
                <a href="{% url 'view_friend_profile' item.friendship_id %}" 
                   class="font-semibold text-sm link link-primary hover:underline">
                  {{ item.user.username }}
                </a>
                {% if item.type == 'task' %}
                  <span class="badge badge-success badge-sm">Task</span>
                {% else %}
                  <span class="badge badge-info badge-sm">Log</span>
                {% endif %}
              </div>

              <p class="mt-1 text-sm">
                {% if item.type == 'task' %}
                  Completed: <span class="font-semibold">{{ item.title }}</span>
                {% else %}
                  Logged: <span class="font-semibold">{{ item.title }}</span>
                {% endif %}
              </p>

              <p class="mt-1 text-xs text-base-content/70 flex flex-wrap items-center gap-x-3 gap-y-1">
                <span class="inline-flex items-center gap-1">
                  <i class="bi bi-clock" aria-hidden="true"></i>
                  {{ item.timestamp|date:"M j, g:i A" }}
                </span>
                {% if item.duration %}
                <span class="inline-flex items-center gap-1">
                  <i class="bi bi-stopwatch" aria-hidden="true"></i>
                  {{ item.duration }}m
                </span>
                {% endif %}
                {% if item.category %}
                <span class="inline-flex items-center gap-1">
                  <i class="bi bi-tag" aria-hidden="true"></i>
                  {{ item.category.name }}
                </span>
                {% endif %}
              </p>
            </div>

            <!-- Star action (clear target + aria) -->
            <button
              class="star-btn btn btn-ghost btn-sm gap-2"
              data-activity-type="{{ item.type }}"
              data-activity-id="{{ item.id }}"
              aria-label="{% if item.user_starred %}Unstar this activity{% else %}Star this activity{% endif %}">
              <i class="bi bi-star{% if item.user_starred %}-fill{% endif %} {% if item.user_starred %}text-warning{% endif %}" aria-hidden="true"></i>
              <span class="star-count text-sm tabular-nums">{{ item.star_count }}</span>
            </button>
          </article>
          {% endfor %}
        </div>
      </div>
    </section>
    {% endif %}

    <!-- Right: side cards -->
    <aside class="space-y-6">

      {% if pending_friend_requests %}
      <section class="card border border-base-200 bg-base-100" aria-label="Friend requests">
        <div class="card-body p-5">
          <div class="flex items-center justify-between">
            <h2 class="text-base font-bold flex items-center gap-2">
              <i class="bi bi-person-plus" aria-hidden="true"></i>
              <span>Friend Requests</span>
            </h2>
            <a href="{% url 'friend_requests' %}" class="link link-primary text-sm">Review</a>
          </div>

          <div class="mt-3 space-y-3">
            {% for request in pending_friend_requests|slice:":2" %}
            <div class="flex items-center justify-between gap-3">
              <div class="flex items-center gap-2 min-w-0">
                <div class="avatar placeholder">
                  <div class="bg-neutral text-neutral-content rounded-full w-9">
                    <span class="text-xs">{{ request.from_user.username|first|upper }}</span>
                  </div>
                </div>
                <span class="text-sm font-semibold truncate">{{ request.from_user.username }}</span>
              </div>
              <a href="{% url 'friend_requests' %}" class="btn btn-outline btn-sm">Open</a>
            </div>
            {% endfor %}
          </div>
        </div>
      </section>
      {% endif %}

      <!-- Today's Tasks -->
      <section class="card border border-base-200 bg-base-100" aria-label="Today's tasks">
        <div class="card-body p-5">
          <div class="flex items-center justify-between gap-3">
            <h2 class="text-base font-bold flex items-center gap-2">
              <i class="bi bi-list-check" aria-hidden="true"></i>
              <span>Today</span>
            </h2>
            <a href="{% url 'task_list' %}" class="link link-primary text-sm">View all</a>
          </div>

          {% if pending_tasks %}
          <ul class="mt-3 space-y-2">
            {% for task in pending_tasks|slice:":3" %}
            <li class="flex items-center justify-between gap-3 p-3 rounded-xl border border-base-200 bg-base-100 hover:bg-base-200/40 transition">
              <div class="min-w-0">
                <p class="text-sm font-semibold truncate">{{ task.title }}</p>
                {% if task.category %}
                <p class="text-xs text-base-content/70 flex items-center gap-1 mt-1">
                  <i class="bi bi-tag" aria-hidden="true"></i>
                  <span class="truncate">{{ task.category.name }}</span>
                </p>
                {% endif %}
              </div>
              <a href="{% url 'log_create' %}?task={{ task.id }}"
                 class="btn btn-primary btn-sm"
                 aria-label="Log time for {{ task.title }}">
                <i class="bi bi-plus-lg" aria-hidden="true"></i>
                <span class="sr-only">Log</span>
              </a>
            </li>
            {% endfor %}
          </ul>
          {% else %}
          <div class="mt-4 p-4 rounded-xl bg-base-200/50 text-center">
            <p class="text-sm text-base-content/70">All caught up for today.</p>
          </div>
          {% endif %}
        </div>
      </section>

      <!-- Recent Activity -->
      <section class="card border border-base-200 bg-base-100" aria-label="Recent activity">
        <div class="card-body p-5">
          <div class="flex items-center justify-between gap-3">
            <h2 class="text-base font-bold flex items-center gap-2">
              <i class="bi bi-clock-history" aria-hidden="true"></i>
              <span>Recent</span>
            </h2>
            <a href="{% url 'log_list' %}" class="link link-primary text-sm">View all</a>
          </div>

          <div class="mt-3 space-y-3">
            {% for log in recent_logs|slice:":3" %}
            <div class="p-3 rounded-xl border border-base-200 bg-base-100">
              <p class="text-sm font-semibold">{{ log.activity }}</p>
              <p class="mt-1 text-xs text-base-content/70 flex items-center gap-2">
                <span class="inline-flex items-center gap-1">
                  <i class="bi bi-stopwatch" aria-hidden="true"></i>
                  {{ log.duration }}m
                </span>
                {% if log.category %}
                <span class="inline-flex items-center gap-1">
                  <i class="bi bi-tag" aria-hidden="true"></i>
                  {{ log.category.name }}
                </span>
                {% endif %}
              </p>
            </div>
            {% empty %}
            <p class="text-sm text-base-content/70 italic">No recent activity.</p>
            {% endfor %}
          </div>
        </div>
      </section>

    </aside>
  </div>
</main>

<script>
document.addEventListener('DOMContentLoaded', function () {
  document.querySelectorAll('.star-btn').forEach(button => {
    button.addEventListener('click', async function () {
      const activityType = this.dataset.activityType;
      const activityId = this.dataset.activityId;
      const starIcon = this.querySelector('.bi');
      const starCount = this.querySelector('.star-count');

      try {
        const response = await fetch('{% url "toggle_star_reaction" %}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
          },
          body: JSON.stringify({ activity_type: activityType, activity_id: activityId })
        });

        const data = await response.json();

        if (response.ok) {
          const starred = !!data.starred;

          // icon + emphasis (avoid relying on colour only by using filled/outline)
          starIcon.classList.toggle('bi-star-fill', starred);
          starIcon.classList.toggle('bi-star', !starred);
          starIcon.classList.toggle('text-warning', starred);

          this.setAttribute('aria-label', starred ? 'Unstar this activity' : 'Star this activity');
          starCount.textContent = data.star_count;
        } else {
          console.error('Error:', data.error);
        }
      } catch (err) {
        console.error('Network error:', err);
      }
    });
  });
});
</script>

{% endblock %}
