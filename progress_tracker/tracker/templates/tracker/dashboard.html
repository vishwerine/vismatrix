{% extends 'tracker/base.html' %}

{% block title %}Dashboard - VisMatrix{% endblock %}

{# Mobile FAB: redirect to Messages (Inbox) instead of Log Time #}
{% block mobile_fab_href %}{% url 'inbox' %}{% endblock %}
{% block mobile_fab_aria %}Open messages{% endblock %}
{% block mobile_fab_icon %}bi-chat-dots{% endblock %}

{% block content %}
<main class="space-y-6">

  <!-- Header -->
  <header class="card border border-base-200 bg-base-100" role="banner">
    <div class="card-body p-5 sm:p-6">
      <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
        <div class="min-w-0">
          <h1 class="text-2xl sm:text-3xl font-extrabold text-base-content truncate">
            Welcome back, <span class="gradient-text">{{ user.username }}</span>!
          </h1>
          <p class="text-sm text-base-content/70 mt-1">
            Your progress overview and updates for today.
          </p>
        </div>

        <div class="flex items-center gap-2 text-sm text-base-content/70">
          <i class="bi bi-calendar-event text-primary text-lg" aria-hidden="true"></i>
          <span class="font-semibold">{{ today|date:"l, F j, Y" }}</span>
        </div>
      </div>

      <!-- Quick actions -->
      <div class="mt-4 flex flex-col sm:flex-row gap-2">
        <a href="{% url 'task_create' %}" class="btn btn-outline gap-2">
          <i class="bi bi-plus-square" aria-hidden="true"></i>
          <span>New Task</span>
        </a>
        <a href="{% url 'log_create' %}" class="btn btn-primary gap-2">
          <i class="bi bi-stopwatch" aria-hidden="true"></i>
          <span>Log Time</span>
        </a>
        <a href="{% url 'analytics' %}" class="btn btn-primary gap-2">
          <i class="bi bi-bar-chart-line" aria-hidden="true"></i>
          <span>Analytics</span>
        </a>
      </div>
    </div>
  </header>

  {% if star_notifications_count > 0 %}
  <!-- Notifications -->
  <section class="alert alert-warning" role="alert" aria-live="polite">
    <div class="flex items-start gap-3 w-full">
      <i class="bi bi-star-fill text-xl" aria-hidden="true"></i>
      <div class="flex-1 min-w-0">
        <h2 class="font-bold text-base">
          You have {{ star_notifications_count }} star{{ star_notifications_count|pluralize }}.
        </h2>
        <p class="text-sm text-base-content/70">Friends appreciated your activities.</p>
      </div>
      <a href="{% url 'notifications' %}" class="btn btn-outline btn-sm gap-2">
        <i class="bi bi-bell" aria-hidden="true"></i>
        <span>View</span>
      </a>
    </div>
  </section>
  {% endif %}

  {% if unread_message_count > 0 %}
  <!-- New Messages Notification -->
  <section class="alert alert-info" role="alert" aria-live="polite">
    <div class="flex items-start gap-3 w-full">
      <i class="bi bi-chat-dots text-xl" aria-hidden="true"></i>
      <div class="flex-1 min-w-0">
        <h2 class="font-bold text-base">
          You have {{ unread_message_count }} new message{{ unread_message_count|pluralize }}.
        </h2>
        <p class="text-sm text-base-content/70">Friends sent you messages.</p>
      </div>
      <a href="{% url 'inbox' %}" class="btn btn-outline btn-sm gap-2">
        <i class="bi bi-inbox" aria-hidden="true"></i>
        <span>View</span>
      </a>
    </div>
  </section>
  {% endif %}


  <!-- Main Content Grid: 3 columns on large screens -->
  <div class="grid grid-cols-1 xl:grid-cols-12 gap-6">

    <!-- LEFT COLUMN: Schedule & Tasks (xl:col-span-4) -->
    <div class="xl:col-span-4 space-y-6">

      <!-- Day Planner Promotion -->
      <section class="card border border-primary/30 bg-gradient-to-br from-primary/5 to-secondary/5">
        <div class="card-body p-5">
          <div class="flex items-center gap-3">
            <div class="flex-shrink-0">
              <div class="w-12 h-12 rounded-full bg-primary/10 flex items-center justify-center">
                <i class="bi bi-calendar-check text-primary text-2xl" aria-hidden="true"></i>
              </div>
            </div>
            <div class="flex-1 min-w-0">
              <h2 class="text-sm font-bold text-base-content">New Feature!</h2>
              <p class="text-xs text-base-content/70 mt-0.5">Organize your day hour by hour</p>
            </div>
          </div>
          <a href="{% url 'day_planner' %}" class="btn btn-primary btn-sm w-full mt-3 gap-2">
            <i class="bi bi-calendar-week" aria-hidden="true"></i>
            <span>Try Our New AI Day Planner</span>
          </a>
        </div>
      </section>

      <!-- Recent Activity -->
      <section class="card border border-base-200 bg-base-100" aria-label="Recent activity">
        <div class="card-body p-5">
          <div class="flex items-center justify-between gap-3">
            <h2 class="text-base font-bold flex items-center gap-2">
              <i class="bi bi-clock-history"></i>
              <span>Recent Logs</span>
            </h2>
            <a href="{% url 'log_list' %}" class="link link-primary text-sm">View all</a>
          </div>

          <div class="mt-3 space-y-3">
            {% for log in recent_logs|slice:":4" %}
            <div class="p-3 rounded-xl border border-base-200 bg-base-100">
              <p class="text-sm font-semibold">{{ log.activity }}</p>
              <p class="mt-1 text-xs text-base-content/70 flex items-center gap-2">
                <span class="inline-flex items-center gap-1">
                  <i class="bi bi-stopwatch"></i>
                  {{ log.duration }}m
                </span>
                {% if log.category %}
                <span class="inline-flex items-center gap-1">
                  <i class="bi bi-tag"></i>
                  {{ log.category.name }}
                </span>
                {% endif %}
              </p>
            </div>
            {% empty %}
            <p class="text-sm text-base-content/70 italic text-center py-4">No recent activity.</p>
            {% endfor %}
          </div>
        </div>
      </section>

      <!-- Plans -->
      <section class="card border border-base-200 bg-base-100" aria-label="Active plans">
        <div class="card-body p-5">
          <div class="flex items-center justify-between gap-3">
            <h2 class="text-base font-bold flex items-center gap-2">
              <i class="bi bi-diagram-3"></i>
              <span>Plans</span>
            </h2>
            <a href="{% url 'plan_list' %}" class="link link-primary text-sm">View all</a>
          </div>

          {% if active_plans %}
          <div class="mt-3 space-y-3">
            {% for plan in active_plans|slice:":3" %}
            <a href="{% url 'plan_detail' plan.pk %}" 
               class="block p-3 rounded-xl border border-base-200 bg-base-100 hover:bg-base-200/40 transition">
              <div class="flex items-start justify-between gap-2">
                <div class="min-w-0 flex-1">
                  <p class="text-sm font-semibold truncate">{{ plan.title }}</p>
                  <p class="mt-1 text-xs text-base-content/70 flex items-center gap-2">
                    <span class="inline-flex items-center gap-1">
                      <i class="bi bi-diagram-3"></i>
                      {{ plan.total_tasks|default:0 }} task{{ plan.total_tasks|default:0|pluralize }}
                    </span>
                    {% if plan.total_tasks > 0 %}
                    <span class="inline-flex items-center gap-1">
                      <i class="bi bi-check-circle"></i>
                      {{ plan.completed_tasks|default:0 }}/{{ plan.total_tasks }}
                    </span>
                    {% endif %}
                  </p>
                </div>
                {% if plan.total_tasks > 0 %}
                <div class="radial-progress text-xs" 
                     style="--value:{% widthratio plan.completed_tasks plan.total_tasks 100 %}; --size:2.5rem; --thickness:3px;"
                     role="progressbar">
                  <span class="text-[10px]">{% widthratio plan.completed_tasks plan.total_tasks 100 %}%</span>
                </div>
                {% endif %}
              </div>
            </a>
            {% endfor %}
          </div>
          {% else %}
          <div class="mt-4 p-4 rounded-xl bg-base-200/50 text-center">
            <p class="text-sm text-base-content/70">No active plans.</p>
            <a href="{% url 'plan_create' %}" class="btn btn-outline btn-sm mt-2 gap-2">
              <i class="bi bi-plus-lg"></i>
              <span>Create Plan</span>
            </a>
          </div>
          {% endif %}
        </div>
      </section>

    </div>

    <!-- MIDDLE COLUMN: Friends Feed (xl:col-span-5) -->
    <div class="xl:col-span-5">
      {% if friends_timeline %}
      <section class="card border border-base-200 bg-base-100" aria-label="Friends activity">
        <div class="card-body p-5 sm:p-6">
          <div class="flex items-center justify-between gap-3">
            <h2 class="text-lg font-bold flex items-center gap-2">
              <i class="bi bi-people"></i>
              <span>Friends Feed</span>
              <span class="badge badge-primary badge-sm">{{ friends_timeline|length }}</span>
            </h2>
            <a href="{% url 'friends_feed' %}" class="link link-primary text-sm flex items-center gap-1">
              <span>View all</span>
              <i class="bi bi-arrow-right"></i>
            </a>
          </div>

          <div class="mt-4 space-y-3">
          {% for item in friends_timeline %}
          <article class="p-4 rounded-2xl border border-base-200 bg-base-100 hover:bg-base-200/40 transition-colors cursor-pointer">
            <div class="flex items-start gap-3">
              <div class="avatar placeholder">
                <div class="bg-gradient-to-br from-primary to-secondary text-primary-content rounded-full w-12 h-12 ring-2 ring-primary/20 shadow-lg">
                  <span class="text-base font-bold">{{ item.user.username|first|upper }}</span>
                </div>
              </div>

              <div class="flex-1 min-w-0">
                <div class="flex flex-wrap items-center gap-2 mb-1">
                  <a href="{% url 'view_friend_profile' item.friendship_id %}"
                     class="font-bold text-sm link link-primary hover:underline">
                    {{ item.user.username }}
                  </a>
                  {% if item.type == 'task' %}
                    <span class="badge badge-success badge-sm gap-1 shadow-sm">
                      <i class="bi bi-check-circle-fill" aria-hidden="true"></i>
                      <span>Task</span>
                    </span>
                  {% else %}
                    <span class="badge badge-info badge-sm gap-1 shadow-sm">
                      <i class="bi bi-stopwatch" aria-hidden="true"></i>
                      <span>Log</span>
                    </span>
                  {% endif %}
                </div>

                <p class="text-sm font-semibold mb-2">
                  {% if item.type == 'task' %}
                    Completed: {{ item.title }}
                  {% else %}
                    Logged: {{ item.title }}
                  {% endif %}
                </p>

                <div class="flex flex-wrap items-center gap-x-4 gap-y-1 text-xs text-base-content/70">
                  <span class="inline-flex items-center gap-1">
                    <i class="bi bi-clock" aria-hidden="true"></i>
                    {{ item.timestamp|date:"M j, g:i A" }}
                  </span>
                  {% if item.duration %}
                  <span class="inline-flex items-center gap-1">
                    <i class="bi bi-stopwatch" aria-hidden="true"></i>
                    {{ item.duration }}m
                  </span>
                  {% endif %}
                  {% if item.category %}
                  <span class="inline-flex items-center gap-1 badge badge-outline badge-xs">
                    <i class="bi bi-tag" aria-hidden="true"></i>
                    {{ item.category.name }}
                  </span>
                  {% endif %}
                </div>
              </div>

              <!-- Star action -->
              <button
                class="star-btn btn btn-ghost btn-sm gap-2 flex-shrink-0"
                data-activity-type="{{ item.type }}"
                data-activity-id="{{ item.id }}"
                aria-label="{% if item.user_starred %}Unstar this activity{% else %}Star this activity{% endif %}">
                <i class="bi bi-star{% if item.user_starred %}-fill{% endif %} {% if item.user_starred %}text-warning{% endif %} text-lg" aria-hidden="true"></i>
                <span class="star-count text-sm font-semibold tabular-nums">{{ item.star_count }}</span>
              </button>
            </div>
          </article>
          {% endfor %}
          </div>
        </div>
      </section>
      {% endif %}
    </div>

    <!-- RIGHT COLUMN: Stats & Info (xl:col-span-3) -->
    <aside class="xl:col-span-3 space-y-6">

      {% if pending_friend_requests %}
      <section class="card border border-base-200 bg-base-100" aria-label="Friend requests">
        <div class="card-body p-5">
          <div class="flex items-center justify-between">
            <h2 class="text-base font-bold flex items-center gap-2">
              <i class="bi bi-person-plus" aria-hidden="true"></i>
              <span>Friend Requests</span>
            </h2>
            <a href="{% url 'friend_requests' %}" class="link link-primary text-sm">Review</a>
          </div>

          <div class="mt-3 space-y-3">
            {% for request in pending_friend_requests|slice:":2" %}
            <div class="flex items-center justify-between gap-3">
              <div class="flex items-center gap-2 min-w-0">
                <div class="avatar placeholder">
                  <div class="bg-neutral text-neutral-content rounded-full w-9">
                    <span class="text-xs">{{ request.from_user.username|first|upper }}</span>
                  </div>
                </div>
                <span class="text-sm font-semibold truncate">{{ request.from_user.username }}</span>
              </div>
              <a href="{% url 'friend_requests' %}" class="btn btn-outline btn-sm">Open</a>
            </div>
            {% endfor %}
          </div>
        </div>
      </section>
      {% endif %}

      <!-- Today's Tasks -->
      <section class="card border border-base-200 bg-base-100" aria-label="Today's tasks">
        <div class="card-body p-5">
          <div class="flex items-center justify-between gap-3">
            <h2 class="text-base font-bold flex items-center gap-2">
              <i class="bi bi-list-check" aria-hidden="true"></i>
              <span>Today's Tasks</span>
            </h2>
            <a href="{% url 'task_list' %}" class="link link-primary text-sm flex items-center gap-1">
              <span>View all</span>
              <i class="bi bi-arrow-right text-xs" aria-hidden="true"></i>
            </a>
          </div>

          {% if pending_tasks %}
          <ul class="mt-3 space-y-2">
            {% for task in pending_tasks|slice:":4" %}
            <li class="group">
              <div class="flex items-start gap-3 p-3 rounded-xl border border-base-200 bg-base-100 hover:bg-base-200/40 hover:border-primary/30 transition">
                <div class="flex-1 min-w-0">
                  <p class="text-sm font-semibold truncate">{{ task.title }}</p>
                  <div class="flex flex-wrap items-center gap-2 mt-1">
                    {% if task.category %}
                    <span class="badge badge-outline badge-xs gap-1">
                      <i class="bi bi-tag" aria-hidden="true"></i>
                      {{ task.category.name }}
                    </span>
                    {% endif %}
                    {% if task.due_date %}
                    <span class="badge badge-xs gap-1 {% if task.due_date == today %}badge-warning{% elif task.due_date < today %}badge-error{% else %}badge-ghost{% endif %}">
                      <i class="bi bi-calendar" aria-hidden="true"></i>
                      {{ task.due_date|date:"M j" }}
                    </span>
                    {% endif %}
                    {% if task.priority %}
                    <span class="badge badge-xs {% if task.priority == 'high' %}badge-error{% elif task.priority == 'medium' %}badge-warning{% else %}badge-ghost{% endif %}">
                      {{ task.priority }}
                    </span>
                    {% endif %}
                  </div>
                </div>
                <a href="{% url 'log_create' %}?task={{ task.id }}"
                   class="btn btn-primary btn-sm gap-1"
                   aria-label="Log time for {{ task.title }}">
                  <i class="bi bi-play-fill" aria-hidden="true"></i>
                  <span>Start</span>
                </a>
              </div>
            </li>
            {% endfor %}
          </ul>
          {% else %}
          <div class="mt-4 p-4 rounded-xl bg-gradient-to-br from-success/5 to-transparent border border-success/20 text-center">
            <i class="bi bi-check-circle text-success text-3xl mb-2"></i>
            <p class="text-sm font-semibold text-base-content">All caught up!</p>
            <p class="text-xs text-base-content/70 mt-1">No pending tasks for today.</p>
          </div>
          {% endif %}
        </div>
      </section>



      <!-- Activity Calendar -->
      {% if calendar_days %}
      <section class="card border border-base-200 bg-base-100" aria-label="Monthly activity">
        <div class="card-body p-5">
          <div class="flex items-center justify-between gap-3">
            <h2 class="text-base font-bold flex items-center gap-2">
              <i class="bi bi-calendar3" aria-hidden="true"></i>
              <span>This Month</span>
            </h2>
            <span class="badge badge-outline text-xs">{{ logs_this_month }} logs</span>
          </div>

          <div class="mt-3">
            <!-- Calendar header -->
            <div class="grid grid-cols-7 gap-1 mb-2">
              {% for day_name in day_names %}
              <div class="text-xs text-center font-semibold text-base-content/60">
                {{ day_name|slice:":1" }}
              </div>
              {% endfor %}
            </div>
            
            <!-- Calendar days -->
            <div class="grid grid-cols-7 gap-1">
              {% for day in calendar_days %}
              <div class="aspect-square flex items-center justify-center text-xs rounded {% if day.logged %}bg-primary text-primary-content font-semibold{% else %}bg-base-200/50 text-base-content/50{% endif %}"
                   title="{% if day.logged %}Activity logged{% else %}No activity{% endif %}">
                {{ day.day }}
              </div>
              {% endfor %}
            </div>
            
            <div class="mt-3 flex items-center justify-center gap-3 text-xs">
              <div class="flex items-center gap-1">
                <div class="w-3 h-3 rounded bg-base-200/50"></div>
                <span class="text-base-content/60">None</span>
              </div>
              <div class="flex items-center gap-1">
                <div class="w-3 h-3 rounded bg-primary"></div>
                <span class="text-base-content/60">Logged</span>
              </div>
            </div>
          </div>
        </div>
      </section>
      {% endif %}

      <!-- Optional: Messages quick link (nice on desktop, harmless on mobile) -->
      <section class="card border border-base-200 bg-base-100" aria-label="Messages shortcut">
        <div class="card-body p-5">
          <div class="flex items-center justify-between gap-3">
            <h2 class="text-base font-bold flex items-center gap-2">
              <i class="bi bi-chat-dots" aria-hidden="true"></i>
              <span>Messages</span>
            </h2>
            <a href="{% url 'inbox' %}" class="link link-primary text-sm">Open Inbox</a>
          </div>
          <p class="mt-2 text-sm text-base-content/70">
            Chat with friends and keep your streak going.
          </p>
        </div>
      </section>

    </aside>
  </div>
</main>

<!-- Star toggle script -->
<script>
(function() {
  'use strict';
  
  // Ensure we only initialize once
  if (window.__dashboardInitialized) {
    console.warn('Dashboard already initialized, skipping...');
    return;
  }
  window.__dashboardInitialized = true;
  
  // Detect large dataset and apply optimizations
  const articleCount = document.querySelectorAll('article').length;
  const buttonCount = document.querySelectorAll('.star-btn').length;
  const cardCount = document.querySelectorAll('.card').length;
  
  // Lower threshold - even modest datasets can cause issues
  const isDataHeavy = articleCount > 3 || buttonCount > 5 || cardCount > 10;
  
  if (isDataHeavy) {
    console.log('ðŸ“Š Large dataset detected (' + articleCount + ' articles, ' + buttonCount + ' buttons, ' + cardCount + ' cards), applying performance optimizations...');
    document.body.classList.add('data-heavy');
    
    // Throttle scroll events - only fire every 150ms max
    let scrollTimeout;
    let scrollRAF;
    
    const throttledScroll = function() {
      if (scrollRAF) return; // Already scheduled
      
      scrollRAF = requestAnimationFrame(() => {
        document.body.classList.add('is-scrolling');
        scrollRAF = null;
        
        clearTimeout(scrollTimeout);
        scrollTimeout = setTimeout(() => {
          document.body.classList.remove('is-scrolling');
        }, 150);
      });
    };
    
    // Only add if not already added
    if (!window.__dashboardScrollListenerAdded) {
      window.__dashboardScrollListenerAdded = true;
      window.addEventListener('scroll', throttledScroll, { passive: true });
    }
  } else {
    console.log('âœ… Normal dataset (' + articleCount + ' articles, ' + buttonCount + ' buttons, ' + cardCount + ' cards)');
  }
  
  // Star toggle - use event delegation OUTSIDE DOMContentLoaded
  // This prevents duplicate listeners and runs immediately
  let isProcessingClick = false;
  let lastClickTime = 0;
  
  document.addEventListener('click', function(event) {
    const button = event.target.closest('.star-btn');
    if (!button) return;
    
    // Aggressive debouncing for data-heavy pages (prevent rapid clicks)
    const now = Date.now();
    if (now - lastClickTime < 500) {
      event.preventDefault();
      event.stopPropagation();
      return;
    }
    lastClickTime = now;
    
    // Prevent multiple simultaneous requests
    if (isProcessingClick) {
      event.preventDefault();
      event.stopPropagation();
      return;
    }
    
    // Prevent default and stop propagation
    event.preventDefault();
    event.stopPropagation();
    
    isProcessingClick = true;
    button.disabled = true;
    
    const activityType = button.dataset.activityType;
    const activityId = button.dataset.activityId;
    const starIcon = button.querySelector('.bi');
    const starCount = button.querySelector('.star-count');

    // Use fetch with timeout (3s for faster recovery)
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 3000);

    fetch('{% url "toggle_star_reaction" %}', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token }}',
        'X-Requested-With': 'XMLHttpRequest'
      },
      body: JSON.stringify({ activity_type: activityType, activity_id: activityId }),
      signal: controller.signal
    })
    .then(response => response.json())
    .then(data => {
      clearTimeout(timeoutId);
      if (data.starred !== undefined) {
        const starred = !!data.starred;
        starIcon.classList.toggle('bi-star-fill', starred);
        starIcon.classList.toggle('bi-star', !starred);
        starIcon.classList.toggle('text-warning', starred);
        button.setAttribute('aria-label', starred ? 'Unstar this activity' : 'Star this activity');
        if (starCount) {
          starCount.textContent = data.star_count;
        }
      }
    })
    .catch(err => {
      clearTimeout(timeoutId);
      if (err.name !== 'AbortError') {
        console.error('Network error:', err);
      }
    })
    .finally(() => {
      isProcessingClick = false;
      button.disabled = false;
    });
  }, { passive: false });

document.addEventListener('DOMContentLoaded', function () {
  // Current time indicator for day schedule
  const timeline = document.getElementById('day-timeline');
  const currentTimeLine = document.getElementById('current-time-line');
  const currentTimeText = document.getElementById('current-time-text');
  
  // Early exit if elements don't exist
  if (!timeline || !currentTimeLine || !currentTimeText) {
    return;
  }
  
  let timelineUpdateInterval = null;
  let updatePending = false;
  
  function updateCurrentTimeLine() {
    if (updatePending) return;

    updatePending = true;
    
    const now = new Date();
    const hours = now.getHours();
    const minutes = now.getMinutes();
    
    // Only show the line if current time is between 9 AM (9) and 9 PM (21)
    if (hours >= 9 && hours < 21) {
      // Use requestAnimationFrame for smoother updates and better performance
      requestAnimationFrame(() => {
        try {
          // Calculate position as percentage
          // Total time span: 9 AM to 9 PM = 12 hours = 720 minutes
          // Current time from 9 AM in minutes
          const minutesFrom9AM = (hours - 9) * 60 + minutes;
          const totalMinutes = 12 * 60; // 12 hours
          const percentage = (minutesFrom9AM / totalMinutes) * 100;
          
          // Timeline has 12 hour slots, each 48px (h-12)
          const timelineHeight = 12 * 48; // 576px
          const topPosition = (percentage / 100) * timelineHeight;
          
          // Use transform instead of top for better performance
          currentTimeLine.style.transform = `translateY(${topPosition}px)`;
          currentTimeLine.style.top = '0';
          currentTimeLine.classList.remove('hidden');
          
          // Format time
          const ampm = hours >= 12 ? 'PM' : 'AM';
          const displayHours = hours > 12 ? hours - 12 : hours;
          const displayMinutes = minutes.toString().padStart(2, '0');
          currentTimeText.textContent = `${displayHours}:${displayMinutes} ${ampm}`;
        } catch (error) {
          console.error('Error updating timeline:', error);
        } finally {
          updatePending = false;
        }
      });
    } else {
      currentTimeLine.classList.add('hidden');
      updatePending = false;
    }
  }
  
  // Clear any existing interval to prevent duplicates
  if (timelineUpdateInterval) {
    clearInterval(timelineUpdateInterval);
    timelineUpdateInterval = null;
  }
  
  // Update current time line immediately and every minute
  updateCurrentTimeLine();
  timelineUpdateInterval = setInterval(updateCurrentTimeLine, 60000); // Update every minute
  
  // Clean up interval when page is hidden or unloaded - use { once: true } to prevent duplicates
  const visibilityHandler = function() {
    if (document.hidden && timelineUpdateInterval) {
      clearInterval(timelineUpdateInterval);
      timelineUpdateInterval = null;
      updatePending = false; // Reset throttle flag
    } else if (!document.hidden && !timelineUpdateInterval) {
      updateCurrentTimeLine();
      timelineUpdateInterval = setInterval(updateCurrentTimeLine, 60000);
    }
  };
  
  const unloadHandler = function() {
    if (timelineUpdateInterval) {
      clearInterval(timelineUpdateInterval);
      timelineUpdateInterval = null;
      updatePending = false;
    }
  };
  
  // Only add listeners if not already added (check flag on window)
  if (!window.__dashboardTimelineListenersAdded) {
    window.__dashboardTimelineListenersAdded = true;
    document.addEventListener('visibilitychange', visibilityHandler, { passive: true });
    window.addEventListener('beforeunload', unloadHandler, { once: true, passive: true });
  }
});

})(); // End IIFE
</script>


{% endblock %}
