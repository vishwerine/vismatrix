{% extends 'tracker/base.html' %}
{% load ad_tags %}

{% block title %}Dashboard - VisMatrix{% endblock %}

{# Mobile FAB: redirect to Messages (Inbox) instead of Log Time #}
{% block mobile_fab_href %}{% url 'inbox' %}{% endblock %}
{% block mobile_fab_aria %}Open messages{% endblock %}
{% block mobile_fab_icon %}bi-chat-dots{% endblock %}

{% block content %}
<main class="space-y-6">

  <!-- Header -->
  <header class="card border border-base-200 bg-gradient-to-br from-primary/5 via-base-100 to-secondary/5 shadow-lg" role="banner">
    <div class="card-body p-6 sm:p-8">
      <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
        <div class="min-w-0">
          <h1 class="text-3xl sm:text-4xl font-black text-base-content truncate mb-2">
            Welcome back, <span class="gradient-text">{{ user.username }}</span>! üëã
          </h1>
          <p class="text-sm sm:text-base text-base-content/70">
            Your progress overview and updates for today.
          </p>
        </div>

        <div class="flex items-center gap-3 text-sm sm:text-base text-base-content/70 bg-base-100/50 px-4 py-2 rounded-xl backdrop-blur-sm">
          <i class="bi bi-calendar-event text-primary text-xl" aria-hidden="true"></i>
          <span class="font-semibold">{{ today|date:"l, F j, Y" }}</span>
        </div>
      </div>

      <!-- Quick actions -->
      <div class="mt-6 flex flex-wrap gap-3">
        <a href="{% url 'quickstart' %}" class="btn btn-accent gap-2 shadow-lg hover:shadow-xl transition-all">
          <i class="bi bi-lightning-charge-fill" aria-hidden="true"></i>
          <span>Quickstart</span>
        </a>
        <a href="{% url 'mentor_list' %}" class="btn btn-outline gap-2 hover:shadow-md transition-all">
          <i class="bi bi-people" aria-hidden="true"></i>
          <span>Find Mentor</span>
        </a>
        {% if is_mentor %}
        <a href="{% url 'mentor_dashboard' %}" class="btn btn-success gap-2 shadow-md hover:shadow-lg transition-all">
          <i class="bi bi-person-badge" aria-hidden="true"></i>
          <span>My Mentor Profile</span>
        </a>
        {% endif %}
        <a href="{% url 'task_create' %}" class="btn btn-primary gap-2 shadow-md hover:shadow-lg transition-all">
          <i class="bi bi-plus-square" aria-hidden="true"></i>
          <span>New Task</span>
        </a>

        <a href="{% url 'task_list' %}" class="btn btn-primary gap-2 shadow-md hover:shadow-lg transition-all">Tasks</a>
        </a>

        <a href="{% url 'habit_list' %}" class="btn btn-success gap-2 shadow-md hover:shadow-lg transition-all">
          <i class="bi bi-repeat" aria-hidden="true"></i>
          <span>Habits</span>
        </a>

        <a href="{% url 'log_list' %}" class="btn btn-primary gap-2 shadow-md hover:shadow-lg transition-all">Logs</a>
        </a>

      </div>

    </div>
  </header>

  <!-- Advertisement: Header Banner -->
  {% ad_container 'header_banner' 'my-6 max-w-5xl mx-auto' %}

  {% if unread_message_count > 0 %}
  <!-- New Messages Notification -->
  <section class="alert alert-info shadow-md hover:shadow-lg transition-all" role="alert" aria-live="polite">
    <div class="flex items-start gap-4 w-full">
      <div class="flex-shrink-0 w-12 h-12 rounded-full bg-info/20 flex items-center justify-center">
        <i class="bi bi-chat-dots text-info text-xl" aria-hidden="true"></i>
      </div>
      <div class="flex-1 min-w-0">
        <h2 class="font-bold text-base sm:text-lg">
          üí¨ {{ unread_message_count }} new message{{ unread_message_count|pluralize }}
        </h2>
        <p class="text-sm text-base-content/70 mt-1">Friends sent you messages.</p>
      </div>
      <a href="{% url 'inbox' %}" class="btn btn-info btn-sm gap-2 shadow-md hover:shadow-lg transition-all">
        <i class="bi bi-inbox" aria-hidden="true"></i>
        <span>View</span>
      </a>
    </div>
  </section>
  {% endif %}

  {% if unread_notifications_count > 0 %}
  <!-- Mentorship Notifications -->
  <section class="alert alert-success shadow-md hover:shadow-lg transition-all" role="alert" aria-live="polite">
    <div class="flex items-start gap-4 w-full">
      <div class="flex-shrink-0 w-12 h-12 rounded-full bg-success/20 flex items-center justify-center">
        <i class="bi bi-bell-fill text-success text-xl" aria-hidden="true"></i>
      </div>
      <div class="flex-1 min-w-0">
        <h2 class="font-bold text-base sm:text-lg">
          üîî {{ unread_notifications_count }} new notification{{ unread_notifications_count|pluralize }}
        </h2>
        <p class="text-sm text-base-content/70 mt-1">Updates about your mentorships.</p>
      </div>
      <a href="{% url 'notifications_list' %}" class="btn btn-success btn-sm gap-2 shadow-md hover:shadow-lg transition-all">
        <i class="bi bi-bell" aria-hidden="true"></i>
        <span>View</span>
      </a>
    </div>
  </section>
  {% endif %}


  <!-- Main Content Grid: 3 columns on large screens -->
  <div class="grid grid-cols-1 xl:grid-cols-12 gap-6">

    <!-- LEFT COLUMN: Schedule & Tasks (xl:col-span-4) -->
    <div class="xl:col-span-4 space-y-6">

      {% comment %} <!-- Day Planner Promotion -->
      <section class="card border border-primary/30 bg-gradient-to-br from-primary/5 to-secondary/5">
        <div class="card-body p-5">
          <div class="flex items-center gap-3">
            <div class="flex-shrink-0">
              <div class="w-12 h-12 rounded-full bg-primary/10 flex items-center justify-center">
                <i class="bi bi-calendar-check text-primary text-2xl" aria-hidden="true"></i>
              </div>
            </div>
            <div class="flex-1 min-w-0">
              <h2 class="text-sm font-bold text-base-content">New Feature!</h2>
              <p class="text-xs text-base-content/70 mt-0.5">Organize your day hour by hour</p>
            </div>
          </div>
          <a href="{% url 'day_planner' %}" class="btn btn-primary btn-sm w-full mt-3 gap-2">
            <i class="bi bi-calendar-week" aria-hidden="true"></i>
            <span>Try Our New AI Day Planner</span>
          </a>
        </div>
      </section> {% endcomment %}

      <!-- Recent Activity -->
      <section class="card border border-base-200 bg-base-100 shadow-md hover:shadow-lg transition-all" aria-label="Recent activity">
        <div class="card-body p-5">
          <div class="flex items-center justify-between gap-3 mb-1">
            <h2 class="text-base font-bold flex items-center gap-2">
              <i class="bi bi-clock-history text-primary"></i>
              <span>Recent Logs</span>
            </h2>
            <a href="{% url 'log_list' %}" class="link link-primary text-sm font-semibold hover:gap-2 transition-all flex items-center gap-1">
              <span>View all</span>
              <i class="bi bi-arrow-right text-xs"></i>
            </a>
          </div>

          <div class="mt-4 space-y-2">
            {% for log in recent_logs|slice:":4" %}
            <div class="p-4 rounded-xl border border-base-200 bg-gradient-to-br from-base-100 to-base-200/20 hover:shadow-md hover:border-primary/30 transition-all">
              <p class="text-sm font-semibold text-base-content">{{ log.activity }}</p>
              <p class="mt-2 text-xs text-base-content/70 flex items-center gap-3">
                <span class="inline-flex items-center gap-1 bg-primary/10 px-2 py-1 rounded-md">
                  <i class="bi bi-stopwatch text-primary"></i>
                  <span class="font-semibold">{{ log.duration }}m</span>
                </span>
                {% if log.category %}
                <span class="inline-flex items-center gap-1 badge badge-outline badge-sm">
                  <i class="bi bi-tag"></i>
                  {{ log.category.name }}
                </span>
                {% endif %}
              </p>
            </div>
            {% empty %}
            <div class="text-center py-8">
              <i class="bi bi-inbox text-4xl text-base-content/30 mb-2"></i>
              <p class="text-sm text-base-content/70">No recent activity.</p>
            </div>
            {% endfor %}
          </div>
        </div>
      </section>

      <!-- Plans -->
      <section class="card border border-base-200 bg-base-100 shadow-md hover:shadow-lg transition-all" aria-label="Active plans">
        <div class="card-body p-5">
          <div class="flex items-center justify-between gap-3 mb-1">
            <h2 class="text-base font-bold flex items-center gap-2">
              <i class="bi bi-diagram-3 text-secondary"></i>
              <span>Plans</span>
            </h2>
            <a href="{% url 'plan_list' %}" class="link link-primary text-sm font-semibold hover:gap-2 transition-all flex items-center gap-1">
              <span>View all</span>
              <i class="bi bi-arrow-right text-xs"></i>
            </a>
          </div>

          {% if active_plans %}
          <div class="mt-4 space-y-2">
            {% for plan in active_plans|slice:":3" %}
            <a href="{% url 'plan_detail' plan.pk %}" 
               class="block p-4 rounded-xl border border-base-200 bg-gradient-to-br from-base-100 to-base-200/20 hover:shadow-md hover:border-secondary/30 transition-all group">
              <div class="flex items-start justify-between gap-3">
                <div class="min-w-0 flex-1">
                  <p class="text-sm font-bold truncate group-hover:text-secondary transition-colors">{{ plan.title }}</p>
                  <p class="mt-2 text-xs text-base-content/70 flex items-center gap-3">
                    <span class="inline-flex items-center gap-1">
                      <i class="bi bi-diagram-3"></i>
                      {{ plan.total_tasks|default:0 }} task{{ plan.total_tasks|default:0|pluralize }}
                    </span>
                    {% if plan.total_tasks > 0 %}
                    <span class="inline-flex items-center gap-1 font-semibold">
                      <i class="bi bi-check-circle text-success"></i>
                      {{ plan.completed_tasks|default:0 }}/{{ plan.total_tasks }}
                    </span>
                    {% endif %}
                  </p>
                </div>
                {% if plan.total_tasks > 0 %}
                <div class="radial-progress text-xs text-secondary" 
                     style="--value:{% widthratio plan.completed_tasks plan.total_tasks 100 %}; --size:3rem; --thickness:4px;"
                     role="progressbar">
                  <span class="text-[10px] font-bold">{% widthratio plan.completed_tasks plan.total_tasks 100 %}%</span>
                </div>
                {% endif %}
              </div>
            </a>
            {% endfor %}
          </div>
          {% else %}
          <div class="mt-4 p-6 rounded-xl bg-gradient-to-br from-base-200/50 to-base-200/20 text-center border border-base-300">
            <i class="bi bi-diagram-3 text-4xl text-base-content/30 mb-2"></i>
            <p class="text-sm text-base-content/70 mb-3">No active plans yet.</p>
            <a href="{% url 'plan_create' %}" class="btn btn-primary btn-sm gap-2 shadow-md hover:shadow-lg transition-all">
              <i class="bi bi-plus-lg"></i>
              <span>Create Plan</span>
            </a>
          </div>
          {% endif %}
        </div>
      </section>

      <!-- Today's Habits -->
      {% if todays_habits %}
      <section class="card border border-success/30 bg-gradient-to-br from-success/5 to-transparent shadow-md hover:shadow-lg transition-all" aria-label="Today's habits">
        <div class="card-body p-5">
          <div class="flex items-center justify-between gap-3 mb-1">
            <h2 class="text-base font-bold flex items-center gap-2">
              <i class="bi bi-repeat text-success"></i>
              <span>Today's Habits</span>
            </h2>
            <a href="{% url 'habit_list' %}" class="link link-primary text-sm font-semibold hover:gap-2 transition-all flex items-center gap-1">
              <span>View all</span>
              <i class="bi bi-arrow-right text-xs"></i>
            </a>
          </div>

          <div class="mt-4 space-y-2">
            {% for habit in todays_habits|slice:":4" %}
            <div class="p-4 rounded-xl border border-base-200 bg-gradient-to-br from-base-100 to-base-200/20 {% if habit.completed_today %}bg-success/5 border-success/30{% elif habit.is_due %}bg-warning/5 border-warning/30{% endif %} hover:shadow-md transition-all">
              <div class="flex items-start gap-3">
                <!-- Completion checkbox -->
                <div class="flex-shrink-0 pt-0.5">
                  {% if habit.completed_today %}
                    <i class="bi bi-check-circle-fill text-success text-xl"></i>
                  {% else %}
                    <form method="post" action="{% url 'habit_complete' habit.pk %}" class="inline">
                      {% csrf_token %}
                      <input type="hidden" name="next" value="dashboard">
                      <button type="submit" class="btn btn-circle btn-xs btn-ghost hover:bg-success/20" title="Mark as complete">
                        <i class="bi bi-circle text-base-content/30"></i>
                      </button>
                    </form>
                  {% endif %}
                </div>

                <div class="flex-1 min-w-0">
                  <p class="text-sm font-bold truncate">{{ habit.title }}</p>
                  <div class="flex flex-wrap items-center gap-2 mt-2">
                    <!-- Frequency -->
                    <span class="badge badge-ghost badge-xs gap-1">
                      <i class="bi bi-arrow-repeat"></i>
                      {{ habit.get_frequency_display }}
                    </span>
                    
                    <!-- Category -->
                    {% if habit.category %}
                    <span class="badge badge-outline badge-xs gap-1">
                      <i class="bi bi-tag"></i>
                      {{ habit.category.name }}
                    </span>
                    {% endif %}

                    <!-- Streak for daily habits -->
                    {% if habit.frequency == 'daily' and habit.current_streak > 0 %}
                    <span class="badge badge-warning badge-xs gap-1 font-bold">
                      <i class="bi bi-fire"></i>
                      {{ habit.current_streak }} day{{ habit.current_streak|pluralize }}
                    </span>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>

          <!-- Quick link to create habit -->
          <div class="mt-3">
            <a href="{% url 'habit_create' %}" class="btn btn-success btn-sm w-full gap-2">
              <i class="bi bi-plus-lg"></i>
              <span>New Habit</span>
            </a>
          </div>
        </div>
      </section>
      {% endif %}

      {% if active_timer_sessions %}
      <!-- Active Public Timer Sessions -->
      <section class="card border border-info/30 bg-gradient-to-br from-info/5 to-transparent" aria-label="Active timer sessions">
        <div class="card-body p-5">
          <div class="flex items-center justify-between gap-3">
            <h2 class="text-base font-bold flex items-center gap-2">
              <i class="bi bi-broadcast text-info" aria-hidden="true"></i>
              <span>Live Timer Sessions</span>
              <span class="badge badge-info badge-sm">{{ active_timer_sessions|length }}</span>
            </h2>
          </div>

          <div class="mt-3 space-y-2">
            {% for session in active_timer_sessions %}
            <div class="p-3 rounded-xl border border-info/20 bg-base-100 hover:bg-info/5 transition">
              <div class="flex items-start justify-between gap-3">
                <div class="flex-1 min-w-0">
                  <div class="flex items-center gap-2 mb-1">
                    <div class="avatar placeholder">
                      <div class="bg-info text-info-content rounded-full w-7 h-7">
                        <span class="text-xs font-bold">{{ session.host.username|first|upper }}</span>
                      </div>
                    </div>
                    <span class="text-xs font-semibold text-base-content/80">{{ session.host.username }}</span>
                    {% if session.started_at and not session.ended_at %}
                    <span class="flex items-center gap-1">
                      <span class="relative flex h-2 w-2">
                        <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-success opacity-75"></span>
                        <span class="relative inline-flex rounded-full h-2 w-2 bg-success"></span>
                      </span>
                      <span class="text-xs text-success font-medium">Live</span>
                    </span>
                    {% elif session.ended_at %}
                    <span class="flex items-center gap-1">
                      <span class="relative inline-flex rounded-full h-2 w-2 bg-warning"></span>
                      <span class="text-xs text-warning font-medium">Paused</span>
                    </span>
                    {% else %}
                    <span class="flex items-center gap-1">
                      <span class="relative inline-flex rounded-full h-2 w-2 bg-base-content/40"></span>
                      <span class="text-xs text-base-content/60 font-medium">Waiting</span>
                    </span>
                    {% endif %}
                  </div>
                  
                  <p class="text-sm font-semibold truncate">{{ session.task.title }}</p>
                  
                  <div class="flex flex-wrap items-center gap-2 mt-1">
                    {% if session.task.category %}
                    <span class="badge badge-outline badge-xs gap-1">
                      <i class="bi bi-tag" aria-hidden="true"></i>
                      {{ session.task.category.name }}
                    </span>
                    {% endif %}
                    <span class="badge badge-info badge-xs gap-1">
                      <i class="bi bi-alarm" aria-hidden="true"></i>
                      {{ session.duration }}m {{ session.get_mode_display }}
                    </span>
                    <span class="badge badge-ghost badge-xs gap-1">
                      <i class="bi bi-people" aria-hidden="true"></i>
                      {{ session.participants.count }} participant{{ session.participants.count|pluralize }}
                    </span>
                  </div>
                </div>
                
                <a href="{% url 'task_timer' session.task.id %}?session={{ session.share_code }}"
                   class="btn btn-info btn-sm gap-1 flex-shrink-0"
                   aria-label="Join {{ session.host.username }}'s timer session">
                  <i class="bi bi-box-arrow-in-right" aria-hidden="true"></i>
                  <span>Join</span>
                </a>
              </div>
            </div>
            {% endfor %}
          </div>

          <div class="mt-3 text-xs text-base-content/60 flex items-center gap-1">
            <i class="bi bi-info-circle" aria-hidden="true"></i>
            <span>Join live sessions to collaborate with others</span>
          </div>
        </div>
      </section>
      {% endif %}

      <!-- Advertisement: In-Content -->
      {% ad_container 'in_content' 'my-6' %}

    </div>

    <!-- MIDDLE COLUMN: Friends Feed (xl:col-span-5) -->
    <div class="xl:col-span-5">
      {% if friends_timeline %}
      <section class="card border border-base-200 bg-base-100 shadow-lg hover:shadow-xl transition-all" aria-label="Friends activity">
        <div class="card-body p-5 sm:p-6">
          <div class="flex items-center justify-between gap-3 mb-1">
            <h2 class="text-lg font-bold flex items-center gap-2">
              <i class="bi bi-people text-primary"></i>
              <span>Friends Feed</span>
              <span class="badge badge-primary badge-md shadow-md">{{ friends_timeline|length }}</span>
            </h2>
            <a href="{% url 'friends_feed' %}" class="link link-primary text-sm font-semibold hover:gap-2 transition-all flex items-center gap-1">
              <span>View all</span>
              <i class="bi bi-arrow-right"></i>
            </a>
          </div>

          <div class="mt-5 space-y-3">
          {% for item in friends_timeline %}
          <article class="p-4 sm:p-5 rounded-2xl border border-base-200 bg-gradient-to-br from-base-100 to-base-200/20 hover:shadow-xl hover:border-primary/30 hover:-translate-y-1 transition-all cursor-pointer group">
            <div class="flex items-start gap-4">
              <div class="avatar placeholder">
                <div class="bg-gradient-to-br from-primary to-secondary text-primary-content rounded-full w-12 h-12 sm:w-14 sm:h-14 ring-2 ring-primary/20 shadow-lg group-hover:ring-4 group-hover:ring-primary/30 transition-all">
                  <span class="text-base sm:text-lg font-bold">{{ item.user.username|first|upper }}</span>
                </div>
              </div>

              <div class="flex-1 min-w-0">
                <div class="flex flex-wrap items-center gap-2 mb-1">
                  <a href="{% url 'view_friend_profile' item.friendship_id %}"
                     class="font-bold text-sm link link-primary hover:underline">
                    {{ item.user.username }}
                  </a>
                  {% if item.type == 'task' %}
                    <span class="badge badge-success badge-sm gap-1 shadow-sm">
                      <i class="bi bi-check-circle-fill" aria-hidden="true"></i>
                      <span>Task</span>
                    </span>
                  {% elif item.type == 'habit' %}
                    <span class="badge badge-secondary badge-sm gap-1 shadow-sm">
                      <i class="bi bi-repeat" aria-hidden="true"></i>
                      <span>Habit</span>
                    </span>
                  {% else %}
                    <span class="badge badge-info badge-sm gap-1 shadow-sm">
                      <i class="bi bi-stopwatch" aria-hidden="true"></i>
                      <span>Log</span>
                    </span>
                  {% endif %}
                </div>

                <p class="text-sm font-semibold mb-2">
                  {% if item.type == 'task' %}
                    Completed: {{ item.title }}
                  {% elif item.type == 'habit' %}
                    Completed habit: {{ item.title }}
                  {% else %}
                    Logged: {{ item.title }}
                  {% endif %}
                </p>

                <div class="flex flex-wrap items-center gap-x-4 gap-y-1 text-xs text-base-content/70">
                  <span class="inline-flex items-center gap-1">
                    <i class="bi bi-clock" aria-hidden="true"></i>
                    {{ item.timestamp|date:"M j, g:i A" }}
                  </span>
                  {% if item.duration %}
                  <span class="inline-flex items-center gap-1">
                    <i class="bi bi-stopwatch" aria-hidden="true"></i>
                    {{ item.duration }}m
                  </span>
                  {% endif %}
                  {% if item.category %}
                  <span class="inline-flex items-center gap-1 badge badge-outline badge-xs">
                    <i class="bi bi-tag" aria-hidden="true"></i>
                    {{ item.category.name }}
                  </span>
                  {% endif %}
                </div>
              </div>

              <!-- Star action -->
              <button
                class="star-btn btn btn-ghost btn-sm gap-2 flex-shrink-0"
                data-activity-type="{{ item.type }}"
                data-activity-id="{{ item.id }}"
                aria-label="{% if item.user_starred %}Unstar this activity{% else %}Star this activity{% endif %}">
                <i class="bi bi-star{% if item.user_starred %}-fill{% endif %} {% if item.user_starred %}text-warning{% endif %} text-lg" aria-hidden="true"></i>
                <span class="star-count text-sm font-semibold tabular-nums">{{ item.star_count }}</span>
              </button>
            </div>
          </article>
          {% endfor %}
          </div>
        </div>
      </section>
      {% else %}
      <!-- No Friends: Show Suggested Users -->
      <section class="card border border-base-200 bg-base-100 shadow-lg hover:shadow-xl transition-all" aria-label="Suggested users">
        <div class="card-body p-5 sm:p-6">
          <div class="flex items-center justify-between gap-3 mb-1">
            <h2 class="text-lg font-bold flex items-center gap-2">
              <i class="bi bi-person-plus text-primary"></i>
              <span>People You May Know</span>
            </h2>
            <a href="{% url 'user_list' %}" class="link link-primary text-sm font-semibold hover:gap-2 transition-all flex items-center gap-1">
              <span>View all</span>
              <i class="bi bi-arrow-right"></i>
            </a>
          </div>

          <div class="text-center py-6 mb-4">
            <i class="bi bi-people text-5xl text-base-content/30 mb-3"></i>
            <p class="text-base font-semibold text-base-content mb-2">No friends yet!</p>
            <p class="text-sm text-base-content/70">Connect with others to see their activity and stay motivated together.</p>
          </div>

          {% if suggested_users %}
          <div class="space-y-3">
            {% for suggested_user in suggested_users %}
            <div class="p-4 rounded-2xl border border-base-200 bg-gradient-to-br from-base-100 to-base-200/20 hover:shadow-lg hover:border-primary/20 hover:-translate-y-0.5 transition-all">
              <div class="flex items-center justify-between gap-4">
                <div class="flex items-center gap-3 min-w-0 flex-1">
                  <div class="avatar placeholder">
                    <div class="bg-gradient-to-br from-neutral to-neutral-focus text-neutral-content rounded-full w-12 h-12 ring-2 ring-base-300 shadow-md">
                      <span class="text-base font-bold">{{ suggested_user.username|first|upper }}</span>
                    </div>
                  </div>
                  <div class="min-w-0 flex-1">
                    <p class="font-bold text-sm truncate">{{ suggested_user.username }}</p>
                    <p class="text-xs text-base-content/60 mt-0.5">
                      <i class="bi bi-calendar-check"></i>
                      Joined {{ suggested_user.date_joined|date:"M Y" }}
                    </p>
                  </div>
                </div>
                <a href="{% url 'view_user_profile' suggested_user.id %}" 
                   class="btn btn-primary btn-sm gap-2 flex-shrink-0 shadow-md hover:shadow-lg transition-all"
                   aria-label="View {{ suggested_user.username }}'s profile">
                  <i class="bi bi-person-plus-fill"></i>
                  <span>Add</span>
                </a>
              </div>
            </div>
            {% endfor %}
          </div>
          
          <div class="mt-5 text-center">
            <a href="{% url 'user_list' %}" class="btn btn-outline btn-primary gap-2 shadow-md hover:shadow-lg transition-all">
              <i class="bi bi-search"></i>
              <span>Browse More Users</span>
            </a>
          </div>
          {% else %}
          <div class="text-center py-4">
            <p class="text-sm text-base-content/70">No suggested users at the moment.</p>
            <a href="{% url 'user_list' %}" class="btn btn-primary btn-sm gap-2 mt-3">
              <i class="bi bi-search"></i>
              <span>Browse Users</span>
            </a>
          </div>
          {% endif %}
        </div>
      </section>
      {% endif %}
    </div>

    <!-- RIGHT COLUMN: Stats & Info (xl:col-span-3) -->
    <aside class="xl:col-span-3 space-y-6">

      <!-- Advertisement: Sidebar -->
      {% ad_container 'sidebar' 'my-6' %}

      {% if pending_friend_requests %}
      <section class="card border border-base-200 bg-base-100" aria-label="Friend requests">
        <div class="card-body p-5">
          <div class="flex items-center justify-between">
            <h2 class="text-base font-bold flex items-center gap-2">
              <i class="bi bi-person-plus" aria-hidden="true"></i>
              <span>Friend Requests</span>
            </h2>
            <a href="{% url 'friend_requests' %}" class="link link-primary text-sm">Review</a>
          </div>

          <div class="mt-3 space-y-3">
            {% for request in pending_friend_requests|slice:":2" %}
            <div class="flex items-center justify-between gap-3">
              <div class="flex items-center gap-2 min-w-0">
                <div class="avatar placeholder">
                  <div class="bg-neutral text-neutral-content rounded-full w-9">
                    <span class="text-xs">{{ request.from_user.username|first|upper }}</span>
                  </div>
                </div>
                <span class="text-sm font-semibold truncate">{{ request.from_user.username }}</span>
              </div>
              <a href="{% url 'friend_requests' %}" class="btn btn-outline btn-sm">Open</a>
            </div>
            {% endfor %}
          </div>
        </div>
      </section>
      {% endif %}

      <!-- Today's Tasks -->
      <section class="card border border-base-200 bg-base-100 shadow-md hover:shadow-lg transition-all" aria-label="Today's tasks">
        <div class="card-body p-5">
          <div class="flex items-center justify-between gap-3 mb-1">
            <h2 class="text-base font-bold flex items-center gap-2">
              <i class="bi bi-list-check text-success" aria-hidden="true"></i>
              <span>Today's Tasks</span>
            </h2>
            <a href="{% url 'task_list' %}" class="link link-primary text-sm font-semibold hover:gap-2 transition-all flex items-center gap-1">
              <span>View all</span>
              <i class="bi bi-arrow-right text-xs" aria-hidden="true"></i>
            </a>
          </div>

          {% if pending_tasks %}
          <ul class="mt-4 space-y-2">
            {% for task in pending_tasks|slice:":4" %}
            <li class="group">
              <div class="flex items-start gap-3 p-4 rounded-xl border border-base-200 bg-gradient-to-br from-base-100 to-base-200/20 hover:shadow-lg hover:border-success/30 hover:-translate-y-0.5 transition-all">
                <div class="flex-1 min-w-0">
                  <p class="text-sm font-bold truncate group-hover:text-success transition-colors">{{ task.title }}</p>
                  <div class="flex flex-wrap items-center gap-2 mt-2">
                    {% if task.category %}
                    <span class="badge badge-outline badge-xs gap-1">
                      <i class="bi bi-tag" aria-hidden="true"></i>
                      {{ task.category.name }}
                    </span>
                    {% endif %}
                    {% if task.due_date %}
                    <span class="badge badge-xs gap-1 {% if task.due_date == today %}badge-warning{% elif task.due_date < today %}badge-error{% else %}badge-ghost{% endif %}">
                      <i class="bi bi-calendar" aria-hidden="true"></i>
                      {{ task.due_date|date:"M j" }}
                    </span>
                    {% endif %}
                    {% if task.priority %}
                    <span class="badge badge-xs {% if task.priority == 'high' %}badge-error{% elif task.priority == 'medium' %}badge-warning{% else %}badge-ghost{% endif %}">
                      {{ task.priority }}
                    </span>
                    {% endif %}
                  </div>
                </div>
                <a href="{% url 'task_timer' task.id %}"
                   class="btn btn-primary btn-sm gap-1"
                   aria-label="Start timer for {{ task.title }}">
                  <i class="bi bi-alarm-fill" aria-hidden="true"></i>
                  <span>Start</span>
                </a>
              </div>
            </li>
            {% endfor %}
          </ul>
          {% else %}
          <div class="mt-4 p-4 rounded-xl bg-gradient-to-br from-success/5 to-transparent border border-success/20 text-center">
            <i class="bi bi-check-circle text-success text-3xl mb-2"></i>
            <p class="text-sm font-semibold text-base-content">All caught up!</p>
            <p class="text-xs text-base-content/70 mt-1">No pending tasks for today.</p>
          </div>
          {% endif %}
        </div>
      </section>



      <!-- Leaderboard -->
      <section class="card border border-base-200 bg-base-100 shadow-md hover:shadow-lg transition-all" aria-label="Leaderboard">
        <div class="card-body p-5">
          <div class="flex items-center justify-between gap-3 mb-4">
            <h2 class="text-base font-bold flex items-center gap-2">
              <i class="bi bi-trophy-fill text-warning text-xl" aria-hidden="true"></i>
              <span>Leaderboard</span>
            </h2>
            {% if user_rank %}
            <span class="badge badge-primary badge-md shadow-md">üèÜ #{{ user_rank }}</span>
            {% endif %}
          </div>

          <!-- Current User Stats -->
          <div class="mb-4 p-4 rounded-xl bg-gradient-to-br from-primary/15 via-primary/10 to-secondary/15 border-2 border-primary/30 shadow-lg">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-3">
                <div class="avatar placeholder">
                  <div class="bg-gradient-to-br from-primary to-secondary text-primary-content rounded-full w-12 h-12 ring-2 ring-primary/20 shadow-lg">
                    <span class="text-base font-bold">{{ user.username|first|upper }}</span>
                  </div>
                </div>
                <div>
                  <p class="font-bold text-sm">{{ user.username }}</p>
                  <p class="text-xs text-base-content/70 font-medium mt-0.5">
                    <i class="bi bi-fire text-warning"></i>
                    {{ user_points.current_streak }} day streak
                  </p>
                </div>
              </div>
              <div class="text-right">
                <p class="text-xl font-black text-primary">{{ user_points.total_points }}</p>
                <p class="text-xs text-base-content/60 font-semibold">points</p>
              </div>
            </div>
          </div>

          <!-- Top 10 -->
          <div class="space-y-2">
            {% for entry in leaderboard %}
            <div class="flex items-center justify-between p-2 rounded-lg {% if entry.user == user %}bg-primary/5{% else %}hover:bg-base-200/40{% endif %} transition">
              <div class="flex items-center gap-2 min-w-0">
                <span class="text-sm font-bold {% if forloop.counter <= 3 %}text-warning{% else %}text-base-content/60{% endif %} w-6">
                  {% if forloop.counter == 1 %}ü•á
                  {% elif forloop.counter == 2 %}ü•à
                  {% elif forloop.counter == 3 %}ü•â
                  {% else %}#{{ forloop.counter }}
                  {% endif %}
                </span>
                <div class="avatar placeholder">
                  <div class="bg-neutral text-neutral-content rounded-full w-8">
                    <span class="text-xs">{{ entry.user.username|first|upper }}</span>
                  </div>
                </div>
                <span class="text-sm font-semibold truncate {% if entry.user == user %}text-primary{% endif %}">
                  {{ entry.user.username }}
                </span>
              </div>
              <div class="text-right">
                <span class="text-sm font-bold tabular-nums">{{ entry.total_points }}</span>
                <span class="text-xs text-base-content/60">pts</span>
              </div>
            </div>
            {% empty %}
            <p class="text-sm text-center text-base-content/70 py-4">No rankings yet</p>
            {% endfor %}
          </div>

          <!-- Points Legend -->
          <div class="mt-4 p-3 rounded-lg bg-base-200/50">
            <p class="text-xs font-semibold text-base-content/80 mb-2">Earn Points:</p>
            <div class="space-y-1 text-xs text-base-content/70">
              <p><span class="font-semibold">+10</span> Log activity</p>
              <p><span class="font-semibold">+50</span> Daily visit</p>
              <p><span class="font-semibold">+75</span> Receive star from friend</p>
              <p><span class="font-semibold">+100</span> Complete task or accept mentee</p>
              <p><span class="font-semibold">+500</span> 3-day streak bonus</p>
              <p><span class="font-semibold">+1000</span> Complete plan</p>
            </div>
          </div>
        </div>
      </section>

      <!-- Optional: Messages quick link (nice on desktop, harmless on mobile) -->
      <section class="card border border-base-200 bg-base-100" aria-label="Messages shortcut">
        <div class="card-body p-5">
          <div class="flex items-center justify-between gap-3">
            <h2 class="text-base font-bold flex items-center gap-2">
              <i class="bi bi-chat-dots" aria-hidden="true"></i>
              <span>Messages</span>
            </h2>
            <a href="{% url 'inbox' %}" class="link link-primary text-sm">Open Inbox</a>
          </div>
          <p class="mt-2 text-sm text-base-content/70">
            Chat with friends and keep your streak going.
          </p>
        </div>
      </section>

    </aside>
  </div>
</main>

<!-- Star notifications toast -->
{% if star_notifications_count > 0 %}
<div id="star-toast" class="toast toast-top toast-end z-50 hidden" style="top: 5rem;">
  <div class="alert alert-warning shadow-lg">
    <div class="flex items-center gap-3">
      <i class="bi bi-star-fill text-warning text-xl" aria-hidden="true"></i>
      <div>
        <h3 class="font-bold">üéâ {{ star_notifications_count }} new star{{ star_notifications_count|pluralize }}!</h3>
        <div class="text-xs">Friends appreciated your activities.</div>
      </div>
      <a href="{% url 'notifications' %}" class="btn btn-warning btn-xs gap-1">
        <i class="bi bi-bell" aria-hidden="true"></i>
        <span>View</span>
      </a>
      <button class="btn btn-ghost btn-xs btn-circle" onclick="this.closest('#star-toast').remove()" aria-label="Close notification">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>
  </div>
</div>

<script>
// Show star notification toast on page load (only once per session)
(function() {
  const toast = document.getElementById('star-toast');
  if (toast) {
    // Check if toast has already been shown in this session
    const toastShown = sessionStorage.getItem('starToastShown');
    
    if (!toastShown) {
      // Show toast after a brief delay
      setTimeout(() => {
        toast.classList.remove('hidden');
      }, 500);
      
      // Mark as shown in session storage
      sessionStorage.setItem('starToastShown', 'true');
      
      // Auto-hide after 8 seconds
      setTimeout(() => {
        toast.classList.add('opacity-0', 'transition-opacity', 'duration-500');
        setTimeout(() => toast.remove(), 500);
      }, 8000);
    } else {
      // Already shown in this session, remove the toast element
      toast.remove();
    }
  }
})();
</script>
{% endif %}

<!-- Star toggle script -->
<script>
(function() {
  'use strict';
  
  // Ensure we only initialize once
  if (window.__dashboardInitialized) {
    console.warn('Dashboard already initialized, skipping...');
    return;
  }
  window.__dashboardInitialized = true;
  
  // Detect large dataset and apply optimizations
  const articleCount = document.querySelectorAll('article').length;
  const buttonCount = document.querySelectorAll('.star-btn').length;
  const cardCount = document.querySelectorAll('.card').length;
  
  // Lower threshold - even modest datasets can cause issues
  const isDataHeavy = articleCount > 3 || buttonCount > 5 || cardCount > 10;
  
  if (isDataHeavy) {
    console.log('üìä Large dataset detected (' + articleCount + ' articles, ' + buttonCount + ' buttons, ' + cardCount + ' cards), applying performance optimizations...');
    document.body.classList.add('data-heavy');
    
    // Throttle scroll events - only fire every 150ms max
    let scrollTimeout;
    let scrollRAF;
    
    const throttledScroll = function() {
      if (scrollRAF) return; // Already scheduled
      
      scrollRAF = requestAnimationFrame(() => {
        document.body.classList.add('is-scrolling');
        scrollRAF = null;
        
        clearTimeout(scrollTimeout);
        scrollTimeout = setTimeout(() => {
          document.body.classList.remove('is-scrolling');
        }, 150);
      });
    };
    
    // Only add if not already added
    if (!window.__dashboardScrollListenerAdded) {
      window.__dashboardScrollListenerAdded = true;
      window.addEventListener('scroll', throttledScroll, { passive: true });
    }
  } else {
    console.log('‚úÖ Normal dataset (' + articleCount + ' articles, ' + buttonCount + ' buttons, ' + cardCount + ' cards)');
  }
  
  // Star toggle - use event delegation OUTSIDE DOMContentLoaded
  // This prevents duplicate listeners and runs immediately
  let isProcessingClick = false;
  let lastClickTime = 0;
  
  document.addEventListener('click', function(event) {
    const button = event.target.closest('.star-btn');
    if (!button) return;
    
    // Aggressive debouncing for data-heavy pages (prevent rapid clicks)
    const now = Date.now();
    if (now - lastClickTime < 500) {
      event.preventDefault();
      event.stopPropagation();
      return;
    }
    lastClickTime = now;
    
    // Prevent multiple simultaneous requests
    if (isProcessingClick) {
      event.preventDefault();
      event.stopPropagation();
      return;
    }
    
    // Prevent default and stop propagation
    event.preventDefault();
    event.stopPropagation();
    
    isProcessingClick = true;
    button.disabled = true;
    
    const activityType = button.dataset.activityType;
    const activityId = button.dataset.activityId;
    const starIcon = button.querySelector('.bi');
    const starCount = button.querySelector('.star-count');

    // Use fetch with timeout (3s for faster recovery)
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 3000);

    fetch('{% url "toggle_star_reaction" %}', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token }}',
        'X-Requested-With': 'XMLHttpRequest'
      },
      body: JSON.stringify({ activity_type: activityType, activity_id: activityId }),
      signal: controller.signal
    })
    .then(response => response.json())
    .then(data => {
      clearTimeout(timeoutId);
      if (data.starred !== undefined) {
        const starred = !!data.starred;
        starIcon.classList.toggle('bi-star-fill', starred);
        starIcon.classList.toggle('bi-star', !starred);
        starIcon.classList.toggle('text-warning', starred);
        button.setAttribute('aria-label', starred ? 'Unstar this activity' : 'Star this activity');
        if (starCount) {
          starCount.textContent = data.star_count;
        }
      }
    })
    .catch(err => {
      clearTimeout(timeoutId);
      if (err.name !== 'AbortError') {
        console.error('Network error:', err);
      }
    })
    .finally(() => {
      isProcessingClick = false;
      button.disabled = false;
    });
  }, { passive: false });

document.addEventListener('DOMContentLoaded', function () {
  // Current time indicator for day schedule
  const timeline = document.getElementById('day-timeline');
  const currentTimeLine = document.getElementById('current-time-line');
  const currentTimeText = document.getElementById('current-time-text');
  
  // Early exit if elements don't exist
  if (!timeline || !currentTimeLine || !currentTimeText) {
    return;
  }
  
  let timelineUpdateInterval = null;
  let updatePending = false;
  
  function updateCurrentTimeLine() {
    if (updatePending) return;

    updatePending = true;
    
    const now = new Date();
    const hours = now.getHours();
    const minutes = now.getMinutes();
    
    // Only show the line if current time is between 9 AM (9) and 9 PM (21)
    if (hours >= 9 && hours < 21) {
      // Use requestAnimationFrame for smoother updates and better performance
      requestAnimationFrame(() => {
        try {
          // Calculate position as percentage
          // Total time span: 9 AM to 9 PM = 12 hours = 720 minutes
          // Current time from 9 AM in minutes
          const minutesFrom9AM = (hours - 9) * 60 + minutes;
          const totalMinutes = 12 * 60; // 12 hours
          const percentage = (minutesFrom9AM / totalMinutes) * 100;
          
          // Timeline has 12 hour slots, each 48px (h-12)
          const timelineHeight = 12 * 48; // 576px
          const topPosition = (percentage / 100) * timelineHeight;
          
          // Use transform instead of top for better performance
          currentTimeLine.style.transform = `translateY(${topPosition}px)`;
          currentTimeLine.style.top = '0';
          currentTimeLine.classList.remove('hidden');
          
          // Format time
          const ampm = hours >= 12 ? 'PM' : 'AM';
          const displayHours = hours > 12 ? hours - 12 : hours;
          const displayMinutes = minutes.toString().padStart(2, '0');
          currentTimeText.textContent = `${displayHours}:${displayMinutes} ${ampm}`;
        } catch (error) {
          console.error('Error updating timeline:', error);
        } finally {
          updatePending = false;
        }
      });
    } else {
      currentTimeLine.classList.add('hidden');
      updatePending = false;
    }
  }
  
  // Clear any existing interval to prevent duplicates
  if (timelineUpdateInterval) {
    clearInterval(timelineUpdateInterval);
    timelineUpdateInterval = null;
  }
  
  // Update current time line immediately and every minute
  updateCurrentTimeLine();
  timelineUpdateInterval = setInterval(updateCurrentTimeLine, 60000); // Update every minute
  
  // Clean up interval when page is hidden or unloaded - use { once: true } to prevent duplicates
  const visibilityHandler = function() {
    if (document.hidden && timelineUpdateInterval) {
      clearInterval(timelineUpdateInterval);
      timelineUpdateInterval = null;
      updatePending = false; // Reset throttle flag
    } else if (!document.hidden && !timelineUpdateInterval) {
      updateCurrentTimeLine();
      timelineUpdateInterval = setInterval(updateCurrentTimeLine, 60000);
    }
  };
  
  const unloadHandler = function() {
    if (timelineUpdateInterval) {
      clearInterval(timelineUpdateInterval);
      timelineUpdateInterval = null;
      updatePending = false;
    }
  };
  
  // Only add listeners if not already added (check flag on window)
  if (!window.__dashboardTimelineListenersAdded) {
    window.__dashboardTimelineListenersAdded = true;
    document.addEventListener('visibilitychange', visibilityHandler, { passive: true });
    window.addEventListener('beforeunload', unloadHandler, { once: true, passive: true });
  }
});

})(); // End IIFE
</script>


{% endblock %}
