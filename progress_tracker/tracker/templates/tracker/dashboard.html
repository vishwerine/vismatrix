{% extends 'tracker/base.html' %}

{% block title %}Dashboard - VisMatrix{% endblock %}

{# Mobile FAB: redirect to Messages (Inbox) instead of Log Time #}
{% block mobile_fab_href %}{% url 'inbox' %}{% endblock %}
{% block mobile_fab_aria %}Open messages{% endblock %}
{% block mobile_fab_icon %}bi-chat-dots{% endblock %}

{% block content %}
<main class="space-y-6">

  <!-- Header -->
  <header class="card border border-base-200 bg-base-100" role="banner">
    <div class="card-body p-5 sm:p-6">
      <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
        <div class="min-w-0">
          <h1 class="text-2xl sm:text-3xl font-extrabold text-base-content truncate">
            Welcome back, {{ user.username }}!
          </h1>
          <p class="text-sm text-base-content/70 mt-1">
            Your progress overview and updates for today.
          </p>
        </div>

        <div class="flex items-center gap-2 text-sm text-base-content/70">
          <i class="bi bi-calendar-event text-primary text-lg" aria-hidden="true"></i>
          <span class="font-semibold">{{ today|date:"l, F j, Y" }}</span>
        </div>
      </div>

      <!-- Quick actions -->
      <div class="mt-4 flex flex-col sm:flex-row gap-2">
        <a href="{% url 'task_create' %}" class="btn btn-outline gap-2">
          <i class="bi bi-plus-square" aria-hidden="true"></i>
          <span>New Task</span>
        </a>
        <a href="{% url 'log_create' %}" class="btn btn-primary gap-2">
          <i class="bi bi-stopwatch" aria-hidden="true"></i>
          <span>Log Time</span>
        </a>
        <a href="{% url 'analytics' %}" class="btn btn-primary gap-2">
          <i class="bi bi-bar-chart-line" aria-hidden="true"></i>
          <span>Analytics</span>
        </a>
      </div>
    </div>
  </header>

  {% if star_notifications_count > 0 %}
  <!-- Notifications -->
  <section class="alert alert-warning" role="alert" aria-live="polite">
    <div class="flex items-start gap-3 w-full">
      <i class="bi bi-star-fill text-xl" aria-hidden="true"></i>
      <div class="flex-1 min-w-0">
        <h2 class="font-bold text-base">
          You have {{ star_notifications_count }} star{{ star_notifications_count|pluralize }}.
        </h2>
        <p class="text-sm text-base-content/70">Friends appreciated your activities.</p>
      </div>
      <a href="{% url 'notifications' %}" class="btn btn-outline btn-sm gap-2">
        <i class="bi bi-bell" aria-hidden="true"></i>
        <span>View</span>
      </a>
    </div>
  </section>
  {% endif %}

  {% if unread_message_count > 0 %}
  <!-- New Messages Notification -->
  <section class="alert alert-info" role="alert" aria-live="polite">
    <div class="flex items-start gap-3 w-full">
      <i class="bi bi-chat-dots text-xl" aria-hidden="true"></i>
      <div class="flex-1 min-w-0">
        <h2 class="font-bold text-base">
          You have {{ unread_message_count }} new message{{ unread_message_count|pluralize }}.
        </h2>
        <p class="text-sm text-base-content/70">Friends sent you messages.</p>
      </div>
      <a href="{% url 'inbox' %}" class="btn btn-outline btn-sm gap-2">
        <i class="bi bi-inbox" aria-hidden="true"></i>
        <span>View</span>
      </a>
    </div>
  </section>
  {% endif %}

  <!-- Quick Stats Overview -->
  <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4" aria-label="Quick statistics">
    
    <!-- Today's Progress -->
    <div class="card border border-base-200 bg-gradient-to-br from-primary/5 to-transparent">
      <div class="card-body p-5">
        <div class="flex items-start justify-between gap-2">
          <div class="flex-1">
            <p class="text-xs font-semibold text-base-content/60 uppercase">Today's Progress</p>
            <p class="text-2xl font-bold mt-2">{{ today_completed }}/{{ today_tasks_count }}</p>
            <p class="text-sm text-base-content/70 mt-1">
              {% if today_tasks_count > 0 %}
                {{ today_completion_rate }}% complete
              {% else %}
                No tasks yet
              {% endif %}
            </p>
          </div>
          <div class="radial-progress text-primary" 
               style="--value:{{ today_completion_rate }}; --size:3rem; --thickness:4px;"
               role="progressbar"
               aria-label="Today's completion">
            <i class="bi bi-check-circle text-lg"></i>
          </div>
        </div>
      </div>
    </div>

    <!-- Current Streak -->
    <div class="card border border-base-200 bg-gradient-to-br from-success/5 to-transparent">
      <div class="card-body p-5">
        <div class="flex items-start justify-between gap-2">
          <div class="flex-1">
            <p class="text-xs font-semibold text-base-content/60 uppercase">Current Streak</p>
            <p class="text-2xl font-bold mt-2">{{ current_streak }}</p>
            <p class="text-sm text-base-content/70 mt-1">day{{ current_streak|pluralize }}</p>
          </div>
          <div class="flex items-center justify-center w-12 h-12 rounded-full bg-success/10">
            <i class="bi bi-fire text-success text-2xl"></i>
          </div>
        </div>
      </div>
    </div>

    <!-- Week Activity -->
    <div class="card border border-base-200 bg-gradient-to-br from-info/5 to-transparent">
      <div class="card-body p-5">
        <div class="flex items-start justify-between gap-2">
          <div class="flex-1">
            <p class="text-xs font-semibold text-base-content/60 uppercase">This Week</p>
            <p class="text-2xl font-bold mt-2">{{ week_time }}</p>
            <p class="text-sm text-base-content/70 mt-1 flex items-center gap-1">
              <span>minutes</span>
              {% if week_trend > 0 %}
                <i class="bi bi-arrow-up text-success text-sm"></i>
                <span class="text-success">+{{ week_trend }}%</span>
              {% elif week_trend < 0 %}
                <i class="bi bi-arrow-down text-error text-sm"></i>
                <span class="text-error">{{ week_trend }}%</span>
              {% endif %}
            </p>
          </div>
          <div class="flex items-center justify-center w-12 h-12 rounded-full bg-info/10">
            <i class="bi bi-graph-up text-info text-2xl"></i>
          </div>
        </div>
      </div>
    </div>

    <!-- Total Time -->
    <div class="card border border-base-200 bg-gradient-to-br from-warning/5 to-transparent">
      <div class="card-body p-5">
        <div class="flex items-start justify-between gap-2">
          <div class="flex-1">
            <p class="text-xs font-semibold text-base-content/60 uppercase">Total Time</p>
            <p class="text-2xl font-bold mt-2">{{ total_time }}</p>
            <p class="text-sm text-base-content/70 mt-1">
              Avg: {{ avg_daily_time }}m/day
            </p>
          </div>
          <div class="flex items-center justify-center w-12 h-12 rounded-full bg-warning/10">
            <i class="bi bi-clock text-warning text-2xl"></i>
          </div>
        </div>
      </div>
    </div>

  </section>

  {% if best_day_info or weekly_overview %}
  <!-- Activity Insights -->
  <section class="card border border-base-200 bg-base-100" aria-label="Activity insights">
    <div class="card-body p-5 sm:p-6">
      <h2 class="text-lg font-bold flex items-center gap-2">
        <i class="bi bi-lightbulb" aria-hidden="true"></i>
        <span>Activity Insights</span>
      </h2>

      <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-6">
        
        {% if best_day_info %}
        <!-- Best Day -->
        <div class="p-4 rounded-2xl border border-base-200 bg-gradient-to-br from-success/5 to-transparent">
          <div class="flex items-start gap-3">
            <i class="bi bi-trophy-fill text-success text-2xl" aria-hidden="true"></i>
            <div>
              <p class="text-xs font-semibold text-base-content/60 uppercase">Most Productive Day</p>
              <p class="text-base font-bold mt-1">{{ best_day_info.date|date:"F j, Y" }}</p>
              <p class="text-sm text-base-content/70 mt-1">{{ best_day_info.minutes }} minutes logged</p>
            </div>
          </div>
        </div>
        {% endif %}

        {% if weekly_overview %}
        <!-- Weekly Activity Pattern -->
        <div class="p-4 rounded-2xl border border-base-200 bg-base-100">
          <p class="text-xs font-semibold text-base-content/60 uppercase mb-3">Last 7 Days</p>
          <div class="flex items-end justify-between gap-1 h-20">
            {% for day in weekly_overview %}
            <div class="flex-1 flex flex-col items-center gap-1">
              <div class="w-full bg-primary rounded-t" 
                   style="height: {{ day.percent }}%;"
                   title="{{ day.label }}: {{ day.minutes }}m"></div>
              <span class="text-xs text-base-content/60">{{ day.label }}</span>
            </div>
            {% endfor %}
          </div>
        </div>
        {% endif %}

      </div>
    </div>
  </section>
  {% endif %}

  <!-- Main layout -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

    <!-- Left: Friends Feed -->
    {% if friends_timeline %}
    <section class="card border border-base-200 bg-base-100 lg:col-span-2" aria-label="Friends activity">
      <div class="card-body p-5 sm:p-6">
        <div class="flex items-center justify-between gap-3">
          <h2 class="text-lg font-bold flex items-center gap-2">
            <i class="bi bi-people" aria-hidden="true"></i>
            <span>Friends Feed</span>
            <span class="badge badge-primary badge-sm">{{ friends_timeline|length }}</span>
          </h2>
          <a href="{% url 'friends_list' %}" class="link link-primary text-sm flex items-center gap-1">
            <span>View all</span>
            <i class="bi bi-arrow-right" aria-hidden="true"></i>
          </a>
        </div>

        <div class="mt-4 space-y-3">
          {% for item in friends_timeline %}
          <article class="p-4 rounded-2xl border border-base-200 bg-base-100 hover:bg-base-200/40 transition">
            <div class="flex items-start gap-3">
              <div class="avatar placeholder">
                <div class="bg-gradient-to-br from-primary to-secondary text-primary-content rounded-full w-12 h-12 ring-2 ring-primary/20">
                  <span class="text-base font-bold">{{ item.user.username|first|upper }}</span>
                </div>
              </div>

              <div class="flex-1 min-w-0">
                <div class="flex flex-wrap items-center gap-2 mb-1">
                  <a href="{% url 'view_friend_profile' item.friendship_id %}"
                     class="font-bold text-sm link link-primary hover:underline">
                    {{ item.user.username }}
                  </a>
                  {% if item.type == 'task' %}
                    <span class="badge badge-success badge-sm gap-1">
                      <i class="bi bi-check-circle-fill" aria-hidden="true"></i>
                      <span>Task</span>
                    </span>
                  {% else %}
                    <span class="badge badge-info badge-sm gap-1">
                      <i class="bi bi-stopwatch" aria-hidden="true"></i>
                      <span>Log</span>
                    </span>
                  {% endif %}
                </div>

                <p class="text-sm font-semibold mb-2">
                  {% if item.type == 'task' %}
                    Completed: {{ item.title }}
                  {% else %}
                    Logged: {{ item.title }}
                  {% endif %}
                </p>

                <div class="flex flex-wrap items-center gap-x-4 gap-y-1 text-xs text-base-content/70">
                  <span class="inline-flex items-center gap-1">
                    <i class="bi bi-clock" aria-hidden="true"></i>
                    {{ item.timestamp|date:"M j, g:i A" }}
                  </span>
                  {% if item.duration %}
                  <span class="inline-flex items-center gap-1">
                    <i class="bi bi-stopwatch" aria-hidden="true"></i>
                    {{ item.duration }}m
                  </span>
                  {% endif %}
                  {% if item.category %}
                  <span class="inline-flex items-center gap-1 badge badge-outline badge-xs">
                    <i class="bi bi-tag" aria-hidden="true"></i>
                    {{ item.category.name }}
                  </span>
                  {% endif %}
                </div>
              </div>

              <!-- Star action -->
              <button
                class="star-btn btn btn-ghost btn-sm gap-2 flex-shrink-0"
                data-activity-type="{{ item.type }}"
                data-activity-id="{{ item.id }}"
                aria-label="{% if item.user_starred %}Unstar this activity{% else %}Star this activity{% endif %}">
                <i class="bi bi-star{% if item.user_starred %}-fill{% endif %} {% if item.user_starred %}text-warning{% endif %} text-lg" aria-hidden="true"></i>
                <span class="star-count text-sm font-semibold tabular-nums">{{ item.star_count }}</span>
              </button>
            </div>
          </article>
          {% endfor %}
        </div>
      </div>
    </section>
    {% endif %}

    <!-- Right: side cards -->
    <aside class="space-y-6">

      {% if pending_friend_requests %}
      <section class="card border border-base-200 bg-base-100" aria-label="Friend requests">
        <div class="card-body p-5">
          <div class="flex items-center justify-between">
            <h2 class="text-base font-bold flex items-center gap-2">
              <i class="bi bi-person-plus" aria-hidden="true"></i>
              <span>Friend Requests</span>
            </h2>
            <a href="{% url 'friend_requests' %}" class="link link-primary text-sm">Review</a>
          </div>

          <div class="mt-3 space-y-3">
            {% for request in pending_friend_requests|slice:":2" %}
            <div class="flex items-center justify-between gap-3">
              <div class="flex items-center gap-2 min-w-0">
                <div class="avatar placeholder">
                  <div class="bg-neutral text-neutral-content rounded-full w-9">
                    <span class="text-xs">{{ request.from_user.username|first|upper }}</span>
                  </div>
                </div>
                <span class="text-sm font-semibold truncate">{{ request.from_user.username }}</span>
              </div>
              <a href="{% url 'friend_requests' %}" class="btn btn-outline btn-sm">Open</a>
            </div>
            {% endfor %}
          </div>
        </div>
      </section>
      {% endif %}

      <!-- Today's Tasks -->
      <section class="card border border-base-200 bg-base-100" aria-label="Today's tasks">
        <div class="card-body p-5">
          <div class="flex items-center justify-between gap-3">
            <h2 class="text-base font-bold flex items-center gap-2">
              <i class="bi bi-list-check" aria-hidden="true"></i>
              <span>Today's Tasks</span>
            </h2>
            <a href="{% url 'task_list' %}" class="link link-primary text-sm flex items-center gap-1">
              <span>View all</span>
              <i class="bi bi-arrow-right text-xs" aria-hidden="true"></i>
            </a>
          </div>

          {% if pending_tasks %}
          <ul class="mt-3 space-y-2">
            {% for task in pending_tasks|slice:":4" %}
            <li class="group">
              <div class="flex items-start gap-3 p-3 rounded-xl border border-base-200 bg-base-100 hover:bg-base-200/40 hover:border-primary/30 transition">
                <div class="flex-1 min-w-0">
                  <p class="text-sm font-semibold truncate">{{ task.title }}</p>
                  <div class="flex flex-wrap items-center gap-2 mt-1">
                    {% if task.category %}
                    <span class="badge badge-outline badge-xs gap-1">
                      <i class="bi bi-tag" aria-hidden="true"></i>
                      {{ task.category.name }}
                    </span>
                    {% endif %}
                    {% if task.due_date %}
                    <span class="badge badge-xs gap-1 {% if task.due_date == today %}badge-warning{% elif task.due_date < today %}badge-error{% else %}badge-ghost{% endif %}">
                      <i class="bi bi-calendar" aria-hidden="true"></i>
                      {{ task.due_date|date:"M j" }}
                    </span>
                    {% endif %}
                    {% if task.priority %}
                    <span class="badge badge-xs {% if task.priority == 'high' %}badge-error{% elif task.priority == 'medium' %}badge-warning{% else %}badge-ghost{% endif %}">
                      {{ task.priority }}
                    </span>
                    {% endif %}
                  </div>
                </div>
                <a href="{% url 'log_create' %}?task={{ task.id }}"
                   class="btn btn-primary btn-sm gap-1"
                   aria-label="Log time for {{ task.title }}">
                  <i class="bi bi-play-fill" aria-hidden="true"></i>
                  <span>Start</span>
                </a>
              </div>
            </li>
            {% endfor %}
          </ul>
          {% else %}
          <div class="mt-4 p-4 rounded-xl bg-gradient-to-br from-success/5 to-transparent border border-success/20 text-center">
            <i class="bi bi-check-circle text-success text-3xl mb-2"></i>
            <p class="text-sm font-semibold text-base-content">All caught up!</p>
            <p class="text-xs text-base-content/70 mt-1">No pending tasks for today.</p>
          </div>
          {% endif %}
        </div>
      </section>

      <!-- Recent Activity -->
      <section class="card border border-base-200 bg-base-100" aria-label="Recent activity">
        <div class="card-body p-5">
          <div class="flex items-center justify-between gap-3">
            <h2 class="text-base font-bold flex items-center gap-2">
              <i class="bi bi-clock-history" aria-hidden="true"></i>
              <span>Recent</span>
            </h2>
            <a href="{% url 'log_list' %}" class="link link-primary text-sm">View all</a>
          </div>

          <div class="mt-3 space-y-3">
            {% for log in recent_logs|slice:":3" %}
            <div class="p-3 rounded-xl border border-base-200 bg-base-100">
              <p class="text-sm font-semibold">{{ log.activity }}</p>
              <p class="mt-1 text-xs text-base-content/70 flex items-center gap-2">
                <span class="inline-flex items-center gap-1">
                  <i class="bi bi-stopwatch" aria-hidden="true"></i>
                  {{ log.duration }}m
                </span>
                {% if log.category %}
                <span class="inline-flex items-center gap-1">
                  <i class="bi bi-tag" aria-hidden="true"></i>
                  {{ log.category.name }}
                </span>
                {% endif %}
              </p>
            </div>
            {% empty %}
            <p class="text-sm text-base-content/70 italic">No recent activity.</p>
            {% endfor %}
          </div>
        </div>
      </section>

      <!-- Plans -->
      <section class="card border border-base-200 bg-base-100" aria-label="Active plans">
        <div class="card-body p-5">
          <div class="flex items-center justify-between gap-3">
            <h2 class="text-base font-bold flex items-center gap-2">
              <i class="bi bi-diagram-3" aria-hidden="true"></i>
              <span>Plans</span>
            </h2>
            <a href="{% url 'plan_list' %}" class="link link-primary text-sm">View all</a>
          </div>

          {% if active_plans %}
          <div class="mt-3 space-y-3">
            {% for plan in active_plans|slice:":3" %}
            <a href="{% url 'plan_detail' plan.pk %}" 
               class="block p-3 rounded-xl border border-base-200 bg-base-100 hover:bg-base-200/40 transition">
              <div class="flex items-start justify-between gap-2">
                <div class="min-w-0 flex-1">
                  <p class="text-sm font-semibold truncate">{{ plan.title }}</p>
                  <p class="mt-1 text-xs text-base-content/70 flex items-center gap-2">
                    <span class="inline-flex items-center gap-1">
                      <i class="bi bi-diagram-3" aria-hidden="true"></i>
                      {{ plan.total_tasks|default:0 }} task{{ plan.total_tasks|default:0|pluralize }}
                    </span>
                    {% if plan.total_tasks > 0 %}
                    <span class="inline-flex items-center gap-1">
                      <i class="bi bi-check-circle" aria-hidden="true"></i>
                      {{ plan.completed_tasks|default:0 }}/{{ plan.total_tasks }}
                    </span>
                    {% endif %}
                  </p>
                </div>
                {% if plan.total_tasks > 0 %}
                <div class="radial-progress text-xs" 
                     style="--value:{% widthratio plan.completed_tasks plan.total_tasks 100 %}; --size:2.5rem; --thickness:3px;"
                     role="progressbar"
                     aria-label="Plan progress">
                  <span class="text-[10px]">{% widthratio plan.completed_tasks plan.total_tasks 100 %}%</span>
                </div>
                {% endif %}
              </div>
            </a>
            {% endfor %}
          </div>
          {% else %}
          <div class="mt-4 p-4 rounded-xl bg-base-200/50 text-center">
            <p class="text-sm text-base-content/70">No active plans.</p>
            <a href="{% url 'plan_create' %}" class="btn btn-outline btn-sm mt-2 gap-2">
              <i class="bi bi-plus-lg" aria-hidden="true"></i>
              <span>Create Plan</span>
            </a>
          </div>
          {% endif %}
        </div>
      </section>

      <!-- Activity Calendar -->
      {% if calendar_days %}
      <section class="card border border-base-200 bg-base-100" aria-label="Monthly activity">
        <div class="card-body p-5">
          <div class="flex items-center justify-between gap-3">
            <h2 class="text-base font-bold flex items-center gap-2">
              <i class="bi bi-calendar3" aria-hidden="true"></i>
              <span>This Month</span>
            </h2>
            <span class="badge badge-outline text-xs">{{ logs_this_month }} logs</span>
          </div>

          <div class="mt-3">
            <!-- Calendar header -->
            <div class="grid grid-cols-7 gap-1 mb-2">
              {% for day_name in day_names %}
              <div class="text-xs text-center font-semibold text-base-content/60">
                {{ day_name|slice:":1" }}
              </div>
              {% endfor %}
            </div>
            
            <!-- Calendar days -->
            <div class="grid grid-cols-7 gap-1">
              {% for day in calendar_days %}
              <div class="aspect-square flex items-center justify-center text-xs rounded {% if day.logged %}bg-primary text-primary-content font-semibold{% else %}bg-base-200/50 text-base-content/50{% endif %}"
                   title="{% if day.logged %}Activity logged{% else %}No activity{% endif %}">
                {{ day.day }}
              </div>
              {% endfor %}
            </div>
            
            <div class="mt-3 flex items-center justify-center gap-3 text-xs">
              <div class="flex items-center gap-1">
                <div class="w-3 h-3 rounded bg-base-200/50"></div>
                <span class="text-base-content/60">None</span>
              </div>
              <div class="flex items-center gap-1">
                <div class="w-3 h-3 rounded bg-primary"></div>
                <span class="text-base-content/60">Logged</span>
              </div>
            </div>
          </div>
        </div>
      </section>
      {% endif %}

      <!-- Optional: Messages quick link (nice on desktop, harmless on mobile) -->
      <section class="card border border-base-200 bg-base-100" aria-label="Messages shortcut">
        <div class="card-body p-5">
          <div class="flex items-center justify-between gap-3">
            <h2 class="text-base font-bold flex items-center gap-2">
              <i class="bi bi-chat-dots" aria-hidden="true"></i>
              <span>Messages</span>
            </h2>
            <a href="{% url 'inbox' %}" class="link link-primary text-sm">Open Inbox</a>
          </div>
          <p class="mt-2 text-sm text-base-content/70">
            Chat with friends and keep your streak going.
          </p>
        </div>
      </section>

    </aside>
  </div>
</main>

<!-- Star toggle script -->
<script>
document.addEventListener('DOMContentLoaded', function () {
  document.querySelectorAll('.star-btn').forEach(button => {
    button.addEventListener('click', async function () {
      const activityType = this.dataset.activityType;
      const activityId = this.dataset.activityId;
      const starIcon = this.querySelector('.bi');
      const starCount = this.querySelector('.star-count');

      try {
        const response = await fetch('{% url "toggle_star_reaction" %}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
          },
          body: JSON.stringify({ activity_type: activityType, activity_id: activityId })
        });

        const data = await response.json();

        if (response.ok) {
          const starred = !!data.starred;
          starIcon.classList.toggle('bi-star-fill', starred);
          starIcon.classList.toggle('bi-star', !starred);
          starIcon.classList.toggle('text-warning', starred);
          this.setAttribute('aria-label', starred ? 'Unstar this activity' : 'Star this activity');
          starCount.textContent = data.star_count;
        } else {
          console.error('Error:', data.error);
        }
      } catch (err) {
        console.error('Network error:', err);
      }
    });
  });
});
</script>


{% endblock %}
